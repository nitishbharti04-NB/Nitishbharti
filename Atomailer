[[dags]]
dag_id = 'Load_capacity'
schedule_interval = '0 5,7,9,11,13,14,16 * * *'

[[dags]] 
dag_id = 'AeBulky_POD'
schedule_interval = '0 7,9,11,13,15,17,19 * * *'

[[dags]] 
dag_id = 'Held_Shipments'
schedule_interval = '30 6 * * *'

[[dags]]
dag_id = 'email_dag'
schedule_interval = '45 5 * * *'


[[dags]]
dag_id = 'AE_losto'
schedule_interval = '5 6 * * *'

[[dags]]
dag_id = 'volumetric_compliance_1'
schedule_interval = '5 7,18 * * *'

[[dags]]
dag_id = 'volumetric_compliance_MTD'
schedule_interval = '5 8,18 * * *'

[[dags]]
dag_id = 'NB_AEEDD'
schedule_interval = '0 2,3,4,5,6,7,8,9,11,13,15,16,17,18,19,23 * * *'

[[dags]]
dag_id = 'AE_AttemptDistance'
schedule_interval = '5 6 * * *'

[[dags]]
dag_id = 'calling_mailer'
schedule_interval = '0 17 * * *'

[[dags]]
dag_id = 'NP_Daily_10'
schedule_interval = '35 4 * * *'

[[dags]]
dag_id = 'Ekta@3011'
schedule_interval = '1 0 1 * *'

[[dags]] 
dag_id = 'NA_mails'
schedule_interval = '0 3 * * *'

[[dags]] 
dag_id = 'ag_mailers'
schedule_interval = '0 4 * * *'

[[dags]] 
dag_id = 'ag_capacity_attempt'
schedule_interval = '0 13 * * *'

[[dags]] 
dag_id = 'Dark_store'
schedule_interval = '0 22 * * *'

[[dags]] 
dag_id = 'SlotClosure_Capacity'
schedule_interval = '0 22 * * *'


[[dags]] 
dag_id = 'LS_CIR'
schedule_interval = '0 6,7,8,9,10,11,12,13 * * *'

[[dags]] 
dag_id = 'LS_101214'
schedule_interval = '0 8,10,12 * * *'

[[dags]]
dag_id = 'rto_email'
schedule_interval = '0 20 * * *'

[[dags]]
dag_id = 'premium_ser'
schedule_interval = '45 3 * * 0-5'

[[dags]]
dag_id = 'adm_report'
schedule_interval = '0 7 * * *'

[[dags]]
dag_id = 'failed_rtv'
schedule_interval = '0 5 * * *'

[[dags]] 
dag_id = 'WBP'
schedule_interval = '0 5,7,9,11 * * *'

[[dags]]
dag_id = 'Pending_add'
schedule_interval = '0 0 * * 0'

[[dags]]
dag_id = 'Pending_address_rtv'
schedule_interval = '0 0 * * 3'


[[dags]]
dag_id = 'LSH15'
schedule_interval = '15 * * * *'

[[dags]]
dag_id = 'LSItem'
schedule_interval = '50 09,21 * * *'

[[dags]] 
dag_id = 'LSv12'
schedule_interval = '0 6 * * *'

[[dags]] 
dag_id = 'LSEv10'
schedule_interval = '45 7 * * *'

[[dags]] 
dag_id = 'LSv9'
schedule_interval = '0 9 * * *'

[[dags]] 
dag_id = 'LSETv12'
schedule_interval = '45 9 * * *'

[[dags]] 
dag_id = 'LSETv15'
schedule_interval = '15 12 * * *'

[[dags]] 
dag_id = 'LSv830'
schedule_interval = '30 8 * * *'

[[dags]] 
dag_id = 'LSEv9'
schedule_interval = '0 7 * * *'

[[dags]] 
dag_id = 'LSEv13'
schedule_interval = '0 12 * * *'

[[dags]] 
dag_id = 'LSEv12'
schedule_interval = '45 11 * * *'

[[dags]] 
dag_id = 'LSv7'
schedule_interval = '35 4 * * *'

[[dags]] 
dag_id = 'LSv8to4'
schedule_interval = '15 5,6,7,8,9,10,11,12,13,14,15,17 * * *'

[[dags]] 
dag_id = 'Weekly_report'
schedule_interval = '05 01 * * 7'

[[dags]]
dag_id = 'Incentive_mailer'
schedule_interval = '0 2 * * *'

[[dags]]
dag_id = 'Hub_DA_Report'
schedule_interval = '* 2 1 * *'

[[dags]]
dag_id = 'DRT_SHP_MAILER'
schedule_interval = '30 5 * * *'

[[dags]]
dag_id = 'PKG_MTRL'
schedule_interval = '0 6 * * *'

[[dags]]
dag_id = 'Breach_SummaryReport'
schedule_interval = '0 2 * * *'

[[dags]]
dag_id = 'Deliver_Percentage_Summary'
schedule_interval = '0 3 * * *'

[[dags]]
dag_id = 'F_daily_test'
schedule_interval = '15 3 * * *'

[[dags]]
dag_id = 'ops_hourly'
schedule_interval = '@hourly'

[[dags]]
dag_id = 'NEERAJ_Daily_10'
schedule_interval = '45 4 * * *'

[[dags]]
dag_id = 'Akshay_UAE_10'
schedule_interval = '0 1 * * *'

# [[email]]
# dag_id = 'Akshay_UAE_10'
# task_id = 'Pending_for_FA_Breach'
# name ='Pending_for_FA_Breach_Greater_then_0_day'
# body = ["""SELECT Country_code ,COUNT(distinct awb_nr) Pending_Attempt_Cnt FROM (SELECT distinct so.country_code ,sois.awb_nr , DATE(soi.estimated_delivery_at ) edd,hub ,id_mp,soi.id_sales_order_item_status FROM noonltddwh.sales.sales_order_item soi LEFT JOIN noonltddwh.sales.sales_order so using(id_Sales_order)LEFT JOIN noonltddwh.sales.sales_order_item_shipment sois using(id_sales_order_item_shipment) LEFT JOIN `noonbilogoi.Share_Point.NE_FAS` fa using(awb_nr) LEFT JOIN ( SELECT awb_nr , hub.code as Hub from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub) Hubr ON Hubr.awb_nr = sois.awb_nr WHERE DATE(soi.estimated_delivery_at ) >= current_date - 14 and DATE(soi.estimated_delivery_at ) <= current_date - 1 AND fa.FA_TS is null and sois.awb_nr is not null and substr(sois.awb_nr,0,1) = 'P' and soi.id_sales_order_item_status = 5)GROUP BY 1 order by Pending_Attempt_Cnt desc"""]
# attachment_sql = ["""SELECT distinct so.country_code ,sois.awb_nr , DATE(soi.estimated_delivery_at ) edd,Hubr.hub ,id_mp,soi.id_sales_order_item_status,case when so.payment_method_code = 'cod' then 'cod' else 'Perpaid' end as payment_method_code,ifs.status,current_location, case when awb_3PL is not null then '3PL' else 'NE' end as NE_3PL_flag,final_status FROM noonltddwh.sales.sales_order_item soi LEFT JOIN noonltddwh.sales.sales_order so using(id_Sales_order)LEFT JOIN noonltddwh.sales.sales_order_item_shipment sois using(id_sales_order_item_shipment)LEFT JOIN(SELECT status,ls.current_location,CASE WHEN ls.loc_type = 'hub_location' and ls.creq_leg_type = 'Delivery' and num_attempts = 0 then 'Pending_attempt_1' WHEN ls.loc_type = 'hub_location' and ls.creq_leg_type = 'Delivery' and num_attempts = 1 then 'Pending_attempt_2' WHEN ls.loc_type = 'hub_location' and ls.creq_leg_type = 'Delivery' and num_attempts = 2 then 'Pending_attempt_3' WHEN ls.loc_type = 'hub_location' and ls.creq_leg_type = 'Delivery' and num_attempts > 2 then 'Pending_attempt_>3' WHEN ls.loc_type IN ('hub_transfer','pgroup') and ls.creq_leg_type = 'Delivery' then 'InTransit' WHEN ls.loc_type IN ('hub_transfer','pgroup') and ls.creq_leg_type = 'RTO' then 'RTO InTransit' WHEN ls.loc_type IN ('user','service_point_locker_location','service_point_counter') and ls.creq_leg_type = 'Delivery' then 'Out For Delivery' WHEN ls.loc_type IN ('pgroup','hub_transfer') and ls.creq_leg_type = 'RTO' then 'RTO InTransit' WHEN ls.loc_type IN ('hub_location') and ls.creq_leg_type = 'RTO' then 'RTO Pending for Dispatch' WHEN ls.loc_type IN ('user','service_point_counter_location','service_point_locker_location','service_point_counter') and ls.creq_leg_type = 'RTO' then 'RTO OnField' when epd.final_status is not null then epd.final_status else 'Pending_handover' end as final_status ,ls.loc_type,hub,ls.creq_leg_type,ls.country ,cl.num_attempts,awb_nr FROM `noonbilogoi.battleplan_v1.item_final_state` ls LEFT JOIN `noonbilogmis.reporting.EG_Pending_Data` epd using(awb_nr) LEFT JOIn noonltddwh.lms.creq_leg cl using(id_creq_leg) WHERE creq = 'LM' group by 1,2,3,4,5,6,7,8,9 ) ifs using(awb_nr)LEFT JOIN (SELECT tpl_item.awb_nr noon_awb,tpl_carrier_reference.reference_nr awb_3PL ,c.name DSP FROM `noonltddwh.lms.item` item LEFT JOIN noonltddwh.lms.tpl_item_pgroup_map tpl_item_pgroup_map ON tpl_item_pgroup_map.id_item_pgroup = item.id_item LEFT JOIN noonltddwh.lms.item tpl_item ON tpl_item_pgroup_map.id_item = tpl_item.id_item left join `noonltddwh.lms.tpl_carrier_reference` as tpl_carrier_reference on tpl_carrier_reference.id_item =tpl_item_pgroup_map.id_item_pgroup left join noonltddwh.lms.carrier c using(id_carrier) WHERE tpl_carrier_reference.reference_nr is not null) d on d.noon_awb = sois.awb_nr LEFT JOIN `noonbilogoi.Share_Point.NE_FAS` fa using(awb_nr) LEFT JOIN ( SELECT awb_nr , hub.code as Hub from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub) Hubr ON Hubr.awb_nr = sois.awb_nr WHERE DATE(soi.estimated_delivery_at ) >= current_date - 14 and DATE(soi.estimated_delivery_at ) <= current_date - 1 AND fa.FA_TS is null and sois.awb_nr is not null and substr(sois.awb_nr,0,1) = 'P' and soi.id_sales_order_item_status = 5"""]
# recipients = ["hjha@noon.com","vijain@noon.com","sraut@noon.com","uae-trojans@noon.com","kray@noon.com","mshawky@noon.com","morub@noon.com","nkumar@noon.com","nadlakha@noon.com","mjaroli@noon.com","pchhetri@noon.com","nesingh@noon.com","aemam@noon.com","skallingal@noon.com","mahamza@noon.com","wsperito@noon.com","vmohan@noon.com","pdhakad@noon.com","mwarish@noon.com","nparnami@noon.com","nseth@noon.com","dgera@noon.com","logistics-reporting@noon.com","anssingh@noon.com","rguevarra@noon.com","vishsingh@noon.com","ekumari@noon.com","sagautam@noon.com","amewada@noon.com","skotla@noon.com","mabulfaraj@noon.com","mohshaikh@noon.com","vdubey@noon.com","lkarunakaran@noon.com","rsyed@noon.com","jmiyan@noon.com","sreddy@noon.com","vipindas@noon.com","alateef@noon.com","ywahi@noon.com","faizalam@noon.com","ckrishna@noon.com","lsharma@noon.com","npaliwal@noon.com"]
# sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'NP_Daily_10'
#task_id = 'NP_Daily_10'
#name ='CIR_pick_pending_to_return_Tpl'
#body = ["""SElect * from `noonbilogmis.reporting.3PL_CIR_Pick_return_body`""","""select * from `noonbilogmis.reporting.ag_cir_pending`"""]
#attachment_sql = ["""SElect * from `noonbilogmis.reporting.3PL_CIR_Pick_return_attachment`""","""SELECT creation_dt,client_ref,reference_nr,pick_status,dsp,Hub,country,hub_sector,CASE WHEN substr(client_ref,0,1) = 'W' then 'Warranty' else 'CIR' END AS Flag FROM noonbilogmis.reporting.3PL_CIR_ALL_LS WHERE pick_status = 'opened' and country <>'eg' and DSP='aramex'"""]
#recipients = ["akesargadde@noon.com","lsharma@noon.com","ahmadAlaw@aramex.com","zaid@aramex.com","emadSa@aramex.com","vbhardwaj@noon.com","vijain@noon.com","logistics-reporting@noon.com","satanwar@noon.com","vishsingh@noon.com","rguevarra@noon.com","vchaudhary@noon.com","mabulfaraj@noon.com"]
#sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'NP_Daily_10'
task_id = 'Yesterday_3PL_Breached'
name ='Yesterday_3PL_Breached_cases'
body = ["""SELECT * FROM `noonbilogmis.reporting.TPL_yesterday_body`"""]
attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.TPL_yesterday_rawdata`"""]
recipients = ["akesargadde@noon.com","lsharma@noon.com","vijain@noon.com","logistics-reporting@noon.com","satanwar@noon.com","rguevarra@noon.com","vchaudhary@noon.com","mabulfaraj@noon.com"]
sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'NEERAJ_Daily_10'
#task_id = 'Last_7_Days_3PL'
#name ='Last_7_Days_pending_3PL'
#attachment_sql = ["""select ship_dt as Ship_Date, Sum(Not_attempted) as Not_attempted from (select ship_dt,case when attempt1>current_date and attempt2>current_date() and attempt3>current_date then count(distinct awb_nr) end as Not_attempted from `noonbilogmis.reporting.3PL_ALL111_LS` where DATE(ship_dt) > current_Date -8	group by ship_dt,attempt1,attempt2,attempt3) group by ship_dt"""]
#recipients = ["satanwar@noon.com","logistics-reporting@noon.com","mabulfaraj@noon.com"]
#sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'NEERAJ_Daily_10'
#task_id = 'wants_delivery'
#name ='wants_delivery_3PL'
#attachment_sql = ["""Select Ship_dt as Ship_Date,sum(Delivered_within_24_Hrs) as Delivered_within_24_Hrs, sum(Delivered_within_48_Hrs) as Delivered_within_48_Hrs from (select ac.ship_dt,case when date_diff(date(ac.ship_dt),date(ab.Date_Time),day)>=1 then count (distinct ac.awb_nr) end as Delivered_within_24_Hrs,case when date_diff(date(ac.ship_dt),date(ab.Date_Time),day)>=2 then count (distinct  ac.awb_nr) end as Delivered_within_48_Hrs,from `noonbilogmis.reporting.3PL_ALL111_LS` ac inner join `noonbilogoi.nefreelancer.ne_calling_outcom_history` ab on ab.unique_ID = ac.Order_Number where DATE(ac.ship_dt) > current_Date -8 and ab.Cust_Disposition like '%reschedule%' group by ship_dt,date_time) group by ship_dt order by ship_dt desc"""]
#recipients = ["satanwar@noon.com","logistics-reporting@noon.com","mabulfaraj@noon.com"]
#sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'NEERAJ_Daily_10'
#task_id = 'Pickup_pending'
#name ='Pickup_pending_3PL'
#body = ["""select case when timestamp_diff(current_date,creation_dt,day) between 0 and 2  then "0 - 2 Days" when timestamp_diff(current_date,creation_dt,day) between 2 and 4  then "2- 4 Days" when timestamp_diff(current_date,creation_dt,day)  > 4  then "above_4_days Days" end as Ageing,count (distinct order_nr)  as Pickup_pending from`noonbilogmis.reporting.3PL_CIR_ALL_LS`where pick_status in ('opened','held') group by ageing order by ageing"""]
#attachment_sql = ["""select case when timestamp_diff(current_date,creation_dt,day) between 0 and 2  then "0 - 2 Days" when timestamp_diff(current_date,creation_dt,day) between 2 and 4  then "2- 4 Days" when timestamp_diff(current_date,creation_dt,day)  > 4  then "above_4_days Days" end as Ageing,count (distinct order_nr)  as Pickup_pending,client_ref from`noonbilogmis.reporting.3PL_CIR_ALL_LS`where pick_status in ('opened','held') group by ageing,client_ref order by ageing"""]
#recipients = ["satanwar@noon.com","logistics-reporting@noon.com","mabulfaraj@noon.com"]
#sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'NEERAJ_Daily_10'
task_id = 'Warranty_Pickup_pending'
name ='Warranty_Pickup_pending_3PL'
body = ["""select case when timestamp_diff(current_date,creation_dt,day) between 0 and 2 then "0 - 2 Days" when timestamp_diff(current_date,creation_dt,day)between 2 and 4 then  "2 to 4 Days" when timestamp_diff(current_date,creation_dt,day)> 4 then  "Above 4 Days" end as Ageing,Count(Distinct client_ref) Total_pickup_pending from`noonbilogmis.reporting.3PL_CIR_ALL_LS`where left (client_ref,1) ='W'	and flag in ('Not-Pickup','held')group by ageing order by 1"""]
attachment_sql = ["""select case when timestamp_diff(current_date,creation_dt,day) between 0 and 2 then "0 - 2 Days" when timestamp_diff(current_date,creation_dt,day)between 2 and 4 then  "2 to 4 Days" when timestamp_diff(current_date,creation_dt,day)> 4 then  "Above 4 Days" end as Ageing, client_ref from`noonbilogmis.reporting.3PL_CIR_ALL_LS`where left (client_ref,1) ='W'	and flag in ('Not-Pickup','held')group by ageing,client_ref order by 1"""]
recipients = ["satanwar@noon.com","logistics-reporting@noon.com","mabulfaraj@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'ops_hourly'
task_id = 'DS_CUDelivered_Report'
name ='DS_CUDelivered_Report'
body = ["""Select * from `noonbilogoi.SA.DS_CUDelivered_Report`""","""Select * from `noonbilogoi.SA.CurrentDate_CTag_Orders`""","""Select * from `noonbilogoi.SA.P1Wk_CTag_Orders`"""]
recipients = ["dnataraja@noon.com","paynikath@noon.com","wsperito@noon.com","mjaroli@noon.com","pchhetri@noon.com","rjoseph@noon.com","grahman@noon.com","pdhakad@noon.com"]
sender = 'logistics-reporting@noon.com'





#[[email]]

#dag_id = 'LSv12'
#task_id = 'Zendesk_warranty_pending'
#name ='warranty_cases_manual_check'
#attachment_sql = ["""SELECT * FROM `noonbilogmis.RG_complaint.Warranty_manual_raw_data`"""]
#body = ["""SELECT * FROM `noonbilogmis.RG_complaint.Warranty_manual_check`""","""SELECT * FROM `noonbilogmis.RG_complaint.Warranty_manual_check_1`"""]
#recipients = ["rguevarra@noon.com","ops.excellence@noon.com","support_ne@noon.com","vinsharma@noon.com","pwilson@noon.com","satanwar@noon.com","vchaudhary@noon.com","sbhat@noon.com","abdabdullah@noon.com","kshanu@noon.com","nesupport_EGY@noon.com","sraut@noon.com","akesargadde@noon.com","mshawky@noon.com","marksamy@noon.com","mespeno@noon.com","aemam@noon.com","sups@noon.com","uae-trojans@noon.com","nadlakha@noon.com","nseth@noon.com","Tarek Awad","Mohammad Shahnawaz","nesupport_UAE@noon.com"]
#sender = 'sshivhare@noon.com'


#[[email]]

#dag_id = 'LSv12'
#task_id = 'EGY_Calling_Outcomes'
#name = 'EGY_Calling_Outcomes'
#attachment_sql = ["""SELECT * FROM `noonbilogmis.RG_complaint.EGY_calling_raw`"""]
#body = [""" SELECT * FROM `noonbilogmis.RG_complaint.EGY_calling_1`"""]
#recipients = ["vijain@noon.com","rguevarra@noon.com","noabdelrahman@noon.com","hanyabdullah@noon.com","aouda@noon.com","nesupport_EGY@noon.com","sshivhare@noon.com","shshivhare@noon.com","kshanu@noon.com","spraveen@noon.com","rkhunteta@noon.com","sbhat@noon.com",]
#sender = 'sshivhare@noon.com'

[[email]]
dag_id = 'F_daily_test'
task_id = 'sdev_ndaily'
name ='Noon Daily EOD Summary Report'
body = ["""select * from `noonbilogoi.SA.Noon_Daily_EOD_Summary_Orders` order by 1,2,3""", """select * from `noonbilogoi.SA.Noon_Daily_EOD_Summary_Items`"""]
recipients = ["rjoseph@noon.com","faraz@noon.com","hzarka@noon.com","rk@noon.com","hjha@noon.com","shaahmad@noon.com","pchhetri@noon.com","marshad@noon.com","aparkar@noon.com","gkgupta@noon.com","masghar@noon.com","asahu@noon.com","morub@noon.com","pbagri@noon.com","sdev@noon.com","mjaroli@noon.com","skallingal@noon.com","dhsingh@noon.com","dnataraja@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'SlotClosure_Capacity'
task_id = 'SlotClosure_Capacity'
name ='SlotClosure_Capacity'
body = ["""select * from noonbilogoi.reporting_mart.SlotClosure_Capacity"""]
recipients = ["rjoseph@noon.com","sdev@noon.com","mjaroli@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'email_dag'
task_id = 'yesterday_qc_fail_data_eg'
name = 'yesterday_qc_fail_data_eg'
attachment_sql = ["""select * from `noonbilogmis.NA_tables.qc_fail_raw` where qc_date = current_date()-1 and Country in ('eg','EG')"""]
body = ["""select distinct reason_code,count(distinct item_nr) as item_count,sum(value) as value from `noonbilogmis.NA_tables.qc_fail_raw` where qc_date = current_date()-1 and Country in ('eg','EG') group by 1"""]
recipients = ["sraut@noon.com","mshawky@noon.com","nadlakha@noon.com","mahamza@noon.com","nanand@noon.com","moustafaamer@noon.com","vijain@noon.com","amoheb@noon.com"]
sender = 'nanand@noon.com'

[[email]]
dag_id = 'Breach_SummaryReport'
task_id = 'SectorWise_AdherenceReport'
name ='SectorWise_AdherenceReport'
body = ["""select * from `noonbilogoi.reporting_mart.NDD_SectorWise_AdherenceReport`"""]
attachment_sql = ["""select * from noonbilogoi.SA.CurrentDateDailyView"""]
recipients = ["rjoseph@noon.com","pbagri@noon.com","grahman@noon.com","dnataraja@noon.com","asethi@noon.com","paynikath@noon.com","vchellapandi@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'failed_rtv'
task_id = 'DS_HubPerformance'
name ='DS_HubPerformance'
body = ["""select * from `noonbilogoi.reporting_mart.DS_HubPerformance`"""]
attachment_sql = ["""select * from noonbilogoi.reporting_mart.DS_HubPerformance_RawData"""]
recipients = ["rjoseph@noon.com","mjaroli@noon.com","pchhetri@noon.com","dnataraja@noon.com","paynikath@noon.com","asethi@noon.com","pbagri@noon.com","mshivashankarappa@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Breach_SummaryReport'
task_id = 'Instant_Delays_Report'
name ='Instant_Delays_Report'
body = ["""select * from `noonbilogoi.reporting_mart.Instant_Delays_Summary`"""]
attachment_sql = ["""select * from noonbilogoi.reporting_mart.Instant_Delays_RawData"""]
recipients = ["rjoseph@noon.com","mjaroli@noon.com","pbagri@noon.com","pchhetri@noon.com","sdev@noon.com","dnataraja@noon.com","asethi@noon.com","ruhd3@noon.com","skallingal@noon.com","morub@noon.com","daily.logistics@noon.com","DarkStoredxb@noon.com","aparker@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Breach_SummaryReport'
task_id = 'BreachReport_ItemLevel'
name ='Breach_Report_Summary'
body = ["""select * from `noonbilogoi.reporting_mart.Breach_Report_Summary_Overall`""","""select * from `noonbilogoi.reporting_mart.Breach_Report_Summary_BreachCategory`"""]
attachment_sql = ["""select * from noonbilogoi.reporting_mart.Breach_Item_RawData_v2"""]
recipients = ["rjoseph@noon.com","hjha@noon.com","daily.logistics@noon.com","jcarpio@noon.com","daily_leaders@noon.com","grahman@noon.com","asethi@noon.com","paynikath@noon.com","ajainudeen@noon.com","vchellapandi@noon.com","aayash@noon.com","aparkar@noon.com","morub@noon.com","ybasha@noon.com","masghar@noon.com","mjaroli@noon.com","pbagri@noon.com","dnataraja@noon.com","sdev@noon.com","skallingal@noon.com","gschaudhary@noon.com","pchhetri@noon.com","asahu@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'PKG_MTRL'
task_id = 'PM_Movement_Pendency_AE'
name ='Packaging Material Movement Pendency AE'
attachment_sql = ["""select * from `noonbilogmis.reporting.packaging_material`where country_code = 'AE'"""]
body = ["""Select  country_code as country, FORMAT_DATETIME("%B, %Y", DATETIME (created_at)) Order_Date, count (case when  status =  'cancelled' then order_nr end) cancelled, count (case when  status =  'confirmed' then order_nr end) confirmed, count (case when  status =  'delivered' then order_nr end) delivered, count (case when  status =  'shipped' then order_nr end) shipped, From (select distinct order_nr,country_code, status,mp, created_at, CASE  when Ageing <=2 then '0_2_Days' when Ageing >2 and Ageing <=5 then '3_5_Days' when Ageing >5 then 'Above_5_Days' end as Ageing_Remark from `noonbilogmis.reporting.packaging_material` ) where country_code = 'AE' group by 1,2 order by 2 desc"""]
recipients = ["srizvi@noon.com","kssingh@noon.com","usingal@noon.com","ralexander@noon.com>","npaliwal@noon.com","joantony@noon.com","sanyamgupta@noon.com","muhahmed@noon.com","sor@noon.com","pchhetri@noon.com","nesingh@noon.com","skotla@noon.com","sujaiswal@noon.com","aiabdelsamad@noon.com","rguevarra@noon.com","rilao@noon.com","dxb-g2@noon.com","jaslam@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'PKG_MTRL'
task_id = 'PM_Movement_Pendency_SA'
name ='Packaging_Material_Movement_Pendency_SA'
attachment_sql = ["""select * from `noonbilogmis.reporting.packaging_material` where country_code = 'SA'"""]
body = [""" Select country_code as country, FORMAT_DATETIME("%B, %Y", DATETIME (created_at)) Order_Date, count (case when  status =  'cancelled' then order_nr end) cancelled, count (case when  status =  'confirmed' then order_nr end) confirmed, count (case when  status =  'delivered' then order_nr end) delivered, count (case when  status =  'shipped' then order_nr end) shipped, From (select distinct order_nr,country_code, status,mp, created_at, CASE  when Ageing <=2 then '0_2_Days' when Ageing >2 and Ageing <=5 then '3_5_Days' when Ageing >5 then 'Above_5_Days' end as Ageing_Remark from `noonbilogmis.reporting.packaging_material` ) where country_code = 'SA' group by 1,2 order by 2 desc"""]
recipients = ["Muhammad Shakeel Ahmed <muahmed@noon.com>","kssingh@noon.com","usingal@noon.com","npaliwal@noon.com","Misbah Ur Rehman <murrehman@noon.com>","First Mile KSA <fmksa@noon.com>","Sravan Kotla <skotla@noon.com>","Mohib Rub <morub@noon.com>","Subham Jaiswal <sujaiswal@noon.com>","shakhan@noon.com","ltijani@noon.com","bkumar@noon.com","jaslam@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'PKG_MTRL'
task_id = 'PM_Movement_Pendency_EG'
name ='Packaging Material Movement Pendency EG'
attachment_sql = ["""select * from `noonbilogmis.reporting.packaging_material` where country_code = 'EG'  and status = 'confirmed'"""]
body = [""" Select  country_code as country, FORMAT_DATETIME("%B, %Y", DATETIME (created_at)) Order_Date, count (case when  status =  'cancelled' then order_nr end) cancelled, count (case when  status =  'confirmed' then order_nr end) confirmed, count (case when  status =  'delivered' then order_nr end) delivered, count (case when  status =  'shipped' then order_nr end) shipped, From (select distinct order_nr,country_code, status,mp, created_at, CASE  when Ageing <=2 then '0_2_Days' when Ageing >2 and Ageing <=5 then '3_5_Days' when Ageing >5 then 'Above_5_Days' end as Ageing_Remark from `noonbilogmis.reporting.packaging_material`  ) where country_code = 'EG' group by 1,2 order by 2 desc"""]
recipients = ["Mohamed Samy Hussein <mhussein@noon.com>","kssingh@noon.com","usingal@noon.com","npaliwal@noon.com","Mrwan Hamza <mahamza@noon.com>","Abdelrahman Magdy <amagdy@noon.com>","Abdelrahman Radwan <abdhassan@noon.com>","Ahmed Fayez <ahfayez@noon.com>","Sarfraz Ahmed Raut <sraut@noon.com>","Sravan Kotla <skotla@noon.com>","Subham Jaiswal <sujaiswal@noon.com>","jaslam@noon.com","Michael Shawky <Mshawky@noon.com>"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'adm_report'
task_id = 'adm_report_ytd'
name ='Logistics Reporting ADM Report'
body = ["""SELECT * FROM `noonbilogmis.reporting.adm_first`""","""SELECT * FROM `noonbilogmis.reporting.adm_second`""","""SELECT * FROM `noonbilogmis.reporting.adm_third`""","""SELECT * FROM `noonbilogmis.reporting.adm_fourth`""","""SELECT * FROM `noonbilogmis.reporting.adm_fifth`""","""SELECT * FROM `noonbilogmis.reporting.adm_sixth`""","""SELECT * FROM `noonbilogmis.reporting.adm_seventh`"""]
recipients = ["marshad@noon.com","nitgupta@noon.com","masiuddin@noon.com","skotla@noon.com","vdubey@noon.com","logistics-reporting@noon.com","mubahmed@noon.com","kray@noon.com","hjha@noon.com","vijain@noon.com","akesargadde@noon.com","mjaroli@noon.com","hjha@noon.com","skallingal@noon.com","sujaiswal@noon.com","nadlakha@noon.com","nkumar@noon.com","lsharma@noon.com"]
sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'Incentive_mailer'
#task_id = 'DA_Login_Data'
#name ='DA_Login_Data'
#attachment_sql = ["""select * from noonbilogoi.reporting_mart.DA_Login_Data"""]
#body = ["""select * from noonbilogoi.reporting_mart.DA_Login_Data"""]
#recipients = ["rjoseph@noon.com","mohdkhan@noon.com"]
#sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Hub_DA_Report'
task_id = 'Hub_DA_Report'
name ='Hub_DA_Report'
attachment_sql = ["""select * from noonbilogmis.uae_ops.Hub_DA_Report"""]
body = ["""select * from noonbilogmis.uae_ops.Hub_DA_Report"""]
recipients = ["rjoseph@noon.com","vchellapandi@noon.com"]
sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'Incentive_mailer'
#task_id = 'Incentive_mailer'
#name ='Incentive_Mailer'
#attachment_sql = ["""select * from noonbilogmis.uae_ops.Core_Incentive""","""select * from noonbilogmis.uae_ops.Core_Incentive_DOD""","""select * from noonbilogmis.uae_ops.CU_Incentive""","""select * from noonbilogmis.uae_ops.CU_Incentive_DOD""","""select * from noonbilogmis.uae_ops.CIR_Incentive""","""select * from noonbilogmis.uae_ops.CIR_Incentive_DOD""","""select * from noonbilogmis.uae_ops.Daily_Incentive""","""select * from noonbilogmis.uae_ops.Daily_Incentive_DOD""","""select * from noonbilogmis.uae_ops.Biker_Incentive""","""select * from noonbilogmis.uae_ops.Biker_Incentive_DOD"""]
#recipients = ["rjoseph@noon.com","mjaroli@noon.com","cjoshi@noon.com","pchhetri@noon.com","vpatel@noon.com","smadiye@noon.com"]
#sender = 'logistics-reporting@noon.com'

# [[email]]
# dag_id = 'DRT_SHP_MAILER'
# task_id = 'pending_rto_drt_shp_atchmnt'
# name ='Noon_Direct_Ship_RTO_Pending'
# body = ["""select * from `noonbilogmis.reporting.drt_shp_odr_type_wise`""","""select * from `noonbilogmis.reporting.drt_shp_fs_wise`"""]
# attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.drt_shp_atchmnt`"""]
# recipients = ["skotla@noon.com","sujaiswal@noon.com","kvasu@noon.com","usingal@noon.com","stocktrasfer_ksa@noon.com","srizvi@noon.com","logistics-reporting@noon.com","dgera@noon.com","nitgupta@noon.com","npaliwal@noon.com","morub@noon.com","marshad@noon.com","pchhetri@noon.com","vijain@noon.com","hjha@noon.com","pdhakad@noon.com","Fulfillment.sa@noon.com","bkumar@noon.com","shkaushik@noon.com","jaslam@noon.com","fmksa@noon.com","bdhanapaul@noon.com","lalexander@noon.com","vgupta@noon.com","gngugi@noon.com","aiabdelsamad@noon.com","sor@noon.com","mhussein@noon.com","murrehman@noon.com","ralexander@noon.com","nseth@noon.com"]
# sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Incentive_mailer'
task_id = 'CrossUtilization_Report_Test'
name ='CrossUtilization_Report'
body = ["""select * from noonbilogoi.reporting_mart.CU_Report"""]
recipients = ["rjoseph@noon.com","pbagri@noon.com","kjadala@noon.com","sdev@noon.com","paynikath@noon.com","pchhetri@noon.com","akheruwala@noon.com","dnataraja@noon.com","ajainudeen@noon.com","skallingal@noon.com","mjaroli@noon.com","hjha@noon.com","akesargadde@noon.com","kray@noon.com","marshad@noon.com","morub@noon.com","aparkar@noon.com"]
sender = 'logistics-reporting@noon.com'

# [[email]]
# dag_id = 'Pending_add'
# task_id = 'directship_pending'
# name = 'Pending addr shipments - DS'
# attachment_sql = ["""select distinct timestamp_diff(current_timestamp() ,creq.created_at,day) as Order_Ageing, timestamp_diff(current_timestamp() ,itm.created_at,day) as AWB_Ageing, timestamp_diff(current_timestamp() ,rto_creation,day) as RTO_Ageing, timestamp_diff(current_timestamp() ,itms.updated_at,day) as Update_Ageing, case  when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code)='deliveryHub Locationtransiting' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code)='deliveryPackage Grouptransiting' then 'Pending Delivery' when loc_type.name='Pending Address' and InBound_ManifestNr is not null then 'Pending Pickup Manifested' when loc_type.name='Pending Address' and InBound_ManifestNr is null then 'Pending Pickup Not Manifested' when concat(clt.code,loc_type.name)='deliveryUser' and bpg.pge_group is null and first_attempt_ts is null then 'Picked Up' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingProcessing' then 'Out for Delivery' when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is null and bpg.pge_group is null then "Pending to Connect" when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is not null and bpg.pge_group is not null then "Connected to LM" when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryHub TransfertransitingShipped' then 'HT In Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingShipped' then 'Pending Pickup Manifested' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryService Point Locker LocationtransitingShipped' then 'Pending at Service Point' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingShipped' then 'Out for Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name)='rtoHub Location' then 'RTO Pending at Hub' when concat(clt.code,loc_type.name)='rtoHub Transfer' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoPackage Group' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoUser'  then 'RTO With User' else 'Check' end as Final_Status, case when  loc_type.name='Package Group' and d_package_group is not null then dpg_org_hub end PG_Origin , case when  loc_type.name='Package Group' and d_package_group is not null then dpg_dest_hub end PG_Destination, case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_org_hub end Delivery_HT_Origin , case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_dst_hub end Delivery_HT_Destination, w.code as seller_warehouse, w.id_partner_owner, w.name as Partner_Name, pwh.display_name_en as Seller_Display_Name, c.name_en as Seller_City, mp.name_en as Order_Type, country.code as Destination_Country, h.code as Hub, RTO_Hub,  hs.code as Hub_Sector, hss.code as Hub_Sub_Sector, c.country_code as Country, rto_creation, soi.item_nr , soistatus.name_en as Item_Status, sb.awb_nr as ship_box, sois.awb_nr as awb_nr, InBound_ManifestNr, OutBound_ManifestNr, loc_type.name as Loc_Type, client_pkg_ref, client_ref, s.code as Source_Status , itmstts.code as awb_status, clt.code as Creq_Leg_type, REPLACE(coalesce(hl.code,u.username, pgroup,ht.hub_transfer_nr, m.manifest_nr,mx.manifest_nr, spc.code,spl.code,tote.awb_nr, pgroup_com, spcl.code,spll.code,adx.address_uid),'@ops.idp.noon.team','')  as current_location, itm.created_at as Item_Creation, itms.updated_at as Item_Updated, creq.created_at Order_Creation, if(country.code='ae',timestamp_add(exported.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(exported.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(exported.created_at, interval 2 hour),exported.created_at))) as exported_at, date(soi.estimated_delivery_at) as edd, if(country.code='ae',timestamp_add(inbound_manifest.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(inbound_manifest.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(inbound_manifest.created_at, interval 2 hour),inbound_manifest.created_at))) as  manifested_at, if(country.code='ae',timestamp_add(session_field_item.first_attempt_ts, interval 4 hour) ,if(country.code='sa',timestamp_add(session_field_item.first_attempt_ts, interval 3 hour) ,if(country.code='eg',timestamp_add(session_field_item.first_attempt_ts, interval 2  hour),session_field_item.first_attempt_ts))) as first_attempt_ts from `noonltddwh.sales.sales_order_item` soi LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois  on soi.id_sales_order_item_shipment=sois.id_sales_order_item_shipment LEFT JOIN `noonltddwh.sales.sales_order` so on so.id_sales_order=soi.id_sales_order LEFT JOIN (select * from  `noonltddwh.sales.sales_order_item_status_history` where id_sales_order_item_status=4 ) exported using (id_sales_order_item) LEFT JOIN noonltddwh.partner.partner_warehouse partner_warehouse on soi.id_partner_warehouse=partner_warehouse.id_partner_warehouse LEFT JOIN noonltddwh.ref.partner pwh ON pwh.id_partner=partner_warehouse.id_partner_owner LEFT JOIN `noonltddwh.ref.mp` mp on mp.id_mp =so.id_mp LEFT JOIN `noonltddwh.ref.sales_order_item_status` soistatus on soistatus.id_sales_order_item_status =soi.id_sales_order_item_status  LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller LEFT JOIN noonltddwh.xms_sourcing.warehouse w on wl.id_warehouse = w.id_warehouse LEFT JOIN noonltddwh.xms_sourcing.status s on sb.id_status = s.id_status LEFT JOIN noonltddwh.partner.partner_warehouse pw on w.code=pw.code LEFT JOIN noonltddwh.ref.city c on pw.id_city=c.id_city LEFT JOIN noonltddwh.lms.item itm on itm.awb_nr=sois.awb_nr LEFT JOIN (SELECT id_item,manifest_nr as OutBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=1)  out_manifest_item  USING (id_item) LEFT JOIN (SELECT id_item,manifest_nr as InBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=0)  in_manifest_item  USING (id_item) left join (select distinct id_item, manifest.* from  `noonltddwh.lms.manifest_item` as manifest_item left join  `noonltddwh.lms.manifest` as manifest using (id_manifest) where id_manifest_type in (3,6)) as inbound_manifest using (id_item) left join (select id_item, min(created_at) as first_attempt_ts  from  `noonltddwh.lms.item_event` as item_event  where  replace(json_extract_scalar(item_event.data,'$.event_code'),'','')='shipment_ofd' group by 1) as session_field_item using (id_item) LEFT JOIN noonltddwh.lms.item_type itmt USING (id_item_type) LEFT JOIN noonltddwh.lms.item_state itms USING (id_item) LEFT JOIN `noonltddwh.lms.loc_type` loc_type on itms.id_loc_type = loc_type.id_loc_type LEFT JOIN `noonltddwh.lms.item_pkg` ipg on itm.id_item =ipg.id_item  LEFT JOIN noonltddwh.lms.status itmstts on itms.id_status = itmstts.id_status LEFT JOIN noonltddwh.lms.client_pkg_ref cpr on sois.awb_nr=cpr.awb_nr LEFT JOIN `noonltddwh.lms.creq_leg` creq_leg on creq_leg.id_creq_leg=ipg.id_creq_leg LEFT JOIN `noonltddwh.lms.creq` creq on creq.id_creq=creq_leg.id_creq LEFT JOIN (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type =3 ) cleg on cleg.id_creq=cpr.id_creq LEFT JOIN (select awb_nr , cleg.created_at as rto_creation from `noonltddwh.lms.item`  left join `noonltddwh.lms.item_pkg` using (id_item) left join `noonltddwh.lms.creq_leg` cleg using (id_creq_leg) where id_creq_leg_type =4) rtoc on rtoc.awb_nr=sois.awb_nr LEFT JOIN (select id_creq,h.code as RTO_Hub from `noonltddwh.lms.creq_leg` cleg LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub where id_creq_leg_type =4 ) clegr on clegr.id_creq=cpr.id_creq LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub_subsector` hss on cleg.id_hub_subsector = hss.id_hub_subsector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub LEFT JOIN `noonltddwh.lms.hub_airport` ha using (id_hub_airport) LEFT JOIN `noonltddwh.lms.country` country on country.id_country=ha.id_country LEFT JOIN `noonltddwh.lms.country_zone` cz on cz.id_country_zone=cleg.id_country_zone   LEFT JOIN `noonltddwh.lms.creq_leg_type`  clt on creq_leg.id_creq_leg_type =clt.id_creq_leg_type  LEFT JOIN `noonltddwh.lms.hub_location` hl  on (itms.id_loc_type,itms.loc_id) = (1,id_hub_location) LEFT JOIN `noonltddwh.lms.user` u on (itms.id_loc_type,itms.loc_id) = (2,u.id_user) LEFT JOIN (select id_item, awb_nr as pgroup from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ip on  (itms.id_loc_type,itms.loc_id) = (3,ip.id_item) LEFT JOIN `noonltddwh.lms.hub_transfer` ht on  (itms.id_loc_type,itms.loc_id) = (4,id_hub_transfer) LEFT JOIN `noonltddwh.lms.manifest` m on  (itms.id_loc_type,itms.loc_id) = (5,m.id_manifest) LEFT JOIN `noonltddwh.lms.manifest` mx on (itms.id_loc_type,itms.loc_id) = (6,mx.id_manifest) LEFT JOIN `noonltddwh.lms.service_point_counter` spc on  (itms.id_loc_type,itms.loc_id) = (8,id_service_point_counter) LEFT JOIN `noonltddwh.lms.address` adx on  (itms.id_loc_type,itms.loc_id) = (9,adx.id_address) LEFT JOIN (select id_item, awb_nr as pgroup_com from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ipc on (itms.id_loc_type,itms.loc_id) = (11,ipc.id_item) LEFT JOIN `noonltddwh.lms.service_point_locker` spl on (itms.id_loc_type,itms.loc_id) = (12,id_service_point_locker) LEFT JOIN `noonltddwh.lms.service_point_counter_location` spcl ON (itms.id_loc_type,itms.loc_id)=(13,spcl.id_service_point_counter_location) LEFT JOIN `noonltddwh.lms.service_point_locker_location` spll ON (itms.id_loc_type,itms.loc_id)= (17,spll.id_service_point_locker_location) LEFT JOIN `noonltddwh.lms.item` tote ON (itms.id_loc_type,itms.loc_id)=(16,tote.id_item) LEFT JOIN ( SELECT DISTINCT item.awb_nr, hub_transfer.hub_transfer_nr, org_hub.code dht_org_hub, dst_hub.code dht_dst_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) LEFT JOIN noonltddwh.lms.hub org_hub on hub_transfer.id_hub_src = org_hub.id_hub LEFT JOIN noonltddwh.lms.hub dst_hub on hub_transfer.id_hub_dst = dst_hub.id_hub WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as dht on (dht.awb_nr,dht.hub_transfer_nr)= (sois.awb_nr,ht.hub_transfer_nr)  LEFT JOIN (SELECT DISTINCT item.awb_nr, pitem.awb_nr d_package_group, org_hub.code as dpg_org_hub, Hub_Code as dpg_dest_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id)  LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) LEFT JOIN ( SELECT id_item, MIN(id_item_state_history) as id_item_state_history FROM noonltddwh.lms.item_state_history ish LEFT JOIN noonltddwh.lms.item it USING (id_item) WHERE id_loc_type=1 GROUP BY 1 ) orgloc ON orgloc.id_item=pitem.id_item LEFT JOIN noonltddwh.lms.item_state_history orgish USING (id_item_state_history) LEFT JOIN noonltddwh.lms.hub_location orghl ON (orgish.id_loc_type, orgish.loc_id) = (1, orghl.id_hub_location) LEFT JOIN noonltddwh.lms.hub org_hub ON (orghl.id_hub=org_hub.id_hub) LEFT JOIN (SELECT awb_nr,loc_type.code,case when hub.code is null then hub_sector_hub.code else hub.code end as Hub_Code FROM noonltddwh.lms.item_pgroup item_pgroup LEFT JOIN noonltddwh.lms.item item USING(id_item) LEFT JOIN noonltddwh.lms.loc_type loc_type using(id_loc_type) LEFT JOIN noonltddwh.lms.hub hub ON (loc_type.code,item_pgroup.loc_id) = ('hub',hub.id_hub) LEFT JOIN noonltddwh.lms.hub_sector hub_sector ON (loc_type.code,item_pgroup.loc_id) = ('hub_sector',hub_sector.id_hub_sector) LEFT JOIN noonltddwh.lms.hub hub_sector_hub ON hub_sector_hub.id_hub = hub_sector.id_hub ) pgroup_data on pgroup_data.awb_nr = pitem.awb_nr  LEFT JOIN noonltddwh.lms.item_state its ON its.id_item=item.id_item WHERE item.id_item_type = 1 AND cs.id_loc_type in (3,11)) dpg on (dpg.awb_nr,d_package_group) = (sois.awb_nr ,pgroup) LEFT JOIN (SELECT DISTINCT item.awb_nr,pitem.awb_nr pge_group,FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) where pitem.awb_nr is not null ) bpg on bpg.awb_nr = sois.awb_nr  LEFT JOIN (SELECT DISTINCT item.awb_nr,hub_transfer.hub_transfer_nr as htransfer, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item  LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as ddht on ddht.awb_nr= sois.awb_nr  where wl.id_warehouse_lane_type=3 and itm.id_item_type =1 and so.id_cart_type =1 and soi.id_invoice_section =1  and pw.id_warehouse_type <>5 and loc_type.name='Pending Address' """]
# body = ["""SELECT Country ,Final_Status ,count(distinct case when AWB_Ageing between 0 and 2 then awb_nr end) less_then_2_days ,count(distinct case when AWB_Ageing between 2 and 5 then awb_nr end) less_then_5_days ,count(distinct case when AWB_Ageing > 5 then awb_nr end) Above_5_days FROM (select distinct timestamp_diff(current_timestamp() ,creq.created_at,day) as Order_Ageing, timestamp_diff(current_timestamp() ,itm.created_at,day) as AWB_Ageing, timestamp_diff(current_timestamp() ,rto_creation,day) as RTO_Ageing, timestamp_diff(current_timestamp() ,itms.updated_at,day) as Update_Ageing, case when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code)='deliveryHub Locationtransiting' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code)='deliveryPackage Grouptransiting' then 'Pending Delivery' when loc_type.name='Pending Address' and InBound_ManifestNr is not null then 'Pending Pickup Manifested' when loc_type.name='Pending Address' and InBound_ManifestNr is null then 'Pending Pickup Not Manifested' when concat(clt.code,loc_type.name)='deliveryUser' and bpg.pge_group is null and first_attempt_ts is null then 'Picked Up' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingProcessing' then 'Out for Delivery' when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is null and bpg.pge_group is null then "Pending to Connect" when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is not null and bpg.pge_group is not null then "Connected to LM" when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryHub TransfertransitingShipped' then 'HT In Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingShipped' then 'Pending Pickup Manifested' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryService Point Locker LocationtransitingShipped' then 'Pending at Service Point' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingShipped' then 'Out for Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name)='rtoHub Location' then 'RTO Pending at Hub' when concat(clt.code,loc_type.name)='rtoHub Transfer' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoPackage Group' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoUser'  then 'RTO With User' else 'Check' end as Final_Status, case when  loc_type.name='Package Group' and d_package_group is not null then dpg_org_hub end PG_Origin , case when  loc_type.name='Package Group' and d_package_group is not null then dpg_dest_hub end PG_Destination, case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_org_hub end Delivery_HT_Origin , case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_dst_hub end Delivery_HT_Destination, w.code as seller_warehouse, w.id_partner_owner, w.name as Partner_Name, pwh.display_name_en as Seller_Display_Name, c.name_en as Seller_City, mp.name_en as Order_Type, country.code as Destination_Country, h.code as Hub, RTO_Hub,  hs.code as Hub_Sector, hss.code as Hub_Sub_Sector, c.country_code as Country, rto_creation, soi.item_nr , soistatus.name_en as Item_Status, sb.awb_nr as ship_box, sois.awb_nr as awb_nr, InBound_ManifestNr, OutBound_ManifestNr, loc_type.name as Loc_Type, client_pkg_ref, client_ref, s.code as Source_Status , itmstts.code as awb_status, clt.code as Creq_Leg_type, REPLACE(coalesce(hl.code,u.username, pgroup,ht.hub_transfer_nr, m.manifest_nr,mx.manifest_nr, spc.code,spl.code,tote.awb_nr, pgroup_com, spcl.code,spll.code,adx.address_uid),'@ops.idp.noon.team','')  as current_location, itm.created_at as Item_Creation, itms.updated_at as Item_Updated, creq.created_at Order_Creation, if(country.code='ae',timestamp_add(exported.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(exported.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(exported.created_at, interval 2 hour),exported.created_at))) as exported_at, date(soi.estimated_delivery_at) as edd, if(country.code='ae',timestamp_add(inbound_manifest.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(inbound_manifest.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(inbound_manifest.created_at, interval 2 hour),inbound_manifest.created_at))) as  manifested_at, if(country.code='ae',timestamp_add(session_field_item.first_attempt_ts, interval 4 hour) ,if(country.code='sa',timestamp_add(session_field_item.first_attempt_ts, interval 3 hour) ,if(country.code='eg',timestamp_add(session_field_item.first_attempt_ts, interval 2  hour),session_field_item.first_attempt_ts))) as first_attempt_ts from `noonltddwh.sales.sales_order_item` soi LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois  on soi.id_sales_order_item_shipment=sois.id_sales_order_item_shipment LEFT JOIN `noonltddwh.sales.sales_order` so on so.id_sales_order=soi.id_sales_order LEFT JOIN (select * from  `noonltddwh.sales.sales_order_item_status_history` where id_sales_order_item_status=4 ) exported using (id_sales_order_item) LEFT JOIN noonltddwh.partner.partner_warehouse partner_warehouse on soi.id_partner_warehouse=partner_warehouse.id_partner_warehouse LEFT JOIN noonltddwh.ref.partner pwh ON pwh.id_partner=partner_warehouse.id_partner_owner LEFT JOIN `noonltddwh.ref.mp` mp on mp.id_mp =so.id_mp LEFT JOIN `noonltddwh.ref.sales_order_item_status` soistatus on soistatus.id_sales_order_item_status =soi.id_sales_order_item_status  LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller LEFT JOIN noonltddwh.xms_sourcing.warehouse w on wl.id_warehouse = w.id_warehouse LEFT JOIN noonltddwh.xms_sourcing.status s on sb.id_status = s.id_status LEFT JOIN noonltddwh.partner.partner_warehouse pw on w.code=pw.code LEFT JOIN noonltddwh.ref.city c on pw.id_city=c.id_city LEFT JOIN noonltddwh.lms.item itm on itm.awb_nr=sois.awb_nr LEFT JOIN (SELECT id_item,manifest_nr as OutBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=1)  out_manifest_item  USING (id_item) LEFT JOIN (SELECT id_item,manifest_nr as InBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=0)  in_manifest_item  USING (id_item) left join (select distinct id_item, manifest.* from  `noonltddwh.lms.manifest_item` as manifest_item left join  `noonltddwh.lms.manifest` as manifest using (id_manifest) where id_manifest_type in (3,6)) as inbound_manifest using (id_item) left join (select id_item, min(created_at) as first_attempt_ts  from  `noonltddwh.lms.item_event` as item_event  where  replace(json_extract_scalar(item_event.data,'$.event_code'),'','')='shipment_ofd' group by 1) as session_field_item using (id_item) LEFT JOIN noonltddwh.lms.item_type itmt USING (id_item_type) LEFT JOIN noonltddwh.lms.item_state itms USING (id_item) LEFT JOIN `noonltddwh.lms.loc_type` loc_type on itms.id_loc_type = loc_type.id_loc_type LEFT JOIN `noonltddwh.lms.item_pkg` ipg on itm.id_item =ipg.id_item  LEFT JOIN noonltddwh.lms.status itmstts on itms.id_status = itmstts.id_status LEFT JOIN noonltddwh.lms.client_pkg_ref cpr on sois.awb_nr=cpr.awb_nr LEFT JOIN `noonltddwh.lms.creq_leg` creq_leg on creq_leg.id_creq_leg=ipg.id_creq_leg LEFT JOIN `noonltddwh.lms.creq` creq on creq.id_creq=creq_leg.id_creq LEFT JOIN (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type =3 ) cleg on cleg.id_creq=cpr.id_creq LEFT JOIN (select awb_nr , cleg.created_at as rto_creation from `noonltddwh.lms.item`  left join `noonltddwh.lms.item_pkg` using (id_item) left join `noonltddwh.lms.creq_leg` cleg using (id_creq_leg) where id_creq_leg_type =4) rtoc on rtoc.awb_nr=sois.awb_nr LEFT JOIN (select id_creq,h.code as RTO_Hub from `noonltddwh.lms.creq_leg` cleg LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub where id_creq_leg_type =4 ) clegr on clegr.id_creq=cpr.id_creq LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub_subsector` hss on cleg.id_hub_subsector = hss.id_hub_subsector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub LEFT JOIN `noonltddwh.lms.hub_airport` ha using (id_hub_airport) LEFT JOIN `noonltddwh.lms.country` country on country.id_country=ha.id_country LEFT JOIN `noonltddwh.lms.country_zone` cz on cz.id_country_zone=cleg.id_country_zone   LEFT JOIN `noonltddwh.lms.creq_leg_type`  clt on creq_leg.id_creq_leg_type =clt.id_creq_leg_type  LEFT JOIN `noonltddwh.lms.hub_location` hl  on (itms.id_loc_type,itms.loc_id) = (1,id_hub_location) LEFT JOIN `noonltddwh.lms.user` u on (itms.id_loc_type,itms.loc_id) = (2,u.id_user) LEFT JOIN (select id_item, awb_nr as pgroup from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ip on  (itms.id_loc_type,itms.loc_id) = (3,ip.id_item) LEFT JOIN `noonltddwh.lms.hub_transfer` ht on  (itms.id_loc_type,itms.loc_id) = (4,id_hub_transfer) LEFT JOIN `noonltddwh.lms.manifest` m on  (itms.id_loc_type,itms.loc_id) = (5,m.id_manifest) LEFT JOIN `noonltddwh.lms.manifest` mx on (itms.id_loc_type,itms.loc_id) = (6,mx.id_manifest) LEFT JOIN `noonltddwh.lms.service_point_counter` spc on  (itms.id_loc_type,itms.loc_id) = (8,id_service_point_counter) LEFT JOIN `noonltddwh.lms.address` adx on  (itms.id_loc_type,itms.loc_id) = (9,adx.id_address) LEFT JOIN (select id_item, awb_nr as pgroup_com from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ipc on (itms.id_loc_type,itms.loc_id) = (11,ipc.id_item) LEFT JOIN `noonltddwh.lms.service_point_locker` spl on (itms.id_loc_type,itms.loc_id) = (12,id_service_point_locker) LEFT JOIN `noonltddwh.lms.service_point_counter_location` spcl ON (itms.id_loc_type,itms.loc_id)=(13,spcl.id_service_point_counter_location) LEFT JOIN `noonltddwh.lms.service_point_locker_location` spll ON (itms.id_loc_type,itms.loc_id)= (17,spll.id_service_point_locker_location) LEFT JOIN `noonltddwh.lms.item` tote ON (itms.id_loc_type,itms.loc_id)=(16,tote.id_item) LEFT JOIN ( SELECT DISTINCT item.awb_nr, hub_transfer.hub_transfer_nr, org_hub.code dht_org_hub, dst_hub.code dht_dst_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) LEFT JOIN noonltddwh.lms.hub org_hub on hub_transfer.id_hub_src = org_hub.id_hub LEFT JOIN noonltddwh.lms.hub dst_hub on hub_transfer.id_hub_dst = dst_hub.id_hub WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as dht on (dht.awb_nr,dht.hub_transfer_nr)= (sois.awb_nr,ht.hub_transfer_nr)  LEFT JOIN (SELECT DISTINCT item.awb_nr, pitem.awb_nr d_package_group, org_hub.code as dpg_org_hub, Hub_Code as dpg_dest_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id)  LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) LEFT JOIN ( SELECT id_item, MIN(id_item_state_history) as id_item_state_history FROM noonltddwh.lms.item_state_history ish LEFT JOIN noonltddwh.lms.item it USING (id_item) WHERE id_loc_type=1 GROUP BY 1 ) orgloc ON orgloc.id_item=pitem.id_item LEFT JOIN noonltddwh.lms.item_state_history orgish USING (id_item_state_history) LEFT JOIN noonltddwh.lms.hub_location orghl ON (orgish.id_loc_type, orgish.loc_id) = (1, orghl.id_hub_location) LEFT JOIN noonltddwh.lms.hub org_hub ON (orghl.id_hub=org_hub.id_hub) LEFT JOIN (SELECT awb_nr,loc_type.code,case when hub.code is null then hub_sector_hub.code else hub.code end as Hub_Code FROM noonltddwh.lms.item_pgroup item_pgroup LEFT JOIN noonltddwh.lms.item item USING(id_item) LEFT JOIN noonltddwh.lms.loc_type loc_type using(id_loc_type) LEFT JOIN noonltddwh.lms.hub hub ON (loc_type.code,item_pgroup.loc_id) = ('hub',hub.id_hub) LEFT JOIN noonltddwh.lms.hub_sector hub_sector ON (loc_type.code,item_pgroup.loc_id) = ('hub_sector',hub_sector.id_hub_sector) LEFT JOIN noonltddwh.lms.hub hub_sector_hub ON hub_sector_hub.id_hub = hub_sector.id_hub ) pgroup_data on pgroup_data.awb_nr = pitem.awb_nr  LEFT JOIN noonltddwh.lms.item_state its ON its.id_item=item.id_item WHERE item.id_item_type = 1 AND cs.id_loc_type in (3,11)) dpg on (dpg.awb_nr,d_package_group) = (sois.awb_nr ,pgroup) LEFT JOIN (SELECT DISTINCT item.awb_nr,pitem.awb_nr pge_group,FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) where pitem.awb_nr is not null ) bpg on bpg.awb_nr = sois.awb_nr  LEFT JOIN (SELECT DISTINCT item.awb_nr,hub_transfer.hub_transfer_nr as htransfer, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item  LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as ddht on ddht.awb_nr= sois.awb_nr  where wl.id_warehouse_lane_type=3 and itm.id_item_type =1 and so.id_cart_type =1 and soi.id_invoice_section =1  and pw.id_warehouse_type <>5 and loc_type.name='Pending Address' ) WHERE Order_Type <> 'daily' and Final_Status <> 'Pending Pickup Manifested'  GROUP BY 1,2 order by 1,2 """]
# recipients = ["mshrideep@noon.com","bkumar@noon.com","meaziz@noon.com","usingal@noon.com","dgera@noon.com","npaliwal@noon.com","stawfek@noon.com","logistics-reporting@noon.com","avv@noon.com","bmondal@noon.com","ambassiouny@noon.com","shakhan@noon.com","ltijani@noon.com","meswaramurthy@noon.com","klogarta@noon.com","bshah@noon.com","vijain@noon.com","skotla@noon.com","sujaiswal@noon.com","tali@noon.com"]
# sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Pending_address_rtv'
task_id = 'directship_pending_add'
name = 'Pending addr shipments - DirectShip'
attachment_sql = ["""select distinct timestamp_diff(current_timestamp() ,creq.created_at,day) as Order_Ageing, timestamp_diff(current_timestamp() ,itm.created_at,day) as AWB_Ageing, timestamp_diff(current_timestamp() ,rto_creation,day) as RTO_Ageing, timestamp_diff(current_timestamp() ,itms.updated_at,day) as Update_Ageing, case  when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code)='deliveryHub Locationtransiting' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code)='deliveryPackage Grouptransiting' then 'Pending Delivery' when loc_type.name='Pending Address' and InBound_ManifestNr is not null then 'Pending Pickup Manifested' when loc_type.name='Pending Address' and InBound_ManifestNr is null then 'Pending Pickup Not Manifested' when concat(clt.code,loc_type.name)='deliveryUser' and bpg.pge_group is null and first_attempt_ts is null then 'Picked Up' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingProcessing' then 'Out for Delivery' when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is null and bpg.pge_group is null then "Pending to Connect" when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is not null and bpg.pge_group is not null then "Connected to LM" when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryHub TransfertransitingShipped' then 'HT In Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingShipped' then 'Pending Pickup Manifested' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryService Point Locker LocationtransitingShipped' then 'Pending at Service Point' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingShipped' then 'Out for Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name)='rtoHub Location' then 'RTO Pending at Hub' when concat(clt.code,loc_type.name)='rtoHub Transfer' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoPackage Group' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoUser'  then 'RTO With User' else 'Check' end as Final_Status, case when  loc_type.name='Package Group' and d_package_group is not null then dpg_org_hub end PG_Origin , case when  loc_type.name='Package Group' and d_package_group is not null then dpg_dest_hub end PG_Destination, case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_org_hub end Delivery_HT_Origin , case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_dst_hub end Delivery_HT_Destination, w.code as seller_warehouse, w.id_partner_owner, w.name as Partner_Name, pwh.display_name_en as Seller_Display_Name, c.name_en as Seller_City, mp.name_en as Order_Type, country.code as Destination_Country, h.code as Hub, RTO_Hub,  hs.code as Hub_Sector, hss.code as Hub_Sub_Sector, c.country_code as Country, rto_creation, soi.item_nr , soistatus.name_en as Item_Status, sb.awb_nr as ship_box, sois.awb_nr as awb_nr, InBound_ManifestNr, OutBound_ManifestNr, loc_type.name as Loc_Type, client_pkg_ref, client_ref, s.code as Source_Status , itmstts.code as awb_status, clt.code as Creq_Leg_type, REPLACE(coalesce(hl.code,u.username, pgroup,ht.hub_transfer_nr, m.manifest_nr,mx.manifest_nr, spc.code,spl.code,tote.awb_nr, pgroup_com, spcl.code,spll.code,adx.address_uid),'@ops.idp.noon.team','')  as current_location, itm.created_at as Item_Creation, itms.updated_at as Item_Updated, creq.created_at Order_Creation, if(country.code='ae',timestamp_add(exported.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(exported.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(exported.created_at, interval 2 hour),exported.created_at))) as exported_at, date(soi.estimated_delivery_at) as edd, if(country.code='ae',timestamp_add(inbound_manifest.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(inbound_manifest.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(inbound_manifest.created_at, interval 2 hour),inbound_manifest.created_at))) as  manifested_at, if(country.code='ae',timestamp_add(session_field_item.first_attempt_ts, interval 4 hour) ,if(country.code='sa',timestamp_add(session_field_item.first_attempt_ts, interval 3 hour) ,if(country.code='eg',timestamp_add(session_field_item.first_attempt_ts, interval 2  hour),session_field_item.first_attempt_ts))) as first_attempt_ts from `noonltddwh.sales.sales_order_item` soi LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois  on soi.id_sales_order_item_shipment=sois.id_sales_order_item_shipment LEFT JOIN `noonltddwh.sales.sales_order` so on so.id_sales_order=soi.id_sales_order LEFT JOIN (select * from  `noonltddwh.sales.sales_order_item_status_history` where id_sales_order_item_status=4 ) exported using (id_sales_order_item) LEFT JOIN noonltddwh.partner.partner_warehouse partner_warehouse on soi.id_partner_warehouse=partner_warehouse.id_partner_warehouse LEFT JOIN noonltddwh.ref.partner pwh ON pwh.id_partner=partner_warehouse.id_partner_owner LEFT JOIN `noonltddwh.ref.mp` mp on mp.id_mp =so.id_mp LEFT JOIN `noonltddwh.ref.sales_order_item_status` soistatus on soistatus.id_sales_order_item_status =soi.id_sales_order_item_status  LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller LEFT JOIN noonltddwh.xms_sourcing.warehouse w on wl.id_warehouse = w.id_warehouse LEFT JOIN noonltddwh.xms_sourcing.status s on sb.id_status = s.id_status LEFT JOIN noonltddwh.partner.partner_warehouse pw on w.code=pw.code LEFT JOIN noonltddwh.ref.city c on pw.id_city=c.id_city LEFT JOIN noonltddwh.lms.item itm on itm.awb_nr=sois.awb_nr LEFT JOIN (SELECT id_item,manifest_nr as OutBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=1)  out_manifest_item  USING (id_item) LEFT JOIN (SELECT id_item,manifest_nr as InBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=0)  in_manifest_item  USING (id_item) left join (select distinct id_item, manifest.* from  `noonltddwh.lms.manifest_item` as manifest_item left join  `noonltddwh.lms.manifest` as manifest using (id_manifest) where id_manifest_type in (3,6)) as inbound_manifest using (id_item) left join (select id_item, min(created_at) as first_attempt_ts  from  `noonltddwh.lms.item_event` as item_event  where  replace(json_extract_scalar(item_event.data,'$.event_code'),'','')='shipment_ofd' group by 1) as session_field_item using (id_item) LEFT JOIN noonltddwh.lms.item_type itmt USING (id_item_type) LEFT JOIN noonltddwh.lms.item_state itms USING (id_item) LEFT JOIN `noonltddwh.lms.loc_type` loc_type on itms.id_loc_type = loc_type.id_loc_type LEFT JOIN `noonltddwh.lms.item_pkg` ipg on itm.id_item =ipg.id_item  LEFT JOIN noonltddwh.lms.status itmstts on itms.id_status = itmstts.id_status LEFT JOIN noonltddwh.lms.client_pkg_ref cpr on sois.awb_nr=cpr.awb_nr LEFT JOIN `noonltddwh.lms.creq_leg` creq_leg on creq_leg.id_creq_leg=ipg.id_creq_leg LEFT JOIN `noonltddwh.lms.creq` creq on creq.id_creq=creq_leg.id_creq LEFT JOIN (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type =3 ) cleg on cleg.id_creq=cpr.id_creq LEFT JOIN (select awb_nr , cleg.created_at as rto_creation from `noonltddwh.lms.item`  left join `noonltddwh.lms.item_pkg` using (id_item) left join `noonltddwh.lms.creq_leg` cleg using (id_creq_leg) where id_creq_leg_type =4) rtoc on rtoc.awb_nr=sois.awb_nr LEFT JOIN (select id_creq,h.code as RTO_Hub from `noonltddwh.lms.creq_leg` cleg LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub where id_creq_leg_type =4 ) clegr on clegr.id_creq=cpr.id_creq LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub_subsector` hss on cleg.id_hub_subsector = hss.id_hub_subsector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub LEFT JOIN `noonltddwh.lms.hub_airport` ha using (id_hub_airport) LEFT JOIN `noonltddwh.lms.country` country on country.id_country=ha.id_country LEFT JOIN `noonltddwh.lms.country_zone` cz on cz.id_country_zone=cleg.id_country_zone   LEFT JOIN `noonltddwh.lms.creq_leg_type`  clt on creq_leg.id_creq_leg_type =clt.id_creq_leg_type  LEFT JOIN `noonltddwh.lms.hub_location` hl  on (itms.id_loc_type,itms.loc_id) = (1,id_hub_location) LEFT JOIN `noonltddwh.lms.user` u on (itms.id_loc_type,itms.loc_id) = (2,u.id_user) LEFT JOIN (select id_item, awb_nr as pgroup from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ip on  (itms.id_loc_type,itms.loc_id) = (3,ip.id_item) LEFT JOIN `noonltddwh.lms.hub_transfer` ht on  (itms.id_loc_type,itms.loc_id) = (4,id_hub_transfer) LEFT JOIN `noonltddwh.lms.manifest` m on  (itms.id_loc_type,itms.loc_id) = (5,m.id_manifest) LEFT JOIN `noonltddwh.lms.manifest` mx on (itms.id_loc_type,itms.loc_id) = (6,mx.id_manifest) LEFT JOIN `noonltddwh.lms.service_point_counter` spc on  (itms.id_loc_type,itms.loc_id) = (8,id_service_point_counter) LEFT JOIN `noonltddwh.lms.address` adx on  (itms.id_loc_type,itms.loc_id) = (9,adx.id_address) LEFT JOIN (select id_item, awb_nr as pgroup_com from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ipc on (itms.id_loc_type,itms.loc_id) = (11,ipc.id_item) LEFT JOIN `noonltddwh.lms.service_point_locker` spl on (itms.id_loc_type,itms.loc_id) = (12,id_service_point_locker) LEFT JOIN `noonltddwh.lms.service_point_counter_location` spcl ON (itms.id_loc_type,itms.loc_id)=(13,spcl.id_service_point_counter_location) LEFT JOIN `noonltddwh.lms.service_point_locker_location` spll ON (itms.id_loc_type,itms.loc_id)= (17,spll.id_service_point_locker_location) LEFT JOIN `noonltddwh.lms.item` tote ON (itms.id_loc_type,itms.loc_id)=(16,tote.id_item) LEFT JOIN ( SELECT DISTINCT item.awb_nr, hub_transfer.hub_transfer_nr, org_hub.code dht_org_hub, dst_hub.code dht_dst_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) LEFT JOIN noonltddwh.lms.hub org_hub on hub_transfer.id_hub_src = org_hub.id_hub LEFT JOIN noonltddwh.lms.hub dst_hub on hub_transfer.id_hub_dst = dst_hub.id_hub WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as dht on (dht.awb_nr,dht.hub_transfer_nr)= (sois.awb_nr,ht.hub_transfer_nr)  LEFT JOIN (SELECT DISTINCT item.awb_nr, pitem.awb_nr d_package_group, org_hub.code as dpg_org_hub, Hub_Code as dpg_dest_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id)  LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) LEFT JOIN ( SELECT id_item, MIN(id_item_state_history) as id_item_state_history FROM noonltddwh.lms.item_state_history ish LEFT JOIN noonltddwh.lms.item it USING (id_item) WHERE id_loc_type=1 GROUP BY 1 ) orgloc ON orgloc.id_item=pitem.id_item LEFT JOIN noonltddwh.lms.item_state_history orgish USING (id_item_state_history) LEFT JOIN noonltddwh.lms.hub_location orghl ON (orgish.id_loc_type, orgish.loc_id) = (1, orghl.id_hub_location) LEFT JOIN noonltddwh.lms.hub org_hub ON (orghl.id_hub=org_hub.id_hub) LEFT JOIN (SELECT awb_nr,loc_type.code,case when hub.code is null then hub_sector_hub.code else hub.code end as Hub_Code FROM noonltddwh.lms.item_pgroup item_pgroup LEFT JOIN noonltddwh.lms.item item USING(id_item) LEFT JOIN noonltddwh.lms.loc_type loc_type using(id_loc_type) LEFT JOIN noonltddwh.lms.hub hub ON (loc_type.code,item_pgroup.loc_id) = ('hub',hub.id_hub) LEFT JOIN noonltddwh.lms.hub_sector hub_sector ON (loc_type.code,item_pgroup.loc_id) = ('hub_sector',hub_sector.id_hub_sector) LEFT JOIN noonltddwh.lms.hub hub_sector_hub ON hub_sector_hub.id_hub = hub_sector.id_hub ) pgroup_data on pgroup_data.awb_nr = pitem.awb_nr  LEFT JOIN noonltddwh.lms.item_state its ON its.id_item=item.id_item WHERE item.id_item_type = 1 AND cs.id_loc_type in (3,11)) dpg on (dpg.awb_nr,d_package_group) = (sois.awb_nr ,pgroup) LEFT JOIN (SELECT DISTINCT item.awb_nr,pitem.awb_nr pge_group,FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) where pitem.awb_nr is not null ) bpg on bpg.awb_nr = sois.awb_nr  LEFT JOIN (SELECT DISTINCT item.awb_nr,hub_transfer.hub_transfer_nr as htransfer, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item  LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as ddht on ddht.awb_nr= sois.awb_nr  where wl.id_warehouse_lane_type=3 and itm.id_item_type =1 and so.id_cart_type =1 and soi.id_invoice_section =1  and pw.id_warehouse_type <>5 and loc_type.name='Pending Address' """]
body = ["""SELECT Country ,Final_Status ,count(distinct case when AWB_Ageing between 0 and 2 then awb_nr end) less_then_2_days ,count(distinct case when AWB_Ageing between 2 and 5 then awb_nr end) less_then_5_days ,count(distinct case when AWB_Ageing > 5 then awb_nr end) Above_5_days FROM (select distinct timestamp_diff(current_timestamp() ,creq.created_at,day) as Order_Ageing, timestamp_diff(current_timestamp() ,itm.created_at,day) as AWB_Ageing, timestamp_diff(current_timestamp() ,rto_creation,day) as RTO_Ageing, timestamp_diff(current_timestamp() ,itms.updated_at,day) as Update_Ageing, case when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingDelivered' then 'Delivered' when concat(clt.code,loc_type.name,itmstts.code)='deliveryHub Locationtransiting' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code)='deliveryPackage Grouptransiting' then 'Pending Delivery' when loc_type.name='Pending Address' and InBound_ManifestNr is not null then 'Pending Pickup Manifested' when loc_type.name='Pending Address' and InBound_ManifestNr is null then 'Pending Pickup Not Manifested' when concat(clt.code,loc_type.name)='deliveryUser' and bpg.pge_group is null and first_attempt_ts is null then 'Picked Up' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingProcessing' then 'Out for Delivery' when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is null and bpg.pge_group is null then "Pending to Connect" when concat(clt.code,loc_type.name)='deliveryHub Location' and  htransfer is not null and bpg.pge_group is not null then "Connected to LM" when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryHub TransfertransitingShipped' then 'HT In Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingShipped' then 'Pending Pickup Manifested' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryPackage GrouptransitingShipped' then 'Package in Transit' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryService Point Locker LocationtransitingShipped' then 'Pending at Service Point' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryUsertransitingShipped' then 'Out for Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name,itmstts.code,soistatus.name_en)='deliveryManifestinboundingProcessing' then 'Pending Delivery' when concat(clt.code,loc_type.name)='rtoHub Location' then 'RTO Pending at Hub' when concat(clt.code,loc_type.name)='rtoHub Transfer' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoPackage Group' then 'RTO In Transit' when concat(clt.code,loc_type.name)='rtoUser'  then 'RTO With User' else 'Check' end as Final_Status, case when  loc_type.name='Package Group' and d_package_group is not null then dpg_org_hub end PG_Origin , case when  loc_type.name='Package Group' and d_package_group is not null then dpg_dest_hub end PG_Destination, case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_org_hub end Delivery_HT_Origin , case when  loc_type.name='Hub Transfer' and dht.hub_transfer_nr is not null then dht_dst_hub end Delivery_HT_Destination, w.code as seller_warehouse, w.id_partner_owner, w.name as Partner_Name, pwh.display_name_en as Seller_Display_Name, c.name_en as Seller_City, mp.name_en as Order_Type, country.code as Destination_Country, h.code as Hub, RTO_Hub,  hs.code as Hub_Sector, hss.code as Hub_Sub_Sector, c.country_code as Country, rto_creation, soi.item_nr , soistatus.name_en as Item_Status, sb.awb_nr as ship_box, sois.awb_nr as awb_nr, InBound_ManifestNr, OutBound_ManifestNr, loc_type.name as Loc_Type, client_pkg_ref, client_ref, s.code as Source_Status , itmstts.code as awb_status, clt.code as Creq_Leg_type, REPLACE(coalesce(hl.code,u.username, pgroup,ht.hub_transfer_nr, m.manifest_nr,mx.manifest_nr, spc.code,spl.code,tote.awb_nr, pgroup_com, spcl.code,spll.code,adx.address_uid),'@ops.idp.noon.team','')  as current_location, itm.created_at as Item_Creation, itms.updated_at as Item_Updated, creq.created_at Order_Creation, if(country.code='ae',timestamp_add(exported.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(exported.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(exported.created_at, interval 2 hour),exported.created_at))) as exported_at, date(soi.estimated_delivery_at) as edd, if(country.code='ae',timestamp_add(inbound_manifest.created_at, interval 4 hour) ,if(country.code='sa',timestamp_add(inbound_manifest.created_at, interval 3 hour) ,if(country.code='eg',timestamp_add(inbound_manifest.created_at, interval 2 hour),inbound_manifest.created_at))) as  manifested_at, if(country.code='ae',timestamp_add(session_field_item.first_attempt_ts, interval 4 hour) ,if(country.code='sa',timestamp_add(session_field_item.first_attempt_ts, interval 3 hour) ,if(country.code='eg',timestamp_add(session_field_item.first_attempt_ts, interval 2  hour),session_field_item.first_attempt_ts))) as first_attempt_ts from `noonltddwh.sales.sales_order_item` soi LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois  on soi.id_sales_order_item_shipment=sois.id_sales_order_item_shipment LEFT JOIN `noonltddwh.sales.sales_order` so on so.id_sales_order=soi.id_sales_order LEFT JOIN (select * from  `noonltddwh.sales.sales_order_item_status_history` where id_sales_order_item_status=4 ) exported using (id_sales_order_item) LEFT JOIN noonltddwh.partner.partner_warehouse partner_warehouse on soi.id_partner_warehouse=partner_warehouse.id_partner_warehouse LEFT JOIN noonltddwh.ref.partner pwh ON pwh.id_partner=partner_warehouse.id_partner_owner LEFT JOIN `noonltddwh.ref.mp` mp on mp.id_mp =so.id_mp LEFT JOIN `noonltddwh.ref.sales_order_item_status` soistatus on soistatus.id_sales_order_item_status =soi.id_sales_order_item_status  LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller LEFT JOIN noonltddwh.xms_sourcing.warehouse w on wl.id_warehouse = w.id_warehouse LEFT JOIN noonltddwh.xms_sourcing.status s on sb.id_status = s.id_status LEFT JOIN noonltddwh.partner.partner_warehouse pw on w.code=pw.code LEFT JOIN noonltddwh.ref.city c on pw.id_city=c.id_city LEFT JOIN noonltddwh.lms.item itm on itm.awb_nr=sois.awb_nr LEFT JOIN (SELECT id_item,manifest_nr as OutBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=1)  out_manifest_item  USING (id_item) LEFT JOIN (SELECT id_item,manifest_nr as InBound_ManifestNr    FROM `noonltddwh.lms.manifest_item`  LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest) WHERE is_outbound=0)  in_manifest_item  USING (id_item) left join (select distinct id_item, manifest.* from  `noonltddwh.lms.manifest_item` as manifest_item left join  `noonltddwh.lms.manifest` as manifest using (id_manifest) where id_manifest_type in (3,6)) as inbound_manifest using (id_item) left join (select id_item, min(created_at) as first_attempt_ts  from  `noonltddwh.lms.item_event` as item_event  where  replace(json_extract_scalar(item_event.data,'$.event_code'),'','')='shipment_ofd' group by 1) as session_field_item using (id_item) LEFT JOIN noonltddwh.lms.item_type itmt USING (id_item_type) LEFT JOIN noonltddwh.lms.item_state itms USING (id_item) LEFT JOIN `noonltddwh.lms.loc_type` loc_type on itms.id_loc_type = loc_type.id_loc_type LEFT JOIN `noonltddwh.lms.item_pkg` ipg on itm.id_item =ipg.id_item  LEFT JOIN noonltddwh.lms.status itmstts on itms.id_status = itmstts.id_status LEFT JOIN noonltddwh.lms.client_pkg_ref cpr on sois.awb_nr=cpr.awb_nr LEFT JOIN `noonltddwh.lms.creq_leg` creq_leg on creq_leg.id_creq_leg=ipg.id_creq_leg LEFT JOIN `noonltddwh.lms.creq` creq on creq.id_creq=creq_leg.id_creq LEFT JOIN (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type =3 ) cleg on cleg.id_creq=cpr.id_creq LEFT JOIN (select awb_nr , cleg.created_at as rto_creation from `noonltddwh.lms.item`  left join `noonltddwh.lms.item_pkg` using (id_item) left join `noonltddwh.lms.creq_leg` cleg using (id_creq_leg) where id_creq_leg_type =4) rtoc on rtoc.awb_nr=sois.awb_nr LEFT JOIN (select id_creq,h.code as RTO_Hub from `noonltddwh.lms.creq_leg` cleg LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub where id_creq_leg_type =4 ) clegr on clegr.id_creq=cpr.id_creq LEFT JOIN `noonltddwh.lms.hub_sector` hs on cleg.id_hub_sector = hs.id_hub_sector LEFT JOIN `noonltddwh.lms.hub_subsector` hss on cleg.id_hub_subsector = hss.id_hub_subsector LEFT JOIN `noonltddwh.lms.hub` h on hs.id_hub = h.id_hub LEFT JOIN `noonltddwh.lms.hub_airport` ha using (id_hub_airport) LEFT JOIN `noonltddwh.lms.country` country on country.id_country=ha.id_country LEFT JOIN `noonltddwh.lms.country_zone` cz on cz.id_country_zone=cleg.id_country_zone   LEFT JOIN `noonltddwh.lms.creq_leg_type`  clt on creq_leg.id_creq_leg_type =clt.id_creq_leg_type  LEFT JOIN `noonltddwh.lms.hub_location` hl  on (itms.id_loc_type,itms.loc_id) = (1,id_hub_location) LEFT JOIN `noonltddwh.lms.user` u on (itms.id_loc_type,itms.loc_id) = (2,u.id_user) LEFT JOIN (select id_item, awb_nr as pgroup from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ip on  (itms.id_loc_type,itms.loc_id) = (3,ip.id_item) LEFT JOIN `noonltddwh.lms.hub_transfer` ht on  (itms.id_loc_type,itms.loc_id) = (4,id_hub_transfer) LEFT JOIN `noonltddwh.lms.manifest` m on  (itms.id_loc_type,itms.loc_id) = (5,m.id_manifest) LEFT JOIN `noonltddwh.lms.manifest` mx on (itms.id_loc_type,itms.loc_id) = (6,mx.id_manifest) LEFT JOIN `noonltddwh.lms.service_point_counter` spc on  (itms.id_loc_type,itms.loc_id) = (8,id_service_point_counter) LEFT JOIN `noonltddwh.lms.address` adx on  (itms.id_loc_type,itms.loc_id) = (9,adx.id_address) LEFT JOIN (select id_item, awb_nr as pgroup_com from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ipc on (itms.id_loc_type,itms.loc_id) = (11,ipc.id_item) LEFT JOIN `noonltddwh.lms.service_point_locker` spl on (itms.id_loc_type,itms.loc_id) = (12,id_service_point_locker) LEFT JOIN `noonltddwh.lms.service_point_counter_location` spcl ON (itms.id_loc_type,itms.loc_id)=(13,spcl.id_service_point_counter_location) LEFT JOIN `noonltddwh.lms.service_point_locker_location` spll ON (itms.id_loc_type,itms.loc_id)= (17,spll.id_service_point_locker_location) LEFT JOIN `noonltddwh.lms.item` tote ON (itms.id_loc_type,itms.loc_id)=(16,tote.id_item) LEFT JOIN ( SELECT DISTINCT item.awb_nr, hub_transfer.hub_transfer_nr, org_hub.code dht_org_hub, dst_hub.code dht_dst_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) LEFT JOIN noonltddwh.lms.hub org_hub on hub_transfer.id_hub_src = org_hub.id_hub LEFT JOIN noonltddwh.lms.hub dst_hub on hub_transfer.id_hub_dst = dst_hub.id_hub WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as dht on (dht.awb_nr,dht.hub_transfer_nr)= (sois.awb_nr,ht.hub_transfer_nr)  LEFT JOIN (SELECT DISTINCT item.awb_nr, pitem.awb_nr d_package_group, org_hub.code as dpg_org_hub, Hub_Code as dpg_dest_hub, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id)  LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) LEFT JOIN ( SELECT id_item, MIN(id_item_state_history) as id_item_state_history FROM noonltddwh.lms.item_state_history ish LEFT JOIN noonltddwh.lms.item it USING (id_item) WHERE id_loc_type=1 GROUP BY 1 ) orgloc ON orgloc.id_item=pitem.id_item LEFT JOIN noonltddwh.lms.item_state_history orgish USING (id_item_state_history) LEFT JOIN noonltddwh.lms.hub_location orghl ON (orgish.id_loc_type, orgish.loc_id) = (1, orghl.id_hub_location) LEFT JOIN noonltddwh.lms.hub org_hub ON (orghl.id_hub=org_hub.id_hub) LEFT JOIN (SELECT awb_nr,loc_type.code,case when hub.code is null then hub_sector_hub.code else hub.code end as Hub_Code FROM noonltddwh.lms.item_pgroup item_pgroup LEFT JOIN noonltddwh.lms.item item USING(id_item) LEFT JOIN noonltddwh.lms.loc_type loc_type using(id_loc_type) LEFT JOIN noonltddwh.lms.hub hub ON (loc_type.code,item_pgroup.loc_id) = ('hub',hub.id_hub) LEFT JOIN noonltddwh.lms.hub_sector hub_sector ON (loc_type.code,item_pgroup.loc_id) = ('hub_sector',hub_sector.id_hub_sector) LEFT JOIN noonltddwh.lms.hub hub_sector_hub ON hub_sector_hub.id_hub = hub_sector.id_hub ) pgroup_data on pgroup_data.awb_nr = pitem.awb_nr  LEFT JOIN noonltddwh.lms.item_state its ON its.id_item=item.id_item WHERE item.id_item_type = 1 AND cs.id_loc_type in (3,11)) dpg on (dpg.awb_nr,d_package_group) = (sois.awb_nr ,pgroup) LEFT JOIN (SELECT DISTINCT item.awb_nr,pitem.awb_nr pge_group,FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item LEFT JOIN noonltddwh.lms.item pitem ON (cs.id_loc_type,cs.loc_id) = (3,pitem.id_item) where pitem.awb_nr is not null ) bpg on bpg.awb_nr = sois.awb_nr  LEFT JOIN (SELECT DISTINCT item.awb_nr,hub_transfer.hub_transfer_nr as htransfer, FROM noonltddwh.lms.container_state cs LEFT JOIN noonltddwh.lms.container_line cl using(id_loc_type,loc_id) LEFT JOIN noonltddwh.lms.item item ON item.id_item = cl.id_item  LEFT JOIN noonltddwh.lms.hub_transfer hub_transfer ON (cs.id_loc_type,loc_id) = (4,hub_transfer.id_hub_transfer) WHERE item.id_item_type IN (1,2) AND cs.id_loc_type = 4 )as ddht on ddht.awb_nr= sois.awb_nr  where wl.id_warehouse_lane_type=3 and itm.id_item_type =1 and so.id_cart_type =1 and soi.id_invoice_section =1  and pw.id_warehouse_type <>5 and loc_type.name='Pending Address' ) WHERE Order_Type <> 'daily' and Final_Status <> 'Pending Pickup Manifested'  GROUP BY 1,2 order by 1,2 """]
recipients = ["mshrideep@noon.com","meaziz@noon.com","usingal@noon.com","srizvi@noon.com","logistics-reporting@noon.com","avv@noon.com","bmondal@noon.com","shakhan@noon.com","ltijani@noon.com","meswaramurthy@noon.com","klogarta@noon.com","bshah@noon.com","vijain@noon.com","skotla@noon.com","sujaiswal@noon.com","tali@noon.com"]
sender = 'logistics-reporting@noon.com'


#[[email]]
#dag_id = 'failed_rtv'
#task_id = 'yesterday_cir'
#name = 'YESTERDAY CENTRAL CIR PERFORMANCE'
#attachment_sql = ["""SELECT * FROM `noonbilogoi.SJ.CIR_Summary` where date_diff(current_date(),Creation_With_Cutoff,day)=1 and substr(Hub,5,1)<>"T"""","""SELECT * FROM `noonbilogoi.SJ.CIR_Data` where date_diff(current_date(),Creation_With_Cutoff,day)=1 and substr(Hub,5,1)<>"T""""]
#body = ["""SELECT * FROM `noonbilogmis.reporting.cir_summary_yt` """]
#recipients = ["mhussein@noon.com","hjha@noon.com","vijain@noon.com","sdev@noon.com","nparnami@noon.com","usingal@noon.com","skallingal@noon.com","aparkar@noon.com","vishsingh@noon.com","npaliwal@noon.com","melfayoumy@noon.com","logistics-reporting@noon.com","skotla@noon.com","syednizam@noon.com","sraut@noon.com","kray@noon.com","mshawky@noon.com","morub@noon.com","nkumar@noon.com","nadlakha@noon.com","lsharma@noon.com","mjaroli@noon.com","pchhetri@noon.com","nesingh@noon.com","aemam@noon.com","skallingal@noon.com","mahamza@noon.com","mwarish@noon.com","akesargadde@noon.com","uae-trojans@noon.com","logistics.bq@noon.com","logksa@noon.com","mabulfaraj@noon.com","satanwar@noon.com","nseth@noon.com"]
#sender = 'logistics-reporting@noon.com'


# [[email]]
# dag_id = 'failed_rtv'
# task_id = 'pod_failed_rtv'
# name = 'Yesterday Attempted RTV - POA Summary'
# attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.poa_mail_body` WHERE Business_Type Not IN ('Daily') AND hub NOT IN ('RUH-X9')"""]
# body = ["""SELECT * FROM `noonbilogmis.reporting.poa_summary_first`"""]
# recipients = ["sor@noon.com","murrehman@noon.com","auh-hub@noon.com","srizvi@noon.com","usingal@noon.com","logistics-reporting@noon.com","AUH2_Hub@noon.com","dgera@noon.com","AUH3_Hub@noon.com","dxb-g2@noon.com","RKT-hub@noon.com","FJR-hub@noon.com","DXB_Hub@noon.com","DXB02_Hub@noon.com","DXB03_Hub@noon.com","DXBA8-hub@noon.com","shj-hub@noon.com","AAN-Hub@noon.com","mahamza@noon.com","fm_hub@noon.com","karkhalifa@noon.com","rguevarra@noon.com","rilao@noon.com","mhussein@noon.com","Mshawky@noon.com","fmksa@noon.com","morub@noon.com","sraut@noon.com","marshad@noon.com","pchhetri@noon.com","wsperito@noon.com","ralexander@noon.com","skotla@noon.com","sujaiswal@noon.com","sraut@noon.com","vijain@noon.com"]
# sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'failed_rtv'
task_id = 'pod_pop_compliance'
name = 'Yesterday POD and POP Compliance Summary'
attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.poa`"""]
recipients = ["nesupport_UAE@noon.com","rguevarra@noon.com","skotla@noon.com","abdabdullah@noon.com","usingal@noon.com","kshanu@noon.com","srizvi@noon.com","logistics-reporting@noon.com","sor@noon.com","murrehman@noon.com","aemam@noon.com","morub@noon.com","sujaiswal@noon.com","vijain@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'ag_capacity_attempt'
task_id = 'Ekta_Noon_daily_Report'
name = 'Pending closure Noon Daily '
attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.Neeraj_Noon_daily_RTO_pgroup_rawdata`"""] 
body = ["""SELECT * FROM `noonbilogmis.reporting.Neeraj_Noon_daily_RTO_pgroup_body`"""]
recipients = ["logistics-reporting@noon.com","dxb-d4@noon.com","uaequalityteam@noon.com","daily.dxb-a4@noon.com","dxb-d1@noon.com","dxb-d3@noon.com","dxb-d2@noon.com","dxb-d4@noon.com","auh-d1@noon.com", "mjaroli@noon.com", "jnazareno@noon.com", "dnataraja@noon.com", "dchopra@noon.com", "auh-d1@noon.com", "sbhetwal@noon.com", "batala@noon.com", "asethi@noon.com", "vkapinaiah@noon.com", "aan-Hub@noon.com", "daily.dxb-a4@noon.com", "daily.logistics@noon.com", "daily_leaders@noon.com", "daily_sellerops@noon.com", "daily_ct@noon.com", "nmandeep@noon.com", "hbadami@noon.com", "Daily_fulfilment@noon.com", "skallingal@noon.com", "ekairezi@noon.com", "shaahmad@noon.com", "qtariq@noon.com", "grahman@noon.com", "syehussain@noon.com", "anujsharma@noon.com", "Shj02_hub@noon.com", "AUH4_Hub@noon.com", "dxb05_hub@noon.com", "FJR-hub@noon.com", "RKT-hub@noon.com", "sc-product@noon.com", "nesupport_UAE@noon.com", "vchellapandi@noon.com", "bdhanapaul@noon.com", "dhaider@noon.com", "gmurupel@noon.com", "pchhetri@noon.com", "nesingh@noon.com", "ajainudeen@noon.com", "alihossain@noon.com", "szaidi@noon.com", "paynikath@noon.com", "wsperito@noon.com", "sdev@noon.com", "tsubrahmanyam@noon.com", "akesargadde@noon.com", "uae-trojans@noon.com", "pthakur@noon.com", "spradhan@noon.com", "daily.support@noon.com", "cjoshi@noon.com", "masghar@noon.com", "gkgupta@noon.com", "asahu@noon.com", "asamaniego@noon.com", "navantsa@noon.com", "myarafat@noon.com", "mmusngi@noon.com", "vganesan@noon.com", "saali@noon.com", "aluarca@noon.com", "snazir@noon.com", "bmikdad@noon.com", "sroy@noon.com", "eantonio@noon.com", "echenwi@noon.com", "zabbasi@noon.com", "mimran@noon.com", "mjali@noon.com", "rthanneeru@noon.com", "jcarpio@noon.com", "zzubair@noon.com", "lmlead-uae@noon.com", "sthapa@noon.com", "rgoddanla@noon.com", "skc@noon.com", "ops.excellence@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'yesterday_warrant_shipment_Under_new_B2C_process'
name = 'yesterday warrant shipment Under new B2C_process'
attachment_sql = ["""select * from `noonbilogmis.reporting.DB_warranty3_1` where date(created_at) = current_date()-1"""]
body = ["""select country , count(distinct awb_nr) as awb_count from `noonbilogmis.reporting.DB_warranty3_1` where date(created_at) = current_date()-1 group by 1 ""","""select hub ,count(distinct awb_nr) as awb_count from `noonbilogmis.reporting.DB_warranty3_1` where date(created_at) = current_date()-1 group by 1 order by 2 desc"""]
recipients = ["nseth@noon.com","nanand@noon.com","nadlakha@noon.com","asabri@noon.com","rguevarra@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'email_dag'
task_id = 'RTC_Pending_data'
name = 'RTC Pending data'
attachment_sql = ["""select * from `noonbilogmis.reporting.CIR_RTC`""", """select * from `noonbilogmis.reporting.Warranty_RTC`"""]
body = ["""Select country,count(distinct case when Creq_leg = "delivery" then awb_nr end ) as Delivery,count(distinct case when Creq_leg = "rto" then awb_nr end ) as NDR, count(awb_nr) as CIR_RTC_Count from `noonbilogmis.reporting.CIR_RTC` group by 1 order by 1""" ,"""select country,count(distinct case when leg_type = "delivery" then awb_nr end ) as Delivery,count(distinct case when leg_type = "rto" then awb_nr end ) as NDR, count(awb_nr) as Warranty_RTC_Count from `noonbilogmis.reporting.Warranty_RTC` group by 1 order by 1"""]
recipients = ["nseth@noon.com" , "nadlakha@noon.com","rguevarra@noon.com", "sbhat@noon.com" , "sshivhare@noon.com" ]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'email_dag'
task_id = 'CIR_RTC_Held_data'
name = 'CIR RTC on Hold data'
attachment_sql = ["""select * from `noonbilogmis.reporting.CIR_RTC` where leg_status = "held" """]
body = [""" Select country, count(distinct case when Creq_leg = "delivery" and leg_status = "held"  then awb_nr end ) as Delivery_on_Hold, count(distinct case when Creq_leg = "delivery" then awb_nr end ) as Delivery_total ,count(distinct case when Creq_leg = "rto" then awb_nr end ) as NDR, count(awb_nr) as CIR_RTC_Count from `noonbilogmis.reporting.CIR_RTC` group by 1 order by 1 """]
recipients = ["nseth@noon.com" , "nadlakha@noon.com","rguevarra@noon.com", "sbhat@noon.com" , "sshivhare@noon.com" , "agandhi@noon.com" , "bkumar@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'email_dag'
task_id = 'WRTV_Pending_data'
name = 'WRTV Pending data'
attachment_sql = ["""select client_ref,awb_nr, creq_leg,leg_status, created_at,  num_attempts, reason, rescheduled_date, country, hub,  totalAgeing from `noonbilogmis.reporting.DB_warranty_RTV` where status2 not in ("Delivered" , "rto_handed_over_afs")"""]
body = ["""select country,count(distinct case when creq_leg = "delivery" then awb_nr end ) as Delivery,count(distinct case when creq_leg = "rto" then awb_nr end ) as NDR, count(awb_nr) as WRTV_Count from `noonbilogmis.reporting.DB_warranty_RTV` where status2 not in ("Delivered" , "rto_handed_over_afs" ) group by 1"""]
recipients = ["nseth@noon.com" , "nadlakha@noon.com","rguevarra@noon.com", "sbhat@noon.com" , "sshivhare@noon.com" ]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'WBP'
task_id = 'Warranty_B2B_UAE'
name = 'Warranty B2B UAE'
attachment_sql = ["""select country, hub,client_ref, date(case when extract(hour from  timestamp_add(created_at,interval 4 hour))<12 then DATE(timestamp_add(created_at,interval 4 hour)) else DATE(timestamp_add(created_at,interval 4 hour)) +1 end) as Creation_With_Cutoff, created_at, creq_leg_type,Pickup_WH_code,leg_status, num_attempts, awb_nr, pickup_ts,totalAgeing, PickedAgeing , reason, remarks, updated_at,current_hub, Status, Status2 from `noonbilogmis.reporting.DB_warranty2` where country = "AE" and Status <> "Handed_over to AFS" and status2 <> "attempts exhausted""""]
body = ["""select leg_status , count(client_ref) as count_awb from `noonbilogmis.reporting.DB_warranty2` where country = "AE" and Status <> "Handed_over to AFS" and status2 <> "attempts exhausted"group by 1 order by 1 desc"""]
recipients = ["nseth@noon.com" , "baelsayed@noon.com", "aluarca@noon.com" ,"achandorkar@noon.com", "srizvi@noon.com" , "usingal@noon.com" , "dxba9-hub@noon.com" , "DXB-G2@noon.com" , "DXB_Hub@noon.com" , "DXB02_Hub@noon.com" , "DXB03_Hub@noon.com" , "dxb05_hub@noon.com" , "dxb06_hub@noon.com" , "DXBA8-hub@noon.com" , "shj-hub@noon.com" , "mshajahan@noon.com" , "gngugi@noon.com" , "aravuthar@noon.com" , "rdalioan@noon.com" , "skadar@noon.com" , "jshylaja@noon.com"  ]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'Bulky_POD_Yesterday'
name = 'Bulky POD Yesterday'
attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.NS_Bulky_POD` where Delivered_Date = current_date() -1 """]
recipients = ["nseth@noon.com", "nadlakha@noon.com" ,"mhussein@noon.com","rgaje@noon.com", "nemustafa@noon.com", "ajmalkakkandi@noon.com", "nemustafa@noon.com", "mahamza@noon.com" , "srizvi@noon.com" , "nemustafa@noon.com" , "mshawky@noon.com" , "morub@noon.com", "satanwar@noon.com" , "achandorkar@noon.com" , "dnataraja@noon.com" ]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'CIR_POP_UAE'
name = 'CIR POP UAE'
attachment_sql = [""" SELECT * FROM `noonbilogmis.reporting.CIR_POP_UAE`  """]
recipients = ["nseth@noon.com", "annautiyal@noon.com" , "asethi@noon.com","sshivhare@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'CIR_Audit_POP'
name = 'CIR Audit POP'
attachment_sql = [""" SELECT * FROM `noonbilogmis.reporting.CIR_Audit_POP`  """]
body = ["""SELECT country , Count(Distinct client_ref) as request_nr, count(distinct awb_nr) as awb_count , Count(distinct POP_URL) as Image_count FROM `noonbilogmis.reporting.CIR_Audit_POP` group by 1  """]
recipients = ["nseth@noon.com","mhussein@noon.com","asethi@noon.com", "bpkrishna@noon.com", "mshawky@noon.com", "achandorkar@noon.com", "ckrishna@noon.com", "vishsingh@noon.com", "mahamza@noon.com", "wsperito@noon.com","aouda@noon.com", "melfayoumy@noon.com","UAEQualityTeam@noon.com", "uae-trojans@noon.com", "moshahnawaz@noon.com",  "vijain@noon.com" , "nadlakha@noon.com" , "mubaig@noon.com","oelsayed@noon.com","hhelmi@noon.com", "ALX01_Hub@noon.com" , "ALY_A2_Hub@noon.com" , "humostafa@noon.com", "CAI01_Hub@noon.com" , "GIZ01_Hub@noon.com" , "CAI-A3_Hub@noon.com","CAI-A4@noon.com" , "maemam@noon.com" , "CAI-A9_hub@noon.com", "CAI-B1_Hub@noon.com", "CAI-C1_Hub@noon.com", "CAI-D1_Hub@noon.com", "CAI-F1-Hub@noon.com", "CAI-G1-HUB@NOON.COM", "mosabdelnaser@noon.com", "CAI-I1_Hub@noon.com" , "mhmostafa@noon.com", "CAI-M1_Hub@noon.com", "CAI-S1-Hub@noon.com" , "hgamal@noon.com", "mahlotfy@noon.com", "mafarag@noon.com","CAI-A7-Hub@noon.com", "training-audit-egy@noon.com","sshivhare@noon.com"]
sender ='logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'Bulky_TPL_Allocation'
name = 'Bulky TPL Allocation'
body = [""" SELECT TPL_Vendor ,Handover_date ,count(awb_nr) as awb_nr FROM `noonbilogmis.reporting.NS_Bulky_TPL_Allocation` where Handover_date = current_date() - 1 group by 1,2 """]
recipients = ["nseth@noon.com", "nadlakha@noon.com" , "vijain@noon.com", "ckrishna@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'Yesterday_Bulky_Load'
name = 'Bulky Shipment Load'
attachment_sql = ["""Select  country,  display_name , LM_city, count(awb_nr) as awb_count FROM `noonbilogmis.reporting.NS_Bulky_load` where Date (manifest_unpacked_TS) = current_date - 1 group by 1,2,3 order by 1,4 desc"""]
body = [""" SELECT country,count(awb_nr) as awb_count FROM `noonbilogmis.reporting.NS_Bulky_load` where Date (manifest_unpacked_TS) = current_date - 1 group by 1 order by 1  """]
recipients = ["nseth@noon.com", "nadlakha@noon.com" , "vijain@noon.com", "ckrishna@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'email_dag'
task_id = 'yesterday_Warranty_Pickup_Summary'
name = 'yesterday Warranty Pickup Summary'
attachment_sql = ["""select * FROM `noonbilogmis.reporting.Warranty_pickup_summary` where Creation_With_Cutoff >= current_date() - 2 and Creation_With_Cutoff <> current_date"""]
body = [""" Select * from (SELECT country, case when  hub = "CAI-T1" then "3pl" when  hub = "RUH-T1" then "3pl" when  hub = "AHB-T1" then "3pl" else "nE" end  as carrier,count(distinct client_ref) as Total_request,count(distinct case when  Creation_With_Cutoff >= current_date() - 1  then client_ref end ) as New_Request,count(distinct case when    Creation_With_Cutoff = current_date() - 2 then client_ref end ) as Pending_request,count(distinct case when num_attempts <> 0 then client_ref end ) as Assigned ,count(distinct awb_nr) as picked ,count(distinct case when  num_attempts = 0 then client_ref end ) as Un_Attempted,count(distinct case when num_attempts = 0 and timestamp_diff(current_timestamp(), created_at, hour )> 48 then client_ref end ) as OverTAT,count(distinct case when num_attempts = 0 and timestamp_diff(current_timestamp(), created_at, hour )< 48 then client_ref end ) as UnderTAT FROM `noonbilogoi.reporting_mart.Warranty_pickup_summary` where Creation_With_Cutoff >= current_date() - 2 and Creation_With_Cutoff <> current_date group by 1,2) where carrier <> "3pl"   """]
recipients = ["nseth@noon.com","nanand@noon.com","nadlakha@noon.com","mahamza@noon.com","mwarish@noon.com", "vinsharma@noon.com","rguevarra@noon.com","mhussein@noon.com","wsperito@noon.com","vmohan@noon.com","kray@noon.com","syednizam@noon.com","vishsingh@noon.com","satanwar@noon.com","mabulfaraj@noon.com","nparnami@noon.com","mjaroli@noon.com","vijain@noon.com","msaid@noon.com","tawad@noon.com","uae-trojans@noon.com","rramos@noon.com","cdavid@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'Yesterday_Bulky_Load_National_serviceability'
name = 'Bulky Load National Serviceability'
attachment_sql = ["""  SELECT display_name ,Date (manifest_unpacked_TS) as DT, awb_nr , origin_warehouse, LMD, LM_city, country, client_ref as order_nr FROM `noonbilogmis.reporting.NS_Bulky_load` where Date (manifest_unpacked_TS) = current_date - 1 and display_name in ("NOON/DXBBK07" , "NOON/RUHBK06") order by 1"""]
body = [""" SELECT display_name ,Date (manifest_unpacked_TS) as DT, count(awb_nr) as awb_count FROM `noonbilogmis.reporting.NS_Bulky_load` where Date (manifest_unpacked_TS) = current_date - 1 and display_name in ("NOON/DXBBK07" , "NOON/RUHBK06") group by 1,2 order by 1 """]
recipients = ["nseth@noon.com", "nadlakha@noon.com" ]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'email_dag'
task_id = 'Yesterday_CIR_Address_Misrouted'
name = 'Yesterday CIR Address Misrouted/Changed_Re-attempt'
attachment_sql = ["""Select * FROM `noonbilogmis.reporting.CIR_address_misrouted`"""]
body = ["""Select country, count(distinct client_ref) as address_misrouted_count FROM `noonbilogmis.reporting.CIR_address_misrouted` group by 1 order by 2 desc"""]
recipients = ["nseth@noon.com","nanand@noon.com","nadlakha@noon.com","nparnami@noon.com","wsperito@noon.com","vmohan@noon.com","vishsingh@noon.com","syednizam@noon.com" , "mahamza@noon.com","mhussein@noon.com","moshahnawaz@noon.com","tawad@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'calling_mailer'
task_id = 'calling_morning_data'
name = 'calling_morning_data'
attachment_sql = ["""select x.order_nr , x.campaign_name , x.script_name , x.upload_date , customer_code from `noonbilogoi.nefreelancer.ne_calling_list_history` x left join `noonltddwh.sales.sales_order` using (order_nr) where upload_date = current_date()"""]
recipients = ["nanand@noon.com","nparnami@noon.com","kshanu@noon.com"]
sender = 'nanand@noon.com'


[[email]]
dag_id = 'LSv7'
task_id = 'LPC_KPI_Yesterday'
name ='LPC KPI Yesterday - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.LPC_MF_Pack_To_Unpack_Raw_Weekly where DATE(manifest_dt) = current_date()-1""","""SELECT * FROM noonbilogmis.reporting.LPC_MF_Pack_To_Unpack_TAT_yesterday""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_HT_TAT_Yesterday""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_HT_Raw_Weekly where date(LPC_rec_tm) = current_Date-1""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_TPL_TAT_Yesterday""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_TPL_rawdata_Weekly WHERE DATE(lpc_time) = current_Date - 1""","""SELECT * FROM noonbilogmis.reporting.RTO_To_WH_TAT_Yesterday""","""SELECT * FROM noonbilogmis.reporting.RTO_To_WH_Raw_Weekly where DATE(RTO_LegDate) = current_date - 1""","""SELECT * FROM noonbilogmis.reporting.CIR_Picked_To_LPC_TAT_Yesterday""","""SELECT * FROM noonbilogmis.reporting.CIR_Picked_To_LPC_Raw_Weekly WHERE DATE(Manifest) = current_date -1""","""SELECT * FROM noonbilogmis.reporting.AWB_creation_to_MF WHERE date(timestamp_add(created_at ,interval 2 hour) ) = current_date-1""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_TPL_rawdata_Yesterday_CAI_03_04""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_HT_Raw_Yesterday_CAI03_04"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","npaliwal@noon.com","egy-anp.team@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv7'
task_id = 'Hub_Performance_Report_MTD_mailer_eg'
name ='Hub Performance Report MTD - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.Hub_Performance_Report_MTD_Final""","""SELECT final.*, ifs.pkg_value AS Pkg_value FROM `noonbilogmis.reporting.Hub_Performance_Report_Yest_Final_For_V2`  final left join `noonbilogoi.battleplan_v1.item_final_state` ifs on ifs.awb_nr = final.awb_nr ""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_Report_Yesterday_Final_CIR"""]
body = ["""SELECT OFD_Dt,Hub,COUNT(DISTINCT username) username_cnt,SUM(Total_OFD) Total_OFD,SUM(number_delivered) number_delivered,SUM(und_delivered) und_delivered,SUM(number_address_changed) number_address_changed,SUM(number_address_misrouted) number_address_misrouted,SUM(number_customer_canceled) number_customer_canceled,SUM(number_held_consolidation) number_held_consolidation ,SUM(NDD_Total_OFD) NDD_Total_OFD          ,SUM(NDD_Total_Delivered) NDD_Total_Delivered          ,SUM(VIP_Total_OFD) VIP_Total_OFD                    ,SUM(VIP_Total_Delivered) VIP_Total_Delivered          ,SUM(Loyalty_Total_OFD) Loyalty_Total_OFD          ,SUM(Loyalty_Total_Delivered) Loyalty_Total_Delivered                    ,SUM(Total_assigned) Total_assigned          ,SUM(Total_pickup) Total_pickup , SUM(Total_assigned) Total_assigned, SUM(Total_pickup) Total_pickup FROM noonbilogmis.reporting.Hub_Performance_Report_MTD_Final WHERE OFD_Dt = date_add(current_date,interval -1 day) GROUP BY 1,2"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","shsherif@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","megasser@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv7'
task_id = 'Hub_Performance_new_Report_eg'
name ='Hub Performance New Report YTD - EG Overall'
depends = ['Hub_Performance_new_Report_Query1_data1_eg','Hub_Performance_new_Report_Query2_data1_eg','Hub_Performance_new_Report_Query3_data1_eg','Hub_Performance_new_Report_Query4_data1_eg','Hub_Performance_new_Report_Query5_data1_eg','Hub_Performance_new_Report_Query6_data1_eg','Hub_Performance_new_Report_Query7_data1_eg','Hub_Performance_new_Report_Query8_data1_eg','Hub_Performance_new_Report_Query9_data1_eg','Hub_Performance_new_Report_Query10_data1_eg','Hub_Performance_new_Report_Query11_data1_eg','Hub_Performance_new_Report_Query12_data1_eg','Hub_Performance_new_Report_Query13_data1_eg','Hub_Performance_new_Report_Query14_data1_eg']
body = ["""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query14_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query1_data_eg UNION ALL SELECT KPI, CAST(Value as string) FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query2_data_eg UNION ALL SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query3_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query4_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query5_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query6_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query7_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query8_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query9_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query10_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query11_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query12_data_eg""","""SELECT * FROM noonbilogmis.reporting.Hub_Performance_new_Report_Query13_data_eg"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'



#[[email]]
#dag_id = 'LSETv12'
#task_id = 'PDD_today_tomorrow_day_after_tomorrow'
#name ='PDD today tomorrow and day after tomorrow - EG'
#attachment_sql = ["""SELECT DATE(promised_at) PDD,awb_nr,DATE(created_at) Ship_dt,current_location, destination_hub,Received_by_LPC , Final_Status FROM noonbilogmis.reporting.EG_Pending_Data d left join (select awb_nr awb,MIN(f.FA_TS) FA_Date  from `noonbilogoi.LMS_CORE.NE_FA` f where DATE(f.FA_TS) < current_Date+5  group by 1) FA ON FA.awb = d.awb_nr LEFT JOIN ( SELECT distinct awb_nr awb2 FROM noonltddwh.sales.sales_order_item soi left join noonltddwh.sales.sales_order_item_shipment using(id_sales_order_item_shipment) where id_sales_order_item_status = 6 ) t on t.awb2 = d.awb_nr  LEFT JOIN  (select awb_nr awb_nr1,min(ish.created_at) as Received_by_LPC from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code like "%Z1%" group by 1) as hubr on d.awb_nr=hubr.awb_nr1 WHERE  DATE(promised_at) >= current_Date and  DATE(promised_at)  < current_date+3 and creq_leg_type ='Delivery' and creq_type = 'b2c_delivery' and carrier_change = 'No' and Final_Status not in  ('Delivered','UnDelivered') and country = 'eg' and t.awb2 is null"""]
#recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","sraut@noon.com","mwafaey@noon.com"]
#sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSETv12'
task_id = 'Hourly_LPC'
name ='Hourly LPC - EG'
attachment_sql = ["""SELECT  DATE(t1.Received_by_LPC)Dt,extract(hour from t1.Received_by_LPC) Hour,Hub.Hub,substr(pw.display_name,6,100) wh_type ,COUNT(DISTINCT sois.awb_nr) cnt FROM    `noonltddwh.sales.sales_order_item_shipment` sois left join `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse  LEFT JOIN `noonltddwh.sales.sales_order` so using(id_sales_order) LEFT JOIN ( SELECT distinct id_sales_order_item_shipment,id_invoice_section FROM noonltddwh.sales.sales_order_item) t on t.id_sales_order_item_shipment = sois.id_sales_order_item_shipment LEFT JOIN (SELECT awb_nr , hub.code as Hub from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub)   as Hub on Hub.awb_nr= sois.awb_nr LEFT JOIN (select i.awb_nr awb,min(ish.created_at) as Received_by_LPC , MAX(ish.created_at) MAX_Received_by_LPC from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join noonltddwh.lms.item i using(id_item) where id_loc_type = 1 and hl.code like "%Z1%" group by 1) t1 ON t1.awb = sois.awb_nr WHERE   DATE(t1.Received_by_LPC) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH) AND so.country_code = 'EG' and id_cart_type =1 and id_invoice_section =1 and sois.id_carrier = 9 GROUP BY 1,2,3,4"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSETv12'
task_id = 'CIR_pending_for_FA_more_than_36_hour'
name ='CIR pending for FA more than 36 hour - EG'
attachment_sql = ["""SELECT hub,country_zone,Hub_sector,client_ref,creq_nr,creq_created_at,creq_status,Final_Status,num_attempts  ,case when date_diff(current_date(),DATE(creq_created_at),day)>2 THEN 'More_than_3_day' else 'Less_than_3_day' end as  Flag FROM      (SELECT distinct CASE When creq_leg_job_status = 'Pending' AND num_attempts = 0 then 'Pendinng for 0 Attempts' When creq_leg_job_status = 'Pending' AND num_attempts > 0 then 'Attempted But Not Assigned' When creq_leg_job_status = 'Opened' AND num_attempts >= 0 then 'Assigned but not Picked' end as Final_Status,* FROM `noonbilogoi.cir_v1.dq_custreq_cir` where creq_type ='CIR' and creq_status !='Closed' and creq_leg_type!='Dropoff' and creq_leg_status not in ('Held','Canceled') and creq_leg_job_status!='Canceled' and country = 'eg' AND  ((timestamp_diff(current_timestamp,creq_leg_job_updated_at,hour)> 12 AND creq_leg_job_status = 'Opened') OR creq_leg_job_status = 'Pending')) GROUP BY 1,2,3,4,5,6,7,8,9"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSETv12'
task_id = 'awb_carrier_EG'
name ='Carrier Wise Shipment Count'
attachment_sql = ["""select date(shipping_date) shipping_date,carrier ,count(distinct awb_nr ) as Shipment from `noonbilogoi.LMS_CORE.awb_carrier` where country_code ='EG' and DATE(shipping_date) >=DATE_TRUNC(CURRENT_DATE() -1, MONTH) group by 1,2"""]
recipients = ["megasser@noon.com","Sarfraz Ahmed Raut <sraut@noon.com>","mahamza@noon.com","mshawky@noon.com", "mhussein@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv7'
task_id = 'Cash_Collection_yesterday_mailer_eg'
name ='Cash Collection yesterday - EG Overall'
attachment_sql = ["""SELECT DATE(Dt) Date,username,Hub,money_collected_yest FROM ( select * from (select distinct hub.code Hub, username, date(timestamp_add(cash_transaction_entry.created_at, interval -2 hour)) DT, substr(currency.code,0,2) as country ,round(sum(if(cash_transaction.id_cash_transaction_type=4 and cash_transaction_entry.id_cash_account_type=5,cash_transaction_entry.amount,0))/100,0) as money_collected_yest ,round(sum(if(cash_transaction.id_cash_transaction_type=1 and cash_transaction_entry.id_cash_account_type=1,cash_transaction_entry.amount,0))/100,0) as money_collected_cash_yest ,round(sum(if(cash_transaction.id_cash_transaction_type=3 and cash_transaction_entry.id_cash_account_type=4,cash_transaction_entry.amount,0))/100,0) as money_collected_card_yest ,-round(sum(if(cash_transaction.id_cash_transaction_type=7 and cash_transaction_entry.id_cash_account_type in (7) , cash_transaction_entry.amount,0))/100.0) as bts_posted_yest from `noonltddwh.lms.cash_transaction_entry` as cash_transaction_entry left join `noonltddwh.lms.cash_transaction` as cash_transaction using (id_cash_transaction) left join (SELECT DISTINCT id_user,username, DATE(f.created_at) created_at, id_hub FROM `noonltddwh.lms.session_field` f left join noonltddwh.lms.user u using(id_user)) sf ON sf.id_user = cash_transaction.id_user and DATE(sf.created_at) = DATE(cash_transaction_entry.created_at) left join `noonltddwh.lms.hub` hub using(id_hub) left join `noonltddwh.lms.currency` as currency using (id_currency) where date_diff(current_date(),date(timestamp_add(cash_transaction_entry.created_at, interval -2 hour)),day)<50 group by 1,2,3,4 ) left join (select distinct substr(currency.code,0,2) as country ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0) as int64) as user_balance_yest ,cast(round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_outgoing_yest ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0)+round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_balance_total_yest from `noonltddwh.lms.cash_account_summary` as cash_account_summary left join `noonltddwh.lms.currency` as currency using (id_currency) where date(timestamp_add(cash_account_summary.created_at, interval -2 hour))<current_date() group by 1) using (country) left join (select distinct substr(currency.code,0,2) as country ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0) as int64) as user_balance_today ,cast(round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_outgoing_today ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0)+round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_balance_total_today from `noonltddwh.lms.cash_account_summary` as cash_account_summary left join `noonltddwh.lms.currency` as currency using (id_currency) where date(timestamp_add(cash_account_summary.created_at, interval -2 hour))<=current_date() group by 1) using (country) ) T WHERE country = 'eg' AND DATE(Dt) = DATE_ADD(CURRENT_DATE(), INTERVAL -1 day)   order by 1"""]
body = ["""SELECT DATE(Dt) Date,Hub,money_collected_yest FROM ( select * from (select distinct hub.code Hub, date(timestamp_add(cash_transaction_entry.created_at, interval -2 hour)) DT, substr(currency.code,0,2) as country ,round(sum(if(cash_transaction.id_cash_transaction_type=4 and cash_transaction_entry.id_cash_account_type=5,cash_transaction_entry.amount,0))/100,0) as money_collected_yest ,round(sum(if(cash_transaction.id_cash_transaction_type=1 and cash_transaction_entry.id_cash_account_type=1,cash_transaction_entry.amount,0))/100,0) as money_collected_cash_yest ,round(sum(if(cash_transaction.id_cash_transaction_type=3 and cash_transaction_entry.id_cash_account_type=4,cash_transaction_entry.amount,0))/100,0) as money_collected_card_yest ,-round(sum(if(cash_transaction.id_cash_transaction_type=7 and cash_transaction_entry.id_cash_account_type in (7) , cash_transaction_entry.amount,0))/100.0) as bts_posted_yest from `noonltddwh.lms.cash_transaction_entry` as cash_transaction_entry left join `noonltddwh.lms.cash_transaction` as cash_transaction using (id_cash_transaction) left join (SELECT DISTINCT id_user, DATE(created_at) created_at, id_hub FROM `noonltddwh.lms.session_field`) sf ON sf.id_user = cash_transaction.id_user and DATE(sf.created_at) = DATE(cash_transaction_entry.created_at) left join `noonltddwh.lms.hub` hub using(id_hub) left join `noonltddwh.lms.currency` as currency using (id_currency) where date_diff(current_date(),date(timestamp_add(cash_transaction_entry.created_at, interval -2 hour)),day)<50 group by 1,2,3 ) left join (select distinct substr(currency.code,0,2) as country ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0) as int64) as user_balance_yest ,cast(round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_outgoing_yest ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0)+round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_balance_total_yest from `noonltddwh.lms.cash_account_summary` as cash_account_summary left join `noonltddwh.lms.currency` as currency using (id_currency) where date(timestamp_add(cash_account_summary.created_at, interval -2 hour))<current_date() group by 1) using (country) left join (select distinct substr(currency.code,0,2) as country ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0) as int64) as user_balance_today ,cast(round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_outgoing_today ,cast(round(sum(if(id_cash_account_type=1,cash_account_summary.amount,0))/100,0)+round(sum(if(id_cash_account_type=7,cash_account_summary.amount,0))/100,0) as int64) as user_balance_total_today from `noonltddwh.lms.cash_account_summary` as cash_account_summary left join `noonltddwh.lms.currency` as currency using (id_currency) where date(timestamp_add(cash_account_summary.created_at, interval -2 hour))<=current_date() group by 1) using (country) ) T WHERE country = 'eg' AND DATE(Dt) = DATE_ADD(CURRENT_DATE(), INTERVAL -1 day) order by 1"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","Karkhalifa@noon.com","megasser@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSH15'
task_id = 'OFD'
name ='OFD Report Today - EG Overall'
body = ["""SELECT Hub,ofd_date,COUNT(DISTINCT username) user_Cnt,COUNT(distinct awb_nr) total_cnt ,COUNT(DISTINCT total_touchpoints) total_touchpoints,SUM(omw) omw,SUM(cal) Call,SUM(CASE WHEN end_status = 'Delivered' THEN 1 ELSE 0 END) Del,count(distinct case when end_status NOT IN         ('Delivered','address_changed','address_changed_reroute','address_changed_warning','address_misrouted','customer_canceled','held_consolidation')         then awb_nr end) as und_delivered FROM noonbilogmis.reporting.OFD_Forward WHERE ofd_date = current_date and country = 'eg' GROUP BY 1,2"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","Bassam Mohamed <bmohamed@noon.com>","Msaid@noon.com","npaliwal@noon.com", "Hossam Sharaf <hsharaf@noon.com>", "Gamal Mahmoud <gamahmoud@noon.com>", "Mohamed Mahdy <mmahdy@noon.com>", "CAI01_Hub <CAI01_Hub@noon.com>", "Giza <GIZ01_Hub@noon.com>", "Omar Elsayed <oelsayed@noon.com>","Dina Saad <dsaad@noon.com>", "Mohamed Samy Hussein <mhussein@noon.com>", "ALX01_Hub <ALX01_Hub@noon.com>","Tarek Mohamed Gaber Awad <tawad@noon.com>","NE Support - EGY <nesupport_EGY@noon.com>","log-egy@noon.com","karkhalifa@noon.com","CAI-A4@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'




[[email]]
dag_id = 'LSv7'
task_id = 'Shipments_Allocation'
name ='Shipments_Allocation'
attachment_sql = ["""SELECT ship_dt Shipped_date, city, SUM(Cnt) Total_Shipment, SUM(CASE WHEN  Hub NOT like '%T1' THEN Cnt ELSE 0 END) AS NE,SUM(CASE WHEN  Hub like '%T1' THEN Cnt ELSE 0 END) AS Aramex FROM noonbilogmis.reporting.Shipments_Allocation4 GROUP BY 1,2""","""SELECT Hub, hub_sector, country_zone,ship_dt Shipped_date, display_name, SUM(Cnt) Cnt  FROM noonbilogmis.reporting.Shipments_Allocation4 GROUP BY 1,2,3,4,5""","""SELECT hub.Hub , hub.hub_sector , hub.country_zone, DATE(Total_lpc_Receiving) LPC_Date,COUNT(1) Cnt FROM  noonltddwh.sales.sales_order_item_shipment sois   left join  noonltddwh.sales.sales_order so using(id_sales_order)  left join  noonltddwh.lms.item i using(awb_nr)  left join  (select id_item, MIN(ish.created_at) as Total_lpc_Receiving  from `noonltddwh.lms.item_state_history` ish  left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)   where id_loc_type = 1 and hl.code like "%Z1%"   group by 1  ) t on i.id_item = t.id_item  LEFT JOIN  (  select id_item, MAX(ish.created_at) as Total_hub_Receiving  from `noonltddwh.lms.item_state_history` ish  left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)   where id_loc_type = 1 and hl.code not like "%Z1%"   group by 1  ) t1 ON t.id_item = t1.id_item and Total_HUB_Receiving > Total_LPC_Receiving LEFT JOIN(SELECT awb_nr , hub.code as Hub, hub_sector.code hub_sector, country_zone.code country_zone from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub left join noonltddwh.lms.country_zone country_zone using(id_country_zone)) hub on hub.awb_nr = i.awb_nr  where DATE(Total_lpc_Receiving) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH) and so.country_code = 'EG' and    hub.Hub IS NOT NULL GROUP BY 1,2,3,4""","""WITH d AS (SELECT 1 as check, hub.Hub , hub.hub_sector , hub.country_zone, DATE(Total_lpc_Receiving) LPC_Date,COUNT(1) Cnt FROM  noonltddwh.sales.sales_order_item_shipment sois   left join  noonltddwh.sales.sales_order so using(id_sales_order)  left join  noonltddwh.lms.item i using(awb_nr)  left join  (select id_item, MIN(ish.created_at) as Total_lpc_Receiving  from `noonltddwh.lms.item_state_history` ish  left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)   where id_loc_type = 1 and hl.code like "%Z1%"   group by 1  ) t on i.id_item = t.id_item  LEFT JOIN  (  select id_item, MAX(ish.created_at) as Total_hub_Receiving  from `noonltddwh.lms.item_state_history` ish  left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)   where id_loc_type = 1 and hl.code not like "%Z1%"   group by 1  ) t1 ON t.id_item = t1.id_item and Total_HUB_Receiving > Total_LPC_Receiving LEFT JOIN(SELECT awb_nr , hub.code as Hub, hub_sector.code hub_sector, country_zone.code country_zone from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub left join noonltddwh.lms.country_zone country_zone using(id_country_zone)) hub on hub.awb_nr = i.awb_nr  where DATE(Total_lpc_Receiving) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH) and so.country_code = 'EG' and    hub.Hub IS NOT NULL GROUP BY 1,2,3,4,5) SELECT Hub,SUM(Cnt) Awb, Concat(CAST(ROUND((SUM(Cnt) / MAX(s.Total))*100,2) AS String),"%")  Avg FROM d LEFT JOIN (SELECT check, SUM(Cnt) Total FROM D GROUP BY 1)s ON   d.Check = s.check group by 1"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","Msaid@noon.com","npaliwal@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv7'
task_id = 'ASN_report_pickup'
name ='ASN_Report_Pickup_EG'
attachment_sql = ["""SELECT    substr(hs.code,0,6) hub,creq.creq_nr,creq.client_ref,                           CASE WHEN substr(creq.client_ref,0,1) = 'A' THEN partner.name else pw.display_name end as partner_name                           ,username ,creq.created_at,pickup_dt,awb_nr,                           firstattempt,MF_Creation_Time,Returned_Time FROM      noonltddwh.lms.creq creq left join `noonltddwh.lms.address` a on a.id_address = creq.id_address_src  left join `noonltddwh.partner.partner_warehouse` pw on pw.code = a.address_uid left join `noonltddwh.ops_inbound.asn` as asn on asn.asn_nr =creq.client_ref left join `noonltddwh.ref.partner` as partner on partner.id_partner = asn.id_partner_source LEFT JOIN noonltddwh.lms.creq_leg creq_leg using    (id_creq) LEFT JOIN `noonltddwh.lms.country_zone` cz using    (id_country_zone) LEFT JOIN `noonltddwh.lms.hub_sector` hs using    (id_hub_sector)LEFT JOIN(         SELECT   creq_nr,         min(fa) AS firstattempt         FROM     (                  SELECT *                  FROM   (                          SELECT    creq_nr,                          min(creq_leg_history.created_at) AS fa                          FROM      `noonltddwh.lms.creq` creq                          left JOIN      `noonltddwh.lms.creq_leg` using     (id_creq)                          LEFT JOIN                                   (                                   SELECT *, json_extract(data, '$.num_attempts')='1' AS attempt                                   FROM   `noonltddwh.lms.creq_leg_history`) creq_leg_history using     (id_creq_leg)                                   WHERE     attempt=true                                   GROUP BY  1                                   )                                   UNION ALL                                   (                                   SELECT    creq_nr,                                   min(manifest.created_at) AS fa                                   FROM      `noonltddwh.lms.creq` creq                                   LEFT JOIN `noonltddwh.lms.manifest` AS manifest using     (id_creq)                                   WHERE     id_manifest_type=1                                   GROUP BY  1                                   )                 )                GROUP BY 1    )using     (creq_nr)     LEFT JOIN              (              SELECT    creq.creq_nr ,MF_Creation_Time,user.username ,Returned_Time,awb_nr ,              min(creq_leg.created_at) pickup_dt              FROM      noonltddwh.lms.creq creq              LEFT JOIN noonltddwh.lms.creq_leg creq_leg using    (id_creq)              left join `noonltddwh.lms.item_pkg` ip using(id_creq_leg)              left join `noonltddwh.lms.item` using(id_item)              left join              (              SELECT ish.id_item ,MAX(ish.created_at) MF_Creation_Time              FROM  `noonltddwh.lms.item_state_history` ish              left join `noonltddwh.lms.manifest_item` hs on ish.loc_id = hs.id_manifest              left join `noonltddwh.lms.manifest` m using(id_manifest)              WHERE ish.id_loc_type = 5              and is_outbound = 1 and id_manifest_type = 2              GROUP BY 1              ) mf using(id_item)              LEFT JOIN              (              SELECT ish.id_item , u.username               FROM (              SELECT id_item,min(ish.created_at ) dt              FROM  `noonltddwh.lms.item_state_history` ish              GROUP BY 1                    ) t inner join  `noonltddwh.lms.item_state_history` ish on t.id_item = ish.id_item  and t.dt = ish.created_at                     left join noonltddwh.lms.user u on ish.id_user_updater = u.id_user               ) user using(id_item)              left join              (              SELECT ish.id_item,MAX(ish.created_at) Returned_Time              FROM  `noonltddwh.lms.item_state_history` ish              left join `noonltddwh.lms.manifest_item` hs on ish.loc_id = hs.id_manifest              left join `noonltddwh.lms.manifest` m using(id_manifest)              WHERE ish.id_loc_type = 6              and is_outbound = 1 and id_manifest_type = 2              GROUP BY 1              ) ret on ret.id_item = ip.id_item              WHERE     id_creq_type = 4              AND       id_creq_leg_type = 2              GROUP BY  1,2,3,4,5              ) pick ON        pick.creq_nr = creq.creq_nr WHERE     id_creq_type = 4 AND       id_creq_leg_type = 1 AND       substr(cz.code,0,2) = 'EG' AND       date(creq.created_at ) = current_Date -1 AND       pick.creq_nr IS NOT NULL"""]
recipients = ["sraut@noon.com","lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSv12'
task_id = 'RTV_Queue_Monitoring'
name ='RTV_Queue_Monitoring'
attachment_sql = ["""select * from `noonbilogmis.reporting.RTV_Queue_Monitoring1`"""]
body = ["""SELECT Hub,hub_sector,COUNT(1) Total_Cnt,SUM(CASE WHEN Aging_day < 3 THEN 1 ELSE 0 END) AS Aging_0_2_Day,SUM(CASE WHEN Aging_day > 2 AND Aging_day < 6 THEN  1 else 0 END) AS Aging_3_5_day ,SUM(CASE WHEN Aging_day > 5 THEN 1 ELSE 0 END) AS Aging_More_than_5_day FROM `noonbilogmis.reporting.RTV_Queue_Monitoring1` GROUP BY 1,2"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","usingal@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv830'
task_id = 'ASN_Queue_Monitoring'
name ='ASN_Queue_Monitoring'
attachment_sql = ["""select * from `noonbilogmis.reporting.ASN_Queue_Monitoring`"""]
body = ["""SELECT Hub,COUNT(1) ASN_Count FROM `noonbilogmis.reporting.ASN_Queue_Monitoring` group by 1"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","usingal@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


#[[email]]
#dag_id = 'LSv7'
#task_id = '3PL_Data'
#name ='3PL_Data'
#attachment_sql = ["""SELECT t.*FROM   (SELECT hub.hub,               sois.awb_nr,               hub.hub_sector,               hub.country_zone,               Date(sois.created_at) ship_dt,               pw.display_name,               city.name_en          city        FROM   noonltddwh.sales.sales_order_item_shipment sois               LEFT JOIN `noonltddwh.partner.partner_warehouse` pw                      ON sois.id_partner_warehouse_origin =                         pw.id_partner_warehouse               LEFT JOIN (SELECT awb_nr aw,                                 origin_hub                          FROM   `noonbilogmis.reporting.EG_Pending_Data`) pd                      ON pd.aw = sois.awb_nr               LEFT JOIN noonltddwh.sales.sales_order so USING(id_sales_order)               LEFT JOIN `noonltddwh.bqsync.customer_address` AS ca                      ON ca.address_code = so.address_code               LEFT JOIN `noonltddwh.ref.city` AS city                      ON ca.id_city = city.id_city               LEFT JOIN noonltddwh.lms.item i USING(awb_nr)               LEFT JOIN (SELECT id_item,                                 Min(ish.created_at) AS Total_lpc_Receiving                          FROM   `noonltddwh.lms.item_state_history` ish                                 LEFT JOIN `noonltddwh.lms.hub_location` hl                                        ON ( ish.id_loc_type, ish.loc_id ) = ( 1                                           ,                                           id_hub_location )                          WHERE  id_loc_type = 1                                 AND hl.code LIKE "%Z1%"                          GROUP  BY 1) t                      ON i.id_item = t.id_item               LEFT JOIN (SELECT id_item,                                 Max(ish.created_at) AS Total_hub_Receiving                          FROM   `noonltddwh.lms.item_state_history` ish                                 LEFT JOIN `noonltddwh.lms.hub_location` hl                                        ON ( ish.id_loc_type, ish.loc_id ) = ( 1                                           ,                                           id_hub_location )                          WHERE  id_loc_type = 1                                 AND hl.code NOT LIKE "%Z1%"                          GROUP  BY 1) t1                      ON t.id_item = t1.id_item                         AND total_hub_receiving > total_lpc_receiving               LEFT JOIN(SELECT awb_nr,                                hub.code          AS Hub,                                hub_sector.code   hub_sector,                                country_zone.code country_zone                         FROM   `noonltddwh.lms.client_pkg_ref` client_pkg_ref                                LEFT JOIN(SELECT *                                          FROM   `noonltddwh.lms.creq_leg`                                          WHERE  id_creq_leg_type = 3) AS                                         creq_leg                                USING (                                id_creq)                                LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector                                       ON hub_sector.id_hub_sector = creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub       ON hub_sector.id_hub = hub.id_hub LEFT JOIN noonltddwh.lms.country_zone country_zone USING(id_country_zone)) hub ON hub.awb_nr = i.awb_nr WHERE  Date(sois.created_at) >= Date_trunc(CURRENT_DATE() - 1, month) AND so.country_code = 'EG'AND hub.hub IS NOT NULL GROUP  BY 1,2,3,4,5,6,7) t LEFT JOIN(SELECT distinct i.awb_nr awb from `noonltddwh.lms.item_state_history` ish      left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)      left join `noonltddwh.lms.item` i using(id_item)where id_loc_type = 1 and hl.code like "%TPL%"    ) t1 on t.awb_nr = t1.awb WHERE  ship_dt >= Date_trunc(CURRENT_DATE() - 1, month)       AND        (hub LIKE '%T1' or t1.awb is not null)"""]
#body = ["""SELECT t.hub_sector, COUNT(1) Cnt FROM   (SELECT hub.hub,               sois.awb_nr,               hub.hub_sector,               hub.country_zone,               Date(sois.created_at) ship_dt,               pw.display_name,               city.name_en          city        FROM   noonltddwh.sales.sales_order_item_shipment sois               LEFT JOIN `noonltddwh.partner.partner_warehouse` pw                      ON sois.id_partner_warehouse_origin =                         pw.id_partner_warehouse               LEFT JOIN (SELECT awb_nr aw,                                 origin_hub                          FROM   `noonbilogmis.reporting.EG_Pending_Data`) pd                      ON pd.aw = sois.awb_nr               LEFT JOIN noonltddwh.sales.sales_order so USING(id_sales_order)               LEFT JOIN `noonltddwh.bqsync.customer_address` AS ca                      ON ca.address_code = so.address_code               LEFT JOIN `noonltddwh.ref.city` AS city                      ON ca.id_city = city.id_city               LEFT JOIN noonltddwh.lms.item i USING(awb_nr)               LEFT JOIN (SELECT id_item,                                 Min(ish.created_at) AS Total_lpc_Receiving                          FROM   `noonltddwh.lms.item_state_history` ish                                 LEFT JOIN `noonltddwh.lms.hub_location` hl                                        ON ( ish.id_loc_type, ish.loc_id ) = ( 1                                           ,                                           id_hub_location )                          WHERE  id_loc_type = 1                                 AND hl.code LIKE "%Z1%"                          GROUP  BY 1) t                      ON i.id_item = t.id_item               LEFT JOIN (SELECT id_item,                                 Max(ish.created_at) AS Total_hub_Receiving                          FROM   `noonltddwh.lms.item_state_history` ish                                 LEFT JOIN `noonltddwh.lms.hub_location` hl                                        ON ( ish.id_loc_type, ish.loc_id ) = ( 1                                           ,                                           id_hub_location )                          WHERE  id_loc_type = 1                                 AND hl.code NOT LIKE "%Z1%"                          GROUP  BY 1) t1                      ON t.id_item = t1.id_item                         AND total_hub_receiving > total_lpc_receiving               LEFT JOIN(SELECT awb_nr,                                hub.code          AS Hub,                                hub_sector.code   hub_sector,                                country_zone.code country_zone                         FROM   `noonltddwh.lms.client_pkg_ref` client_pkg_ref                                LEFT JOIN(SELECT *                                          FROM   `noonltddwh.lms.creq_leg`                                          WHERE  id_creq_leg_type = 3) AS                                         creq_leg                                USING (                                id_creq)                                LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector                                       ON hub_sector.id_hub_sector = creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub       ON hub_sector.id_hub = hub.id_hub LEFT JOIN noonltddwh.lms.country_zone country_zone USING(id_country_zone)) hub ON hub.awb_nr = i.awb_nr WHERE  Date(sois.created_at) >= Date_trunc(CURRENT_DATE() - 1, month) AND so.country_code = 'EG'AND hub.hub IS NOT NULL GROUP  BY 1,2,3,4,5,6,7) t LEFT JOIN(SELECT distinct i.awb_nr awb from `noonltddwh.lms.item_state_history` ish      left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)      left join `noonltddwh.lms.item` i using(id_item)where id_loc_type = 1 and hl.code like "%TPL%"    ) t1 on t.awb_nr = t1.awb WHERE  ship_dt = CURRENT_DATE()       AND        (hub LIKE '%T1' or t1.awb is not null) GROUP BY 1 union all SELECT 'Total' AS hub_sector, COUNT(1) Cnt FROM   (SELECT hub.hub,               sois.awb_nr,               hub.hub_sector,               hub.country_zone,               Date(sois.created_at) ship_dt,               pw.display_name,               city.name_en          city        FROM   noonltddwh.sales.sales_order_item_shipment sois               LEFT JOIN `noonltddwh.partner.partner_warehouse` pw                      ON sois.id_partner_warehouse_origin =                         pw.id_partner_warehouse               LEFT JOIN (SELECT awb_nr aw,                                 origin_hub                          FROM   `noonbilogmis.reporting.EG_Pending_Data`) pd                      ON pd.aw = sois.awb_nr               LEFT JOIN noonltddwh.sales.sales_order so USING(id_sales_order)               LEFT JOIN `noonltddwh.bqsync.customer_address` AS ca                      ON ca.address_code = so.address_code               LEFT JOIN `noonltddwh.ref.city` AS city                      ON ca.id_city = city.id_city               LEFT JOIN noonltddwh.lms.item i USING(awb_nr)               LEFT JOIN (SELECT id_item,                                 Min(ish.created_at) AS Total_lpc_Receiving                          FROM   `noonltddwh.lms.item_state_history` ish                                 LEFT JOIN `noonltddwh.lms.hub_location` hl                                        ON ( ish.id_loc_type, ish.loc_id ) = ( 1                                           ,                                           id_hub_location )                          WHERE  id_loc_type = 1                                 AND hl.code LIKE "%Z1%"                          GROUP  BY 1) t                      ON i.id_item = t.id_item               LEFT JOIN (SELECT id_item,                                 Max(ish.created_at) AS Total_hub_Receiving                          FROM   `noonltddwh.lms.item_state_history` ish                                 LEFT JOIN `noonltddwh.lms.hub_location` hl                                        ON ( ish.id_loc_type, ish.loc_id ) = ( 1                                           ,                                           id_hub_location )                          WHERE  id_loc_type = 1                                 AND hl.code NOT LIKE "%Z1%"                          GROUP  BY 1) t1                      ON t.id_item = t1.id_item                         AND total_hub_receiving > total_lpc_receiving               LEFT JOIN(SELECT awb_nr,                                hub.code          AS Hub,                                hub_sector.code   hub_sector,                                country_zone.code country_zone                         FROM   `noonltddwh.lms.client_pkg_ref` client_pkg_ref                                LEFT JOIN(SELECT *                                          FROM   `noonltddwh.lms.creq_leg`                                          WHERE  id_creq_leg_type = 3) AS                                         creq_leg                                USING (                                id_creq)                                LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector                                       ON hub_sector.id_hub_sector = creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub       ON hub_sector.id_hub = hub.id_hub LEFT JOIN noonltddwh.lms.country_zone country_zone USING(id_country_zone)) hub ON hub.awb_nr = i.awb_nr WHERE  Date(sois.created_at) >= Date_trunc(CURRENT_DATE() - 1, month) AND so.country_code = 'EG'AND hub.hub IS NOT NULL GROUP  BY 1,2,3,4,5,6,7) t LEFT JOIN(SELECT distinct i.awb_nr awb from `noonltddwh.lms.item_state_history` ish      left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)      left join `noonltddwh.lms.item` i using(id_item)where id_loc_type = 1 and hl.code like "%TPL%"    ) t1 on t.awb_nr = t1.awb WHERE  ship_dt = CURRENT_DATE()       AND        (hub LIKE '%T1' or t1.awb is not null) GROUP BY 1"""]
#recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
#sender = 'logistics-reporting@noon.com'



[[email]]
dag_id = 'LSv7'
task_id = 'Pending_Shipments_at_Hubs_v2'
name ='Pending Shipments at Hubs - EG Overall'
attachment_sql = ["""SELECT d.*, CASE WHEN aging_day < 6 THEN '0 to 5' WHEN aging_day > 5 and aging_day < 11 THEN '6 to 10' WHEN aging_day > 10 and aging_day < 13 THEN '11 to 12' WHEN aging_day > 12 THEN 'More than 12' end as aging_range,case when vip.awb_nr is not null then 'VIP' end as VIP_flag,case when NDD.awb_nr is not null then 'NDD' end as NDD_flag  FROM noonbilogmis.reporting.Pending_Shipments_at_Hubs_v1 d left join noonltddwh.lms.item i using(awb_nr) left join (SELECT id_item id from `noonltddwh.lms.item_state_history` where id_loc_type  = 18) t on t.id = i.id_item LEFT JOIN(SELECT awb_nr from noonltddwh.sales.sales_order_item_shipment sois left join noonltddwh.sales.sales_order using(id_sales_order) where upper(misc) like "%VIP%")vip on vip.awb_nr = d.awb_nr LEFT JOIN(SELECT awb_nr from noonltddwh.sales.sales_order_item_shipment sois left join noonltddwh.sales.sales_order using(id_sales_order) where upper(misc) like "%NDD%")NDD on NDD.awb_nr = d.awb_nr WHERE final_status NOT IN ('Lost Manifest','Shipped') and last_scan_location_hub NOT IN ('CAI-Z1') and t.id is null"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","shsherif@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSv9'
task_id = 'Pending_Shipments_at_LPC'
name ='Pending Shipments at LPC - EG Overall'
attachment_sql = ["""SELECT d.*,case when vip.awb_nr is not null then 'VIP' end as VIP_flag,case when NDD.awb_nr is not null then 'NDD' end as NDD_flag FROM noonbilogmis.reporting.Pending_Shipments_at_LPC d LEFT JOIN(SELECT awb_nr from noonltddwh.sales.sales_order_item_shipment sois left join noonltddwh.sales.sales_order using(id_sales_order) where upper(misc) like "%VIP%")vip on vip.awb_nr = d.awb_nr LEFT JOIN(SELECT awb_nr from noonltddwh.sales.sales_order_item_shipment sois left join noonltddwh.sales.sales_order using(id_sales_order) where upper(misc) like "%NDD%")NDD on NDD.awb_nr = d.awb_nr"""]
body = ["""SELECT Hub,COUNT(1) Total, SUM(CASE WHEN Final_Status NOT IN ('Held at Branch') AND Aging_Hour < 24  THEN 1 ELSE 0 END) Aging_0_1_Day ,SUM(CASE WHEN Final_Status NOT IN ('Held at Branch') AND Aging_Hour > 23 AND Aging_Hour < 48  THEN 1 ELSE 0 END) Aging_1_2_Day  ,SUM(CASE WHEN Final_Status NOT IN ('Held at Branch') AND Aging_Hour > 47 AND Aging_Hour < 72  THEN 1 ELSE 0 END) Aging_2_3_Day ,SUM(CASE WHEN Final_Status NOT IN ('Held at Branch') AND Aging_Hour > 72 THEN 1 ELSE 0 END) Aging_More_Than_3_Day FROM noonbilogmis.reporting.Pending_Shipments_at_LPC GROUP BY 1"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","moayman@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv7'
task_id = 'PDD_Breach_Report_MTD'
name ='PDD Breach Report - EG Overall'
attachment_sql = ["""SELECT d.*,Received_by_W2 FROM (SELECT Dispatch_Center Hub,Hub_sector,mt.awb_nr,hta_start_ts,created_at,timestamp_add(Received_by_LPC,interval 2 hour) Received_by_LPC ,timestamp_add(Received_by_Hub,interval 2 hour) Received_by_Hub,estimated_delivery_at PDD,tpl_flag, logistics_breach_ne logistics_breach_ne, Overall_Breach Overall_Breach, display_name, case when ndd_awb is not null then 'NDD' end as ndd_Flag, case when VIP_awb is not null then 'VIP' end as VIP_Flag, case when Loyalty_awb is not null then 'Loyalty' end as Loyalty_flag   FROM `noonbilogmis.reporting.PDD_Breach_Report_MTD_mail` mt LEFT JOIN (SELECT sois.awb_nr , pw.display_name  FROM noonltddwh.sales.sales_order_item_shipment sois left join `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse ) pw on pw.awb_nr = mt.awb_nr LEFT JOIN  (SELECT i1.awb_nr, hta_start_ts FROM (SELECT id_item,min(ish.created_at) created_at FROM `noonltddwh.lms.item_state_history` ish where  ish.id_loc_type = 3 GROUP BY 1 ) i INNER JOIN `noonltddwh.lms.item_state_history` ish on i.id_item = ish.id_item and i.created_at = ish.created_at  left join noonltddwh.lms.item i1 on i1.id_item = ish.id_item left join `noonbilogoi.LOGKSA_DATA.pgroup` pgroup on pgroup.id_item =  ish.loc_id left join noonltddwh.lms.hub_transfer ht on ht.hub_transfer_nr = pgroup.hta_start ) T ON T.awb_nr = mt.awb_nr LEFT JOIN(SELECT distinct sois.awb_nr ndd_awb FROM `noonltddwh.sales.sales_order_item_shipment` sois left join `noonltddwh.sales.sales_order` so using(id_sales_order) where upper(so.misc) like "%NDD%" ) NDD on mt.awb_nr = NDD.ndd_awb LEFT JOIN ( SELECT distinct sois.awb_nr VIP_awb FROM `noonltddwh.sales.sales_order_item_shipment` sois left join `noonltddwh.sales.sales_order` so using(id_sales_order) where upper(so.misc) like "%VIP%"  ) VIP on mt.awb_nr = VIP.VIP_awb LEFT JOIN (select distinct awb_nr Loyalty_awb from `noonltddwh.sales.sales_order_item` soi left join `noonltddwh.sales.sales_order` so using(id_sales_order) left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item LEFT JOIN noonltddwh.oms.purchase_item pi on pi.purchase_item_nr = poi.purchase_item_nr LEFT JOIN `noonltddwh.oms.stock_item` b USING (id_purchase_item) left join `noonltddwh.lms.item` using (awb_nr) where id_partner_warehouse_from= id_partner_warehouse_outbound and soi.id_invoice_section = 1 and so.id_cart_type = 1 and so.misc like "%vip%" and lower(json_extract(item_misc, '$.shipping_preferences.ndd')) like "%true%" ) Loyalty on mt.awb_nr = Loyalty.Loyalty_awb WHERE estimated_delivery_at >= DATE_TRUNC(CURRENT_DATE() -1, MONTH)) d LEFT JOIN `noonbilogmis.reporting.EG_Pending_Data`  pd on d.awb_nr = pd.awb_nr LEFT JOIN( select awb_nr,min(timestamp_add(ish.created_at,interval 2 hour)) as Received_by_W2 from `noonltddwh.lms.item_state_history` ish LEFT JOIN noonltddwh.lms.creq_leg cl using(id_creq_leg) left join `noonltddwh.lms.hub_location` hl on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code like "%W2%" group by 1 ) as hubw2 on pd.awb_nr=hubw2.awb_nr"""]
body = ["""SELECT Dispatch_Center,estimated_delivery_at PDD, SUM(total_shippable_awb_ne) total_shippable_awb_ne, SUM(logistics_breach_ne) logistics_breach_ne, concat(round(((sum(logistics_breach_ne)*100)/ SUM(total_shippable_awb_ne)),2),'%') FROM `noonbilogmis.reporting.PDD_Breach_Report_MTD_mail` WHERE estimated_delivery_at = DATE_add(current_date(),interval -1 day) GROUP BY 1,2"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","sraut@noon.com","shsherif@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","dsaad@noon.com","karkhalifa@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


#[[email]]
#dag_id = 'LSv7'
#task_id = 'Damage_Lost_Report_MTD'
#name ='Damage and Lost Report MTD - EG Overall'
#attachment_sql = ["""SELECT DISTINCT Substr(cu.code, 0, 6) Hub,cu.code               hub_sector,                awb_nr,                u.username,clt.code leg_type,                ish.created_at        Update_Date,                'Damage'              AS Flag FROM   (SELECT id_item_state_history_o FROM (SELECT ish.id_creq_leg,id_item, id_item_state_history id_item_state_history_o, row_number()over(partition by id_item order by ish.created_At) rw FROM `noonltddwh.lms.item_state_history` ish LEFT JOIN `noonltddwh.lms.hub_location` hl    ON id_hub_location = loc_id WHERE hl.code LIKE "%DMG%") WHERE rw = 1) t INNER JOIN `noonltddwh.lms.item_state_history` ish ON t.id_item_state_history_o = ish.id_item_state_history       LEFT JOIN `noonltddwh.lms.user` u              ON ish.id_user_updater = u.id_user       LEFT JOIN `noonltddwh.lms.hub_location` hl              ON id_hub_location = loc_id       LEFT JOIN `noonltddwh.lms.hub` h USING (id_hub)       LEFT JOIN `noonltddwh.lms.item` USING (id_item)       LEFT JOIN `noonltddwh.lms.client_pkg_ref` USING (awb_nr)       LEFT JOIN `noonltddwh.lms.creq` c USING (id_creq)       LEFT JOIN `noonltddwh.lms.creq_leg` cl on cl.id_creq_leg = ish.id_creq_leg       LEFT JOIN `noonltddwh.lms.creq_leg_type` clt using(id_creq_leg_type)       LEFT JOIN `noonltddwh.sales.sales_order`              ON order_nr = client_ref       LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois USING (awb_nr)       LEFT JOIN `noonltddwh.sales.sales_order_item` soi              ON sois.id_sales_order_item_shipment                 = soi.id_sales_order_item_shipment       LEFT JOIN `noonltddwh.ref.sales_order_item_status` istatus              ON istatus.id_sales_order_item_status                 = soi.id_sales_order_item_status       LEFT JOIN `noonbilogoi.battleplan_v1.item_final_state` USING (awb_nr)       LEFT JOIN(SELECT sh.id_item id,                        hl.code                 FROM   (SELECT Max(sh.id_item_state_history) id_item_state_his,                                id_item                       id                         FROM   `noonltddwh.lms.item_state_history` sh                                INNER JOIN noonltddwh.lms.item i USING(id_item)                                LEFT JOIN `noonltddwh.lms.hub_location` hl                                       ON ( sh.id_loc_type, sh.loc_id ) = ( 1,                                         id_hub_location )                         WHERE  sh.id_loc_type = 1                                AND hl.code NOT LIKE ( '%DMG%' )                         GROUP  BY 2) T                        INNER JOIN `noonltddwh.lms.item_state_history` sh                                ON T.id_item_state_his =                                   sh.id_item_state_history                                   AND t.id = sh.id_item                        LEFT JOIN `noonltddwh.lms.hub_location` hl                               ON ( sh.id_loc_type, sh.loc_id ) =                                  ( 1, id_hub_location )                 WHERE  sh.id_loc_type = 1                        AND hl.code NOT LIKE '%DMG%') cu              ON cu.id = ish.id_item WHERE  id_loc_type = 1       AND hl.code LIKE "%DMG%"       AND Date(ish.created_at) >= Date_add(Date_trunc(CURRENT_DATE(), month),                                   INTERVAL -1 day)       AND country_code = 'EG' ORDER  BY 1,          2 ""","""select distinct substr(cu.hub_sector,0,6) Hub,cu.hub_sector hub_sector,Last_loc_s,item.awb_nr ,username,Lost_dt ,CASE WHEN manifest.created_At IS NULL THEN item_state_history.created_at ELSE manifest.created_At END AS Update_Date,'Lost' AS Flag ,man.manifest_nr , man.manifested_type from `noonltddwh.lms.item` as item left join (SELECT sh.id_item , sh.created_at Lost_dt FROM (SELECT sh.id_item,MAX(sh.created_at) Lost_dt FROM            `noonltddwh.lms.item_state_history` sh           left join `noonltddwh.lms.hub_location`  hl  on (sh.id_loc_type,sh.loc_id) = (1,id_hub_location)      where     sh.id_loc_type = 1 GROUP BY 1) T INNER JOIN `noonltddwh.lms.item_state_history` sh  on t.id_item = sh.id_item and T.Lost_dt = sh.created_at          left join `noonltddwh.lms.hub_location`  hl  on (sh.id_loc_type,sh.loc_id) = (1,id_hub_location)           where     sh.id_loc_type = 1 and hl.code like '%LOST%') lost using(id_item) left join `noonltddwh.lms.item_state` as item_state using(id_item)left join `noonltddwh.lms.item_pkg` as item_pkg using (id_item)left join `noonltddwh.lms.creq_leg` as creq_leg using (id_creq_leg)LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub left join `noonltddwh.lms.creq` as creq using (id_creq) left join `noonltddwh.lms.country_zone` as country_zone using (id_country_zone)left join (select * from  `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_legx using (id_creq)LEFT JOIN(SELECT    sh.id_item id, hl.code hub_sector FROM     (SELECT    MAX(sh.id_item_state_history) id_item_state_his ,id_item id FROM      `noonltddwh.lms.item_state_history` sh left join `noonltddwh.lms.hub_location`  hl  on (sh.id_loc_type,sh.loc_id) = (1,id_hub_location) where     sh.id_loc_type = 1 and     hl.code not like ('%LOST%') group by 2          ) T INNER JOIN           `noonltddwh.lms.item_state_history` sh ON T.id_item_state_his = sh.id_item_state_history and t.id = sh.id_item          left join `noonltddwh.lms.hub_location`  hl  on (sh.id_loc_type,sh.loc_id) = (1,id_hub_location)           where     sh.id_loc_type = 1        and     hl.code not like '%LOST%') cu ON cu.id = item.id_item left join (SELECT s.*,u.username FROM `noonltddwh.lms.item_state_history` s INNER JOIN(SELECT id_item,MAX(created_at) c FROM `noonltddwh.lms.item_state_history` GROUP BY 1)T ON T.id_item = s.id_item and T.c = s.created_at LEFT JOIN `noonltddwh.lms.user` u ON s.id_user_updater = u.id_user)as item_state_history using(id_item)left join `noonltddwh.lms.hub_location` as hub_location  on  (1,hub_location.id_hub_location)=(item_state_history.id_loc_type,item_state_history.loc_id) left join `noonltddwh.lms.manifest_item` as manifest_item using (id_item) left join (select * from  `noonltddwh.lms.manifest` where id_manifest_type =5) as manifest using (id_manifest) left join(SELECT i.awb_nr , ish.created_at , m.manifest_nr , mt.code manifested_type FROM (SELECT id_item,MAX(created_at )created_at FROM `noonltddwh.lms.item_state_history` ish WHERE id_loc_type = 5 GROUP BY 1) t INNER JOIN `noonltddwh.lms.item_state_history`  ish ON t.id_item = ish.id_item and ish.created_at = t.created_at left join noonltddwh.lms.item i on ish.id_item = i.id_item left join `noonltddwh.lms.manifest` m on ish.loc_id = m.id_manifest left join `noonltddwh.lms.manifest_type` mt using(id_manifest_type)) man on item.awb_nr = man.awb_nr and Lost_dt <= man.created_at LEFT JOIN (SELECT i.awb_nr , hl.code Last_loc_s FROM (SELECT ish.id_item,MAX(ish.created_at) created_at from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) where ish.id_loc_type = 1 GROUP by 1) T INNER JOIN `noonltddwh.lms.item_state_history` ish on t.id_item = ish.id_item and T.created_at = ish.created_at left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join noonltddwh.lms.item i on ish.id_item = i.id_item where ish.id_loc_type = 1 ) Last_loc ON Last_loc.awb_nr = item.awb_nr where item.id_item_type=1 and creq_legx.id_creq_leg is not null and creq.id_creq_type =1 AND substr(country_zone.code,0,2) = 'EG' and lost.id_item is not null and DATE(Lost_dt) >= date_add(DATE_TRUNC(CURRENT_DATE(), MONTH),interval -1 day)"""]
#recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","shsherif@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","megasser@noon.com","Msaid@noon.com","assayed@noon.com","assayed@noon.com","mwafaey@noon.com"]
#sender = 'logistics-reporting@noon.com'



[[email]]
dag_id = 'LSv8to4'
task_id = 'Today_PDD_first'
name ='Today PDD Breach Report pending FA - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.PDD_Breach_Report_today_rawdata"""]
body = ["""WITH D AS (SELECT  substr(hub_sector,0,6) Hub,COUNT(DISTINCT awb_nr) Total_Count, COUNT(DISTINCT CASE WHEN t.OFD_Date IS NOT NULL THEN awb_nr END) AS OFD_Today_Hub ,COUNT(DISTINCT awb_nr) - COUNT(DISTINCT CASE WHEN t.OFD_Date IS NOT NULL THEN awb_nr END) AS Pending_OFD, COUNT(DISTINCT CASE WHEN Received_by_Hub IS NULL THEN awb_nr END) AS Not_received_By_Hub, COUNT(DISTINCT CASE WHEN DATE(Received_by_Hub) = current_Date()  THEN awb_nr END) AS received_By_Hub_today, COUNT(DISTINCT CASE WHEN DATE(Received_by_Hub) = current_Date()-1  THEN awb_nr END) AS received_By_Hub_Yesterday, COUNT(DISTINCT CASE WHEN DATE(Received_by_Hub) < current_Date()-1  THEN awb_nr END) AS received_By_Hub_Before_Yesterday FROM noonbilogmis.reporting.PDD_Breach_Report_today p LEFT JOIN (SELECT distinct awb_nr awb,MAX(OFD_date) OFD_date FROM noonbilogoi.MJ.OFD GROUP BY 1)  t ON t.awb = p.awb_nr GROUP BY 1)SELECT 1 as raw,'Total' AS Hub,SUM(Total_Count) Total_Count,SUM(OFD_Today_Hub) OFD_Today_Hub,SUM(Pending_OFD) Pending_OFD,SUM(Not_received_By_Hub) Not_received_By_Hub,SUM(received_By_Hub_today) AS received_By_Hub_today,SUM(received_By_Hub_Yesterday) received_By_Hub_Yesterday,SUM(received_By_Hub_Before_Yesterday) received_By_Hub_Before_Yesterday  FROM D UNION ALL SELECT 2 as raw, * FROM D order by raw"""]
recipients = ["lsharma@noon.com","sraut@noon.com","mshawky@noon.com","sraut@noon.com","mahamza@noon.com","Msaid@noon.com","mwafaey@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","dsaad@noon.com","log-egy@noon.com","mshokr@noon.com","karkhalifa@noon.com","CAI01_Hub@noon.com","amrhafez@noon.com","CAI-A3_Hub@noon.com","CAI-A9_hub@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LS_101214'
task_id = 'CIR_Monitoring'
name ='CIR Monitoring - EG Overall'
attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.CIR_Monitoring`"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","dsaad@noon.com","mwafaey@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSv7'
task_id = 'RTV_Performance'
name ='RTV_Performance - EG Overall'
attachment_sql = ["""SELECT Hub,username,ofd_date,awb_nr,Delivered,	Undelivered,	ofd_status FROM  noonbilogmis.reporting.RTV_Performance_OFD  where ofd_date >= DATE_TRUNC(CURRENT_DATE()-1, MONTH)"""]
body = ["""SELECT Hub,username,ofd_date,SUM(Delivered)Delivered,	SUM(Undelivered) Undelivered	 FROM noonbilogmis.reporting.RTV_Performance_OFD where ofd_date =CURRENT_DATE()-1 group by 1,2,3"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","usingal@noon.com","npaliwal@noon.com","mwafaey@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'




# [[email]]
# dag_id = 'LSv7'
# task_id = 'ASN_Performance_OFD'
# name ='ASN Performance - EG Overall'
# attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.ASN_Performance_OFD` o WHERE o.OFD_dt >= DATE_TRUNC(CURRENT_DATE()-1, MONTH)""","""SELECT * FROM `noonbilogmis.reporting.ASN_Performance_OFD` o WHERE o.OFD_dt = CURRENT_DATE()-1"""]
# recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","usingal@noon.com","mwafaey@noon.com","Msaid@noon.com"]
# sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSItem'
task_id = 'Item_shipment_count'
name ='Item shipment count'
attachment_sql = ["""SELECT DATE(sois.created_At) ship_date,display_name,case when zpick.code like "%-N-%" then "NonSort" else "Sort" end as Non_Sort_Flag, COUNT(distinct id_Sales_order_item) Itn_cnt,COUNT(distinct awb_nr) Awb_cnt from  `noonltddwh.sales.sales_order_item` soi left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment left join `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse  left join `noonltddwh.wms.exdoc_line` on exdoc_line_ref = item_nr left join `noonltddwh.wms.doc_line` dl using (id_exdoc_line) left join `noonltddwh.wms.job_line` jl on jl.id_doc_line_source = dl.id_doc_line left join  noonltddwh.wms.location lpick ON   jl.id_location_pick=lpick.id_location left join  noonltddwh.wms.zone zpick ON  lpick.id_zone=zpick.id_zone WHERE  sois.id_carrier  = 9 and DATE(sois.created_At) >=  DATE_TRUNC(CURRENT_DATE()-1, MONTH)  and so.country_code = 'EG'and id_cart_type =1 and id_invoice_section =1 group by 1,2,3""","""SELECT DATE(sois.created_At) ship_date,display_name,case when zpick.code like "%-N-%" then "NonSort" else "Sort" end as Non_Sort_Flag, COUNT(distinct id_Sales_order_item) Itn_cnt,COUNT(distinct awb_nr) Awb_cnt from  `noonltddwh.sales.sales_order_item` soi left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment left join `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse  left join `noonltddwh.wms.exdoc_line` on exdoc_line_ref = item_nr left join `noonltddwh.wms.doc_line` dl using (id_exdoc_line) left join `noonltddwh.wms.job_line` jl on jl.id_doc_line_source = dl.id_doc_line left join  noonltddwh.wms.location lpick ON   jl.id_location_pick=lpick.id_location left join  noonltddwh.wms.zone zpick ON  lpick.id_zone=zpick.id_zone WHERE  sois.id_carrier  = 9 and DATE(sois.created_At) = CURRENT_DATE()-1  and so.country_code = 'EG'and id_cart_type =1 and id_invoice_section =1 group by 1,2,3"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Mshawky@noon.com","mwafaey@noon.com","karkhalifa@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSEv13'
task_id = 'Bagging_Compliance'
name ='Bagging Compliance FWD - EG Overall'
attachment_sql = ["""SELECT * FROM `noonbilogmis.reporting.Bagging_compliance`   where ofd_date >= DATE_TRUNC(CURRENT_DATE()-1, MONTH)"""]
body = ["""SELECT Hub,Bagging_Yes,Bagging_No,Total,Inventory_Yes,Inventory_No,Bagging,Inventory FROM (SELECT 1 as d, Hub, SUM(CASE WHEN bagging_check = 'Yes' THEN 1 ELSE 0 END) AS Bagging_Yes,SUM(CASE WHEN bagging_check = 'No' THEN 1 ELSE 0 END) AS Bagging_No,COUNT(1) Total,SUM(CASE WHEN inventory_Check = 'Yes' THEN 1 ELSE 0 END) AS Inventory_Yes,SUM(CASE WHEN inventory_Check = 'No' THEN 1 ELSE 0 END) AS Inventory_No,Concat(CAST(ROUND((SUM(CASE WHEN bagging_check = 'Yes' THEN 1 ELSE 0 END)/COUNT(1))*100,2) AS String),"%") AS Bagging,Concat(CAST(ROUND((SUM(CASE WHEN inventory_Check = 'Yes' THEN 1 ELSE 0 END)/COUNT(1))*100,2) AS String) , '%') AS Inventory FROM `noonbilogmis.reporting.Bagging_compliance` where ofd_date = CURRENT_DATE() and Hub is not null and Hub not in ('CAI-Y2') GROUP BY 1 ,2 union all SELECT 2 as d, 'total' AS Hub, SUM(CASE WHEN bagging_check = 'Yes' THEN 1 ELSE 0 END) AS Bagging_Yes,SUM(CASE WHEN bagging_check = 'No' THEN 1 ELSE 0 END) AS Bagging_No,COUNT(1) Total,SUM(CASE WHEN inventory_Check = 'Yes' THEN 1 ELSE 0 END) AS Inventory_Yes,SUM(CASE WHEN inventory_Check = 'No' THEN 1 ELSE 0 END) AS Inventory_No,Concat(CAST(ROUND((SUM(CASE WHEN bagging_check = 'Yes' THEN 1 ELSE 0 END)/COUNT(1))*100,2) AS String),"%") AS Bagging,Concat(CAST(ROUND((SUM(CASE WHEN inventory_Check = 'Yes' THEN 1 ELSE 0 END)/COUNT(1))*100,2) AS String) , '%') AS Inventory FROM `noonbilogmis.reporting.Bagging_compliance` where ofd_date = CURRENT_DATE() and Hub is not null and Hub not in ('CAI-Y2') GROUP BY 1 ,2) order by d"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","mwafaey@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSEv13'
task_id = 'Bagging_Compliance_CIR'
name ='Bagging Compliance CIR - EG Overall'
attachment_sql = ["""SELECT DATE(returned_TS) Date, fwd_hub Hub,COUNT(DISTINCT client_ref) Total_Count, COUNT(DISTINCT CASE WHEN GB_nr IS NOT NULL THEN client_ref END) AS NoCompliance , COUNT(DISTINCT CASE WHEN GB_nr IS NULL THEN client_ref END)/ COUNT(DISTINCT client_ref) Compliane_Per  	 FROM noonbilogoi.reporting_mart.bagging_compliance where country = "eg" and DATE(returned_TS) > date_add(DATE_TRUNC(CURRENT_DATE(), MONTH),interval -1 day) and substr(client_ref,0,3) = 'RNE' GROUP BY 1,2""","""SELECT * FROM noonbilogoi.reporting_mart.bagging_compliance where country = "eg" and DATE(returned_TS) = CURRENT_DATE()-1 and GB_nr IS NULL and substr(client_ref,0,3) = 'RNE'"""]
body = ["""SELECT DATE(returned_TS) Date, fwd_hub Hub,COUNT(DISTINCT client_ref) Total_Count, COUNT(DISTINCT CASE WHEN GB_nr IS NULL THEN client_ref END) AS NoCompliance , Concat(ROUND(COUNT(DISTINCT CASE WHEN GB_nr IS NOT NULL THEN client_ref END)/ COUNT(DISTINCT client_ref)*100,2),'%') Total_Count  	 FROM noonbilogoi.reporting_mart.bagging_compliance where country = "eg" and DATE(returned_TS) = CURRENT_DATE()-1 and substr(client_ref,0,3) = 'RNE' GROUP BY 1,2"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","mwafaey@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'





[[email]]
dag_id = 'LSv7'
task_id = 'FA_EG'
name ='FA% EG - Reporting'
attachment_sql = ["""SELECT ofd.hub,ofd.hub_sector , ofd.ofd_date,hubr.hub_subsector ,  ofd.end_status , ofd.awb_nr, WH_Code, Payment_Method  FROM (SELECT id_item, MIN(d.created_at) created_at FROM `noonltddwh.lms.session_field_item` d GROUP BY 1) T INNER JOIN `noonltddwh.lms.session_field_item` sfi on T.id_item = sfi.id_item and T.created_at = sfi.created_at INNER JOIN noonltddwh.lms.item ie ON sfi.id_item = ie.id_item   INNER JOIN `noonbilogmis.reporting.OFD_Forward` ofd on ie.awb_nr = ofd.awb_nr and DATE(sfi.created_at ) = ofd.ofd_date LEFT JOIN ( SELECT client_pkg_ref.awb_nr , hub.code as Hub,hss.code hub_subsector,ifs.display_name WH_Code,Payment_Method from `noonltddwh.lms.client_pkg_ref` client_pkg_ref     left join `noonbilogoi.battleplan_v1.item_final_state` ifs on ifs.awb_nr = client_pkg_ref.awb_nr left join ( select  DISTINCT item.awb_nr awb_nr,case when cod_value is not null then "COD" else "Prepaid" end as Payment_Method from `noonltddwh.lms.item` item left join `noonltddwh.lms.item_pkg` item_pkg using (id_item) )NP on NP.awb_nr = client_pkg_ref.awb_nr LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub left join `noonltddwh.lms.hub_subsector` hss using(id_hub_subsector) ) Hubr ON ie.awb_nr = hubr.awb_nr  WHERE DATE(ofd.ofd_date ) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH) GROUP BY 1,2,3,4,5,6,7,8"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","shsherif@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSETv15'
task_id = 'Last_Scan_Stock_Recon'
name ='Last Scan - Stock Recon EG'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.last_scan_stock_recon"""]
body = ["""SELECT hub, COUNT(awb_nr) P1 FROM `noonbilogmis.reporting.last_scan_stock_recon` WHERE Hub not in ('CAI-X9','CAI-Y1','CAI-Y2','CAI-Z1','DXB-G2','DXB-Y4','JED-Y3','TEST-A1')AND priority = 'P1' GROUP BY 1 UNION ALL SELECT 'total' as hub, COUNT(awb_nr) P1 FROM `noonbilogmis.reporting.last_scan_stock_recon` WHERE Hub not in ('CAI-X9','CAI-Y1','CAI-Y2','CAI-Z1','DXB-G2','DXB-Y4','JED-Y3','TEST-A1')AND priority = 'P1' GROUP BY 1"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","shsherif@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","mwafaey@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv9'
task_id = 'CIR_Picked_Not_to_LPC_or_WH'
name ='CIR Picked Not to LPC or WH'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.CIR_Picked_Not_WH"""]
recipients = ["lsharma@noon.com","mshawky@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","mwafaey@noon.com","Msaid@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSv12'
task_id = 'LPC_receving_from_WH'
name ='LPC receving from WH EG'
attachment_sql = ["""select  DATE(LPC_time) Dt,hl.code LPC,display_name,hub_sector,substr(pw.display_name,6,11) warehouse_name, count(distinct i.awb_nr ) Cnt from (SELECT ish.id_item,MIN(ish.created_at) LPC_time FROM `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) WHERE id_loc_type = 1 and (hl.code like "%Z1%" or hl.code like "%Z2%" OR hl.code LIKE "%Z3%") GROUP BY 1) t INNER JOIN `noonltddwh.lms.item_state_history` ish ON ish.id_item = t.id_item and ish.created_at = t.LPC_time left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` i ON i.id_item = t.id_item LEFT JOIN `noonltddwh.sales.sales_order_item_shipment`  sois ON sois.awb_nr = i.awb_nr LEFT JOIN noonltddwh.sales.sales_order so using(id_sales_order) LEFT JOIN `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse LEFT JOIN( SELECT awb_nr , hub.code as Hub,hub_sector.code as hub_sector from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub) Hubr ON Hubr.awb_nr = sois.awb_nr  where id_loc_type = 1 and (hl.code like "%Z1%" OR hl.code like "%Z2%" OR hl.code LIKE "%Z3%") AND DATE(LPC_time) >= date_add(current_date,interval -30 day) and so.country_code = 'EG' GROUP BY 1,2,3,4"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","moayman@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSv12'
task_id = 'Fake_Attempt_Report_EG'
name ='Fake_Attempt_Report_EG'
attachment_sql = ["""select * from noonbilogmis.reporting.Fake_Attempt_Report_MTD where  country = 'eg' ORDER BY 1"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSEv10'
task_id = 'RTO_LPC_TO_WH'
name ='MTD RTO EG'
attachment_sql = ["""SELECT awb_nr,RTO_LegDate,Final_Status,hub,current_location,location_type,location_entity,Received_by_hub, CASE WHEN ti <24 THEN '0-24' WHEN ti >23 and ti < 48 THEN '24-48' WHEN ti >47 and ti < 72 THEN '48-72' WHEN ti >71  THEN '>72' END AS Aging FROM (SELECT *, timestamp_diff(current_timestamp,Received_by_hub,hour) ti FROM (SELECT awb_nr , RTO_LegDate, Final_Status,hubrr.hub,current_location,location_type,location_entity	, MIN(Received_by_hub) Received_by_hub FROM `noonbilogmis.reporting.EG_Pending_Data`  d LEFT JOIN (select awb_nr awb1,ish.created_at as Received_by_hub from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code like "%Z1%" ) as hubr on d.awb_nr=hubr.awb1 and hubr.Received_by_hub >= RTO_LegDate LEFT JOIN (SELECT i.awb_nr awb2 , substr(hl.code,0,6) Hub FROM (select id_item,MAX(ish.created_at) as Received_by_hub from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 GROUP BY 1) T INNER JOIN  `noonltddwh.lms.item_state_history` ish ON t.id_item = ish.id_item and T.Received_by_hub = ish.created_at left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` i on i.id_item = ish.id_item where id_loc_type = 1 ) as hubrr on d.awb_nr=hubrr.awb2 where RTO_LegDate is not null and carrier_change = 'No' and creq_leg_type = 'RTO' and substr(CountryZone,0,2) = 'EG' and Final_Status NOT IN ('Returned_to_CFC','RTO Pending for Dispatch') and Received_by_hub is not null GROUP BY 1,2,3,4,5,6,7)) T"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","moayman@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'






[[email]]
dag_id = 'LSv9'
task_id = 'Wrong_Sort_EG'
name ='Wrong Sort EG'
attachment_sql = ["""SELECT * FROM(SELECT *,case when UnDelivereReason IN ('address_changed','address_misrouted') or held_reason IN ('address_changed','address_misrouted') then 1 else 0 end as flag FROM `noonbilogmis.reporting.EG_Pending_Data` d LEFT JOIN( SELECT  i.awb_nr awb2, Received_by_hub,hl.code Hub1 FROM(select id_item,MAX(ish.created_at) as Received_by_hub from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) where id_loc_type = 1 and hl.code not like "%Z1%" group by 1 ) T INNER JOIN `noonltddwh.lms.item_state_history` ish on T.id_item = ish.id_item and T.Received_by_hub = ish.created_at left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join noonltddwh.lms.item i on ish.id_item = i.id_item where id_loc_type = 1 and hl.code not like "%Z1%" ) as hubr on d.awb_nr=hubr.awb2 LEFT JOIN(SELECT i.awb_nr awb1,MAX(ish.created_At) DD  from `noonltddwh.lms.item_state_history` ish left join noonltddwh.lms.item i on ish.id_item = i.id_item  where id_loc_type = 4 and DATE(ish.created_at) < current_Date -1 group by 1)t on t.awb1 = d.awb_nr where current_location <> destination_hub and location_type = 'hub_location' and d.country = 'eg' and carrier_change = 'No' and current_location not like '%Z1' and DATE(Received_by_hub) = current_date -1 and t.awb1 is null) T where flag = 0"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv9'
task_id = 'Transit_Shipments_To_LPC'
name ='Transit Shipments To LPC EG'
attachment_sql = ["""SELECT T.*,substr(H.code,0,6) Hub_from,substr(H1.code,0,6) Hub_to FROM (SELECT distinct fd.awb_nr  , creq_nr,created_at, promised_at, CASE WHEN hubr.hub IS NULL THEN destination_hub ELSE substr(hubr.hub,0,6) END AS hub , Final_Status, location_entity,CASE WHEN timestamp_diff(current_timestamp,ct,HOur ) < 24 THEN '0-24' WHEN timestamp_diff(current_timestamp,ct,HOur ) > 23 and timestamp_diff(current_timestamp,ct,HOur )< 48 THEN '24-48' WHEN timestamp_diff(current_timestamp,ct,HOur ) > 47 and timestamp_diff(current_timestamp,ct,HOur ) < 72 THEN '48-72' WHEN timestamp_diff(current_timestamp,ct,HOur ) > 71  THEN '>72' END AS Ageing_Range ,timestamp_diff(current_timestamp,ct,HOur ) Ageing_Hours FROM `noonbilogmis.reporting.EG_Pending_Data` fd left join `noonbilogoi.LOGKSA_DATA.pgroup` p on p.hta_start = fd.location_entity LEFT JOIN (SELECT awb_nr,MAX(ish.created_At) ct from `noonltddwh.lms.item_state_history` ish left join noonltddwh.lms.item i using(id_item) WHERE id_loc_type = 4 GROUP BY 1) T ON T.awb_nr = fd.awb_nr LEFT JOIN(SELECT awb_nr , hl.code hub FROM (select id_item,MAX(ish.created_at) as Received_by_hub from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code not like "%Z1%" group by 1 ) t INNER JOIN `noonltddwh.lms.item_state_history` ish ON ish.id_item = t.id_item and t.Received_by_hub = ish.created_at left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` i ON i.id_item = ish.id_item where id_loc_type = 1 and hl.code not like "%Z1%" ) as hubr on fd.awb_nr=hubr.awb_nr where location_type = 'hub_transfer' and fd.country = 'eg') T left join `noonltddwh.lms.hub_transfer` ht ON T.location_entity = ht.hub_transfer_nr LEFT JOIN noonltddwh.lms.hub h on ht.id_hub_src = h.id_hub LEFT JOIN noonltddwh.lms.hub h1 on ht.id_hub_dst = h1.id_hub WHERE H1.code LIKE '%Z1%'"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","moayman@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'LSv12'
task_id = 'ASN_TAT_EG'
name ='ASN TAT EG'
attachment_sql = ["""SELECT Hub, PERCENTILE_CONT(created_to_Pick, 0.9 RESPECT NULLS) OVER(PARTITION BY HUB)created_to_Pick, PERCENTILE_CONT(created_to_FA, 0.9 RESPECT NULLS) OVER(PARTITION BY HUB)created_to_FA FROM (SELECT substr(hs.code,0,6) Hub,creq.creq_nr ,creq.created_at,Pickup_dt,FirstAttempt,timestamp_diff(Pickup_dt,creq.created_at ,Hour) created_to_Pick,timestamp_diff(FirstAttempt,creq.created_at ,hour) created_to_FA FROM noonltddwh.lms.creq creq LEFT JOIN noonltddwh.lms.creq_leg creq_leg using(id_creq)left join `noonltddwh.lms.country_zone` cz using(id_country_zone)left join `noonltddwh.lms.hub_sector` hs using(id_hub_sector)left join (select creq_nr,min(FA) as FirstAttempt from (select *from (SELECT creq_nr, MIN(creq_leg_history.created_at) as FA FROM `noonltddwh.lms.creq` creqLEFT JOIN `noonltddwh.lms.creq_leg`USING (id_creq)LEFT JOIN ( SELECT   *,   json_EXTRACT(data,     '$.num_attempts')='1' AS attempt FROM   `noonltddwh.lms.creq_leg_history`) creq_leg_history USING (id_creq_leg)WHERE attempt=true GROUP BY 1) union all (select creq_nr,min(manifest.created_at) as FA from `noonltddwh.lms.creq` creq left join `noonltddwh.lms.manifest` as manifest using (id_creq) where id_manifest_type=1 group by 1) ) group by 1) using (creq_nr)LEFT JOIN(SELECT creq.creq_nr ,MIN(creq_leg.created_at) Pickup_dt FROM noonltddwh.lms.creq creq LEFT JOIN noonltddwh.lms.creq_leg creq_leg using(id_creq)where id_creq_type = 4 and id_creq_leg_type = 2 group by 1) pick on pick.creq_nr = creq.creq_nr WHERE id_creq_type = 4 and id_creq_leg_type = 1 and substr(cz.code,0,2) = 'EG'and date(creq.created_at ) >=   DATE_TRUNC(CURRENT_DATE() -1, MONTH) and date(creq.created_at ) <= current_Date -1 and pick.creq_nr is not null)""","""SELECT substr(hs.code,0,6) Hub,creq.creq_nr ,creq.created_at,Pickup_dt,FirstAttempt,timestamp_diff(Pickup_dt,creq.created_at ,Hour) created_to_Pick,timestamp_diff(FirstAttempt,creq.created_at ,hour) created_to_FA FROM noonltddwh.lms.creq creq LEFT JOIN noonltddwh.lms.creq_leg creq_leg using(id_creq) left join `noonltddwh.lms.country_zone` cz using(id_country_zone) left join `noonltddwh.lms.hub_sector` hs using(id_hub_sector)left join (select creq_nr,min(FA) as FirstAttempt from (select *from (SELECT creq_nr, MIN(creq_leg_history.created_at) as FA FROM `noonltddwh.lms.creq` creq LEFT JOIN `noonltddwh.lms.creq_leg` USING (id_creq) LEFT JOIN (SELECT   *,   json_EXTRACT(data,     '$.num_attempts')='1' AS attempt FROM  `noonltddwh.lms.creq_leg_history`) creq_leg_history USING(id_creq_leg) WHERE attempt=true GROUP BY  1) union all (select creq_nr,min(manifest.created_at) as FA from `noonltddwh.lms.creq` creq  left join `noonltddwh.lms.manifest` as manifest using (id_creq)  where id_manifest_type=1 group by 1) ) group by 1 ) using (creq_nr) LEFT JOIN(SELECT creq.creq_nr ,MIN(creq_leg.created_at) Pickup_dt   FROM noonltddwh.lms.creq creq LEFT JOIN noonltddwh.lms.creq_leg creq_leg using(id_creq) where id_creq_type = 4 and id_creq_leg_type = 2 group by 1) pick on pick.creq_nr = creq.creq_nr WHERE id_creq_type = 4 and id_creq_leg_type = 1 and substr(cz.code,0,2) = 'EG'and date(creq.created_at ) >=   DATE_TRUNC(CURRENT_DATE() -1, MONTH) and date(creq.created_at ) <= current_Date -1 and pick.creq_nr is not null"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","usingal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv12'
task_id = 'VIP_EG'
name ='VIP Shipment EG'
attachment_sql = ["""SELECT sois.awb_nr ,DATE(so.created_at ) ord,DATE(sois.created_at ) ship_dt,end_status OFD_status,timestamp_add(Received_by_hub,interval 2 hour) Received_by_hub,ofd_date,pd.held_reason ,hubr.hub, case when ofd.awb is not null then 'attempted' else 'not-attempted' end as attempted_flag,case when so.payment_method_code = 'cod' then 'COD' else 'Perpaid' END AS payment_method,COUNT(1) Cnt FROM  noonltddwh.sales.sales_order_item soi INNER JOIN noonltddwh.sales.sales_order_item_shipment sois using(id_sales_order_item_shipment) INNER JOIN noonltddwh.sales.sales_order so on soi.id_sales_order = so.id_sales_order LEFT JOIN `noonbilogmis.reporting.EG_Pending_Data`  pd on sois.awb_nr = pd.awb_nr LEFT JOIN(SELECT distinct awb_nr awb,ofd_Date ,end_status from `noonbilogmis.reporting.OFD_Forward` )ofd on sois.awb_nr = ofd.awb left join (select awb_nr, min(ish.created_at) as Received_by_hub from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code not like "%Z1%" group by 1) as hub on sois.awb_nr=hub.awb_nr LEFT JOIN ( SELECT awb_nr , hub.code as Hub from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq)LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub ) Hubr ON Hubr.awb_nr = sois.awb_nr  where upper(misc) like "%VIP%" and DATE(sois.created_at ) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH)  and so.country_code = 'EG' and id_cart_type =1 and id_invoice_section =1 and sois.id_carrier = 9 and pd.RTO_LegDate IS NULL GROUP BY 1,2,3,4,5,6,7,8,9,10"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSv12'
task_id = 'NDD_EG'
name ='NDD Shipment EG'
attachment_sql = ["""SELECT sois.awb_nr ,DATE(sois.created_at ) ship_dt,end_status OFD_status,ofd_Date,timestamp_add(Received_by_hub,interval 2 hour) Received_by_hub, DATE(Received_by_hub) Received_by_hub_Date,hubr.hub, case when ofd.awb is not null then 'attempted' else 'not-attempted' end as attempted_flag,case when so.payment_method_code  = 'cod' then 'cod' else 'perpaid' end as payment_method,COUNT(1) Cnt FROM  noonltddwh.sales.sales_order_item soi INNER JOIN noonltddwh.sales.sales_order_item_shipment sois using(id_sales_order_item_shipment) INNER JOIN noonltddwh.sales.sales_order so on soi.id_sales_order = so.id_sales_order left join (select awb_nr, min(ish.created_at) as Received_by_hub from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code not like "%Z1%" group by 1) as hub on sois.awb_nr=hub.awb_nr LEFT JOIN (SELECT distinct awb_nr awb ,end_status ,ofd_date from `noonbilogmis.reporting.OFD_Forward` )ofd on sois.awb_nr = ofd.awb and ofd_date >= DATE(Received_by_hub) and ofd_date <= DATE(Received_by_hub) +1 LEFT JOIN( SELECT awb_nr , hub.code as Hub from `noonltddwh.lms.client_pkg_ref` client_pkg_ref LEFT JOIN(select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub) Hubr ON Hubr.awb_nr = sois.awb_nr  LEFT JOIN(SELECT distinct awb_nr awb FROM `noonbilogmis.reporting.EG_Pending_Data`  d where d.RTO_LegDate is not null) rto on sois.awb_nr = rto.awb where upper(so.misc) like "%NDD%"  and rto.awb is null and DATE(Received_by_hub) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH) and so.country_code = 'EG' and id_cart_type =1 and id_invoice_section =1 and sois.id_carrier = 9 GROUP BY 1,2,3,4,5,6,7,8,9"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSEv10'
task_id = 'NV_OFD'
name ='NV OFD EG'
attachment_sql = ["""WITH D as (SELECT    i.awb_nr,lt.code loc_type , ish.*,hl.code Hub_loc,hl.location_code,row_number() over(partition by ish.id_item order by ish.created_at ) rw FROM      `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) LEFT JOIN `noonltddwh.lms.creq_leg` cl using(id_creq_leg) LEFT JOIN `noonltddwh.lms.item` i on ish.id_item = i.id_item LEFT JOIN `noonltddwh.lms.hub_sector` h using(id_hub_sector) LEFT JOIN `noonltddwh.lms.country_zone` cz using(id_country_zone) LEFT JOIN noonltddwh.lms.loc_type lt using(id_loc_type) where      substr(cz.code,0,2) ='EG' and Date(ish.created_at) >= current_date -100 ) SELECT t1.awb_nr,t1.created_at OFD_dt,t2.created_at Hub_dt,t2.Hub_loc,T2.location_code,ofd.end_status , ofd.username FROM (SELECT d.* FROM (SELECT awb_nr,DATE(created_at) ct, MIN(created_at) created_at FROM d WHERE id_loc_type = 2 GROUP BY 1,2 ) t4 INNER JOIN d d ON t4.awb_nr = d.awb_nr and t4.created_at = d.created_at)t1 left join d t2 on t1.id_item = t2.id_item and t1.rw-1 = t2.rw LEFT JOIN `noonbilogmis.reporting.OFD_Forward` ofd on ofd.awb_nr = t1.awb_nr and ofd.ofd_date = DATE(t1.created_at) WHERE t1.id_loc_type = 2 and DATE(t1.created_at ) >= DATE_TRUNC(CURRENT_DATE() -1, MONTH) and t2.Hub_loc like '%-OVF%'"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSEv10'
task_id = 'MF_Pending'
name ='MF Pending EG'
attachment_sql = ["""SELECT T.*,CASE WHEN s.display_name IS NULL THEN origin_warehouse ELSE display_name END AS display_name FROM (SELECT T.* FROM (SELECT    hub.code Hub,substr(cz.code, 0 ,2) country,client_ref,i.awb_nr ,m.manifest_nr,          DATE_Diff(current_date,DATE(m.created_at),day) Aging,DATE(m.created_at) manifest_date          ,CASE WHEN short_code = 'CIR' AND mt.code = 'hub_handover' AND clt.code = 'dropoff' THEN 'CIR_handover'                WHEN short_code = 'FM' AND mt.code = 'hub_handover' AND clt.code = 'dropoff'  THEN 'FM_handover'                WHEN short_code = 'LM' AND mt.code = 'wh_handover' AND clt.code = 'delivery'  THEN 'Forward_handover'                WHEN short_code = 'LM' AND mt.code = 'hub_handover' AND clt.code = 'rto'      THEN 'RTO_handover'                WHEN short_code = 'RTV' AND mt.code = 'wh_handover' AND clt.code = 'delivery' THEN 'RTV_handover'           ELSE NULL END AS Flag,mt.code handover_type          ,case when container_line.unpacked_at IS NULL THEN 1 ELSE 0 END AS Pending_Flag          ,COUNT(1) cnt FROM      `noonltddwh.lms.manifest` m          LEFT JOIN          `noonltddwh.lms.manifest_item` mi using(id_manifest)          left join          (          SELECT ip.*          FROM (          SELECT max(created_At) dt,id_item FROM `noonltddwh.lms.item_pkg` GROUP BY 2              ) T              INNER JOIN               `noonltddwh.lms.item_pkg` ip ON t.id_item = ip.id_item AND T.dt = ip.created_At          ) ip using(id_item)          left join          noonltddwh.lms.item i using(id_item)          LEFT JOIN          noonltddwh.lms.item_state iss ON i.id_item = iss.id_item          LEFT JOIN          `noonltddwh.lms.creq_leg` cl using(id_creq_leg)          left join          noonltddwh.lms.country_zone cz using(id_country_zone)          left join          `noonltddwh.lms.creq` c ON cl.id_creq = c.id_creq          left join          noonltddwh.lms.creq_type ct using(id_creq_type)          left join          noonltddwh.lms.creq_leg_type clt using(id_creq_leg_type)          left join          noonltddwh.lms.manifest_type mt using(id_manifest_type)          left join          (          SELECT container_line.*          FROM (          SELECT id_item,max(created_at) ct           FROM `noonltddwh.lms.container_line` as container_line           WHERE id_loc_type = 5          GROUP BY 1              ) T              INNER JOIN `noonltddwh.lms.container_line` as container_line  ON T.id_item = container_line.id_item and container_line.created_at = t.ct          ) container_line on container_line.id_item = ip.id_item           LEFT JOIN `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=cl.id_hub_sector          LEFT JOIN `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub WHERE      id_manifest_type IN (2,3)   AND       iss.id_status <> 7 and      substr(cz.code, 0 ,2) = 'EG' GROUP BY 1,2,3,4,5,6,7,8,9,10) T LEFT JOIN(select awb_nr, MIN(ish.created_at) as Last_LPC_Receiving from `noonltddwh.lms.item_state_history` ish left join noonltddwh.lms.item i using(id_item) where id_loc_type = 1  group by 1 )lpc ON t.awb_nr = lpc.awb_nr and t.Flag = 'Forward_handover' WHERE lpc.awb_nr is NULL and flag is not null and Pending_Flag = 1) T LEFT JOIN `noonbilogoi.battleplan_v1.item_final_state` s on t.awb_nr = s.awb_nr"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'LSEv10'
task_id = 'Loyal_Customer'
name ='Loyal Customer EG'
attachment_sql = ["""SELECT *,ifs.display_name AS WH_Code FROM `noonbilogoi.UAE_data.loyalty_uae` loyal left join `noonbilogoi.battleplan_v1.item_final_state` ifs on ifs.awb_nr = loyal.awb_nr  where loyal.country = 'eg'"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'



[[email]]
dag_id = 'Weekly_report'
task_id = 'FM_KPI_weekly'
name ='FM_KPI_weekly - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.RTV_TAT_Type_Weekly""","""SELECT * FROM noonbilogmis.reporting.RTV_TAT_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.ASN_TAT_RAW_Weekly""","""SELECT * FROM noonbilogmis.reporting.ASN_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.RTVs_Attempts_Del_Weekly""","""SELECT * FROM noonbilogmis.reporting.RTVs_Received_Count_Weekly"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'Weekly_report'
task_id = 'Hub_KPI_weekly'
name ='Hub_KPI_weekly - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.NV_OFD_Weekly""","""SELECT * FROM noonbilogmis.reporting.HT_To_FA_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.HT_To_FA_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.OFD_FA_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.PDD_Breach_Count_Weekly""","""SELECT * FROM noonbilogmis.reporting.PDD_Breach_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.Lost_Add_Pkg_Value_Weekly""","""SELECT * FROM noonbilogmis.reporting.Damage_Add_Pkg_Value_Weekly""","""SELECT * FROM noonbilogmis.reporting.Pickup_Weekly""","""SELECT * FROM noonbilogmis.reporting.CIR_Adherence_Weekly""","""SELECT * FROM noonbilogmis.reporting.FA_To_RTO_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.FA_To_RTO_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.PDD_Breach_Count_Weekly""","""SELECT * FROM noonbilogmis.reporting.NV_Weekly_Weekly""","""SELECT * FROM noonbilogmis.reporting.TAT_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.TAT_Weekly"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Weekly_report'
task_id = 'Process_Data_weekly'
name ='Process_Data_weekly - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.Fake_Customer_and_Reseller""","""SELECT * FROM noonbilogmis.reporting.Bagging_and_Inventory_Check""","""SELECT * FROM noonbilogmis.reporting.OFD_Relay""","""SELECT * FROM noonbilogmis.reporting.Direct_Ship""","""SELECT * FROM noonbilogmis.reporting.TAT_Raw_FA_Weekly"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Weekly_report'
task_id = 'LPC_KPI_weekly'
name ='LPC_KPI_weekly - EG Overall'
attachment_sql = ["""SELECT * FROM noonbilogmis.reporting.LPC_MF_Pack_To_Unpack_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.LPC_MF_Pack_To_Unpack_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_HT_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_HT_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_TPL_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_TPL_rawdata_Weekly""","""SELECT * FROM noonbilogmis.reporting.RTO_To_WH_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.RTO_To_WH_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.CIR_Picked_To_LPC_TAT_Weekly""","""SELECT * FROM noonbilogmis.reporting.CIR_Picked_To_LPC_Raw_Weekly""","""SELECT * FROM noonbilogmis.reporting.AWB_creation_to_MF""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_TPL_rawdata_Weekly_CAI_03_04""","""SELECT * FROM noonbilogmis.reporting.LPC_Receive_To_HT_Raw_Weekly_CAI03_04"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","egy-anp.team@noon.com","npaliwal@noon.com","Msaid@noon.com","mwafaey@noon.com"]
sender = 'logistics-reporting@noon.com'


[[email]]
dag_id = 'Dark_store'
task_id = 'Dark_store_bikers_capacity'
name ='Dark_store_bikers_capacity'
body = ["""SELECT Slot_Time,capacity,ord_Count,round(itm_Count/ord_Count,2) order_to_item,CASE WHEN ord_Count = 0 THEN '0.00%' WHEN ord_Count > 0 THEN  Concat(round(ord_Count*100/capacity,2),'%')  end as capacity_per FROM noonbilogmis.reporting.Dark_store_bikers_capacity dsbc LEFT JOIN (SELECT DATE(soi.estimated_delivery_at) PDD ,  dts.name  AS Slot,COUNT(distinct order_nr) ord_Count,COUNT(distinct id_sales_order_item) itm_Count,count(distinct sois.awb_nr) awb_cnt FROM  noonltddwh.sales.sales_order_item soi left join noonltddwh.sales.sales_order so using(id_sales_order) LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois using(id_sales_order_item_shipment) LEFT JOIN noonltddwh.sales.sales_delivery_slot_group  sdsg ON (sdsg.id_sales_order, sdsg.delivery_slot_group_ix) = (soi.id_sales_order, soi.delivery_slot_group_ix) left join `noonltddwh.ref.delivery_time_slot` dts on dts.code = sdsg.delivery_time_slot_code where soi.id_sales_order_item_status in (4,5,6,8)and case when so.misc like '%instant%' then 1 else 0 end = 1 and  soi.id_partner_warehouse IN (34,39,121,122,123,124) and  DATE(soi.estimated_delivery_at) = current_Date GROUP BY 1,2 ) t ON t.slot = dsbc.Slot_Time order by delivery_time_slot_code"""]
recipients = ["lsharma@noon.com","sdev@noon.com","pbagri@noon.com"]
sender = 'logistics-reporting@noon.com'



[[email]]
dag_id = 'LSHH'
task_id = 'LPC_Pending_EG'
name ='LPC_Pending_EG'
attachment_sql = ["""SELECT client_ref, client,awb_nr ,manifest_nr ,creq_leg_type,wh_name display_name ,origin_center ,hub hub_sector ,hub_subsector,current_location, return_center code, timestamp_add(created_at, interval 2 hour) created_at, timestamp_add(unpacked_at, interval 2 hour) unpacked_at,timestamp_add(updated_at, interval 2 hour) updated_at ,attempt ,scheduled_date, promised_at,loc_key, final_status, timestamp_add(created_at_local, interval 2 hour) created_at_locatl ,timestamp_add(updated_at_local, interval 2 hour) updated_at_local, timestamp_add(unpacked_at_local, interval 2 hour) unpacked_at_local,timestamp_add(Received_by_LPC, interval 2 hour) LPC_receive ,agimg_range,Case when timestamp_diff(current_timestamp, Received_by_LPC,minute) < 24 Then '0-24' when timestamp_diff(current_timestamp, Received_by_LPC,minute) >=24 And timestamp_diff(current_timestamp, Received_by_LPC,minute) < 48 Then '24-48' when timestamp_diff(current_timestamp, Received_by_LPC,minute) >=48 And timestamp_diff(current_timestamp, Received_by_LPC,minute) < 72 Then '48-72' when timestamp_diff(current_timestamp, Received_by_LPC,minute) >=72 And timestamp_diff(current_timestamp, Received_by_LPC,minute) < 96 Then '72-96' when timestamp_diff(current_timestamp, Received_by_LPC,minute) >=96 And timestamp_diff(current_timestamp, Received_by_LPC,minute) < 120 Then '96-120' when timestamp_diff(current_timestamp, Received_by_LPC,minute) >=120 And timestamp_diff(current_timestamp, Received_by_LPC,minute) < 240 Then '120-240' when timestamp_diff(current_timestamp, Received_by_LPC,minute) >=240 Then '+240' End as aging_range FROM `noonbilogoi.nefreelancer.ne_pending_shipments_mat` mdt LEFT JOIN (SELECT distinct sois.awb_nr a, partner_warehouse.display_name wh_name FROM `noonltddwh.sales.sales_order_item_shipment` sois LEFT JOIN noonltddwh.partner.partner_warehouse partner_warehouse on sois.id_partner_warehouse_origin =partner_warehouse.id_partner_warehouse LEFT JOIN noonltddwh.ref.partner pwh ON pwh.id_partner=partner_warehouse.id_partner_owner where partner_warehouse.display_name is not null )t12 on t12.a = mdt.awb_nr LEFT JOIN(select awb_nr,min(ish.created_at) as Received_by_LPC from `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.hub_location` hl on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) left join `noonltddwh.lms.item` using (id_item) where id_loc_type = 1 and hl.code like "%Z1%" group by 1) using (awb_nr) LEFT JOIN ( SELECT awb_nr awb,m.manifest_nr FROM ( SELECT id_item id, MIN(ish.created_at) dt FROM `noonltddwh.lms.item_state_history` ish where ish.id_loc_type = 5 GROUP BY 1 ) t INNER JOIN `noonltddwh.lms.item_state_history` ish on t.id = ish.id_item and t.dt = ish.created_at left join noonltddwh.lms.item i using(id_item) left join `noonltddwh.lms.manifest` m on m.id_manifest = ish.loc_id where id_loc_type = 5 ) manifest on manifest.awb = mdt.awb_nr where final_status <>'carrier_switch' and current_location IN ('CAI-Z1','CAI-Z2')"""]
recipients = ["lsharma@noon.com","mahamza@noon.com","Karkhalifa@noon.com","CAILPC01@noon.com"]
sender = 'logistics-reporting@noon.com'




#[[email]]
#dag_id = 'LSv7'
#task_id = 'cir_tpl_reschedule_new'
#name ='cir_reschedule_data'
#attachment_sql = ["""SELECT ls.order_nr, ls.WaybillNumber,upload_date,flag,ls.UpdateDescription,Last_OFP_date.Last_OFP_date FROM (select * from `noonbilogoi.nefreelancer.ne_calling_list_history` where script_name = 'cir_tpl') leads LEFT JOIN(select date(Date_time) Date_time, d.Unique_ID ,Cust_Disposition from `noonbilogoi.nefreelancer.ne_calling_outcom_history`  d where Cust_Disposition in ('cir_tpl_cancel','cir_tpl_reschedule')) outcom on leads.upload_date = date(Date_time) and leads.order_nr = outcom.Unique_ID LEFT JOIN  noonbilogmis.reporting.3PL_CIR_ALL_LS ls on leads.order_nr = ls.order_nr LEFT JOIN (SELECT WaybillNumber,MAX(UpdateDateTime) Last_OFP_date FROM `noonbilogoi.VJEXP.ALM`  WHERE  UpdateDescription IN  ('Pickup Scheduled','Picked Up From Shipper')GROUP BY 1) Last_OFP_date on Last_OFP_date.WaybillNumber = ls.WaybillNumber WHERE (DATE(upload_date) > DATE(Last_OFP_date.Last_OFP_date) OR Last_OFP_date.Last_OFP_date IS NULL)and Cust_Disposition in ('cir_tpl_reschedule')and flag = 'Not-Pickup'"""]
#body = ["""SELECT upload_date Calling_date,COUNT(ls.WaybillNumber) Awb_Cnt FROM (select * from `noonbilogoi.nefreelancer.ne_calling_list_history` where script_name = 'cir_tpl') leads LEFT JOIN(select date(Date_time) Date_time, d.Unique_ID ,Cust_Disposition  from `noonbilogoi.nefreelancer.ne_calling_outcom_history`  d where Cust_Disposition in ('cir_tpl_cancel','cir_tpl_reschedule')) outcom on leads.upload_date = date(Date_time) and leads.order_nr = outcom.Unique_ID LEFT JOIN  noonbilogmis.reporting.3PL_CIR_ALL_LS ls on leads.order_nr = ls.order_nr LEFT JOIN(SELECT WaybillNumber,MAX(UpdateDateTime) Last_OFP_date FROM `noonbilogoi.VJEXP.ALM`  WHERE  UpdateDescription IN  ('Pickup Scheduled','Picked Up From Shipper')GROUP BY 1) Last_OFP_date on Last_OFP_date.WaybillNumber = ls.WaybillNumber WHERE (DATE(upload_date) > DATE(Last_OFP_date.Last_OFP_date) OR Last_OFP_date.Last_OFP_date IS NULL) and Cust_Disposition in ('cir_tpl_reschedule')and flag = 'Not-Pickup'GROUP BY 1 order by 1"""]
#recipients = ["lsharma@noon.com","vishsingh@noon.com","satanwar@noon.com"]
#sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'TPL_Recon_template'
#task_id = 'TPL_Recon_template_Mail_Aramex'
#depends = ['TPL_Recon_template']
#name ='COD_pendancy_Aramex'
#attachment_sql = ["""SELECT Reference_nr awb_nr,delivery_date,Currency_code,CASE WHEN carrier_name  = 'NA' THEN 'iMile' ELSE carrier_name end as carrier_name,paid_price_aed FROM noonbilogmis.reporting.TPL_Recon_template_LS where awb_nr is not null and Currency_code <> 'EGP' and gross_amount_aed IS NULL and CASE WHEN carrier_name  = 'NA' THEN 'iMile' ELSE carrier_name end = 'Aramex'"""]
#body = ["""SELECT delivery_date,COUNT(distinct Reference_nr ) Total_count,SUM(paid_price_aed) paid_price_aed FROM noonbilogmis.reporting.TPL_Recon_template_LS where awb_nr is not null and Currency_code <> 'EGP' and gross_amount_aed IS NULL and CASE WHEN carrier_name  = 'NA' THEN 'iMile' ELSE carrier_name end = 'Aramex' GROUP BY 1"""]
#recipients = ["lsharma@noon.com","satanwar@noon.com"]
#sender = 'logistics-reporting@noon.com'

#[[email]]
#dag_id = 'TPL_Recon_template'
#task_id = 'TPL_Recon_template_Mail_SMSA'
#depends = ['TPL_Recon_template']
#name ='COD_pendancy_SMSA'
#attachment_sql = ["""SELECT Reference_nr awb_nr,delivery_date,Currency_code,CASE WHEN carrier_name  = 'NA' THEN 'iMile' ELSE carrier_name end as carrier_name,paid_price_aed FROM noonbilogmis.reporting.TPL_Recon_template_LS where awb_nr is not null and Currency_code <> 'EGP' and gross_amount_aed IS NULL and CASE WHEN carrier_name  = 'NA' THEN 'iMile' ELSE carrier_name end = 'SMSA'"""]
#body = ["""SELECT delivery_date,COUNT(distinct Reference_nr ) Total_count,SUM(paid_price_aed) paid_price_aed FROM noonbilogmis.reporting.TPL_Recon_template_LS where awb_nr is not null and Currency_code <> 'EGP' and gross_amount_aed IS NULL and CASE WHEN carrier_name  = 'NA' THEN 'iMile' ELSE carrier_name end = 'SMSA' GROUP BY 1"""]
#recipients = ["lsharma@noon.com","satanwar@noon.com"]
#sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'NB_AEEDD'
task_id = 'NB_AEEDD_Automaller'
name = 'AE_Today_EDD_RAW_DATA'
attachment_sql = ["""select data.Country,data.awb_nr,data.order_nr , data.NDD_SDD_Flag,data.NDD,data.SDD, case when Data.SDD = 'vip sdd' then 1 else 0 end as vip_sdd_Flag , data.edd,Overall_Breach, Grocery_Breach,data.Pure_NE_Breached, Data.LM_Hub , it.Hub_sector,	it.hub_subsector,	it.Country_zone, Data.ship_dt,Data.ship_cutoff,	Data.customer_order_dt,	it.loc_type,it.current_location, case when fa.fa_ts is null then "OFD_Pending" else 'Ship_ofd' end as ofd_status from `noonbilogmis.reporting.PDD_Breach_Raw_data` data left join `noonbilogoi.battleplan_v1.item_final_state` it using ( awb_nr) left join `noonbilogoi.Share_Point.NE_FAS` fa using (awb_nr) where date(edd) = current_date and data.country = 'ae' and FA_Date is null and creq="LM" and MP <>"daily" """]
recipients = ["nbharti@noon.com","kjadala@noon.com","prpasupuleti@noon.com","pvinod@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'AE_AttemptDistance'
task_id = 'AE_AttemptDistance_Automailer'
name ='AE_AttemptDistance_Breach'
attachment_sql = ["""select * from (select distinct country.code as country, client_ref, awb_nr, clal.id_creq_leg, hs_old.code as hub_sector, cast(json_extract(clal.misc, "$.is_address_newly_changed") as int64) as is_address_newly_changed, cast(json_extract(clal.misc, "$.held_reason_distance") as int64) as held_reason_cutoff, case when cast(json_extract(clal.misc, "$.held_reason_distance") as int64) < round(cast(json_extract(clal.misc, "$.distance") as FLOAT64), 2) then 1 else 0 end as exception_check, u.username, r1.code as reason, clal.created_at as attempt_marked_at, date(clal.created_at) as attempt_dt, round(cast(json_extract(clal.misc, "$.distance") as FLOAT64), 2) as attempt_distance, cast(json_extract(clal.misc, "$.is_success_attempt") as int64) as is_success_attempt, cast(json_extract(clal.misc, "$.app_build") as string) as app_build, from  `noondwh.lms.creq_leg_attempt_log` clal left join `noondwh.lms.hub_sector` hs_old on (hs_old.id_hub_sector) = (cast(json_extract(clal.misc, "$.id_hub_sector") as int64)) left join(select distinct id_item, awb_nr, id_creq_leg from  `noonltddwh.lms.item_state_history` ish left join `noonltddwh.lms.item` using(id_item) group by 1,2,3) it using(id_creq_leg) left join `noonltddwh.lms.user` u using(id_user) left join `noondwh.lms.user_misc` user_misc using(id_user) left join `noonltddwh.lms.creq_leg` cl  using(id_creq_leg) left join `noondwh.lms.reason` r1 on (r1.id_reason) = (clal.id_reason) left join `noonltddwh.lms.hub_sector` hs on (hs.id_hub_sector) = (cl.id_hub_sector) left join `noonltddwh.lms.hub` h on substr(hs.code,1,6) = (h.code) left join `noonltddwh.lms.hub_airport` hapt using(id_hub_airport) left join `noonltddwh.lms.creq` creq using(id_creq) left join `noonltddwh.lms.country` country using(id_country) where round(cast(json_extract(clal.misc, "$.distance") as FLOAT64), 2) is not null) where attempt_dt=current_date()-1 and country like 'ae' and is_success_attempt = 0 union all select * from (select distinct country, client_ref,awb_nr, id_creq_leg,forward_hub_sector,0 as is_address_newly_changed,cast(held_reason_distance as int64),null exception_check,username,coalesce(reason,ofd_status) reason,ofd_ts as attempt_marked_at, date(ofd_ts) as attempt_dt,attempt_distance,case when cast(attempt_distance as int64) <= cast(held_reason_distance as int64) then 1 else 0 end as is_success_attempt,"LMS 3.0" as app_build from noonbilogoi.Share_Point.LastMile_OFD where ofd_status not in ("Delivered","RTO","address_changed","address_misrouted") and task_type<>'locker_dropoff' and attempt_distance is not null and country like 'ae' and date(ofd_ts) =current_date()-1) where is_success_attempt= 0"""]
recipients = ["nbharti@noon.com","kjadala@noon.com","achandorkar@noon.com","vinsharma@noon.com","rnair@noon.com","smanzil@noon.com","nair@noon.com","smanzil@noon.com","sulkhan@noon.com","vdas@noon.com","faahmad@noon.com","gcamacho@noon.com","mshivashankarappa@noon.com","mkashif@noon.com","selsisy@noon.com","tmotwani@noon.com","anair@noon.com","bthapaliya@noon.com","mohameali@noon.com","riymohamed@noon.com","banaraban@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'AE_losto'
task_id = 'AE_losto_Automailer'
name ='MTD_Losto_location_Raw_Data'
attachment_sql = ["""select * from `noonbilogoi.battleplan_v1.item_final_state`where current_location like "%LOST-O%" and country = "ae"and date(updated_at)  between DATE_TRUNC(current_date-1, month) and current_date and MP <> "noon" and mp not in ('"daily"', '"grocery"', '"packaging"','"sivvi"') and creq = "LM"order by updated_at"""]
recipients = ["nbharti@noon.com","kjadala@noon.com","achandorkar@noon.com","wsperito@noon.com","rgaje@noon.com","sadeem@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'AE_losto'
task_id = 'Attempt_Adherence'
name ='Rescheduled Shipment Attempt_Adherence_Yesterday'
body = ["""select upper(country)Country,
count(distinct case when Attempt_Adherence =1 then awb_nr end) as Attempted,
count(distinct case when Attempt_Adherence =0 then awb_nr end) as Not_Attempted,
cast (concat(round(safe_divide(count(distinct case when Attempt_Adherence =0 then awb_nr end), count(distinct awb_nr))*100,2),"%") as string) Not_Attempted_Percent,
count(distinct awb_nr) Total_Shipment
from (select data.* from (select rschd.*,v2.* except(awb_nr,scheduled_date,row_num,Final_Status), case when ofd.awb_nr is not null then 1 else 0 end as Attempt_Adherence
from (select * from (SELECT awb_nr,max(scheduled_date) upd_scheduled_date
FROM ( SELECT * FROM (SELECT * FROM (
SELECT id_creq_leg,clh.created_at,username,REPLACE(json_EXTRACT(clh.DATA,"$.scheduled_date"),'"','') scheduled_date,
ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num
FROM noondwh.lms.creq_leg_history clh
LEFT JOIN noondwh.lms.user usr USING(id_user)
WHERE clh.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() AS TIMESTAMP), INTERVAL 30 DAY)
AND json_EXTRACT(clh.DATA,"$.scheduled_date") IS NOT NULL)) WHERE row_num=1)
LEFT JOIN noondwh.lms.item_pkg using(id_creq_leg)
LEFT JOIN noondwh.lms.item using(id_item)
GROUP BY 1) Where DATE(upd_scheduled_date)=CURRENT_DATE()-1)rschd
left join `noonbilogoi.LOGKSA_DATA.lms_v2` v2 using (awb_nr)
left join (select * from `noonbilogoi.MJ.OFD` Where is_delivery_block=0) ofd on (rschd.awb_nr,date(rschd.upd_scheduled_date)) = (ofd.awb_nr, ofd.ofd_date)
Where RTO_LegDate is null
and (date(Delivery_Date) >=current_date()-1 or date(Delivery_Date) is null)
and carrier_change <>"Yes"
and location_entity not like "%-LOST-O"
and current_location in (select forward_hub from `noonbilogoi.battleplan_v1.item_final_state` where creq = "LM" )
and current_location is not null) data
left join (select distinct awb_nr,reason, max(updated_date) updated_at from (select * from (select distinct id_creq_leg, awb_nr,
json_extract(clh.data,'$.updated_app') as updated_app,
r.code as reason, data, date(clh.created_at) updated_date,ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num
from `noonltddwh.lms.creq_leg_history` clh
left join `noonltddwh.lms.creq_leg` cl using(id_creq_leg)
left join `noonltddwh.lms.creq` creq using(id_creq)
left join `noonltddwh.lms.reason` r on CAST(json_EXTRACT(DATA,"$.id_reason_held") AS INT64) = r.id_reason
left join `noonltddwh.lms.user` u using(id_user)
left join (select distinct awb_nr, id_item, id_creq_leg 
from `noonltddwh.lms.item_state_history`
left join `noonltddwh.lms.item` it using(id_item) 
)ish using(id_creq_leg)
where date(clh.created_at) between current_Date -10 and current_date()-2
and id_creq_leg_type =3
and id_creq_type =1)) Where reason in ('attempts_exhausted','address_misrouted','customer_canceled','held_for_pickup') 
group by 1,2) ud on  ud.awb_nr=data.awb_nr
where ud.awb_nr is null
and (date(Arrival_Date) <=date(upd_scheduled_date) or Attempt_Adherence=1))
group by 1
order by 4 desc""","""select upper(country)Country,current_location Current_location,
count(distinct case when Attempt_Adherence =1 then awb_nr end) as Attempted,
count(distinct case when Attempt_Adherence =0 then awb_nr end) as Not_Attempted,
cast (concat(round(safe_divide(count(distinct case when Attempt_Adherence =0 then awb_nr end), count(distinct awb_nr))*100,2),"%") as string) Not_Attempted_Percent,
count(distinct awb_nr) Total_Shipment
from (select data.* from (select rschd.*,v2.* except(awb_nr,scheduled_date,row_num,Final_Status), case when ofd.awb_nr is not null then 1 else 0 end as Attempt_Adherence
from (select * from (SELECT awb_nr,max(scheduled_date) upd_scheduled_date
FROM ( SELECT * FROM (SELECT * FROM (
SELECT id_creq_leg,clh.created_at,username,REPLACE(json_EXTRACT(clh.DATA,"$.scheduled_date"),'"','') scheduled_date,
ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num
FROM noondwh.lms.creq_leg_history clh
LEFT JOIN noondwh.lms.user usr USING(id_user)
WHERE clh.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() AS TIMESTAMP), INTERVAL 30 DAY)
AND json_EXTRACT(clh.DATA,"$.scheduled_date") IS NOT NULL)) WHERE row_num=1)
LEFT JOIN noondwh.lms.item_pkg using(id_creq_leg)
LEFT JOIN noondwh.lms.item using(id_item)
GROUP BY 1) Where DATE(upd_scheduled_date)=CURRENT_DATE()-1)rschd
left join `noonbilogoi.LOGKSA_DATA.lms_v2` v2 using (awb_nr)
left join (select * from `noonbilogoi.MJ.OFD` Where is_delivery_block=0) ofd on (rschd.awb_nr,date(rschd.upd_scheduled_date)) = (ofd.awb_nr, ofd.ofd_date)
Where RTO_LegDate is null
and (date(Delivery_Date) >=current_date()-1 or date(Delivery_Date) is null)
and carrier_change <>"Yes"
and location_entity not like "%-LOST-O"
and current_location in (select forward_hub from `noonbilogoi.battleplan_v1.item_final_state` where creq = "LM" )
and current_location is not null) data
left join (select distinct awb_nr,reason, max(updated_date) updated_at from (select * from (select distinct id_creq_leg, awb_nr,
json_extract(clh.data,'$.updated_app') as updated_app,
r.code as reason, data, date(clh.created_at) updated_date,ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num
from `noonltddwh.lms.creq_leg_history` clh
left join `noonltddwh.lms.creq_leg` cl using(id_creq_leg)
left join `noonltddwh.lms.creq` creq using(id_creq)
left join `noonltddwh.lms.reason` r on CAST(json_EXTRACT(DATA,"$.id_reason_held") AS INT64) = r.id_reason
left join `noonltddwh.lms.user` u using(id_user)
left join (select distinct awb_nr, id_item, id_creq_leg 
from `noonltddwh.lms.item_state_history`
left join `noonltddwh.lms.item` it using(id_item) 
)ish using(id_creq_leg)
where date(clh.created_at) between current_Date -10 and current_date()-2
and id_creq_leg_type =3
and id_creq_type =1)) Where reason in ('attempts_exhausted','address_misrouted','customer_canceled','held_for_pickup')
group by 1,2) ud on  ud.awb_nr=data.awb_nr
where ud.awb_nr is null
and (date(Arrival_Date) <=date(upd_scheduled_date) or Attempt_Adherence=1))
group by 1,2
order by 4 desc"""]
attachment_sql = ["""SELECT * FROM noonbilogmis.NB.reschedule_adherence_yesterday"""]
recipients = ["ppandya@noon.com","nbharti@noon.com","ops.excellence@noon.com","mahamza@noon.com","kjadala@noon.com","achandorkar@noon.com","nadlakha@noon.com","sraut@noon.com","yoezz@noon.com","vishsingh@noon.com","sanjakumar@noon.com","anssingh@noon.com","bmadhavaram@noon.com","mshawky@noon.com","pchhetri@noon.com","vtuli@noon.com","ckrishna@noon.com","logsupervisors@noon.com","mahamza@noon.com","mohelmy@noon.com","megasser@noon.com","amoheb@noon.com","hanyabdullah@noon.com","aliismail@noon.com","assayed@noon.com","neksaleads@noon.com","logsupervisors@noon.com","akesargadde@noon.com","egy-anp.team@noon.com"]
sender = 'vinsharma@noon.com'


[[email]]
dag_id = 'AE_losto'
task_id = 'Pending_For_Reattempts_automail'
name ='Pending For Re attempts'
body = ["""select Ageing,
count (distinct case when country = 'eg'then awb_nr end ) EG,
count (distinct case when country = 'sa'then awb_nr end ) SA,
count (distinct case when country = 'ae'then awb_nr end ) AE
  from (With PFR as (select * from (select * from (select *,row_number() over(partition by awb_nr order by ofd_date desc) row_num from noonbilogoi.MJ.OFD)
Where row_num =1)
where ofd_status<>"Delivered"
and ofd_status<>"RTO"
and num_attempts <=4
and ofd_hub is not null
and  awb_nr not in (
select distinct awb_nr from noonbilogoi.MJ.OFD 
Where date(OFD_Date) =current_date()
and awb_nr is not null
))
select PFR.* except(OFD_TS
,manifest_nr,
relayed_at,is_customer_cancelled,
is_session_active,omw,row_num
), ifs.loc_type,V2.Final_Status, COALESCE(V2.Bag_Arrival, V2.Arrival_Date) Hub_Arrival ,V2.current_location,V2.country,
CASE WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -12 HOUR) THEN "0-12 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -24 HOUR) THEN "12-24 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -48 HOUR) THEN "24-48 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -72 HOUR) THEN "48-72 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -96 HOUR) THEN "72-96 Hours" ELSE "96 Hours+" END AS Ageing 
 from PFR
left join noonbilogoi.battleplan_v1.item_final_state ifs using(awb_nr)
left join noonbilogoi.LOGKSA_DATA.lms_v2 V2 using(awb_nr)
left join (SELECT awb_nr,max(scheduled_date) upd_scheduled_date
FROM ( SELECT * FROM (SELECT * FROM (
SELECT id_creq_leg,clh.created_at,username,REPLACE(json_EXTRACT(clh.DATA,"$.scheduled_date"),'"','') scheduled_date,
ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num
FROM noondwh.lms.creq_leg_history clh
LEFT JOIN noondwh.lms.user usr USING(id_user)
WHERE clh.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() AS TIMESTAMP), INTERVAL 30 DAY)
AND json_EXTRACT(clh.DATA,"$.scheduled_date") IS NOT NULL)) WHERE row_num=1)
LEFT JOIN noondwh.lms.item_pkg using(id_creq_leg)
LEFT JOIN noondwh.lms.item using(id_item)
Where DATE(scheduled_date)>CURRENT_DATE() GROUP BY 1) FRD using (awb_nr) 
Where creq ="LM"
and is_delivery_block =0
and loc_type <>"manifested"
and v2.creq_leg_type <>"RTO"
and FRD.awb_nr is null
and V2.carrier_change ="No"
and substr(ofd_hub,5,1) NOT IN ("G","Z","Y")
and MP NOT IN ('"daily"','"grocery"') 
AND V2.FINAL_STATUS <> 'Held at Branch'
and V2.Attempt_Count <= 4
and substr( V2.current_location ,5,1) not in( "G" , "Z", "Y",'T')) group by 1
order by 1
"""
,

"""select country, current_location,
count (distinct case when Ageing = '96 Hours+'then awb_nr end ) _96Hours,
count (distinct case when Ageing = '72-96 Hours'then awb_nr end ) _72_96_Hours,
count (distinct case when Ageing = '24-48 Hours'then awb_nr end ) _24_48_Hours,
count (distinct case when Ageing = '12-24 Hours'then awb_nr end ) _12_24_Hours,
count (distinct case when Ageing = '48-72 Hours'then awb_nr end ) _48_72_Hours,
count (distinct case when Ageing = '0-12 Hours'then awb_nr end ) _0_12_Hours,
  from (With PFR as (select * from (select * from (select *,row_number() over(partition by awb_nr order by ofd_date desc) row_num from noonbilogoi.MJ.OFD)
Where row_num =1)
where ofd_status<>"Delivered"
and ofd_status<>"RTO"
and num_attempts <=4
and ofd_hub is not null
and  awb_nr not in (
select distinct awb_nr from noonbilogoi.MJ.OFD 
Where date(OFD_Date) =current_date()
and awb_nr is not null
))
select PFR.* except(OFD_TS
,manifest_nr,
relayed_at,is_customer_cancelled,
is_session_active,omw,row_num
), ifs.loc_type,V2.Final_Status, COALESCE(V2.Bag_Arrival, V2.Arrival_Date) Hub_Arrival ,V2.current_location,V2.country,
CASE WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -12 HOUR) THEN "0-12 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -24 HOUR) THEN "12-24 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -48 HOUR) THEN "24-48 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -72 HOUR) THEN "48-72 Hours" 
WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -96 HOUR) THEN "72-96 Hours" ELSE "96 Hours+" END AS Ageing 
 from PFR
left join noonbilogoi.battleplan_v1.item_final_state ifs using(awb_nr)
left join noonbilogoi.LOGKSA_DATA.lms_v2 V2 using(awb_nr)
left join (SELECT awb_nr,max(scheduled_date) upd_scheduled_date
FROM ( SELECT * FROM (SELECT * FROM (
SELECT id_creq_leg,clh.created_at,username,REPLACE(json_EXTRACT(clh.DATA,"$.scheduled_date"),'"','') scheduled_date,
ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num
FROM noondwh.lms.creq_leg_history clh
LEFT JOIN noondwh.lms.user usr USING(id_user)
WHERE clh.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() AS TIMESTAMP), INTERVAL 30 DAY)
AND json_EXTRACT(clh.DATA,"$.scheduled_date") IS NOT NULL)) WHERE row_num=1)
LEFT JOIN noondwh.lms.item_pkg using(id_creq_leg)
LEFT JOIN noondwh.lms.item using(id_item)
Where DATE(scheduled_date)>CURRENT_DATE() GROUP BY 1) FRD using (awb_nr) 
Where creq ="LM"
and is_delivery_block =0
and loc_type <>"manifested"
and v2.creq_leg_type <>"RTO"
and FRD.awb_nr is null
and V2.carrier_change ="No"
and substr(ofd_hub,5,1) NOT IN ("G","Z","Y")
and MP NOT IN ('"daily"','"grocery"') 
AND V2.FINAL_STATUS <> 'Held at Branch'
and V2.Attempt_Count <= 4
and substr( V2.current_location ,5,1) not in( "G" , "Z", "Y",'T'))
where country is not null 
 group by 1,2
order by 1,2"""]
attachment_sql = ["""With PFR as (select * from (select * from (select *,row_number() over(partition by awb_nr order by ofd_date desc) row_num from noonbilogoi.MJ.OFD) Where row_num =1) where ofd_status<>"Delivered" and ofd_status<>"RTO" and num_attempts <=4 and ofd_hub is not null and  awb_nr not in ( select distinct awb_nr from noonbilogoi.MJ.OFD Where date(OFD_Date) =current_date() and awb_nr is not null )) select PFR.* except(OFD_TS ,manifest_nr, relayed_at,is_customer_cancelled, is_session_active,omw,row_num ), ifs.loc_type,V2.Final_Status, COALESCE(V2.Bag_Arrival, V2.Arrival_Date) Hub_Arrival ,V2.current_location,V2.country, CASE WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -12 HOUR) THEN "0-12 Hours" WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -24 HOUR) THEN "12-24 Hours" WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -48 HOUR) THEN "24-48 Hours" WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -72 HOUR) THEN "48-72 Hours" WHEN COALESCE(LastAttempt_Date,Bag_Arrival,Arrival_Date) >= TIMESTAMP_ADD(TIMESTAMP(CURRENT_DATETIME()), INTERVAL -96 HOUR) THEN "72-96 Hours" ELSE "96 Hours+" END AS Ageing from PFR left join noonbilogoi.battleplan_v1.item_final_state ifs using(awb_nr) left join noonbilogoi.LOGKSA_DATA.lms_v2 V2 using(awb_nr) left join (SELECT awb_nr,max(scheduled_date) upd_scheduled_date FROM ( SELECT * FROM (SELECT * FROM ( SELECT id_creq_leg,clh.created_at,username,REPLACE(json_EXTRACT(clh.DATA,"$.scheduled_date"),'"','') scheduled_date, ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num FROM noondwh.lms.creq_leg_history clh LEFT JOIN noondwh.lms.user usr USING(id_user) WHERE clh.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() AS TIMESTAMP), INTERVAL 30 DAY) AND json_EXTRACT(clh.DATA,"$.scheduled_date") IS NOT NULL)) WHERE row_num=1) LEFT JOIN noondwh.lms.item_pkg using(id_creq_leg) LEFT JOIN noondwh.lms.item using(id_item) Where DATE(scheduled_date)>CURRENT_DATE() GROUP BY 1) FRD using (awb_nr) Where creq ="LM" and is_delivery_block =0 and loc_type <>"manifested" and v2.creq_leg_type <>"RTO" and FRD.awb_nr is null and V2.carrier_change ="No" and substr(ofd_hub,5,1) NOT IN ("G","Z","Y") and MP NOT IN ('"daily"','"grocery"') AND V2.FINAL_STATUS <> 'Held at Branch' and V2.Attempt_Count <= 4 and substr( V2.current_location ,5,1) not in( "G" , "Z", "Y",'T')"""]
recipients = ["nbharti@noon.com","kemmanuel@noon.com",	"mraza@noon.com",	"mkakhan@noon.com",	"waqmalik@noon.com","aashard@noon.com",	"palam@noon.com",	"mtalat@noon.com",	"oalghamdi@noon.com",	"ygulamsha@noon.com",	"mmhussain@noon.com",	"pghalan@noon.com",	"mzazeeruddin@noon.com",	"fmohammed@noon.com",	"saddamhussain@noon.com",	"vmariappan@noon.com",	"ifarook@noon.com",	"mtinwale@noon.com",	"mahtabsab@noon.com",	"kasiddiqui@noon.com",	"samiah@noon.com",	"jaalmuhanna@noon.com",	"waseelkhan@noon.com",	"mofazil@noon.com",	"wbakhsh@noon.com",	"mdsansari@noon.com",	"mohammednawaz@noon.com",	"tahanifa@noon.com",	"smhussain@noon.com",	"zhuq@noon.com",	"mboota@noon.com",	"kabdulazeez@noon.com",	"rpugazhenthi@noon.com",	"mfarok@noon.com",	"wsheikh@noon.com",	"sqasem@noon.com",	"mdskhan@noon.com",	"banwar@noon.com",	"baahmad@noon.com",	"shafiullah@noon.com",	"smustafa@noon.com",	"mlimbu@noon.com",	"eselvaraj@noon.com",	"rkaruppiya@noon.com",	"amkalim@noon.com",	"djanardan@noon.com",	"sumar@noon.com",	"qhussain@noon.com",	"darumugam@noon.com",	"khussen@noon.com",	"dthyayyil@noon.com",	"kavirajalavakusan@noon.com",	"naufalvm@noon.com",	"smdhussain@noon.com",	"hjunaid@noon.com",	"mrichard@noon.com",	"shekhahamad@noon.com",	"shaquibashraf@noon.com",	"arafatkhan@noon.com",	"rraju@noon.com",	"fehassan@noon.com",	"mmulla@noon.com",	"asifshaikh@noon.com",	"vikharalikhan@noon.com",	"jjalaluddin@noon.com",	"irsadalam@noon.com",	"mrafiuddeen@noon.com",	"pramamoorthy@noon.com",	"rravichandran@noon.com",	"mojawaduddin@noon.com",	"aalmijmaj@noon.com",	"neksaleads@noon.com",	"nadlakha@noon.com",	"Ahmed@malcoo.com",	"alzahranico.ksa@gmail.com",	"sibinshah@hotmail.com",	"ULH-A1@malcoo.com",	"MED-C2@malcoo.com",	"MED-C1@malcoo.com",	"EJH-C1@malcoo.com",	"EJH-A1@malcoo.com",	"vtuli@noon.com",	"azizmohammed9980@gmail.com",	"gunjankumar@noon.com",	"neksacityleads@noon.com",	"neksaleads@noon.com",	"logistics-reporting@noon.com",	"vinsharma@noon.com",	"sanjakumar@noon.com",	"anssingh@noon.com",	"bmadhavaram@noon.com",	"ops.excellence@noon.com",	"mahamza@noon.com",	"kjadala@noon.com",	"achandorkar@noon.com",	"nadlakha@noon.com","sbhat@noon.com",	"vishsingh@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'AE_losto'
task_id = 'EDD_10_Days'
name ='Countrywise EDD'
body = ["""with edd_data as (select distinct country,EDD, count(distinct awb_nr)shipments_count from `noonbilogmis.reporting.PDD_Breach_Raw_data`
where EDD between current_date() and current_date()+10
group by 1,2
order by 1,2)

select cast(edd as string) EDD, * except(edd) from (select edd_data.Country, edd_data.edd, edd_data.shipments_count from  edd_data)
pivot( sum(shipments_count) for country in ('sa',"eg","ae")
) pivot
order by 1"""]
attachment_sql = ["""select distinct country,EDD,LM_Hub,Delivery_Zone, count(distinct awb_nr)shipments_count from `noonbilogmis.reporting.PDD_Breach_Raw_data` where EDD between current_date() and current_date()+10 group by 1,2,3,4 order by 1,2"""]
recipients =["vinsharma@noon.com","ckrishna@noon.com","akesargadde@noon.com","sraut@noon.com","nadlakha@noon.com","kjadala@noon.com","hjha@noon.com","skotla@noon.com","mshawky@noon.com","vijain@noon.com","pchhetri@noon.com","achandorkar@noon.com","wsperito@noon.com","vtuli@noon.com","achakravarthy@noon.com","agautam@noon.com","bmadhavaram@noon.com","asethi@noon.com"]
sender = 'vinsharma@noon.com'

[[email]]
dag_id = 'AeBulky_POD'
task_id = 'AeBulky_POD'
name ='AE_Bulky_POD_Raw_data'
attachment_sql = ["""select distinct ad.awb_nr,order_nr,item_nr,payment_method_code,hub, hub_sector, handover_hub,warehouse,id_warehouse_type ,del_user,item_status,EDD,item_Delivery_TS,POD_URL from `noonbilogoi.UAE_data.AD_data` as ad LEFT JOIN ( SELECT DISTINCT awb_nr, media_type, manifest_nr, CONCAT( "https://storage.cloud.google", SUBSTR(media_url, 27, 1000) ) AS POD_URL FROM ( SELECT DISTINCT manifest_nr, awb_nr, mtype.name AS media_type, id_manifest, id_creq, a.created_at, id_item, b.is_outbound, media_url FROM `noonltddwh.lms.manifest` AS a LEFT JOIN `noonltddwh.lms.manifest_item` b USING (id_manifest) LEFT JOIN `noonltddwh.lms.item` USING (id_item) LEFT JOIN `noonltddwh.lms.manifest_media` mm USING ( id_manifest) LEFT JOIN `noonltddwh.lms.media_type` mtype USING (id_media_type) )) USING (awb_nr) where date(item_Delivery_TS) = current_date -1 and item_status = 'delivered' and handover_hub in ('DXB-B1','DXB-B2','AUH-B1','AUH-B2')"""]
recipients = ["bmadhavaram@noon.com","nbharti@noon.com","vinsharma@noon.com","anssingh@noon.com","uaequalityteam@noon.com","shj-hub@noon.com","asethi@noon.com","nmandeep@noon.com","dxb-g2@noon.com","DXBA8-hub@noon.com", "auh-hub@noon.com","DXB02_Hub@noon.com","AAN-Hub@noon.com","sortcenter@noon.com","DXB_Hub@noon.com","wsperito@noon.com", "paynikath@noon.com","aayash@noon.com","aluarca@noon.com","nesingh@noon.com","pchhetri@noon.com","uae-trojans@noon.com", "ajainudeen@noon.com","nesupport_UAE@noon.com","AUH2_Hub@noon.com","AUH3_Hub@noon.com","RKT-hub@noon.com", "FJR-hub@noon.com","DXB03_Hub@noon.com","annautiyal@noon.com", "vvalappil@noon.com","auh-d1@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'Load_capacity'
task_id = 'Load_capacity_T3'
name ='Logistics LT3 Capacity Overutilization Alert'
body = [""" 

select promise_date ,country_code,delivery_zone_code,lt3_capacity,lt3_load,
concat(lt3_load_util_perc,"%" ) lt3_load_util_perc from(SELECT promise_date ,country_code,delivery_zone_code, sum(lt3_capacity) 
as lt3_capacity,
sum(lt3_load)  as  lt3_load,concat( round(lt3_load_util_perc,0),"%" )lt3_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt3_load_util_perc > 90  and country_code = 'ae'
group by 1,2,3,6
order by 1,6)""",

"""select promise_date ,country_code,delivery_zone_code,lt3_capacity,lt3_load,
concat(lt3_load_util_perc,"%" ) lt3_load_util_perc from(SELECT promise_date ,country_code,delivery_zone_code, sum(lt3_capacity) 
as lt3_capacity,
sum(lt3_load)  as  lt3_load,concat( round(lt3_load_util_perc,0),"%" )lt3_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt3_load_util_perc > 90  and country_code = 'eg'
group by 1,2,3,6
order by 1,6)""",

"""select promise_date ,country_code,delivery_zone_code,lt3_capacity,lt3_load,
concat(lt3_load_util_perc,"%" ) lt3_load_util_perc from(SELECT promise_date ,country_code,delivery_zone_code, sum(lt3_capacity) 
as lt3_capacity,
sum(lt3_load)  as  lt3_load,concat( round(lt3_load_util_perc,0),"%" )lt3_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt3_load_util_perc > 90  and country_code = 'sa'
group by 1,2,3,6
order by 1,6)
"""]
recipients = ["sraut@noon.com","nbharti@noon.com","anssingh@noon.com","akesargadde@noon.com","bmadhavaram@noon.com","vijain@noon.com","mshawky@noon.com","mahamza@noon.com","nadlakha@noon.com","pchhetri@noon.com","vtuli@noon.com","ckrishna@noon.com","bpkrishna@noon.com","nparnami@noon.com","agautam@noon.com","achandorkar@noon.com","egy-anp.team@noon.com","hanyabdullah@noon.com","amoheb@noon.com","mhussein@noon.com",]
sender = 'anssingh@noon.com'

[[email]]
dag_id = 'Load_capacity'
task_id = 'Load_capacity_T2'
name ='Logistics LT2 Capacity Overutilization Alert'
body = [""" 

select promise_date ,country_code,delivery_zone_code,lt2_capacity,lt2_load,
concat(lt2_load_util_perc,"%" ) lt2_load_util_perc from(
SELECT promise_date ,country_code,delivery_zone_code, sum(lt2_capacity) 
as lt2_capacity,
sum(lt2_load)  as  lt2_load,concat( round(lt2_load_util_perc,0),"%" )lt2_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt2_load_util_perc > 90  and country_code = 'ae'
group by 1,2,3,6
order by 1,6)""",

"""select promise_date ,country_code,delivery_zone_code,lt2_capacity,lt2_load,
concat(lt2_load_util_perc,"%" ) lt2_load_util_perc from(
SELECT promise_date ,country_code,delivery_zone_code, sum(lt2_capacity) 
as lt2_capacity,
sum(lt2_load)  as  lt2_load,concat( round(lt2_load_util_perc,0),"%" )lt2_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt2_load_util_perc > 90  and country_code = 'eg'
group by 1,2,3,6
order by 1,6)""",

"""select promise_date ,country_code,delivery_zone_code,lt2_capacity,lt2_load,
concat(lt2_load_util_perc,"%" ) lt2_load_util_perc from(
SELECT promise_date ,country_code,delivery_zone_code, sum(lt2_capacity) 
as lt2_capacity,
sum(lt2_load)  as  lt2_load,concat( round(lt2_load_util_perc,0),"%" )lt2_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt2_load_util_perc > 90  and country_code = 'sa'
group by 1,2,3,6
order by 1,6)
"""]
recipients = ["sraut@noon.com","nbharti@noon.com","anssingh@noon.com","akesargadde@noon.com","bmadhavaram@noon.com","vijain@noon.com","mshawky@noon.com","mahamza@noon.com","nadlakha@noon.com","pchhetri@noon.com","vtuli@noon.com","ckrishna@noon.com","bpkrishna@noon.com","nparnami@noon.com","agautam@noon.com","achandorkar@noon.com","egy-anp.team@noon.com","hanyabdullah@noon.com","amoheb@noon.com","mhussein@noon.com",]
sender = 'anssingh@noon.com'


[[email]]
dag_id = 'Load_capacity'
task_id = 'Load_capacity_T1'
name ='Logistics LT1 Capacity Overutilization Alert'
body = [""" 

select promise_date ,country_code,delivery_zone_code,lt1_capacity,lt1_load_data,
concat(lt1_load_util_perc,"%" ) lt1_load_util_perc from(
SELECT promise_date ,country_code,delivery_zone_code, sum(lt1_capacity) 
as lt1_capacity,
sum(lt1_load_data)  as lt1_load_data,round(lt1_load_util_perc,0)lt1_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt1_load_util_perc > 90  and country_code = 'ae'
group by 1,2,3,6
order by 1,6)""",

"""select promise_date ,country_code,delivery_zone_code,lt1_capacity,lt1_load_data,
concat(lt1_load_util_perc,"%" ) lt1_load_util_perc from(
SELECT promise_date ,country_code,delivery_zone_code, sum(lt1_capacity) 
as lt1_capacity,
sum(lt1_load_data)  as lt1_load_data,round(lt1_load_util_perc,0)lt1_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt1_load_util_perc > 90  and country_code = 'eg'
group by 1,2,3,6
order by 1,6)""",

"""select promise_date ,country_code,delivery_zone_code,lt1_capacity,lt1_load_data,
concat(lt1_load_util_perc,"%" ) lt1_load_util_perc from(
SELECT promise_date ,country_code,delivery_zone_code, sum(lt1_capacity) 
as lt1_capacity,
sum(lt1_load_data)  as lt1_load_data,round(lt1_load_util_perc,0)lt1_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where lt1_load_util_perc > 90  and country_code = 'sa'
group by 1,2,3,6
order by 1,6)
"""]
recipients = ["sraut@noon.com","nbharti@noon.com","anssingh@noon.com","akesargadde@noon.com","bmadhavaram@noon.com","vijain@noon.com","mshawky@noon.com","mahamza@noon.com","nadlakha@noon.com","pchhetri@noon.com","vtuli@noon.com","ckrishna@noon.com","bpkrishna@noon.com","nparnami@noon.com","agautam@noon.com","achandorkar@noon.com","egy-anp.team@noon.com","hanyabdullah@noon.com","amoheb@noon.com","mhussein@noon.com",]
sender = 'anssingh@noon.com'

[[email]]
dag_id = 'Load_capacity'
task_id = 'Load_capacity_bulky'
name ='Logistics bulky Capacity Overutilization Alert'
body = [""" 

select 
promise_date ,country_code,delivery_zone_code,bulky_capacity,bulky_load_data , concat(bulky_load_util_perc,"%")bulky_load_util_perc from (
SELECT promise_date ,country_code,delivery_zone_code, sum(bulky_capacity) 
as bulky_capacity,
sum(bulky_load_data)  as bulky_load_data,round(bulky_load_util_perc,0) bulky_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where bulky_load_util_perc > 90  and country_code = 'ae'
group by 1,2,3,6
order by 1,6) """,

"""select 
promise_date ,country_code,delivery_zone_code,bulky_capacity,bulky_load_data , concat(bulky_load_util_perc,"%")bulky_load_util_perc from (
SELECT promise_date ,country_code,delivery_zone_code, sum(bulky_capacity) 
as bulky_capacity,
sum(bulky_load_data)  as bulky_load_data,round(bulky_load_util_perc,0) bulky_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where bulky_load_util_perc > 90  and country_code = 'eg'
group by 1,2,3,6
order by 1,6)""",

"""select 
promise_date ,country_code,delivery_zone_code,bulky_capacity,bulky_load_data , concat(bulky_load_util_perc,"%")bulky_load_util_perc from (
SELECT promise_date ,country_code,delivery_zone_code, sum(bulky_capacity) 
as bulky_capacity,
sum(bulky_load_data)  as bulky_load_data,round(bulky_load_util_perc,0) bulky_load_util_perc,FROM `noonbilogoi.Share_Point.DE_load_vs_capacity_10d` 
where bulky_load_util_perc > 90  and country_code = 'sa'
group by 1,2,3,6
order by 1,6)
"""]
recipients = ["sraut@noon.com","nbharti@noon.com","anssingh@noon.com","akesargadde@noon.com","bmadhavaram@noon.com","vijain@noon.com","mshawky@noon.com","mahamza@noon.com","nadlakha@noon.com","pchhetri@noon.com","vtuli@noon.com","ckrishna@noon.com","bpkrishna@noon.com","nparnami@noon.com","agautam@noon.com","achandorkar@noon.com","egy-anp.team@noon.com","hanyabdullah@noon.com","amoheb@noon.com","mhussein@noon.com",]
sender = 'anssingh@noon.com'

[[email]]
dag_id = 'volumetric_compliance_1'
task_id = 'volumetric_compliance_data'
name ='volumetric_compliance_yesterday'
body = ["""select Origin_hub Hub,count(distinct awb_nr)Shipment_Count,cast(round(count(distinct case when Volumetric_Flag=1 then awb_nr end)/count(distinct awb_nr)*100,2) as string)Volumetric_Compliance
 from (select * except(docket), case when volumetric_weight is not null then 1 else 0 end as Volumetric_Flag from
(
select * from(
select distinct awb_nr docket,country, wh_code,display_name,type,exp_pickup_date FROM `noonbilogmis.kd.ds_data` where type='normal'
union all
SELECT distinct awb_nr,country,wh_code, display_name,wh_type,exp_pickup_date FROM `noonbilogmis.kd.seller_flex` where wh_type<>'Bulky'
) where date(exp_pickup_date)>=CURRENT_DATE()-15) df
LEFT JOIN
(select * from(
SELECT t.*,h.code as hub,LEFT(hub_location.code,6) Origin_hub, ivd.volumetric_weight,hub_location.code,row_number() over(partition by awb_nr order by t.first_scan_ts) rn 
FROM(select * from (select itm.awb_nr,itm.id_item, id_loc_type,loc_id,  lt.code as location_type, u.username username, ish.created_at first_scan_ts from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.item` itm using(id_item)
left join `noondwh.lms.loc_type` lt using(id_loc_type)
left join `noondwh.lms.user` u on ish.id_user_updater = u.id_user)
where date(first_scan_ts) >= current_date()-120 and id_loc_type=1) t
LEFT JOIN `noonltddwh.lms.hub_location` hub_location ON (t.id_loc_type,t.loc_id) = (1,hub_location.id_hub_location)
LEFT JOIN  `noondwh.lms.item_vmw_detail` ivd on t.id_item=ivd.id_item
LEFT JOIN noondwh.lms.hub h on ivd.id_hub=h.id_hub
 WHERE location_type='hub_location' and  LEFT(hub_location.code,6) like '%-G%') where rn=1) v on df.docket=v.awb_nr
 where date(first_scan_ts)=current_date()-1)
 group by 1
 order by 3 desc"""]
attachment_sql = ["""select * from  `noonbilogmis.reporting.volumetric_compliance_yesterday_1`"""]
recipients = ["vinsharma@noon.com","amkishore@noon.com","achandorkar@noon.com","usingal@noon.com","aksabry@noon.com","mshawky@noon.com","morub@noon.com","amewada@noon.com","hjha@noon.com","vijain@noon.com","skotla@noon.com","vtuli@noon.com","sraut@noon.com","ckrishna@noon.com","pchhetri@noon.com","sanjakumar@noon.com","bmadhavaram@noon.com","akesargadde@noon.com","wsperito@noon.com","akheruwala@noon.com"]
sender = 'logistics-reporting@noon.com'

[[email]]
dag_id = 'volumetric_compliance_MTD'
task_id = 'volumetric_compliance_data_mtd'
name ='volumetric_compliance_MTD'
body = ["""
select upper(Country)Country,Origin_hub Hub,cast(date(first_scan_ts) as string)date,count(distinct awb_nr)Shipment_Count,
count(distinct case when Volumetric_Flag=1 then awb_nr end) as Volumetric_Count,
cast(round(count(distinct case when Volumetric_Flag=1 then awb_nr end)/count(distinct awb_nr)*100,2) as string)Volumetric_Compliance
 from (select * except(docket), case when volumetric_weight is not null then 1 else 0 end as Volumetric_Flag from
(
select * from(
select distinct awb_nr docket,country, wh_code,display_name,type,exp_pickup_date FROM `noonbilogmis.kd.ds_data` where type='normal'
union all
SELECT distinct awb_nr,country,wh_code, display_name,wh_type,exp_pickup_date FROM `noonbilogmis.kd.seller_flex` where wh_type<>'Bulky'
) where date(exp_pickup_date)>=CURRENT_DATE()-45) df
LEFT JOIN
(select * from(
SELECT t.*,h.code as hub,LEFT(hub_location.code,6) Origin_hub, ivd.volumetric_weight,hub_location.code,row_number() over(partition by awb_nr order by t.first_scan_ts) rn 
FROM(select * from (select itm.awb_nr,itm.id_item, id_loc_type,loc_id,  lt.code as location_type, u.username username, ish.created_at first_scan_ts from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.item` itm using(id_item)
left join `noondwh.lms.loc_type` lt using(id_loc_type)
left join `noondwh.lms.user` u on ish.id_user_updater = u.id_user)
where date(first_scan_ts) >= current_date()-120 and id_loc_type=1) t
LEFT JOIN `noonltddwh.lms.hub_location` hub_location ON (t.id_loc_type,t.loc_id) = (1,hub_location.id_hub_location)
LEFT JOIN  `noondwh.lms.item_vmw_detail` ivd on t.id_item=ivd.id_item
LEFT JOIN noondwh.lms.hub h on ivd.id_hub=h.id_hub
 WHERE location_type='hub_location' and  LEFT(hub_location.code,6) like '%-G%') where rn=1) v on df.docket=v.awb_nr
 where date(first_scan_ts) between date_trunc(current_date()-1,month) and current_date()-1)
 group by 1,2,3
 order by 3 desc,1
"""]
attachment_sql = ["""select * from `noonbilogmis.NB.volumetric_compliance_MTD`"""]
recipients = ["vinsharma@noon.com","amkishore@noon.com","achandorkar@noon.com","usingal@noon.com","aksabry@noon.com","mshawky@noon.com","morub@noon.com","amewada@noon.com","hjha@noon.com","vijain@noon.com","skotla@noon.com","vtuli@noon.com","sraut@noon.com","ckrishna@noon.com","pchhetri@noon.com","sanjakumar@noon.com","bmadhavaram@noon.com","akesargadde@noon.com","wsperito@noon.com","akheruwala@noon.com"]
sender = 'logistics-reporting@noon.com'


