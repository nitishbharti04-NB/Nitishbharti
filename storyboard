    
[[dags]]
dag_id = 'mat_battleplan_email_three_hourly_v1'
schedule_interval = '0 6,9,12,15 * * *'

[[dags]]
dag_id = 'mat_battleplan_once'
schedule_interval = '@once'

[[dags]]
dag_id = 'ofd_yfs'
schedule_interval = '45 * * * *'

[[dags]]
dag_id = 'FA_Del_10'
schedule_interval = '* 5,7,9,12,15,18,20 * * *'

[[dags]]
dag_id = 'reschedule'
schedule_interval = '5 4 * * *'

[[dags]]
dag_id = 'pgroup_details'
schedule_interval = '5 */1 * * *'


[[dags]]
dag_id = 'ofd_yfs1'
schedule_interval = '45 * * * *'


[[dags]]
dag_id = 'mat_battleplan_hourly_v1'
schedule_interval = '15 */1 * * *'

[[dags]]
dag_id = 'mat_battleplan_half_v1'
schedule_interval = '15/30 * * * *'

[[dags]]
dag_id = 'battleplan_gsheetsload'
schedule_interval = '@daily'

[[dags]]
dag_id = 'battleplan_frequent_v3'
schedule_interval = '0 * * * *'

[[dags]]
dag_id = 'mat_reportingmart_hourly'
schedule_interval = '0 * * * *'

#[[dags]]
#dag_id = 'volumetric_compliance_yesterday_1'
#schedule_interval = '*/30 * * * *'


[[authview]]
dag_id ='mat_battleplan_once' 
task_id ='vjlmfd11'
destination_table =  'noonbilogmis.reporting.item_check'
sql ='''
SELECT *
FROM noonltddwh.lms.item
limit 10
'''




#############################Daily########################################



[[matview]]
dag_id = 'ofd_yfs1'
task_id = 'Hub_p'
destination_table = '`noonbilogmis.reporting.Hub_perf_2hub`'
sql = '''
select distinct
id_session_field,
awb_nr,
calls,
daily_flag,
omw,
reachable,
unreachable, last_call_attempt,
client_ref,
username,
OFD_Date,
Hub,
ofd_status,
count(distinct username) as Tot_DA,
sum(Total_OFD) as Total_OFD,
sum(Total_Delivered) as Total_Delivered,
round(if(sum(Total_OFD)>0,(sum(Total_Delivered)*100)/sum(Total_OFD),0),2) as percentage_delivered,
sum(Total_Undelivered) as Total_Undelivered,
sum(unrechable) as unrechable,
sum(customer_cancelled) as customer_cancelled,
sum(rescheduled) as rescheduled,
sum(address_changed) as address_changed,
sum(address_misrouted) as address_misrouted,
sum(held_consolidation) as held_consolidation,
sum(customer_initiated_undelivered) as customer_initiated_undelivered,
sum(not_attempted) as not_attempted,
from (
select
id_session_field,
awb_nr,
calls,
omw,
daily_flag,
reachable,
unreachable, last_call_attempt,
client_ref,
username,
OFD_Date,
Hub,
ofd_status,
sum(ofd) as Total_OFD,
sum(delivered) as Total_Delivered,
round(if(sum(ofd)>0,(sum(delivered)*100)/sum(ofd),0),2) as percentage_delivered,
sum(undelivered) as Total_Undelivered,
sum(unrechable) as unrechable,
sum(customer_cancelled) as customer_cancelled,
sum(rescheduled) as rescheduled,
sum(address_changed) as address_changed,
sum(address_misrouted) as address_misrouted,
sum(held_consolidation) as held_consolidation,
sum(customer_initiated_undelivered) as customer_initiated_undelivered,
sum(not_attempted) as not_attempted,
from (
select
id_session_field,
awb_nr,
calls,
omw,
reachable,
unreachable, last_call_attempt,
client_ref,
username,
OFD_Date,
ofd_status,
daily_flag
,count(distinct awb_nr) as ofd
,count(distinct case when ofd_status ='Delivered' then awb_nr end) as delivered 
,(count(distinct awb_nr) -count(distinct case when ofd_status ='Delivered' then awb_nr end)) as undelivered
,count(distinct case when ofd_status like '%unreachable%' then awb_nr end) as unrechable
,count(distinct case when ofd_status in ('customer_canceled','RTO','attempts_exhausted') and  is_customer_cancelled =0 then awb_nr end) as customer_cancelled
,count(distinct case when ofd_status ='rescheduled' then awb_nr end) as rescheduled
,count(distinct case when ofd_status ='address_changed' then awb_nr end) as address_changed
,count(distinct case when ofd_status ='address_misrouted' then awb_nr end) as address_misrouted
,count(distinct case when ofd_status ='held_consolidation' then awb_nr end) as held_consolidation
,(count(distinct case when ofd_status in ('customer_canceled','RTO','attempts_exhausted') and  is_customer_cancelled =1  then awb_nr end)+
  count(distinct case when ofd_status ='address_changed_warning' then awb_nr end)) as customer_initiated_undelivered
,count(distinct case when ofd_status ='Not_Attempted' then awb_nr end) as not_attempted
from (SELECT *, CASE WHEN ddss.awb is null then 'Daily' else 'core' end as daily_flag FROM `noonbilogoi.MJ.OFD` ofd LEFT JOIN (SELECT awb_nr awb FROM `noonbilogmis.base_table.ShipmentTracker` )ddss on ddss.awb = ofd.awb_nr WHERE HUb IN  ('AUH-D2','DXB-D4') and DATE(OFD_DATe) >= current_date -2 )ofd
left join(select id_creq, id_creq_leg, id_country_zone from   `noonltddwh.lms.creq_leg`) as cl using(id_creq_leg)
left join (select id_country_zone, id_country from  `noonltddwh.lms.country_zone`) as cz using(id_country_zone)
left join (select id_country,code as country from `noonltddwh.lms.country`) as ctr using (id_country)
left join (select id_creq,client_ref, id_creq_type from `noonltddwh.lms.creq`) as c using ( id_creq)
left join (select id_creq_type, code as creq_type from  `noonltddwh.lms.creq_type`) as ct using (id_creq_type)
left join (select username, lms_roles from `noonltddwh.lms.user`
left join  `noonltddwh.lms.user_misc` using (id_user) ) using (username)
where creq_type='b2c_delivery' and OFD_Date >= current_date() -2 and country='ae' and lms_roles not in ("fast-manifest")
group by 1,2,3,4,5,6,7,8,9,10,11,12
order by 4
 )
 left join (select id_session_field , h.code as hub
from `noonltddwh.lms.session_field` 
left join `noonltddwh.lms.hub` h using (id_hub)) using (id_session_field)
where delivered > 0 and hub in ('AUH-D2','DXB-D4')
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1,2)
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1
'''


[[matview]]
dag_id = 'ofd_yfs1'
task_id = 'Hub_p11'
destination_table = '`noonbilogmis.reporting.Hub_perf_2hub1`'
sql = '''
select distinct
id_session_field,
awb_nr,
calls,
daily_flag,
omw,
reachable,
unreachable, last_call_attempt,
client_ref,
username,
OFD_Date,
Hub,
ofd_status,
count(distinct username) as Tot_DA,
sum(Total_OFD) as Total_OFD,
sum(Total_Delivered) as Total_Delivered,
round(if(sum(Total_OFD)>0,(sum(Total_Delivered)*100)/sum(Total_OFD),0),2) as percentage_delivered,
sum(Total_Undelivered) as Total_Undelivered,
sum(unrechable) as unrechable,
sum(customer_cancelled) as customer_cancelled,
sum(rescheduled) as rescheduled,
sum(address_changed) as address_changed,
sum(address_misrouted) as address_misrouted,
sum(held_consolidation) as held_consolidation,
sum(customer_initiated_undelivered) as customer_initiated_undelivered,
sum(not_attempted) as not_attempted,
from (
select
id_session_field,
awb_nr,
calls,
omw,
daily_flag,
reachable,
unreachable, last_call_attempt,
client_ref,
username,
OFD_Date,
Hub,
ofd_status,
sum(ofd) as Total_OFD,
sum(delivered) as Total_Delivered,
round(if(sum(ofd)>0,(sum(delivered)*100)/sum(ofd),0),2) as percentage_delivered,
sum(undelivered) as Total_Undelivered,
sum(unrechable) as unrechable,
sum(customer_cancelled) as customer_cancelled,
sum(rescheduled) as rescheduled,
sum(address_changed) as address_changed,
sum(address_misrouted) as address_misrouted,
sum(held_consolidation) as held_consolidation,
sum(customer_initiated_undelivered) as customer_initiated_undelivered,
sum(not_attempted) as not_attempted,
from (
select
id_session_field,
awb_nr,
calls,
omw,
reachable,
unreachable, last_call_attempt,
client_ref,
username,
OFD_Date,
ofd_status,
daily_flag
,count(distinct awb_nr) as ofd
,count(distinct case when ofd_status ='Delivered' then awb_nr end) as delivered 
,(count(distinct awb_nr) -count(distinct case when ofd_status ='Delivered' then awb_nr end)) as undelivered
,count(distinct case when ofd_status like '%unreachable%' then awb_nr end) as unrechable
,count(distinct case when ofd_status in ('customer_canceled','RTO','attempts_exhausted') and  is_customer_cancelled =0 then awb_nr end) as customer_cancelled
,count(distinct case when ofd_status ='rescheduled' then awb_nr end) as rescheduled
,count(distinct case when ofd_status ='address_changed' then awb_nr end) as address_changed
,count(distinct case when ofd_status ='address_misrouted' then awb_nr end) as address_misrouted
,count(distinct case when ofd_status ='held_consolidation' then awb_nr end) as held_consolidation
,(count(distinct case when ofd_status in ('customer_canceled','RTO','attempts_exhausted') and  is_customer_cancelled =1  then awb_nr end)+
  count(distinct case when ofd_status ='address_changed_warning' then awb_nr end)) as customer_initiated_undelivered
,count(distinct case when ofd_status ='Not_Attempted' then awb_nr end) as not_attempted
from (SELECT *, CASE WHEN ddss.awb is null then 'Daily' else 'core' end as daily_flag 

FROM 
(
SELECT ofd.*
FROM `noonbilogmis.reporting.OFD` ofd
left join `noonltddwh.lms.creq_leg` using (id_creq_leg) 
left join `noonltddwh.lms.creq` creq using (id_creq) 
left join `noonltddwh.lms.client` client using (id_client)
left join (SELECT it.awb_nr,sfi.is_delivery_block, sfi.id_address,
    cust.code customer_type, sf.created_at, id_session_field FROM `noonltddwh.lms.session_field` sf
LEFT JOIN `noonltddwh.lms.session_field_item` sfi USING (id_session_field)
LEFT JOIN `noonltddwh.lms.item` it USING (id_item)
LEFT JOIN `noonltddwh.lms.address` addr USING (id_address)
LEFT JOIN `noonltddwh.lms.customer` cus USING (id_customer)
LEFT JOIN `noonltddwh.lms.customer_type` cust USING (id_customer_type)
)  a using  (id_session_field,awb_nr)
left join (select username, lms_roles from `noonltddwh.lms.user` 
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username) 
where id_creq_type =1
and is_delivery_block =0
and lms_roles not in ("bag-unpack-count","fast-manifest","fast-manifest,non-sort-qc","non-sort-qc","tpl-handover","fast-manifest,seller-delivery","seller-delivery","sellerdelivery","fast-manifest","seller-delivery",'lms-locker-putaway','cashier','fc_bagging_job','lms-locker-harvest,lms-locker-putaway','lms-locker-putaway,lms-locker-harvest','lms-locker-putaway,lms-locker-harvest,cashier','lms-locker-putaway,lms-locker-harvest,seller-delivery','lms-locker-putaway,lms-locker-harvest,seller-delivery,cashier','seller-delivery,fast-manifest','stock-recon')
)ofd LEFT JOIN (SELECT awb_nr awb FROM `noonbilogmis.base_table.ShipmentTracker` )ddss on ddss.awb = ofd.awb_nr WHERE HUb IN  ('AUH-B2','DXB-B2') and DATE(OFD_DATe) >= current_date -2 )ofd
left join(select id_creq, id_creq_leg, id_country_zone from   `noonltddwh.lms.creq_leg`) as cl using(id_creq_leg)
left join (select id_country_zone, id_country from  `noonltddwh.lms.country_zone`) as cz using(id_country_zone)
left join (select id_country,code as country from `noonltddwh.lms.country`) as ctr using (id_country)
left join (select id_creq,client_ref, id_creq_type from `noonltddwh.lms.creq`) as c using ( id_creq)
left join (select id_creq_type, code as creq_type from  `noonltddwh.lms.creq_type`) as ct using (id_creq_type)
left join (select username, lms_roles from `noonltddwh.lms.user`
left join  `noonltddwh.lms.user_misc` using (id_user) ) using (username)
where creq_type='b2c_delivery' and OFD_Date >= current_date() -2 and country='ae' and lms_roles not in ("fast-manifest")
group by 1,2,3,4,5,6,7,8,9,10,11,12
order by 4
 )
 left join (select id_session_field , h.code as hub
from `noonltddwh.lms.session_field` 
left join `noonltddwh.lms.hub` h using (id_hub)) using (id_session_field)
where hub in ('AUH-B2','DXB-B2')
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1,2)
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1
'''



[[authview]]
dag_id ='mat_battleplan_once' 
task_id ='premium_services_cutoff'
destination_table =  'noonbilogmis.reporting.Logistics_breach_central_query_for_Breach'
sql ='''
with a as(
select *,
case
when id_sales_order_item_status != 7 and date(order_ts) = promise_date and order_type not in ("vip sdd","paid sdd","vip 3 hour delivery","regular 3 hour delivery") then "Unfeasible Promise"
when id_sales_order_item_status = 7 and cancellation_date > promise_date and date(order_ts) = promise_date and order_type not in ("vip sdd","paid sdd","vip 3 hour delivery","regular 3 hour delivery") then "Unfeasible Promise"
when id_sales_order_item_status != 7 and date(last_expected_ship) != date(first_expected_ship) and wh_change = 0  and date(fa_ts) > promise_date then "QC/ Missing Item"
when id_sales_order_item_status = 7 and cancellation_date > date(last_expected_ship) and date(last_expected_ship) != date(first_expected_ship) and wh_change = 0  and date(fa_ts) > promise_date then "QC/ Missing Item"
when id_sales_order_item_status != 7 and fulfilment_model_change = 1 and order_type in ("vip normal order","regular normal order") and date(last_expected_ship) > promise_date and date(first_expected_ship) <= promise_date and date(fa_ts) > promise_date then "Fulfillment Model Change not recovered by logistics" 
when id_sales_order_item_status = 7 and cancellation_date > promise_date and fulfilment_model_change = 1 and order_type in ("vip normal order","regular normal order") and date(last_expected_ship) > promise_date and date(fa_ts) > promise_date and date(first_expected_ship) <= promise_date then "Fulfillment Model Change not recovered by logistics"
when id_sales_order_item_status != 7 and fulfilment_model_change = 0 and wh_change = 1 and date(last_expected_ship) > promise_date and date(fa_ts) > promise_date and date(first_expected_ship) <= promise_date then "FBN WH Change not recovered by logistics" 
when id_sales_order_item_status = 7 and cancellation_date > promise_date and wh_change = 1 and fulfilment_model_change = 0 and date(fa_ts) > promise_date and date(last_expected_ship) > promise_date  and date(first_expected_ship) <= promise_date then "FBN WH Change not recovered by logistics"
--- Not Cancelled: FA is available
when id_sales_order_item_status != 7 and shipped_TS > expected_shipped_TS and export_ts <= expected_export_TS and date(fa_ts) > promise_date then "Breach due to Fulfilment Delay"
when id_sales_order_item_status != 7 and shipped_TS > expected_shipped_TS and export_ts > expected_export_TS and date(fa_ts) > promise_date then "Breach due to Export Delay"
when id_sales_order_item_status != 7 and shipped_TS <= expected_shipped_TS AND date(fa_ts) > promise_date then "Breach due to Logistics Delay"
---Not Cancelled: No FA after EDD
when id_sales_order_item_status != 7 and shipped_TS > expected_shipped_TS and export_ts <= expected_export_TS and date(fa_ts) is null and promise_date < current_date() then "Breach due to Fulfilment Delay"
when id_sales_order_item_status != 7 and shipped_TS > expected_shipped_TS and export_ts > expected_export_TS and date(fa_ts) is null and promise_date < current_date() then "Breach due to Export Delay"
when id_sales_order_item_status != 7 and shipped_TS <= expected_shipped_TS AND date(fa_ts) is null and promise_date < current_date() then "Breach due to Logistics Delay"
--- Cancelled
when id_sales_order_item_status = 7 and (shipped_TS > expected_shipped_TS or shipped_TS is null)
  and export_ts <= expected_export_TS and (date(fa_ts) > promise_date or date(fa_ts) is null) 
  and cancellation_date > promise_date
  then "Breach due to Fulfilment Delay"
when id_sales_order_item_status = 7 and (shipped_TS > expected_shipped_TS or shipped_TS is null)
  and (date(fa_ts) > promise_date or date(fa_ts) is null)
  and (export_ts > expected_export_TS or export_TS is null) and cancellation_date > promise_date
  then "Breach due to Export Delay"
when id_sales_order_item_status = 7 and shipped_TS <= expected_shipped_TS AND (date(fa_ts) > promise_date or date(fa_ts) is null)
  and cancellation_date > promise_date 
  then "Breach due to Logistics Delay"
else "No breach"
end as breach
from `noonbifugc.CWE.core_sales` 
where promise_date between current_date() - 2 and current_date() - 1 and fulfilment_type = "fbn" 
)
select*
from a
where breach = "Breach due to Logistics Delay"
'''


[[authview]]
dag_id ='mat_battleplan_once' 
task_id ='VJLMSFA'
destination_table =  'noonbilogmis.reporting.VJLMSFA'
sql ='''
SELECT awb_nr, DATE(FA) FA_Date
,FA FA_TS
FROM (
select awb_nr , CASE WHEN substr(awb_nr,14,1) = 'A' THEN timestamp_add(FA_TS,interval 4 hour) 
WHEN substr(awb_nr,14,1) = 'S' THEN timestamp_add(FA_TS,interval 3 hour) 
WHEN substr(awb_nr,14,1) = 'E' THEN timestamp_add(FA_TS,interval 2 hour) 
END AS FA
from (
select awb_nr ,  FA_TS
from (
SELECT
 *,
IF
 (LEAST(ifnull(clh1_created_at,
 TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), ifnull(outbound_ts,
 TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), ifnull(clh2_created_at,
 TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), ifnull(clh3_created_at,
 TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), ifnull(rto_created_at,
 TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), ifnull(locker_created_at,
 TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)))<dispatch_ts,
 dispatch_ts,
 IF
 (clh1_created_at IS NULL AND outbound_ts IS NULL AND clh2_created_at IS NULL AND clh3_created_at IS NULL AND rto_created_at IS NULL AND locker_created_at IS NULL AND add_ts IS NULL, NULL,
 LEAST(ifnull(clh1_created_at, TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
 , ifnull(outbound_ts, TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
 , ifnull(add_ts, TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
 , ifnull(clh2_created_at, TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
 , ifnull(clh3_created_at, TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
 , ifnull(rto_created_at,  TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
 , ifnull(locker_created_at, TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))))) AS FA_TS
FROM (
 SELECT
 id_item,
 item.awb_nr,
 item.created_at AS dispatch_ts,
 creq_leg.id_creq_leg,
 manifest_item.created_at AS outbound_ts,
 clh1.created_at AS clh1_created_at,
 clh2.created_at AS clh2_created_at,
 clh3.created_at AS clh3_created_at,
 creq_leg_rto.created_at AS rto_created_at,
 locker.created_at AS locker_created_at,
 add_ts,
 FROM
 `noondwh.lms.item` item
 LEFT JOIN
 (
SELECT sois.awb_nr ,MIN(timestamp_add(so.created_at,interval 7 hour)) add_ts
FROM noondwh.sales.sales_order_item soi
LEFT JOIN noondwh.sales.sales_order so using(id_sales_order)
LEFT JOIN `noondwh.sales.sales_order_address_change` soish on soish.id_sales_order = so.id_sales_order
LEFT JOIN noondwh.sales.sales_order_item_shipment sois using(id_sales_order_item_shipment)
WHERE soish.id_sales_order is not null
GROUP BY 1
) address_change on item.awb_nr = address_change.awb_nr
 LEFT JOIN (
 SELECT
 id_item,
 MAX(id_creq_leg) AS id_creq_leg
 FROM
 `noondwh.lms.item_state_history`
 LEFT JOIN
 `noondwh.lms.creq_leg`
 USING
 (id_creq_leg)
 WHERE
 id_creq_leg_type=3
 GROUP BY
 1) creq_leg
 USING
 (id_item)
 LEFT JOIN (
 SELECT
 *
 FROM
 `noondwh.lms.manifest_item`
 WHERE
 is_outbound=1 ) manifest_item
 USING
 (id_item)
 
 left join (select id_item , min(created_at) as created_at from `noondwh.lms.item_state_history` 
where id_loc_type in (12, 17)
group by 1) locker using (id_item)
 
 LEFT JOIN (
 SELECT
 id_creq_leg,
 MIN(created_at) AS created_at
 FROM
 `noondwh.lms.creq_leg_history`
 WHERE
 CAST(json_EXTRACT(DATA,
 '$.id_reason_held') AS int64) IN (1,
 2,
 3,
 4,
 5,
 10,
 20,
 22,
 23,
 26,
 36,
 47)
 OR json_EXTRACT(DATA,
 '$.scheduled_date') IS NOT NULL
 GROUP BY
 1) clh1
 USING
 (id_creq_leg)
 LEFT JOIN (
 SELECT
 id_creq_leg,
 MIN(created_at) AS created_at
 FROM
 `noondwh.lms.session_field_contact_attempt`
 WHERE
 id_attempt_type=4
 GROUP BY
 1) clh2
 USING
 (id_creq_leg)
 LEFT JOIN (
 SELECT
 id_creq_leg,
 MIN( created_at) AS created_at
 FROM
 `noondwh.lms.creq_leg_history`
 WHERE
 CAST (json_EXTRACT(DATA,
 "$.id_reason_held") AS int64) = 21
 AND json_EXTRACT(DATA,
 "$.updated_app") LIKE "%field%"
 GROUP BY
 1) clh3
 USING
 (id_creq_leg)
 LEFT JOIN (
 SELECT
 id_item,
 MIN(cl.created_at) AS created_at
 FROM
 `noondwh.lms.item_state_history`
 LEFT JOIN
 `noondwh.lms.creq_leg` cl
 USING
 (id_creq_leg)
 WHERE
 id_creq_leg_type=4
 GROUP BY
 1) creq_leg_rto
 USING
 (id_item))
) where awb_nr like "P%"
)
)
'''




[[matview]]
dag_id = 'ofd_yfs'
task_id = 'Hub_p1'
destination_table = '`noonbilogmis.reporting.Hub_perf_all`'
sql = '''
SELECT 
tt.id_item,	attempt_registered,	awb,	awb1,	brand_code,	calls,	code,	commercial_reporting_category,	created_at,	department,	family,	gtin,	ofd.hub,	ofd.hub_sector,	id_item_state_history,	id_loc_type,	id_product_fulltype,	id_session_field,	id_status,	id_user_updater,	is_content_complete,	is_customer_cancelled,	is_session_active,	last_call_attempt,	lc_time,	loc_id,	manifest_nr,	misc,	model_name_number,	msrp_ae,	msrp_eg,	msrp_sa,	num_attempts,	OFD_Date,	ofd_status,	omw,	product_subtype,	product_type,	reachable,	reason,	relayed_at,	reporting_category,	reporting_category_parent,	sku,	sku_config,	status_images,	status_qc,	title_en,	title_suffix_en,	touchpoint,	unreachable,	username,	variant,tt.id_creq_leg,shipment_status,cod1
,CASE WHEN cod1 is not null then 1 else 0 end as flag,f.client_ref,f.forward_hub
FROM
(
SELECT ish.*,hl.code,i.awb_nr awb1,timestamp_add(ish.created_at,interval 4 hour) lc_time
,cod1
FROM (
SELECT id_item,MAX(ish.created_At) dt
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.hub_location` hl on hl.id_hub_location = ish.loc_id
WHERE ish.id_loc_type = 1 and hl.code IN ('DXB-B1-OPEN-DXB-B1-RENSOPEN','DXB-B1-OPEN-DXB-B1-RCNSOPEN','DXB-B1-OPEN-DXB-B1-ELNSOPEN','DXB-B1-OPEN-DXB-B1-URNSOPEN','DXB-B3-TRIAGE','AUH-B2-TRIAGE','DXB-B2-TRIAGE','DXB-B2-TRIAGE')
GROUP BY 1
) t INNER JOIN `noonltddwh.lms.item_state_history` ish ON t.id_item = ish.id_item and t.dt = ish.created_at
LEFT JOIN `noonltddwh.lms.hub_location` hl on hl.id_hub_location = ish.loc_id
LEFT JOIN noonltddwh.lms.item i on i.id_item = ish.id_item
LEFT JOIN
(
SELECT ish.id_item id1,code cod1
FROM (
SELECT ish.id_item,MAX(created_at) dt
FROM `noonltddwh.lms.item_state_history` ish
GROUP BY 1
) tt inner join `noonltddwh.lms.item_state_history` ish ON tt.id_item = ish.id_item and tt.dt = ish.created_at
LEFT JOIN `noonltddwh.lms.hub_location` hl on hl.id_hub_location = ish.loc_id
WHERE  ish.id_loc_type = 1 and hl.code IN ('DXB-B1-OPEN-DXB-B1-RENSOPEN','DXB-B1-OPEN-DXB-B1-RCNSOPEN','DXB-B1-OPEN-DXB-B1-ELNSOPEN','DXB-B1-OPEN-DXB-B1-URNSOPEN','DXB-B3-TRIAGE','AUH-B2-TRIAGE','DXB-B2-TRIAGE','DXB-B2-TRIAGE')
)dd on dd.id1 = ish.id_item 
)tt
LEFT JOIN 
(
SELECT ofd.*,sf.created_at session_created
FROM  `noonbilogmis.reporting.OFD` ofd
LEFT JOIN `noonltddwh.lms.creq_leg` cl using(id_creq_leg)
LEFT JOIN `noonltddwh.lms.session_field` sf using(id_session_field)
LEFT JOIN
(
SELECT id_item,MIN(ish.created_at) dt
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.hub_location` hl on hl.id_hub_location = ish.loc_id
WHERE id_loc_type = 1
and hl.code IN ('DXB-B1-OPEN-DXB-B1-RENSOPEN','DXB-B1-OPEN-DXB-B1-RCNSOPEN','DXB-B1-OPEN-DXB-B1-ELNSOPEN','DXB-B1-OPEN-DXB-B1-URNSOPEN','DXB-B3-TRIAGE')
GROUP BY 1
)ss on ss.id_item = ofd.id_item and ss.dt <= sf.created_at  
WHERE ss.id_item is not null and cl.id_creq_leg_type = 3
)
ofd on tt.id_item = ofd.id_item 
LEFT JOIN
(
SELECT distinct sois.awb_nr awb, ss.*
FROM  noonltddwh.sales.sales_order_item soi
LEFT JOIN noonltddwh.sales.sales_order so using(id_sales_order)
LEFT JOIN  noonltddwh.sales.sales_order_item_shipment sois using(id_sales_order_item_shipment)
LEFT JOIN noonbicedata.nmviews_v1.catalog_noon ss using(sku)
WHERE id_cart_type =1
and id_invoice_section =1
) dd on dd.awb = tt.awb1
LEFT JOIN `noonbilogoi.battleplan_v1.item_final_state` f on f.awb_nr = tt.awb1
'''

[[authview]]
dag_id ='mat_battleplan_once' 
task_id ='ASN_Queue_Monitoring'
destination_table =  'noonbilogmis.reporting.ASN_Queue_Monitoring'
sql ='''
SELECT    Hub,hub_sector,client_ref,awb_nr , CASE WHEN name is null then display_name else name end AS Partner,created_At,remarks,updated_at,num_attempts
FROM (
select distinct creq.client_ref , creq.id_creq,aa.display_name
,creq.created_at 
,if(creq_legd.id_creq_leg_type is not null,creq_legd.id_creq_leg_type,creq_legp.id_creq_leg_type) as creq_leg_type
,if(creq_legp.id_creq_leg_type=5,'fast_manifest','ops_inbound') as inbound_type
,item.awb_nr 
,hub_sector.code hub_sector
,item.created_at as pickup_ts
,username
,creq_legp.num_attempts 
,creq_legp.remarks 
,substr(country_zone.code,0,2) as country
,substr(hub_sector.code,0,6) as hub
,address.address_uid as wh
,partner.name
,manifest.id_manifest_type,manifested.id_manifest_type id_manifest_type_1,item_state.id_loc_type
,if(creq_legd.id_creq_leg is null or item.created_at IS NULL,'pending_pickup'
,if(manifest.id_manifest_type=2,'handed_over_to_ib'
,if(manifested.id_manifest_type=2,'handed_over_to_ib'
,if(item_state.id_loc_type in (4,3),'in_transit'
,if(item_state.id_loc_type=1,'in_hub'
,if(item_state.id_loc_type=2,'pending_handover_from_da','Pickup_done')))))) as status
,if(item_state.updated_at is null,creq_legp.updated_at,item_state.updated_at) as updated_at
from `noonltddwh.lms.creq` as creq
left join (select * from  `noonltddwh.lms.creq_leg` where id_creq_leg_type in (1,5)) as creq_legp using (id_creq)
LEFT JOIN
(
SELECT a.id_address,pw.display_name 
FROM `noonltddwh.lms.address` a
LEFT JOIN `noonltddwh.partner.partner_warehouse` pw on a.address_uid = pw.code
) aa on creq_legp.id_address =  aa.id_address 
left join `noonltddwh.lms.country_zone` as country_zone using (id_country_zone)
left join (select * from  `noonltddwh.lms.creq_leg` where id_creq_leg_type in (2)) as creq_legd using (id_creq)
left join (select * from (select id_item, max(created_at) as created_at from  `noonltddwh.lms.item_pkg` group by 1) 
left join `noonltddwh.lms.item_pkg` as item_pkgx using (id_item,created_at))  as item_pkg on item_pkg.id_creq_leg =creq_legd.id_creq_leg 
left join `noonltddwh.lms.hub_sector` as hub_sector on hub_sector.id_hub_sector =creq_legp.id_hub_sector 
left join `noonltddwh.lms.address` as address on address.id_address =creq_legd.id_address 
left join `noonltddwh.lms.item` as item using (id_item)
left join `noonltddwh.lms.reason` as reason on reason.id_reason =creq_legp.id_reason_held 
left join `noonltddwh.lms.item_state` as item_state using (id_item)
left join `noonltddwh.lms.manifest` as manifest on (5,manifest.id_manifest)=(item_state.id_loc_type ,item_state.loc_id)
left join `noonltddwh.lms.manifest` as manifested on (6,manifested.id_manifest)=(item_state.id_loc_type ,item_state.loc_id)
left join `noonltddwh.lms.hub_transfer`  as hub_transfer on (4,hub_transfer.id_hub_transfer)=(item_state.id_loc_type ,item_state.loc_id)
left join `noonltddwh.lms.item`  as pgroup on (3,pgroup.id_item)=(item_state.id_loc_type ,item_state.loc_id)
left join `noonltddwh.lms.hub_location`   as hub_location on (1,hub_location.id_hub_location)=(item_state.id_loc_type ,item_state.loc_id)
left join `noonltddwh.lms.user` user on (2,user.id_user)=(item_state.id_loc_type ,item_state.loc_id)
left join `noonltddwh.ops_inbound.asn` as asn on asn.asn_nr =creq.client_ref 
left join `noonltddwh.ref.partner` as partner on partner.id_partner = asn.id_partner_source  
where creq.id_creq_type =4) T
WHERE status IN ('pending_pickup') AND country = 'EG'
'''


[[authview]]
dag_id ='mat_battleplan_once' 
task_id ='Pending_Shipments_at_LPC'
destination_table =  'noonbilogmis.reporting.Pending_Shipments_at_LPC'
sql ='''
SELECT DISTINCT *
FROM  `noonbilogoi.nefreelancer.ne_pending_shipments_mat` mt
LEFT JOIN 
(
SELECT distinct sois.awb_nr awb, substr(pw.display_name ,6,100) wh_type
FROM noonltddwh.sales.sales_order_item_shipment sois
LEFT JOIN `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse 
) T ON T.awb = mt.awb_nr 
LEFT JOIN
(
SELECT awb_nr awbnr,Username 
FROM `noonbilogoi.LOGKSA_DATA.lms_v2` 
)us on mt.awb_nr = us.awbnr
LEFT JOIN
(
select awb_nr, max(ish.created_at) as Last_LPC_Receiving 
from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.hub_location`  hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location) 
left join noonltddwh.lms.item i using(id_item)
where id_loc_type = 1 and (hl.code  like "%Z1%" or hl.code  like "%Z2%" or hl.code  like "%Z3%") group by 1)lpc using(awb_nr)
WHERE (current_location like '%Z1%' OR current_location like '%Z2%' OR current_location like '%Z3%') AND country = 'EG'
AND final_status not in ('Returned_to_CFC','Pending for Dispatch','RTO Pending for Handover','Shipped','carrier_switch')
'''

[[dags]]
dag_id = 'st_dag'
schedule_interval = '0 4 * * *'

[[matview]]
dag_id = 'st_dag'
task_id = 'Story_Board_Query_1'
destination_table = 'noonbilogmis.reporting.Story_Board_Query_1'
sql = '''
SELECT *,current_timestamp() st FROM (
SELECT * FROM (select  
INITCAP(case when json_extract_scalar(creq.misc,'$.mp_code') is null  then client.name 
else json_extract_scalar(creq.misc,'$.mp_code') end) 
as MP, 
case when id_carrier is null then "Noon Express" else cr.name end  as carrier,
case 
when id_country =1 then "AE" when id_country =2 then "SA" when id_country =3 then "EG" end as Country ,
hub.code AS Hub,
case when item_pkg.cod_value is not null then "COD" else "Prepaid" end as Payment_Method,
count(distinct  id_item) as Total_Shipment
from `noonltddwh.lms.item` item
--left join (SELECT awb_nr, carrier from `noonbilogoi.LMS_CORE.awb_carrier` ) T using(awb_nr)
left join `noonltddwh.lms.item_pkg` item_pkg using (id_item)
left join `noonltddwh.lms.creq_leg` creq_leg using (id_creq_leg)
left join `noonltddwh.lms.carrier` as cr using (id_carrier)
left join `noonltddwh.lms.creq` creq using (id_creq)
left join `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector 
left join `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub 
left join `noonltddwh.lms.client` client using (id_client)
left join `noonltddwh.lms.country_zone` using (id_country_zone)
 
where id_creq_type =1
and item.id_item_type =1
and date(PROMISED_at) = current_Date -1
--and extract(month from current_date)=extract(month from date(item.created_at))
--and extract(year from current_date)=extract(year from date(item.created_at))
group by 1,2,3,4,5
)
WHERE MP NOT LIKE "%Daily%" 
)
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'OFD_DEL_SB'
destination_table = 'noonbilogmis.reporting.OFD_DEL_SB'
sql = '''
select distinct country, count(distinct awb_nr) as total_ofd  ,
count( distinct case when ofd_status ="Delivered" then awb_nr end ) total_delivered
from (select distinct * 
from(
select hh.code as ofd_hub,country, hub as awb_hub, hub_sector, client_ref, awb_nr, OFD_Date, manifest_nr, touchpoint, username, ofd_status, attempt_registered, reason, num_attempts, is_session_active, calls, omw, reachable, unreachable, last_call_attempt, creq_type, is_customer_cancelled , if(cod_value is not null, "COD", "Prepaid") as Payment_mode, id_session_field , id_item , id_pay_model,od.app as  lms_version ,is_delivery_block
from `noonbilogoi.MJ.OFD` as od 
left join (select id_item, promised_at , cod_value from `noonltddwh.lms.item_pkg` ) using (id_item)
left join(select id_creq, id_creq_leg, id_country_zone from `noonltddwh.lms.creq_leg`) as cl using(id_creq_leg)
left join (select id_country_zone, id_country from `noonltddwh.lms.country_zone`) as cz using(id_country_zone)
left join (select id_country,code as country from `noonltddwh.lms.country`) as ctr using (id_country)
left join (select id_creq, client_ref , id_creq_type from `noonltddwh.lms.creq`) as c using ( id_creq)
left join (select id_creq_type, code as creq_type from `noonltddwh.lms.creq_type`) as ct using (id_creq_type)
left join `noonltddwh.lms.session_field` using (id_session_field)
left join `noonltddwh.lms.hub` hh using (id_hub)
left join (select username, lms_roles , id_pay_model from `noonltddwh.lms.user`
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username)
where creq_type='b2c_delivery'
and OFD_Date = current_date() -1
--and OFD_Date  between '2022-10-01' and '2022-10-31'
and substr(client_ref,6,1) <> "D"
and is_delivery_block = 0
and ofd_status <> "RTO"))
group by 1 
'''

#[[matview]]
#dag_id = 'st_dag'
#task_id = 'MT_DEL_SB'
#destination_table = 'noonbilogmis.reporting.MT_DEL_SB'
#sql = '''
#select c.code as Country,
#count(distinct item.id_item) as shipments,
#count(distinct case when id_manifest_type = 4 then item.id_item end ) as Delivered
#,current_timestamp() ts
#from `noonltddwh.lms.item`  item
#left join `noonltddwh.lms.item_pkg` using (id_item)
#left join `noonltddwh.lms.item_state` using (id_item)
#left join `noonltddwh.lms.manifest_item` mi on mi.id_item =item.id_item 
#left join `noonltddwh.lms.manifest` using (id_manifest)
#left join `noonltddwh.lms.creq_leg` creq_leg using (id_creq_leg)
#left join `noonltddwh.lms.creq` creq  on creq.id_creq=creq_leg.id_creq
#left join `noonltddwh.lms.country_zone` using (id_country_zone)
#left join `noonltddwh.lms.country` c  using (id_country)
#left join `noonltddwh.lms.client` client using (id_client)
#LEFT JOIN(
#select distinct item.awb_nr , tipm.id_item , tcr.reference_nr, tcr.id_carrier as tpl_carrier  from `noonltddwh.lms.item` item
#LEFT JOIN `noonltddwh.lms.tpl_item_pgroup_map` tipm on tipm.id_item =item.id_item 
#LEFT JOIN `noonltddwh.lms.tpl_carrier_reference` tcr on tipm.id_item_pgroup = tcr.id_item
#)tpl on item.awb_nr =tpl.awb_nr 
#where id_creq_type =1
#and (INITCAP(case when json_extract_scalar(creq.misc,'$.mp_code') is null  then client.name 
#else json_extract_scalar(creq.misc,'$.mp_code') end) ) not like "%Daily%"
#and id_loc_type <>9
#and reference_nr is null
#and date_diff(current_date(),date(item.created_at) ,day)<=40 
#and date_diff(current_date(),date(item.created_at) ,day)>=10 
#and id_item_type =1
#group by 1
#ORDER by 1
#'''

[[matview]]
dag_id = 'st_dag'
task_id = 'warranty'
destination_table = 'noonbilogmis.reporting.warranty'
sql = '''
SELECT
  country,
  CASE
    WHEN hub = "CAI-T1" THEN "3pl"
    WHEN hub = "RUH-T1" THEN "3pl"
  ELSE
  "nE"
END
  AS carrier,
  COUNT(DISTINCT client_ref) AS Total_request,
  COUNT(DISTINCT
    CASE
      WHEN Creation_With_Cutoff >= CURRENT_DATE() - 1 THEN client_ref
  END
    ) AS New_Request,
  COUNT(DISTINCT
    CASE
      WHEN Creation_With_Cutoff = CURRENT_DATE() - 2 THEN client_ref
  END
    ) AS Pending_request,
  COUNT(DISTINCT
    CASE
      WHEN num_attempts <> 0 THEN client_ref
  END
    ) AS Assigned,
  COUNT(DISTINCT awb_nr) AS picked,
  COUNT(DISTINCT
    CASE
      WHEN num_attempts = 0 THEN client_ref
  END
    ) AS Un_Attempted,
  COUNT(DISTINCT
    CASE
      WHEN num_attempts = 0 AND TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), created_at, hour )> 48 THEN client_ref
  END
    ) AS OverTAT,
  COUNT(DISTINCT
    CASE
      WHEN num_attempts = 0 AND TIMESTAMP_DIFF(CURRENT_TIMESTAMP(), created_at, hour )< 48 THEN client_ref
  END
    ) AS UnderTAT
    ,current_timestamp() ts
FROM
  `noonbilogoi.reporting_mart.Warranty_pickup_summary`
WHERE
  Creation_With_Cutoff >= CURRENT_DATE() - 2
  AND Creation_With_Cutoff <> current_date
  AND carrier <>"3pl"
GROUP BY
  1,
  2
  ORDER By 1
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Story_Board_Query_9'
destination_table = 'noonbilogmis.reporting.Story_Board_Query_9'
sql = '''
select *
, round((total_attempted*100/total_shipments),2) as attempt_percent
, round((total_delivered*100/total_shipments),2) as delivery_percent
from
(select country
, count (DISTINCT awb_nr) as total_shipments
, count(distinct case when attempt_check = 1 then awb_nr end) as total_attempted
, count(distinct case when creq_leg_type = 'Delivery' and loc_type = 'manifested' then awb_nr end) as total_delivered
, count(distinct case when attempt_check = 0 and cut_off_remarks = 'shipped_before_cutoff' then awb_nr end) as logistics_breach
, count(distinct case when attempt_check = 0 and cut_off_remarks = 'shipped_after_cutoff' then awb_nr end) as shipping_breach
from
(select awb_nr , client_ref , hub , display_name , country , creq_leg_type , status , date(promised_at) as promised_date ,
if(shipping_ts > expected_shipping_ts , "shipped_after_cutoff" , "shipped_before_cutoff") as cut_off_remarks , shipping_ts , expected_shipping_ts , diff as confirmed_to_exported_time
, loc_type , attempt_check
from
(
select distinct awb_nr , ifs.client_ref as client_ref, ifs.hub as hub, ifs.origin_warehouse as wh_name , ifs.display_name as display_name ,ifs.country as country , ifs.creq_leg_type as creq_leg_type , ifs.status as status,  promised_at , shipped_at , fa_TS , date(so.created_at) as order_date , day , cutoff , check , diff , loc_type ,  if(date(fa_TS) <= date(promised_at),1,0) as attempt_check
,case
when ifs.loc_type = "manifested" and ifs.status = "completed"  then "Delivered"
when ofd_status is not null then ofd_status
when ofd_status is null and ifs.loc_type = "pending_addr" then "Pending_Handover"
when ofd_status is null and ifs.loc_type = "manifest" or ifs.loc_type is null  then "Pending_receiving"
when ofd_status is null and ifs.loc_type = "hub_location" and ifs.current_location like "%Z1%" then "At_Z1_Triage"
when ofd_status is null and ifs.loc_type = "hub_location" and ifs.current_location like "%G1%"  then "At_G1_Triage"
when ofd_status is null and ifs.loc_type = "hub_transfer" then "In_hub_transfer"
when ofd_status is null and ifs.loc_type = "pgroup" then "In_GA_Bag"
when ofd_status is null and ifs.loc_type = "hub_location" and (clx.num_attempts > 0 or ifs.current_location like "%OVF-H%") then "Attempted_At_hub"
when ofd_status is null and ifs.loc_type = "hub_location" and clx.num_attempts = 0 then "Pending_At_hub"
when ofd_status is null and ifs.loc_type = "user" then "with_user"
when ofd_status is null and ifs.loc_type = "manifested"  and ifs.current_location not like "%DA%" then "Returned"
when shipment_nr is null then "pending_shipment_creation"
end as final_status
,case WHEN ifs.country = 'ae' THEN TIMESTAMP_ADD(shipped_at,INTERVAL 4 HOUR)
WHEN ifs.country = 'sa' THEN TIMESTAMP_ADD(shipped_at,INTERVAL 3 HOUR)
WHEN ifs.country = 'eg'  THEN TIMESTAMP_ADD(shipped_at,INTERVAL 2 HOUR)
end as shipping_ts
, manifest_nr,
case when day = 'EDD-0' then timestamp_add(estimated_delivery_at,interval Cutoff hour)
when day = 'EDD-1' then timestamp_add(timestamp_sub(estimated_delivery_at, interval 24 hour) , interval Cutoff hour)
else timestamp_add(timestamp_sub(estimated_delivery_at, interval 24 hour) , interval 18 hour)
end as expected_shipping_ts
from `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.ref.sales_order_item_status` s on soi.id_sales_order_item_status = s.id_sales_order_item_status
left join `noonltddwh.sales.sales_order_item_shipment` sois on sois.id_sales_order_item_shipment =soi.id_sales_order_item_shipment
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca  on ca.address_code = so.address_code
left join (select id_city, name_en as city  from `noonltddwh.ref.city` ) as cy using(id_city)
left join `noonbilogoi.Share_Point.NE_FAS` using (awb_nr)
left join `noonbilogoi.battleplan_v1.item_final_state` ifs using (awb_nr)
left join (select * from `noonbilogmis.NA_tables.premium_services_cutoff` where type = 'SDD') ps on (ifs.origin_warehouse , ca.id_city) = (ps.warehouse_code , ps.id_city)
left join `noonltddwh.lms.creq` c using (client_ref  )
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type = 3) clx on clx.id_creq = c.id_creq
left join (select * from `noonbilogoi.MJ.OFD` WHERE OFD_Date = current_date()) using (awb_nr)
left join (select id_sales_order_item, item_nr, soish.id_sales_order_item_status, awb_nr , soish.created_at as shipped_at
from `noonltddwh.sales.sales_order_item_status_history` soish
left join `noonltddwh.sales.sales_order_item` soi using ( id_sales_order_item)
left join `noonltddwh.sales.sales_order_item_shipment` using ( id_sales_order_item_shipment)
where soish.id_sales_order_item_status = 5) using (awb_nr)
left join (select distinct item_nr , payment_method_code , min_confirmed_at , min_exported_at , timestamp_diff(min_exported_at , min_confirmed_at , minute) as diff ,
if(timestamp_diff(min_exported_at , min_confirmed_at , minute)>30,1,0) as check
from `noonltddwh.sales.sales_order_item`
left join `noonltddwh.sales.sales_order` using (id_sales_order )
left join `noonltddwh.cache.sales_order_item_summary` using (id_sales_order_item)) b on b.item_nr = soi.item_nr
left join (
select distinct id_item, awb_nr, if(id_partner_warehouse_from= id_partner_warehouse_outbound,"FBN","MP") as BU , shipped_at as expected_shipped_at
from `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left JOIN noonltddwh.oms.purchase_item pi on pi.purchase_item_nr = poi.purchase_item_nr
left JOIN `noonltddwh.oms.stock_item` b USING (id_purchase_item)
left join `noonltddwh.lms.item` using (awb_nr)) using (awb_nr)
left join `noonltddwh.partner.partner_warehouse` pw on origin_warehouse = pw.code
where soi.id_invoice_section = 1
and so.id_cart_type = 1
and awb_nr is not null
and date(estimated_delivery_at) = current_date()-1
and so.misc like ('%vip%')
and so.country_code  is not null
))
GROUP BY 1
ORDER BY 1
)
WHERE country is not null 
ORDER by 1
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'FA_DEL'
destination_table = 'noonbilogmis.reporting.FA_DEL'
sql = '''
select * , round(fa_delivered/fa_shipment*100,2)Tdel_prec from(select
distinct
 ifs.country , 
--a.ofd_hub,
-- extract(month from ofd1.ofd_date) as fa_month,
-- extract(year from ofd1.ofd_date) as fa_year,
--CASE WHEN so.payment_method_code = 'cod' THEN 'COD' ELSE 'Prepaid' END AS pay_method,
count(distinct a.awb_nr) as fa_shipment,
count(distinct case when ofd1.ofd_status ="Delivered" then a.awb_nr end) as fa_delivered
from (
  select awb_nr, ofd.ofd_hub, 
  min(ofd_ts) as ofd_ts,
  from `noonbilogoi.MJ.OFD` ofd
  left join `noonbilogmis.base_table.creq_leg` using(id_creq_leg)
  left join `noonbilogmis.base_table.creq` using(id_creq)
  left join `noonbilogoi.battleplan_v1.item_final_state` using(awb_nr)
  left join `noonltddwh.sales.sales_order_item_shipment` sois using (awb_nr)
  left join `noonltddwh.sales.sales_order` so using (id_sales_order)
  where ofd.is_delivery_block = 0 
  and so.id_mp != 6 -- removes daily 
 and ofd_status<>'Not_Attempted'
  and ((id_creq_type =1 and id_creq_leg_type = 3))
  and ofd.hub_sector not like '%SP%' -- removes locker 
  group by 1,2
) a 
left join `noonbilogoi.MJ.OFD` ofd1 on (ofd1.awb_nr,ofd1.ofd_ts)=(a.awb_nr,a.ofd_ts)
LEFT JOIN `noonbilogoi.battleplan_v1.item_final_state` ifs on a.awb_nr=ifs.awb_nr
left join `noonltddwh.sales.sales_order` so on so.order_nr=ifs.client_ref
-- LEFT JOIN 
-- (SELECT distinct awb_nr, country as country_code, customer_type, payment_method_code, date(delivered_ts) as delivered_date
--   FROM `noonbifugc.datamart.core_sales` 
--   where awb_nr is not null
-- ) cs on a.awb_nr=cs.awb_nr

left join (  
select distinct awb_nr, reason cs_ud, updated_app, a.updated_date
from (select distinct id_creq_leg, awb_nr,
json_extract(clh.data,'$.updated_app') as updated_app,
r.code as reason, data, date(clh.created_at) updated_date
, row_number()over(partition by awb_nr order by clh.created_at desc) rw
from `noonltddwh.lms.creq_leg_history` clh
left join `noonltddwh.lms.creq_leg` cl using(id_creq_leg)
left join `noonltddwh.lms.creq` creq using(id_creq)
left join `noonltddwh.lms.reason` r on CAST(json_EXTRACT(DATA,"$.id_reason_held") AS INT64) = r.id_reason
left join `noonltddwh.lms.user` u using(id_user)
left join (select distinct awb_nr, id_item, id_creq_leg 
from `noonltddwh.lms.item_state_history`
left join `noonltddwh.lms.item` it using(id_item)
)ish using(id_creq_leg)
---------
where id_creq_leg_type =3
and date(clh.created_at) >= current_Date -10
and id_creq_type =1 and json_extract(clh.data,'$.updated_app') ='"client"'
order by 1,4) a
where rw=1
and reason in ('held_consolidation','rescheduled','held_for_pickup', 'customer_canceled') 
) ud on (a.awb_nr) = (ud.awb_nr)

where (if(ud.updated_date < ofd1.ofd_date,1,0)=1 or ud.cs_ud is null)
and ofd1.ofd_date = current_date() - 1
-- and ofd1.ofd_hub=ifs.forward_hub
and  (substr(a.ofd_hub,5,1) NOT IN ("G","Z","Y","V") or a.ofd_hub in (select string_field_0 from `noonbilogmis.reporting.MH_Facilities` where string_field_1 like 'LM%')) 
-- and ifs.country='eg' 
group by 1)
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Story_Board_Query_3'
destination_table = 'noonbilogmis.reporting.Story_Board_Query_3'
sql = '''
select 
case when cz.id_country =1 then "AE"
     when cz.id_country =2 then "SA"
     when cz.id_country =3 then "EG"
     else "Check"
     end as Country,
OFD.Hub, 
Total_shipments, 
Overall_Breached,  
Pure_NoonExpress_Breached, 
Grocery_Breached,
TPL_FLow_Breached,
total_delivered_shipments as consolidation_shipment, 
delivered_together as consolidated_delivered, 
count(Distinct username ) as DA, 
CURRENT_DATETIME() AS Current_date
from `noonbilogoi.MJ.OFD`  OFD 
left join `noonbilogoi.Share_Point.DE_rollout_shipments`as de using(awb_nr)
left join `noonltddwh.lms.creq_leg` using (id_creq_leg) 
left join `noonltddwh.lms.creq` using (id_creq) 
left join `noonltddwh.lms.hub_sector` hs using (id_hub_sector)
left join `noonltddwh.lms.country_zone` cz using (id_country_zone)
left join `noonltddwh.sales.sales_order`od on client_ref =od.order_nr 
left join (select username, lms_roles from `noonltddwh.lms.user` 
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username) 
left join ( 
SELECT Country,LM_Hub,SUM(Total_EDD_Shipments)Total_Shipments,SUM(Overall_Breach) Overall_Breached,  
SUM(Pure_NE_Breached) Pure_NoonExpress_Breached,
SUM(Grocery_Breach) Grocery_Breached,
SUM(TPL_FLow_Breach) TPL_FLow_Breached
FROM (
SELECT pad.* FROM `noonbilogmis.reporting.PDD_Breach_Raw_data`  pad
left join `noonbilogoi.battleplan_v1.item_final_state`it on it.awb_nr =pad.awb_nr
WHERE  edd = current_date()-1 and substr(LM_Hub,5,1) <> 'T' 
and it.loc_type <> 'pending_addr'

and current_location not like '%-BLK%'
)
group by 1,2
)as Breach on (OFD.Hub)=(Breach.LM_Hub) 
left join ( SELECT lower(country_code ) as Country, 
Hub, 
total_delivered_shipments , 
delivered_together FROM (Select "Yesterday" as Ageing, country_code, Hub, sum(delivered_shipments) as total_delivered_shipments, sum(delivered_together) as delivered_together, 
sum(other_shipments) as not_together, sum(other_shipments) as Other_Shipment, 
count(distinct case when flag=1 then customer_code end) as customers_more_than_1_DA, 
count(distinct customer_code) as total_customers_delivered 
From ( Select country_code,
customer_code,
Hub,delivered_date, sum(shipments) as delivered_shipments, 
sum(delivered_together) as delivered_together, 
sum(other_shipments) as other_shipments, 
max(if(other_shipments>0,1,0)) as flag from (Select 
country_code, 
final.customer_code, 
delivered_date, Hub, 
count(distinct b.awb_nr) as shipments, 
count(distinct case when time_diff<=1 and b.awb_nr is not null then b.awb_nr end) as delivered_together, 
count(distinct case when delivered_ts<>min_ts and time_diff>=1 and b.awb_nr is not null and min_ts<>max_ts 
and max_ts is not null then b.awb_nr end) as other_shipments 
From (Select country_code,customer_code,Hub,delivered_date,min_ts,max_ts, timestamp_diff(max_ts,min_ts,hour) as time_diff 
From ( select distinct hub.code as Hub, 
so.customer_code , so.country_code, date(min_delivered_at) as delivered_date, 
count(distinct awb_nr) as shipments, min(min_delivered_at) as min_ts, max(min_delivered_at) as max_ts, 
from `noonltddwh.sales.sales_order_item` soi 
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order 
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment 
left join `noonltddwh.lms.client_pkg_ref` client_pkg_ref using (awb_nr) 
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) 
left join `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector 
left join `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub 
left join (SELECT * FROM `noonltddwh.cache.sales_order_item_summary` 
WHERE sales_order_pdate >= '2021-11-01') soiss on soi.id_sales_order_item =soiss.id_sales_order_item 
where id_cart_type =1
and id_invoice_section =1 
and sois.id_carrier =9 
and soi.id_sales_order_item_status =6 
--and extract(year from min_delivered_at)=extract(year from current_date())
group by 1,2,3,4 )) as final 
left join ( select distinct so.customer_code , awb_nr , min_delivered_at as delivered_ts 
from `noonltddwh.sales.sales_order_item` soi 
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order 
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment 
left join (SELECT * FROM `noonltddwh.cache.sales_order_item_summary` 
WHERE sales_order_pdate >='2021-11-01' ) soiss on soi.id_sales_order_item =soiss.id_sales_order_item 
where id_cart_type =1 
and id_invoice_section =1 
and sois.id_carrier =9 
and soi.id_sales_order_item_status =6 ) b on (final.customer_code,delivered_date)=(b.customer_code,date(b.delivered_ts)) 
--where extract(year from delivered_date)=extract(year from current_date()) 
and delivered_date = current_date -1
group by 1,2,3,4)group by 1,2,3,4 ) 
group by 1,2,3 
order by country_code , hub ) 
where Ageing='Yesterday' ) as Consolidation on (OFD.Hub)=(Consolidation.Hub) 
where ofd_date = current_date -1 
and lms_roles not in ("fast-manifest","fast-manifest,non-sort-qc","non-sort-qc","seller-delivery") 
and id_creq_type =1 
and od.id_mp!=6 
and Total_shipments is not null and is_delivery_block = 0 
and id_service_logistics <> 4
group BY 1,2,3,4,5,6,7,8,9,11
order by 1,2

'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Story_Board_Query_Z'
destination_table = 'noonbilogmis.reporting.Story_Board_Query_Z'
sql = '''
SELECT Country,LM_Hub,Hub_sector ,SUM(Total_EDD_Shipments)Total_Shipments,SUM(Overall_Breach) Overall_Breached,  
SUM(Pure_NE_Breached) Pure_NoonExpress_Breached,
FROM (
SELECT * FROM `noonbilogmis.reporting.PDD_Breach_Raw_data` 
WHERE  
(edd = current_date()-1 and Hub_sector in ('RUH-A4-SLM-Z', 'RUH-A7-SLM-Z' ,'JED-A1-SLM-M','JED-A1-SLM-X','JED-A5-SLM-X'))
OR (hub_sector like 'RUH-V1%'and edd = current_date()-1)
)
group by 1,2,3
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Story_Board_Query_5'
destination_table = 'noonbilogmis.reporting.Story_Board_Query_5'
sql = '''
Select distinct
so.country_code as Country ,
Destination_City,
count(distinct so.order_nr) as Total_Orders,
count(distinct soi.item_nr) as Total_Item,
count(distinct case when min_delivered_at is not null then d.awb_nr end ) as Total_Delivered,
count(distinct d.awb_nr ) as Total_Shipment
,current_timestamp() ts
from  `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.sales.sales_order` so using (id_sales_order)  
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca on so.address_code = ca.address_code
left join (select id_city, name_en as destination_city  from `noonltddwh.ref.city` ) as dc on ca.id_city=dc.id_city
left join `noonltddwh.sales.sales_order_item_shipment` d using (id_sales_order_item_shipment)
left join (select id_city, name_en as origin_city  from `noonltddwh.ref.city` ) as o on id_origin_city=o.id_city
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left join `noonltddwh.oms.purchase_item`  pi on pi.purchase_item_nr = poi.purchase_item_nr
left join `noonltddwh.oms.stock_item` b USING (id_purchase_item)
left join `noonltddwh.partner.partner_warehouse` partner_warehouse on b.id_partner_warehouse_outbound=partner_warehouse.id_partner_warehouse
left join 
(SELECT * FROM `noonltddwh.cache.sales_order_item_summary` WHERE sales_order_pdate >= date_add(current_date(),interval -2 day)
) cache on soi.id_sales_order_item =cache.id_sales_order_item 
where date_diff(current_date(),date(estimated_delivery_at),day)=1
and soi.sales_order_pdate >= date_add(current_date(),interval -2 day)
and so.sales_order_pdate >= date_add(current_date(),interval -2 day)
and date_diff(current_date(),date(so.created_at),day)=2
and DESTINATION_CITY=ORIGIN_CITY
and id_partner_warehouse_from= id_partner_warehouse_outbound  -- Condition for FBN
and DESTINATION_CITY in ('Riyadh','Dubai','Jeddah')
and Origin_City in ('Riyadh','Dubai','Jeddah')
and partner_warehouse.display_name in ("NOON/DXB05","NOON/RUH02","NOON/JED01",'NOON/DMM01','NOON/DXB06','NOON/DXBFW01','NOON/RUH04')
and extract(hour from so.created_at)<= (case when so.country_code="SA" then 14 when so.country_code="AE" then 13 end)
and soi.id_sales_order_item_status not in (1,2,7,9)
and soi.id_invoice_section = 1
and so.id_cart_type = 1
and d.id_carrier = 9
and upper(so.misc) not like '%CONSOLIDATE%TRUE%'
group by 1,2
order by 1,2
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Noon_DA_Productivity'
destination_table = 'noonbilogmis.reporting.Noon_DA_Productivity'
sql = '''
select country,DA_FLAG ,SUM(DA_onfield) DA_onfield,sum(ofd_touchpoints)ofd_touchpoints,sum(delivered_tp) delivered_tp,sum(total_ofd_cir) total_ofd_cir,sum(delivered_ofd)delivered_ofd
from( select country
,case when country ="KSA" and User_type ='Salary-Own' then 'NOON' when country ="UAE" and User_type ='general_noon' then 'NOON' when country ="EGY" and User_type ='Noon' then 'NOON' else 'OTHERS' end as DA_FLAG,
DA_onfield,
ofd_touchpoints
,delivered_tp
,total_ofd_cir
,delivered_ofd
from (select * from (select * from (SELECT country, Location,ofd_date,case when substr(lbc.username,1,2) in ('pp', 'xx') then  "per_package"
     when substr(lbc.username,1,2) in ('nf') then "biker"
     when substr(lbc.username,1,2) in ('pt') then "bakala_per_touchpoint"
     when substr(lbc.username,1,2) in ('bk') then "bakala_shop"
     when substr(lbc.username,1,2) in ('lh') then "large"
     else "general_noon"
     end as User_type
,COUNT(DISTINCT CONCAT(lbc.username,ofd_date)) DA_onfield,SUM(ofd_tp) ofd_touchpoints
,SUM(delivered_tp) delivered_tp
,SUM(ofd_cir) total_ofd_cir
,SUM(delivered_ofd) delivered_ofd
FROM (SELECT Location,am_name,region_name,hub_sector, ofd_date,username,country,COUNT(DISTINCT awb_nr) ofd_count,COUNT(distinct CONCAT(ofd_date,customer_address)) ofd_tp
,COUNT(DISTINCT CASE WHEN final_status IN ('Delivered','Pickup Done') THEN CONCAT(ofd_date,customer_address) END) delivered_tp
,COUNT(CASE WHEN final_status IN ('Delivered','Pickup Done') THEN awb_nr END) delivered_ofd
,COUNT(*) ofd_cir
FROM (SELECT a.awb_nr,a.Location,a.Final_Status,a.customer_address,a.username,a.ofd_date ,b.am_name ,b.region_name,hub_sector,b.country
FROM noonbilogoi.LOGKSA_DATA.lms2_ofd_data a
LEFT JOIN noonbilogoi.LOGKSA_DATA.location_by_country b on a.Location =b.branch_code
WHERE ofd_date = current_date -1
AND b.country like "UAE"
UNION ALL
SELECT a.client_ref,a.hub,a.Final_Status,a.address_uid,a.username,a.Attempt_Date,b.am_name ,b.region_name,hub_sector,b.country
FROM noonbilogoi.LOGKSA_DATA.lms2_cir_performance a
LEFT JOIN noonbilogoi.LOGKSA_DATA.location_by_country b on a.hub =b.branch_code
WHERE a.Attempt_Date = current_date -1
AND b.country like "UAE")
GROUP BY 1,2,3,4,5,6,7) a
LEFT JOIN `noondwh.lms.user` lbc ON a.username = lbc.username
GROUP BY 1,2,3,4
union all
SELECT country,Location,ofd_date,lbc.string_field_4 User_type
,COUNT(DISTINCT CONCAT(username,ofd_date)) DA_onfield,SUM(ofd_tp) ofd_touchpoints
,SUM(delivered_tp) delivered_tp
,SUM(ofd_cir) total_ofd_cir
,SUM(delivered_ofd) delivered_ofd
FROM (SELECT Location,am_name,region_name,hub_sector, ofd_date,username,country,COUNT(DISTINCT awb_nr) ofd_count,COUNT(distinct CONCAT(ofd_date,customer_address)) ofd_tp
,COUNT(DISTINCT CASE WHEN final_status IN ('Delivered','Pickup Done') THEN CONCAT(ofd_date,customer_address) END) delivered_tp
,COUNT(CASE WHEN final_status IN ('Delivered','Pickup Done') THEN awb_nr END) delivered_ofd
,COUNT(*) ofd_cir
FROM (SELECT a.awb_nr,a.Location,a.Final_Status,a.customer_address,a.username,a.ofd_date ,b.am_name ,b.region_name,hub_sector,b.country
FROM noonbilogoi.LOGKSA_DATA.lms2_ofd_data a
LEFT JOIN noonbilogoi.LOGKSA_DATA.location_by_country b on a.Location =b.branch_code
WHERE ofd_date = current_date -1
AND b.country LIKE 'KSA'
UNION ALL
SELECT a.client_ref,a.hub,a.Final_Status,a.address_uid,a.username,a.Attempt_Date,b.am_name ,b.region_name,hub_sector,b.country
FROM noonbilogoi.LOGKSA_DATA.lms2_cir_performance a
LEFT JOIN noonbilogoi.LOGKSA_DATA.location_by_country b on a.hub =b.branch_code
WHERE a.Attempt_Date = current_date -1
AND b.country LIKE 'KSA')
GROUP BY 1,2,3,4,5,6,7) a
LEFT JOIN noonbilogoi.LOGKSA_DATA.lms2_user_details lbc ON a.username = lbc.string_field_0
GROUP BY 1,2,3,4
UNION ALL
SELECT country,Location,ofd_date,case when mh_da_type.da_type is not null then mh_da_type.da_type else da_type.name end as da_type
,COUNT(DISTINCT CONCAT(username,ofd_date)) DA_onfield,SUM(ofd_tp) ofd_touchpoints
,SUM(delivered_tp) delivered_tp
,SUM(ofd_cir) total_ofd_cir
,SUM(delivered_ofd) delivered_ofd
FROM (SELECT Location,am_name,region_name,hub_sector, ofd_date,username,country,COUNT(DISTINCT awb_nr) ofd_count,COUNT(distinct CONCAT(ofd_date,customer_address)) ofd_tp
,COUNT(DISTINCT CASE WHEN final_status IN ('Delivered','Pickup Done') THEN CONCAT(ofd_date,customer_address) END) delivered_tp
,COUNT(CASE WHEN final_status IN ('Delivered','Pickup Done') THEN awb_nr END) delivered_ofd
,COUNT(*) ofd_cir
FROM (SELECT a.awb_nr,a.Location,a.Final_Status,a.customer_address,a.username,a.ofd_date ,b.am_name ,b.region_name,hub_sector,b.country
FROM noonbilogoi.LOGKSA_DATA.lms2_ofd_data a
LEFT JOIN noonbilogoi.LOGKSA_DATA.location_by_country b on a.Location =b.branch_code
WHERE ofd_date = current_date -1
AND b.country LIKE 'EGY'
UNION ALL
SELECT a.client_ref,a.hub,a.Final_Status,a.address_uid,a.username,a.Attempt_Date,b.am_name ,b.region_name,hub_sector,b.country
FROM noonbilogoi.LOGKSA_DATA.lms2_cir_performance a
LEFT JOIN noonbilogoi.LOGKSA_DATA.location_by_country b on a.hub =b.branch_code
WHERE a.Attempt_Date = current_date -1
AND b.country LIKE 'EGY')
GROUP BY 1,2,3,4,5,6,7) a
LEFT JOIN(select username, lms_roles, pm.name from `noonltddwh.lms.user` 
left join `noonltddwh.lms.user_misc` um using (id_user)
left join noonltddwh.lms.pay_model pm on um.id_pay_model=pm.id_pay_model ) da_type using (username) 
left join (
  select distinct idp.username, vm.string_field_1 da_type  
from `noonbilogmis.reporting.idp_idp_user` idp 
left join `noonbilogmis.reporting.idp_idp_user_misc` idpm using (id_user)
left join `noonbilogmis.reporting.idp_idp_vendor` v using (id_vendor)
Left join noonbilogmis.reporting.MH_Vendor_Mapping vm on v.name = vm.string_field_0
)mh_da_type using(username) 
GROUP BY 1,2,3,4)
Where Location in (select forward_hub from `noonbilogoi.battleplan_v1.item_final_state` where creq = "LM" ))))group by 1,2

'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Noon_DA_Productivity_without_CU'
destination_table = 'noonbilogmis.reporting.Noon_DA_Productivity_CU'
sql = '''
select
Country,
MP,
Core_DA_flag,
sum(OFD) OFD,
sum(OFD_Delivered) OFD_Delivered,
count(Distinct username ) as DA,
current_timestamp() ts
from
(select
    case when cz.id_country =1 then "AE"
     when cz.id_country =2 then "SA"
     when cz.id_country =3 then "EG"
     else "Check"
     end as Country,
INITCAP(case when json_extract_scalar(creq.misc,'$.mp_code') is null  then client.name 
else json_extract_scalar(creq.misc,'$.mp_code') end) 
as MP,
OFD.username, 
Core_DA_flag,
count(DISTINCT awb_nr) as OFD, 
count(DISTINCT CASE WHEN ofd_status ="Delivered" then awb_nr end) as OFD_Delivered,
--count(Distinct username ) as DA,
 
current_timestamp() ts
from `noonbilogmis.reporting.OFD`  OFD 
left join `noonltddwh.lms.creq_leg` using (id_creq_leg) 
left join `noonltddwh.lms.creq` creq using (id_creq) 
left join `noonltddwh.lms.client` client using (id_client)
left join `noonltddwh.lms.hub_sector` hs using (id_hub_sector)
left join `noonltddwh.lms.country_zone` cz using (id_country_zone)
left join `noonltddwh.sales.sales_order` on client_ref =order_nr 
left join (select username, lms_roles from `noonltddwh.lms.user` 
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username) 
left join (select lower(trim(username)) username,1 as  Core_DA_flag from `noonbilogoi.Bharath.Noon_Core_DA_Bharath_0424`) Core_DA ON (lower(trim(Core_DA.username))) = (lower(trim(OFD.username)))
where date_diff(current_date(),OFD_Date ,day )=1 
and lms_roles not in ("fast-manifest","fast-manifest,non-sort-qc","non-sort-qc","seller-delivery") 
and id_creq_type =1 
and OFD.ofd_status <> 'held_consolidation'
group by 1,2,3,4)
group by 1,2,3 
'''




[[matview]]
dag_id = 'st_dag'
task_id = 'Same_Day_Delivery_Query'
destination_table = 'noonbilogmis.reporting.Same_Day_Delivery_Query'
sql = '''
select pdd.country,
count(awb_nr) Total_ship,
COUNT(DISTINCT case when date(fa_TS) <= date(edd) then awb_nr  end ) as attempt_check,
COUNT(DISTINCT case when 	loc_type = 'manifested' and shipment_status = 'Delivery'  then awb_nr end)as total_delivered,
count(DISTINCT case when Pure_NE_Breached =1 then awb_nr end) Logistic_breach,
count(DISTINCT case when ship_dt > ship_cutoff then awb_nr end)ship_breche,
count(DISTINCT case when overall_breach =1 then awb_nr end) overall_breach
 FROM `noonbilogmis.reporting.PDD_Breach_Raw_data` pdd
left join `noonbilogoi.Share_Point.NE_FAS` as fa using(awb_nr)
left join `noonbilogoi.battleplan_v1.item_final_state` ofd using (awb_nr)
where edd = current_date-1  and sdd is not null 
--and ofd.loc_type <> 'pending_addr'
group by 1
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'NDD_DXBG02'
destination_table = 'noonbilogmis.reporting.NDD_DXBG02'
sql = '''
select *
, round((timely_attempted*100/total_shipments),2) as timely_attempt_percent
, round((total_delivered*100/total_shipments),2) as total_delivery_percent
,current_timestamp() ts
from
(select country
, display_name
, count (DISTINCT awb_nr) as total_shipments
, count(distinct case when attempt_check = 1 then awb_nr end) as timely_attempted
, count(distinct case when creq_leg_type = 'Delivery' and loc_type = 'manifested' then awb_nr end) as total_delivered
, count(distinct case when attempt_check = 0 and cut_off_remarks = 'shipped_before_cutoff' then awb_nr end) as logistics_breach
, count(distinct case when attempt_check = 0 and cut_off_remarks = 'shipped_after_cutoff' then awb_nr end) as shipping_breach
from
(
select distinct awb_nr , client_ref , hub , display_name , country , creq_leg_type , status , date(promised_at) as promised_date ,
if(shipping_ts > expected_shipping_ts , "shipped_after_cutoff" , "shipped_before_cutoff") as cut_off_remarks , shipping_ts, expected_shipping_ts , attempt_check, id_city , city , vip_flag , loc_type
from
(
select distinct awb_nr , ifs.client_ref as client_ref, ifs.hub as hub, ifs.origin_warehouse as wh_name , ifs.display_name as display_name ,ifs.country as country , ifs.creq_leg_type as creq_leg_type , ifs.status as status,  promised_at , shipped_at , fa_TS , date(so.created_at) as order_date , day , cutoff , check , diff , loc_type ,  if(date(fa_TS) <= date(promised_at),1,0) as attempt_check , cx.city as city , cx.id_city as id_city
,case
when ifs.loc_type = "manifested" and ifs.status = "completed"  then "Delivered"
when ofd_status is not null then ofd_status
when ofd_status is null and ifs.loc_type = "pending_addr" then "Pending_Handover"
when ofd_status is null and ifs.loc_type = "manifest" or ifs.loc_type is null  then "Pending_receiving"
when ofd_status is null and ifs.loc_type = "hub_location" and ifs.current_location like "%Z1%" then "At_Z1_Triage"
when ofd_status is null and ifs.loc_type = "hub_location" and ifs.current_location like "%G1%"  then "At_G1_Triage"
when ofd_status is null and ifs.loc_type = "hub_transfer" then "In_hub_transfer"
when ofd_status is null and ifs.loc_type = "pgroup" then "In_GA_Bag"
when ofd_status is null and ifs.loc_type = "hub_location" and (clx.num_attempts > 0 or ifs.current_location like "%OVF-H%") then "Attempted_At_hub"
when ofd_status is null and ifs.loc_type = "hub_location" and clx.num_attempts = 0 then "Pending_At_hub"
when ofd_status is null and ifs.loc_type = "user" then "with_user"
when ofd_status is null and ifs.loc_type = "manifested"  and ifs.current_location not like "%DA%" then "Returned"
when shipment_nr is null then "pending_shipment_creation"
end as final_status
, if(so.misc like "%vip%",1,0) as vip_flag
,if(shipped_at is not null, case WHEN ifs.country = 'ae' THEN TIMESTAMP_ADD(shipped_at,INTERVAL 4 HOUR)
WHEN ifs.country = 'sa' THEN TIMESTAMP_ADD(shipped_at,INTERVAL 3 HOUR)
WHEN ifs.country = 'eg'  THEN TIMESTAMP_ADD(shipped_at,INTERVAL 2 HOUR) end
, case WHEN ifs.country = 'ae' THEN TIMESTAMP_ADD(min_shipped_at,INTERVAL 4 HOUR)
WHEN ifs.country = 'sa' THEN TIMESTAMP_ADD(min_shipped_at,INTERVAL 3 HOUR)
WHEN ifs.country = 'eg'  THEN TIMESTAMP_ADD(min_shipped_at,INTERVAL 2 HOUR)
end )as shipping_ts,
case when day = 'EDD-0' then timestamp_add(estimated_delivery_at , interval cut_off_min minute)
when day = 'EDD-1' then timestamp_add (timestamp_sub(estimated_delivery_at, interval 24 hour) , interval cut_off_min minute)
else timestamp_add(timestamp_sub(estimated_delivery_at, interval 24 hour) , interval 18 hour)
end as expected_shipping_ts
from `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.ref.sales_order_item_status` s on soi.id_sales_order_item_status = s.id_sales_order_item_status
left join (select created_at , id_sales_order_item_shipment, awb_nr , shipment_nr from `noonltddwh.sales.sales_order_item_shipment`) sois on sois.id_sales_order_item_shipment =soi.id_sales_order_item_shipment
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca  on ca.address_code = so.address_code
left join (select id_city, name_en as city  from `noonltddwh.ref.city` ) as cy using(id_city)
left join `noonbilogoi.Share_Point.NE_FAS` using (awb_nr)
left join `noonbilogoi.battleplan_v1.item_final_state` ifs using (awb_nr)
left join (select * from `noonbilogmis.NA_tables.premium_services_cutoff` where type in ('NDD','VIP-NDD') and id_city is not null) ps on (ifs.origin_warehouse , ca.id_city) = (ps.warehouse_code , ps.id_city)
left join `noonltddwh.lms.creq` c using (client_ref)
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type = 3) clx on clx.id_creq = c.id_creq
left join (select * from `noonbilogoi.MJ.OFD` WHERE OFD_Date = current_date()) using (awb_nr)
left join 
(select awb_nr,
ish.created_at as shipped_at
from `noonltddwh.lms.item_state_history` ish
left join `noonbilogmis.base_table.lms_item` using (id_item)
left join `noonbilogmis.reporting.lms_loc_type` using (id_loc_type)
where id_loc_type = 3
) as lms using (awb_nr)
left join (select id_sales_order_item, item_nr, soish.id_sales_order_item_status, awb_nr , min(soish.created_at) as test_1
from `noonltddwh.sales.sales_order_item_status_history` soish
left join `noonltddwh.sales.sales_order_item` soi using ( id_sales_order_item)
left join `noonltddwh.sales.sales_order_item_shipment` using ( id_sales_order_item_shipment)
where soish.id_sales_order_item_status = 5
group by 1,2,3,4
) using (awb_nr)
left join (select distinct item_nr , payment_method_code , min_confirmed_at , min_exported_at , min_shipped_at, timestamp_diff(min_exported_at , min_confirmed_at , minute) as diff ,
if(timestamp_diff(min_exported_at , min_confirmed_at , minute)>30,1,0) as check
from `noonltddwh.sales.sales_order_item`
left join `noonltddwh.sales.sales_order` using (id_sales_order )
left join `noonltddwh.cache.sales_order_item_summary` using (id_sales_order_item)) b on b.item_nr = soi.item_nr
left join (
select distinct id_item, awb_nr, if(id_partner_warehouse_from= id_partner_warehouse_outbound,"FBN","MP") as BU , shipped_at as expected_shipped_at
from `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left JOIN noonltddwh.oms.purchase_item pi on pi.purchase_item_nr = poi.purchase_item_nr
left JOIN `noonltddwh.oms.stock_item` b USING (id_purchase_item)
left join `noonltddwh.lms.item` using (awb_nr)) using (awb_nr)
left join `noonltddwh.partner.partner_warehouse` pw on origin_warehouse = pw.code
left join (select id_city , address_code from `noonltddwh.bqsync.customer_address`) ac on ac.address_code = so.address_code
left join (select id_city,name_en as city from `noonltddwh.ref.city`) as cx on (ac.id_city = cx.id_city)
left join (select id_creq , min(created_at) as test_2 from `noonltddwh.lms.manifest` where id_manifest_type = 3 group by 1) man on (man.id_creq = c.id_creq)
where soi.id_invoice_section = 1
and so.id_cart_type = 1
and date_diff(current_date(),soi.sales_order_pdate,day)<=2
and awb_nr is not null
and date(estimated_delivery_at) = current_date()-1
and lower(json_extract(item_misc,"$.shipping_preferences.ndd")) in ('"free"','"paid"',"true")
and id_mp <> 6
and ifs.hub  not like ('%_T1%')
and ifs.held_check is null
))
where display_name = 'NOON/DXBG02'
group by 1,2
order by 1
)
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'NDD_Query'
destination_table = 'noonbilogmis.reporting.NDD_Query'
sql = '''
select *
, round((total_attempted*100/total_shipments),2) as attempt_percent
, round((total_delivered*100/total_shipments),2) as delivery_percent
,current_timestamp() ts
from
(select country , hub
, count (DISTINCT awb_nr) as total_shipments
, count(distinct case when attempt_check = 1 then awb_nr end) as total_attempted
, count(distinct case when creq_leg_type = 'Delivery' and loc_type = 'manifested' then awb_nr end) as total_delivered
, count(distinct case when attempt_check = 0 and cut_off_remarks = 'shipped_before_cutoff' then awb_nr end) as logistics_breach
, count(distinct case when attempt_check = 0 and cut_off_remarks = 'shipped_after_cutoff' then awb_nr end) as shipping_breach
from
(
select distinct awb_nr , client_ref , hub , display_name , country , creq_leg_type , status , date(promised_at) as promised_date ,
if(shipping_ts > expected_shipping_ts , "shipped_after_cutoff" , "shipped_before_cutoff") as cut_off_remarks , shipping_ts, expected_shipping_ts , attempt_check, id_city , city , vip_flag , loc_type
from
(
select distinct awb_nr , ifs.client_ref as client_ref, ifs.hub as hub, ifs.origin_warehouse as wh_name , ifs.display_name as display_name ,ifs.country as country , ifs.creq_leg_type as creq_leg_type , ifs.status as status,  promised_at , shipped_at , fa_TS , date(so.created_at) as order_date , day , cutoff , check , diff , loc_type ,  if(date(fa_TS) <= date(promised_at),1,0) as attempt_check , cx.city as city , cx.id_city as id_city 
,case 
      when ifs.loc_type = "manifested" and ifs.status = "completed"  then "Delivered"
      when ofd_status is not null then ofd_status  
      when ofd_status is null and ifs.loc_type = "pending_addr" then "Pending_Handover"
      when ofd_status is null and ifs.loc_type = "manifest" or ifs.loc_type is null  then "Pending_receiving"
      when ofd_status is null and ifs.loc_type = "hub_location" and ifs.current_location like "%Z1%" then "At_Z1_Triage"
      when ofd_status is null and ifs.loc_type = "hub_location" and ifs.current_location like "%G1%"  then "At_G1_Triage"
      when ofd_status is null and ifs.loc_type = "hub_transfer" then "In_hub_transfer"
      when ofd_status is null and ifs.loc_type = "pgroup" then "In_GA_Bag"
      when ofd_status is null and ifs.loc_type = "hub_location" and (clx.num_attempts > 0 or ifs.current_location like "%OVF-H%") then "Attempted_At_hub"
      when ofd_status is null and ifs.loc_type = "hub_location" and clx.num_attempts = 0 then "Pending_At_hub"
      when ofd_status is null and ifs.loc_type = "user" then "with_user"
      when ofd_status is null and ifs.loc_type = "manifested"  and ifs.current_location not like "%DA%" then "Returned"  
      when shipment_nr is null then "pending_shipment_creation"
end as final_status
, if(so.misc like "%vip%",1,0) as vip_flag
,if(shipped_at is not null, case WHEN ifs.country = 'ae' THEN TIMESTAMP_ADD(shipped_at,INTERVAL 4 HOUR)
     WHEN ifs.country = 'sa' THEN TIMESTAMP_ADD(shipped_at,INTERVAL 3 HOUR)
     WHEN ifs.country = 'eg'  THEN TIMESTAMP_ADD(shipped_at,INTERVAL 2 HOUR) end
     , case WHEN ifs.country = 'ae' THEN TIMESTAMP_ADD(min_shipped_at,INTERVAL 4 HOUR)
     WHEN ifs.country = 'sa' THEN TIMESTAMP_ADD(min_shipped_at,INTERVAL 3 HOUR)
     WHEN ifs.country = 'eg'  THEN TIMESTAMP_ADD(min_shipped_at,INTERVAL 2 HOUR)
end )as shipping_ts,
case when day = 'EDD-0' then timestamp_add(estimated_delivery_at , interval cut_off_min minute) 
     when day = 'EDD-1' then timestamp_add (timestamp_sub(estimated_delivery_at, interval 24 hour) , interval cut_off_min minute)
else timestamp_add(timestamp_sub(estimated_delivery_at, interval 24 hour) , interval 18 hour)
end as expected_shipping_ts
from `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.ref.sales_order_item_status` s on soi.id_sales_order_item_status = s.id_sales_order_item_status
left join (select created_at , id_sales_order_item_shipment, awb_nr , shipment_nr from `noonltddwh.sales.sales_order_item_shipment`) sois on sois.id_sales_order_item_shipment =soi.id_sales_order_item_shipment
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca  on ca.address_code = so.address_code 
left join (select id_city, name_en as city  from `noonltddwh.ref.city` ) as cy using(id_city)
left join `noonbilogoi.Share_Point.NE_FAS` using (awb_nr)
left join `noonbilogoi.battleplan_v1.item_final_state` ifs using (awb_nr)
left join (select * from `noonbilogmis.NA_tables.premium_services_cutoff` where type in ('NDD','VIP-NDD') and id_city is not null) ps on (ifs.origin_warehouse , ca.id_city) = (ps.warehouse_code , ps.id_city)
left join `noonltddwh.lms.creq` c using (client_ref)
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type = 3) clx on clx.id_creq = c.id_creq 
left join (select * from `noonbilogoi.MJ.OFD` WHERE OFD_Date = current_date()) using (awb_nr)
left join (SELECT 
manifest_nr 
,awb_nr
, container_line.unpacked_at as shipped_at
FROM `noonltddwh.lms.container_line` container_line 
left join `noonltddwh.lms.container_state` container_state using (id_loc_type,loc_id)
left join `noonltddwh.lms.item` item using (id_item)
left join `noonltddwh.lms.manifest` manifest on container_line.loc_id=manifest.id_manifest
left join `noonltddwh.lms.manifest_type` manifest_type using (id_manifest_type)
where id_loc_type = 5
and is_outbound = 0 ) as lms using (awb_nr)
left join (select id_sales_order_item, item_nr, soish.id_sales_order_item_status, awb_nr , min(soish.created_at) as test_1
from `noonltddwh.sales.sales_order_item_status_history` soish 
left join `noonltddwh.sales.sales_order_item` soi using ( id_sales_order_item)
left join `noonltddwh.sales.sales_order_item_shipment` using ( id_sales_order_item_shipment)
where soish.id_sales_order_item_status = 5
group by 1,2,3,4
) using (awb_nr)
left join (select distinct item_nr , payment_method_code , min_confirmed_at , min_exported_at , min_shipped_at, timestamp_diff(min_exported_at , min_confirmed_at , minute) as diff ,
if(timestamp_diff(min_exported_at , min_confirmed_at , minute)>30,1,0) as check
from `noonltddwh.sales.sales_order_item` 
left join `noonltddwh.sales.sales_order` using (id_sales_order )
left join `noonltddwh.cache.sales_order_item_summary` using (id_sales_order_item)) b on b.item_nr = soi.item_nr
left join (
select distinct id_item, awb_nr, if(id_partner_warehouse_from= id_partner_warehouse_outbound,"FBN","MP") as BU , shipped_at as expected_shipped_at
from `noonltddwh.sales.sales_order_item` soi
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment 
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left JOIN noonltddwh.oms.purchase_item pi on pi.purchase_item_nr = poi.purchase_item_nr
left JOIN `noonltddwh.oms.stock_item` b USING (id_purchase_item)
left join `noonltddwh.lms.item` using (awb_nr)) using (awb_nr)
left join `noonltddwh.partner.partner_warehouse` pw on origin_warehouse = pw.code
left join (select id_city , address_code from `noonltddwh.bqsync.customer_address`) ac on ac.address_code = so.address_code
left join (select id_city,name_en as city from `noonltddwh.ref.city`) as cx on (ac.id_city = cx.id_city)
left join (select id_creq , min(created_at) as test_2 from `noonltddwh.lms.manifest` where id_manifest_type = 3 group by 1) man on (man.id_creq = c.id_creq)
where soi.id_invoice_section = 1
and so.id_cart_type = 1
and date_diff(current_date(),soi.sales_order_pdate,day)<=2
and awb_nr is not null
and date(estimated_delivery_at) = current_date()-1
and lower(json_extract(item_misc,"$.shipping_preferences.ndd")) in ('"free"','"paid"',"true")
and id_mp <> 6
and ifs.hub  not like ('%_T1%')
and ifs.held_check is null
))
where display_name <> 'NOON/DXBG02'
group by 1,2
order by 1,2
)
where substr(hub,5,1) <> 'G'
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Story_Board_Query_11'
destination_table = 'noonbilogmis.reporting.Story_Board_Query_11'
sql = '''
SELECT
so.country_code AS Country
,Case WHen id_sales_order_item_status = 6 then 'Delivered' else 'Others' end  as Del_Cont
--,Count(Distinct so.order_nr) AS Total_Orders
--,COUNT(Distinct soi.id_sales_order_item) AS Toal_Items
,COUNT(Distinct sois.awb_nr) AS Total_Shipments
,current_timestamp() ts
FROM
`noonltddwh.sales.sales_order_item`  soi
left JOIN `noonltddwh.sales.sales_order_item_shipment` sois USing (id_sales_order)
left join `noonltddwh.sales.sales_order` so Using (id_sales_Order)
WHERE upper(misc) like "%VIP%"
AND DATE(so.created_at ) > DATE_ADD(current_date(), Interval - 41 day)
AND DATE(so.created_at ) < DATE_ADD(current_date(), Interval - 9 day)
AND id_sales_order_item_status In (5,6,8)
GROUP BY 1,2
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'CIR_Yesterday'
destination_table = 'noonbilogmis.reporting.CIR_Yesterday'
sql = '''
select 
distinct
F.code as Country,
H.code as Hub,
COUNT(DISTINCT creq_nr) as Total_Request,
COUNT(DISTINCT case when cl.id_status =3 and Total_Assigns=1 then creq_nr end ) as Fresh_Assigned,
COUNT(DISTINCT case when cl.id_status =3 and Total_Assigns>1 then creq_nr end ) as Re_Assigned,
-- count(distinct case when cl.id_status =3 then creq_nr end ) as Total_Assigned,
COUNT(DISTINCT case when Assigned is null then creq_nr end ) as Total_Not_Assigned,
COUNT(DISTINCT case when date(FirstAttempt) is not null then creq_nr end ) as Attempted,
COUNT(DISTINCT case when date(FirstAttempt) is null then creq_nr end ) as Un_Attempted,
COUNT(DISTINCT case when id_item is not null then creq_nr end ) as Total_Picked,
COUNT(DISTINCT case when cl.id_status =2 then creq_nr end ) as Total_Canceled,
COUNT(DISTINCT case when cl.id_status =6 then creq_nr end ) as Total_Held,
current_timestamp() ts
from (select * from  `noonltddwh.lms.creq` where date(created_at)>=current_Date()-3) creq
left join (select * from `noonltddwh.lms.creq_leg`where id_creq_leg_type =1 and date(created_at)>=current_Date()-3) cl using (id_creq)
left join (select 
id_creq_leg ,
count(distinct id_creq_leg_job) as Total_Assigns
from `noonltddwh.lms.creq_leg_job` 
group by 1) cljb on cljb.id_creq_leg = cl.id_creq_leg 
left join (select 
id_creq_leg,
min(created_at) as Assigned
from `noonltddwh.lms.creq_leg_history` where date(created_at)>=current_Date()-3
and  json_EXTRACT(data,'$.id_status')="3" group by 1
) clhh on  clhh.id_creq_leg =cl.id_creq_leg 
left join ( select  * from  `noonltddwh.lms.creq_leg`where id_creq_leg_type=2  and date(created_at)>=current_Date()-3) dcreq_leg on creq.id_creq=dcreq_leg.id_creq
left join `noonltddwh.lms.country_zone` cz on cz.id_country_zone=cl.id_country_zone
LEFT JOIN `noonltddwh.lms.country` as F using (id_country)
LEFT JOIN `noonltddwh.lms.hub_sector` as hs on cl.id_hub_sector=hs.id_hub_sector
LEFT JOIN `noonltddwh.lms.hub` as H using (id_hub)
left join (select * from `noonltddwh.lms.item_pkg` where date(created_at)>=current_Date()-3) item_pkg on item_pkg.id_creq_leg=dcreq_leg.id_creq_leg
left join ( select creq_nr,min(FA) as FirstAttempt from (select *
from (SELECT creq_nr, MIN(creq_leg_history.created_at) as FA
FROM (select * from `noonltddwh.lms.creq` where date(created_at)>=current_Date()-3) creq
LEFT JOIN (select * from `noonltddwh.lms.creq_leg` where date(created_at)>=current_Date()-3) USING (id_creq)
LEFT JOIN ( SELECT *, json_EXTRACT(data,'$.num_attempts')='1' AS attempt
FROM 
`noonltddwh.lms.creq_leg_history`
where date(created_at)>=current_Date()-3
) creq_leg_history
USING (id_creq_leg)
WHERE attempt=true
GROUP BY 1)
union all (select creq_nr,min(manifest.created_at) as FA 
from (select * from `noonltddwh.lms.creq` where date(created_at)>=current_Date()-3) creq
left join (select * from `noonltddwh.lms.manifest` where date(created_at)>=current_Date()-3) as manifest using (id_creq)
where id_manifest_type=1 group by 1) ) group by 1


union all
(
select creq_nr,min(clj.updated_at) as FA from `noonltddwh.lms.creq_leg_job` clj
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=1 ) using (id_creq_leg)
left join noonltddwh.lms.creq using (id_creq)
left join `noonltddwh.lms.country_zone` cz using (id_country_zone) 
where id_reason is not null
and date(case
when cz.id_country =1 then timestamp_add(clj.created_at,interval 4 hour)
when cz.id_country =2 then timestamp_add(clj.created_at,interval 3 hour)
when cz.id_country =3 then timestamp_add(clj.created_at,interval 2 hour)
end)<
date(case
when cz.id_country =1 then timestamp_add(current_timestamp(),interval 4 hour)
when cz.id_country =2 then timestamp_add(current_timestamp(),interval 3 hour)
when cz.id_country =3 then timestamp_add(current_timestamp(),interval 2 hour)
end)
group by 1
)

) using (creq_nr)
where
case
when cz.id_country =1 then DATE(timestamp_add(creq.created_at,interval 4 hour))
when cz.id_country =2 then DATE(timestamp_add(creq.created_at,interval 3 hour))
when cz.id_country =3 then DATE(timestamp_add(creq.created_at,interval 2 hour))
end in (current_date()-2,current_date()-1)
and case
when date(case
when cz.id_country =1 then DATE(timestamp_add(creq.created_at,interval 4 hour))
when cz.id_country =2 then DATE(timestamp_add(creq.created_at,interval 3 hour))
when cz.id_country =3 then DATE(timestamp_add(creq.created_at,interval 2 hour))
end) =current_date()-1 then extract(hour from case
when cz.id_country =1 then timestamp_add(creq.created_at,interval 4 hour)
when cz.id_country =2 then timestamp_add(creq.created_at,interval 3 hour)
when cz.id_country =3 then timestamp_add(creq.created_at,interval 2 hour)
end)<12 
when date(case
when cz.id_country =1 then DATE(timestamp_add(creq.created_at,interval 4 hour))
when cz.id_country =2 then DATE(timestamp_add(creq.created_at,interval 3 hour))
when cz.id_country =3 then DATE(timestamp_add(creq.created_at,interval 2 hour))
end) =current_date()-2 then extract(hour from case
when cz.id_country =1 then timestamp_add(creq.created_at,interval 4 hour)
when cz.id_country =2 then timestamp_add(creq.created_at,interval 3 hour)
when cz.id_country =3 then timestamp_add(creq.created_at,interval 2 hour)
end)>=12 
end 
and creq.id_creq_type = 2
and creq.id_client_ref_type =2
GROUP BY 1,2
order by 1,2
'''

#[[matview]]
#dag_id = 'st_dag'
#task_id = 'Yesterday_Breached_Shipments'
#destination_table = 'noonbilogmis.reporting.Yesterday_Breached_Shipments'
#sql = '''
#SELECT breach.*,delivery_block,ofd.OFD_Date , extract(hour from FA_TS) Hour, FA_Date FA_Date,ifs.current_location current_location,ifs.User_Last_Scan User_Last_Scan,current_timestamp() ts
#FROM `noonbilogmis.reporting.PDD_Breach_Raw_data` breach
#left join `noonbilogmis.reporting.OFD` ofd on (ofd.awb_nr, ofd.OFD_Date ) = (breach.awb_nr,breach.edd )
#left join `noonbilogoi.Share_Point.NE_FAS` FA on FA.awb_nr = breach.awb_nr 
#left join `noonbilogoi.battleplan_v1.item_final_state` ifs on ifs.awb_nr = breach.awb_nr 
#left join (
#SELECT item.awb_nr , c.name delivery_block FROM `noonltddwh.lms.item` item
#left join `noonltddwh.lms.item_delivery_block` idp on idp.id_item = item.id_item
#left join `noonltddwh.lms.item_delivery_block_type` c using(id_item_delivery_block_type)
#)temp on temp.awb_nr= breach.awb_nr 
#WHERE edd = current_date()-1
#and Pure_NE_Breach_flag IN (1)
#'''


[[matview]]
dag_id = 'st_dag'
task_id = 'NE_Breached_Citywise'
destination_table = 'noonbilogmis.reporting.NE_Breached_Citywise'
sql = '''
SELECT  
Country
,destination_city
,LM_Hub
,SUM(Total_EDD_Shipments) AS Total_shipments
,SUM(Overall_Breach) AS Overall_Breached
,SUM(Pure_NE_Breached) AS Pure_NoonExpress_Breached
,current_timestamp() ts
FROM (
SELECT * FROM `noonbilogmis.reporting.PDD_Breach_Raw_data` 
WHERE edd = current_date()-1
and Country_zone not in ('SA-ASEER-ALHARAJAH',	'SA-ASEER-AMAQ',	'SA-JAZAN-ALQAHMAH',	'SA-RIYADH-RAFIAAL-JEMSH',	'SA-RIYADH-ARRUWAIDAH',	'SA-RIYADH-ALBIJADIYAH',	'SA-QASSIM-DHRIAH',	'SA-TABUK-DUBA',	'SA-ASEER-AYNIBNFUHAYD',	'SA-QASSIM-QUBA',	'SA-HAIL-BGAA',	'SA-HAIL-ALGHAZALAH',	'SA-QASSIM-ASSUMAYRA',	'SA-HAIL-MWGAG',	'SA-ALYUTMA',	'SA-RIYADH-THARMADA',	'SA-RIYADH-GASAB',	'SA-RIYADH-AL-ARTAWIH',	'SA-EASTERN-GARIATAL-ALIA',	'SA-NORTHERNBOARDERS-AL-AWAGLIAH',	'SA-RUH-A4-AMANA-16',	'SA-MAKKAH-TRBAH',	'SA-TABUK-HALATAMMAR',	'SA-RIYADH-WADIALDAWASIR',	'SA-MADINAH-YANBU1'
)
and Hub_sector  NOT in ('RUH-A4-SLM-Z', 'RUH-A7-SLM-Z' ,'JED-A1-SLM-M','JED-A1-SLM-X','JED-A5-SLM-X') AND hub_sector  NOT like 'RUH-V1%'
)GROUP BY 1,2,3
'''

[[matview]]
dag_id = 'st_dag'
task_id = '3PL_Breached_city_wise'
destination_table = 'noonbilogmis.reporting.3PL_Breached_city_wise'
sql = '''
SELECT distinct
ls.country_code country,DSP carrier,city, RD_flag
, ls.awb_nr,awb, edd PDD,ls.attempt1
, ship_dt_noon, ship_cutoff, handover_cut, handover_unpack_ts, handover_unpack_dt,
CASE WHEN handover_cut < handover_unpack_ts then 1 else 0 end as Handover_Breach
,CASE WHEN edd < attempt1 then 1 else 0 end as Overall_Breach
,CASE WHEN ship_cutoff < ship_dt_noon then 1 else 0 end as Ship_Breach
,CASE WHEN edd> date(ls.Returned_date) then 0
when edd < attempt1 and (CASE WHEN ship_cutoff < ship_dt_noon then 1 else 0 end) = 0 
and (CASE WHEN handover_cut < handover_unpack_ts then 1 else 0 end) = 0 then 1 else 0 end as TPL_Breach
FROM `noonbilogoi.RS.TPL_LM_Master` ls
WHERE creq='LM' and handover_unpack_dt is not null
and edd =(current_date-1) and dsp not in ('aramex','flow') and country_code = "SA"
'''

[[matview]]
dag_id = 'st_dag'
task_id = '3PL_Breached_summary'
destination_table = 'noonbilogmis.reporting.3PL_Breached_summary'
sql = '''
SELECT distinct
ls.country_code country,DSP carrier, city,COUNT(distinct AWB) AS  TOTAL_SHIP,
COUNT(distinct CASE WHEN handover_cut < handover_unpack_ts then AWB end) as Handover_Breach
,COUNT(distinct CASE WHEN edd < attempt1 then AWB end) as Overall_Breach
,COUNT(distinct CASE WHEN ship_cutoff < ship_dt_noon then AWB  end) as Ship_Breach
,COUNT(distinct case when (  CASE WHEN edd> date(ls.Returned_date) then 0
when edd < attempt1 and (CASE WHEN ship_cutoff < ship_dt_noon then 1 else 0 end) = 0 
and (CASE WHEN handover_cut < handover_unpack_ts then 1 else 0 end) = 0 then 1 else 0 end )= 1 then  awb end) as TPL_Breach
FROM `noonbilogoi.RS.TPL_LM_Master` ls
WHERE creq='LM' and handover_unpack_dt is not null
and edd =(current_date-1) and dsp not in ('aramex','flow') and country_code = "SA"
GROUP BY 1 ,2,3
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'ASN_rawdata'
destination_table = 'noonbilogmis.reporting.ASN_rawdata'
sql = '''
WITH ofd as (
SELECT cl.id_creq_leg,s.code as status,clj.updated_at ,clj.id_status
FROM `noonltddwh.lms.creq_leg` cl
LEFT JOIN `noonltddwh.lms.creq_leg_job` clj using(id_creq_leg)
left join `noonltddwh.lms.status` s on s.id_status = clj.id_status
WHERE clj.id_status is not null
)
SELECT *,current_timestamp() ts FROM
(
SELECT *
-- ,case when code = 'closed' and date(updated_at_loc) <= target_date then 0 else 1 end as Breached_flag



-- case when code = 'closed' and date(updated_at_loc) <= target_date then 0 else 1 end as Breached_flag



,CASE
WHEN DATE(closed_loc) <= target_date THEN 'closed'
WHEN DATE(canceled_loc) <= target_date THEN 'canceled'
WHEN DATE(pending_loc) <= target_date THEN 'pending'
WHEN DATE(opened_loc) <= target_date THEN 'opened'
else 'opened'
END AS status,
CASE WHEN DATE(closed_loc) <= target_date OR DATE(canceled_loc) <= target_date THEN 0 else 1 end as Breached_flag
FROM (
SELECT 
DISTINCT 
c.creq_nr AS ASN ,
c.client_ref AS ASN_nu,
closed,canceled,pending,opened,
case
when cz.id_country =1 then timestamp_add(ofp.closed,interval 4 hour)
when cz.id_country =2 then timestamp_add(ofp.closed,interval 3 hour)
when cz.id_country =3 then timestamp_add(ofp.closed,interval 2 hour)
end as closed_loc,



case
when cz.id_country =1 then timestamp_add(ofp.canceled,interval 4 hour)
when cz.id_country =2 then timestamp_add(ofp.canceled,interval 3 hour)
when cz.id_country =3 then timestamp_add(ofp.canceled,interval 2 hour)
end as canceled_loc,



case
when cz.id_country =1 then timestamp_add(ofp.pending,interval 4 hour)
when cz.id_country =2 then timestamp_add(ofp.pending,interval 3 hour)
when cz.id_country =3 then timestamp_add(ofp.pending,interval 2 hour)
end as pending_loc,



case
when cz.id_country =1 then timestamp_add(ofp.opened,interval 4 hour)
when cz.id_country =2 then timestamp_add(ofp.opened,interval 3 hour)
when cz.id_country =3 then timestamp_add(ofp.opened,interval 2 hour)
end as opened_loc,



case when cz.id_country =1 then "AE"
when cz.id_country =2 then "SA"
when cz.id_country =3 then "EG"
else "Check"
end as Country,
cz.code as Country_zone,
hs.hub_sector,
hub.hub,
c.created_at,
ss.code as CL_status,
ss1.code as C_status,
case
when cz.id_country = 1 then timestamp_add(c.created_at,interval 4 hour)
when cz.id_country = 2 then timestamp_add(c.created_at,interval 3 hour)
when cz.id_country = 3 then timestamp_add(c.created_at,interval 2 hour) END AS created_at_loc,
case when cz.id_country = 2
then IF
(c.Created_at <CAST(datetime(DATE(current_date-1),
"10:00:00") AS timestamp),
DATE(current_date -1),
DATE(DATE_ADD(current_timestamp,INTERVAL 1 day)))
when cz.id_country = 1
then IF
(c.Created_at<CAST(datetime(DATE(current_date -1),
"12:00:00") AS timestamp),
DATE(current_date-1),
DATE(DATE_ADD(current_timestamp,INTERVAL 1 day)))
when cz.id_country = 3
then IF
(c.Created_at<CAST(datetime(DATE(current_date -1),
"10:00:00") AS timestamp),
DATE(current_date-1),
DATE(DATE_ADD(current_timestamp,INTERVAL 1 day))) else null end AS target_date
FROM `noonltddwh.lms.creq` c
left join `noonltddwh.lms.status` ss1 on ss1.id_status = c.id_status
LEFT JOIN `noonltddwh.lms.creq_leg` cl using(id_creq)
left join `noonltddwh.lms.status` ss on ss.id_status = cl.id_status
LEFT JOIN `noonltddwh.lms.country_zone` cz using(id_country_zone)
left join (SELECT id_hub_sector,id_hub, code as Hub_sector FROM `noonltddwh.lms.hub_sector`) hs using (id_hub_sector)
left join(SELECT id_hub, code as Hub FROM `noonltddwh.lms.hub` ) hub using(id_hub)
LEFT JOIN(



SELECT d.id_creq_leg,closed.closed,canceled.canceled,pending.pending,opened.opened
FROM ofd d
LEFT JOIN
(
SELECT id_creq_leg,MIN(updated_at) closed
FROM ofd o
WHERE status = 'closed'
GROUP BY 1
) closed on d.id_creq_leg = closed.id_creq_leg



LEFT JOIN
(
SELECT id_creq_leg,MIN(updated_at) canceled
FROM ofd o
WHERE status = 'canceled'
GROUP BY 1
) canceled on d.id_creq_leg = canceled.id_creq_leg



LEFT JOIN
(
SELECT id_creq_leg,MIN(updated_at) pending
FROM ofd o
WHERE status = 'pending'
GROUP BY 1
) pending on d.id_creq_leg = pending.id_creq_leg



LEFT JOIN
(
SELECT id_creq_leg,MIN(updated_at) opened
FROM ofd o
WHERE status = 'opened'
GROUP BY 1
) opened on d.id_creq_leg = opened.id_creq_leg
)ofp on ofp.id_creq_leg = cl.id_creq_leg
WHERE c.id_creq_type = 4
and id_creq_leg_type = 1
)
WHERE
(Country = "AE" ANd created_at_loc >= timestamp_add(timestamp(current_Date-2),interval 12 hour)
and created_at_loc <= timestamp_add(timestamp(current_Date-1),interval 12 hour) ) OR (Country <> "AE" ANd created_at_loc >= timestamp_add(timestamp(current_Date-2),interval 10 hour)
and created_at_loc <= timestamp_add(timestamp(current_Date-1),interval 10 hour) )
AND SUBSTR(ASN_nu,0,1)= 'K'
and hub_sector NOT LIKE '%DROPOFF%'
and hub IN ('AUH-A1', 'DXB-A1', 'DXB-A2', 'DXB-A3', 'DXB-A8', 'DXB-A9', 'SHJ-A1', 'ALY-A1', 'CAI-Y2', 'DMM-Y1', 'JED-Y1', 'RUH-Y1', 'RUH-Y3')
)WHERE SUBSTR(ASN_nu,0,1) <> 'P'
and hub_sector NOT LIKE '%DROPOFF%'
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'RTV_Greater_Then_21days_Unattempted'
destination_table = 'noonbilogmis.reporting.RTV_Greater_Then_21days_Unattempted'
sql = '''
SELECT 
Country
,Hub
,COUNT(DISTINCT case when Ageing = 'Above 21 Days' and Attempt_Check = 'UnAttempted' then awb_nr end ) RTV_Greater_then_21_days_UnAttempted
,COUNT(DISTINCT case when  date(created_at) = current_date()-1 then awb_nr end ) Yesterday_Shipped
,current_timestamp() ts
FROM `noonbilogmis.reporting.rtv_final` 
WHERE ((Ageing = 'Above 21 Days'
and Attempt_Check = 'UnAttempted'
and pkg_status =  'Transiting'
) OR date(created_at) = current_date()-1)
and Address_Type	 <> 'Service Point'
and Hub Not IN ('RUH-G2','RUH-D1','CAI-X9','RUH-X9','DXB-Z4','DXB-G2','DXB-Z1','JED-U9','ELQ-A1','CAI-D1','CAI-H3','CAI-B1','CAI-M1','AUH-A2','RKT-A1','DXB-A4')
and loc_type Not IN ('Service Point Counter Location','Service Point Counter')
GROUP BY 1,2
order by 1,2
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'FBN_Bulky_volume'
destination_table = 'noonbilogmis.reporting.FBN_Bulky_volume'
sql = '''
SELECT 
country_code ,
date(Dispatch),
COUNT(DISTINCT case when  Business_Unit = 'FBN' and id_mp <> 6  then awb_nr end ) as FBN_Cnt,
COUNT(DISTINCT case when  Bulky = 'Bulky' then awb_nr end ) as Bulky_Cnt
FROM (select
distinct 
so.country_code ,
so.id_mp ,
case when w.id_warehouse_type in (5) then "Bulky" end as Bulky,
sois.awb_nr ,
if(id_partner_warehouse_from= id_partner_warehouse_outbound,"FBN","Non-FBN") as Business_Unit, 
sois.created_at as Dispatch,
display_name as Warehouse
,current_timestamp() ts
from  `noonltddwh.sales.sales_order_item` soi 
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order 
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment 
left join `noonltddwh.ref.sales_order_item_status` soiis on soiis.id_sales_order_item_status =soi.id_sales_order_item_status
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
LEFT JOIN `noonltddwh.oms.purchase_item`  pi on pi.purchase_item_nr = poi.purchase_item_nr
left join `noonltddwh.oms.sales_item` si using (id_sales_item)
LEFT JOIN `noonltddwh.oms.stock_item` b USING (id_purchase_item)
LEFT JOIN `noonltddwh.partner.partner_warehouse` partner_warehouse on b.id_partner_warehouse_outbound=partner_warehouse.id_partner_warehouse
LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr
LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller
LEFT JOIN noonltddwh.xms_sourcing.warehouse w on wl.id_warehouse = w.id_warehouse
where date(sois.created_at) >= current_date()-5
and id_cart_type =1
and id_invoice_section =1
)GROUP BY 1,2
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Consolidation_City_wise'
destination_table = 'noonbilogmis.reporting.Consolidation_City_wise'
sql = '''
Select 
country_code, 
final.customer_code, 
delivered_date, Hub, destination_city,
b.awb_nr,
case when time_diff<=1 and b.awb_nr is not null then 'delivered_together' end as delivered_together, 
case when delivered_ts<>min_ts and time_diff>=1 and b.awb_nr is not null and min_ts<>max_ts 
and max_ts is not null then 'other_shipments' end as other_shipments 
From (Select country_code,customer_code,Hub,delivered_date,destination_city,min_ts,max_ts, timestamp_diff(max_ts,min_ts,hour) as time_diff 
From ( select distinct hub.code as Hub, destination_city,
so.customer_code , so.country_code, date(min_delivered_at) as delivered_date, 
count(distinct awb_nr) as shipments, min(min_delivered_at) as min_ts, max(min_delivered_at) as max_ts, 
from `noonltddwh.sales.sales_order_item` soi 
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order 
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment 
left join `noonltddwh.lms.client_pkg_ref` client_pkg_ref using (awb_nr) 
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca on so.address_code = ca.address_code
left join (select id_city, name_en as destination_city from `noonltddwh.ref.city` ) as dc on ca.id_city=dc.id_city
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq) 
left join `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector 
left join `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub 
left join (SELECT * FROM `noonltddwh.cache.sales_order_item_summary` 
WHERE sales_order_pdate >= date_trunc(current_date(), month)) soiss on soi.id_sales_order_item =soiss.id_sales_order_item 
where id_cart_type =1
and id_invoice_section =1 
and sois.id_carrier =9 
and soi.id_sales_order_item_status =6 
and extract(year from min_delivered_at)=extract(year from current_date())
group by 1,2,3,4,5 )) as final 
left join ( select distinct so.customer_code , awb_nr , min_delivered_at as delivered_ts ,case when de.awb_nr is not null and id_service_logistics = 4 then 'Bulky'else null end as bulky_flag

from `noonltddwh.sales.sales_order_item` soi 

left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order 
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment 
left join `noonbilogoi.Share_Point.DE_rollout_shipments`as de using(awb_nr)
left join (SELECT * FROM `noonltddwh.cache.sales_order_item_summary` 

WHERE sales_order_pdate >= date_trunc(current_date(), month) ) soiss on soi.id_sales_order_item =soiss.id_sales_order_item 
where id_cart_type =1 
and id_invoice_section =1 
and sois.id_carrier =9 
and soi.id_sales_order_item_status =6 ) b on (final.customer_code,delivered_date)=(b.customer_code,date(b.delivered_ts)) 
where delivered_date = current_date-1 and substr(hub,5,1) <> "T"and bulky_flag is null 
'''

#[[matview]]
#dag_id = 'st_dag'
#task_id = 'Bakala_Summary'
#destination_table = 'noonbilogmis.reporting.Bakala_Summary'
#sql = '''
#SELECT CASE WHEN type = 'noonfriend' then 'noonfriend' else 'nonnoonfriend' end as type,payment_method_code,
#Hub,COUNT(distinct CASE WHEN flag = 'Delevered' then awb_nr end) AS count,count(distinct awb_nr ) Cnt
#,current_timestamp() ts
#FROM `noonbilogmis.reporting.mtd_Noon_friends_LS1` 
#WHERE OFD_Date = current_date -1
#and type = 'noonfriend'
#GROUP BY 1,2,3
#'''



[[matview]]
dag_id = 'st_dag'
task_id = '3PL_Del_raw_data'
destination_table = 'noonbilogmis.reporting.3PL_Del_raw_data'
sql = '''
SELECT DSP ,
COUNT(DISTINCT case when code = 'Delivered' then awb end ) as Del_Cnt,
COUNT(DISTINCT awb) toal_Shipments
,current_timestamp() ts
FROM `noonbilogoi.RS.TPL_LM_Master` 
where date(handover_unpack_ts) between DATE_TRUNC(current_date -1, month) and current_date-1
and Creq = 'LM' and country_code = 'SA'
GROUP BY 1
order by 1
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Agent_calling_summary'
destination_table = 'noonbilogmis.reporting.Agent_calling_summary'
sql = '''
select case when campaign_name = 'Egypt_Logistics_Call_Back_Auto' then 'EG' when campaign_name = 'Logistics_Call_Back_Auto' then "SA" when campaign_name= 'UAE_Logistics_Call_Back_Auto' then "AE" else campaign_name end as country 
, total_count as order_called
, outcome_rec as outcomes_received
, round((outcome_rec/total_count)*100,2) as outcome_percent
, cx_asked_cancel
, (outcome_rec - cx_asked_cancel) as cx_asked_delivery
,current_timestamp() ts
from
(select
campaign_name
, total_count
, cancel_calls as cx_asked_cancel
, (cancel_calls+rescheduled_calls+adddress_calls) as outcome_rec
, conn_no_input
, (total_count-(cancel_calls+rescheduled_calls+adddress_calls)-conn_no_input) as not_answered_or_no_input
from
(select
clh.campaign_name as campaign_name
, count(distinct clh.order_nr) as total_count
, count(distinct case when coh.cust_disposition like ('%cance%') then clh.order_nr end) as cancel_calls
, count(distinct case when coh.cust_disposition like ('%schedul%') then clh.order_nr end) as rescheduled_calls
, count(distinct case when coh.cust_disposition like ('%ddress%') then clh.order_nr end) as adddress_calls
, count(distinct case when coh.call_status = 'answered' and coh.cust_disposition like ('%_no_inp%') then clh.order_nr end) as conn_no_input
from `noonbilogoi.nefreelancer.ne_calling_list_history` clh
left join `noonbilogoi.nefreelancer.ne_calling_outcom_history` coh on (coh.Unique_ID = clh.order_nr)
where clh.upload_date = current_date()-1
and date(coh.Date_Time) = current_date()-1
and clh.campaign_name like ('%ogistic%')
and coh.campaign_name like ('%ogistic%')
group by 1
ORDER By 1 
))
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'IVR_calling_summary'
destination_table = 'noonbilogmis.reporting.IVR_calling_summary'
sql = '''
select
country
, total_count as order_called
, outcome_rec as outcomes_received
, round((outcome_rec/total_count)*100,2) as outcome_percent
, cx_asked_cancel
, (outcome_rec - cx_asked_cancel) as cx_asked_delivery
,current_timestamp() ts
from
(select
country
, total_count
, cancel_calls as cx_asked_cancel
, (cancel_calls+rescheduled_calls+adddress_calls) as outcome_rec
, conn_no_input
, (total_count-(cancel_calls+rescheduled_calls+adddress_calls)-conn_no_input) as not_answered_or_no_input
from
(select
case when clh.campaign_name like '%ourl%' then 'SA'
when clh.campaign_name like '%UAE%' then 'AE'
when clh.campaign_name like '%EGPT%' then 'EG'
end as country
, count(distinct clh.order_nr) as total_count
, count(distinct case when coh.cust_disposition like ('%cance%') then clh.order_nr end) as cancel_calls
, count(distinct case when coh.cust_disposition like ('%schedul%') then clh.order_nr end) as rescheduled_calls
, count(distinct case when coh.cust_disposition like ('%ddress%') then clh.order_nr end) as adddress_calls
, count(distinct case when coh.call_status = 'answered' and coh.cust_disposition like ('%_no_inp%') then clh.order_nr end) as conn_no_input
from `noonbilogoi.nefreelancer.ne_calling_list_history` clh
left join `noonbilogoi.nefreelancer.ne_calling_outcom_history` coh on (coh.Unique_ID = clh.order_nr)
where clh.upload_date = current_date()-1
and date(coh.Date_Time) = current_date()-1
and clh.campaign_name not like ('%ogistic%')
and coh.campaign_name not like ('%ogistic%')
and coh.Campaign_Name <> 'Noon_CIR'
and clh.campaign_name <> 'Noon_CIR'
group by 1
ORDER BY 1 
))
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'CFC_Breach_Covered_by_logistics'
destination_table = 'noonbilogmis.reporting.CFC_Breach_Covered_by_logistics'
sql = '''
select Country,LM_Hub
,SUM(Total_EDD_Shipments) AS Total_shipments
,SUM(Overall_Breach) AS Overall_Breached
,SUM(Pure_NE_Breached) AS Pure_NoonExpress_Breached
,SUM(CFC_Breach) as  CFC_Breach_Covered_by_Logistics
from (select *,case when ship_dt > ship_cutoff and Overall_Breach = 0 then 1 else 0 end as CFC_Breach
from `noonbilogmis.reporting.PDD_Breach_Raw_data`
where carrier="NE" and date(edd) =  current_Date -1)
group by 1,2

'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Total_CIR_Pendency'
destination_table = 'noonbilogmis.reporting.Total_CIR_Pendency'
sql = '''

SELECT T.*
,case
when aging = 0 then "0 day"
when aging = 1 then "1 day"
when aging = 2 then "2 day"
when aging = 3 then "3 day"
when aging = 4 then "4 day"
when aging = 5 then "5 day"
when aging between 5 and 9 then "5-10 days"
when aging between 10 and 14 then "10-15 days"
when aging between 15 and 19 then "15-20 days"
when aging between 20 and 24 then "10-25 days"
when aging between 25 and 29 then "25-30 days"
when aging between 30 and 34 then "30-35 days"
when aging between 35 and 39 then "35-40 days"
when aging between 40 and 44 then "40-45 days"
when aging between 45 and 49 then "45-50 days"
when aging  >= 50 then "above 50 days"
end as Ageing_remarks
,current_timestamp() ts
FROM 
(
SELECT
client_ref,
creq_leg.id_creq_leg,
num_attempts,
creq_leg.created_at,
TIMESTAMP_DIFF(CURRENT_TIMESTAMP(),creq_leg.created_at,day) AS aging,
hub_sector.code AS hub_sector,
substring (hub_sector.code,
0,
6) AS hub,
src_address.address_uid AS src_address_uid,
dst_address.address_uid AS dst_address_uid,
reason.code AS held_reacon_code,
country.code AS country,
id_reason_held,
creq_leg.id_status,
IF
(creq_leg_job.id_status=3
AND TIMESTAMP_DIFF(CURRENT_TIMESTAMP(),creq_leg_job.updated_at,day)=0,
"Assigned",
"Not Assigned") AS job_status,
IF
(TIMESTAMP_DIFF(CURRENT_TIMESTAMP(),creq_leg.created_at,day)<6,
CAST(TIMESTAMP_DIFF(CURRENT_TIMESTAMP(),creq_leg.created_at,day) AS string),
CONCAT("`",(FLOOR(TIMESTAMP_DIFF(CURRENT_TIMESTAMP(),creq_leg.created_at,day)/5))*5,"-",(FLOOR(TIMESTAMP_DIFF(CURRENT_TIMESTAMP(),creq_leg.created_at,day)/5)+1)*5)) AS aging_group,
IF
(num_attempts>=3
OR id_reason_held IN (2,
18,
19),
"calling_closure_required",
IF
(hub_sector.code LIKE "%T1%",
"TPL",
IF
(num_attempts=0
AND id_reason_held IN (4,
5),
"attempted_address_mistagging_calling_required",
IF
(num_attempts=0,
"Pending__first_attempt",
IF
((num_attempts>0
AND id_reason_held IS NULL)
OR (id_reason_held IN (3)),
"pending_for_reassigning",
IF
( id_reason_held=1
AND DATE_DIFF(scheduled_date,CURRENT_DATE(),day)<4,
"held_reschedule",
IF
( id_reason_held=1
AND DATE_DIFF(scheduled_date,CURRENT_DATE(),day)>=4,
"Audit",
IF
( id_reason_held=5,
"address_calling_required",
IF
( id_reason_held=4,
"address_check_reassigning_required",
"check"))))))))) AS status
FROM
`noonltddwh.lms.creq_leg` creq_leg
LEFT JOIN
`noonltddwh.lms.creq_leg_job_active` creq_leg_job_active
USING
(id_creq_leg)
LEFT JOIN
`noonltddwh.lms.creq_leg_job` creq_leg_job
USING
(id_creq_leg_job)
LEFT JOIN
`noonltddwh.lms.hub_sector` hub_sector
USING
(id_hub_sector)
LEFT JOIN
`noonltddwh.lms.creq` creq
USING
(id_creq)
LEFT JOIN
`noonltddwh.lms.creq_type` creq_type
USING
(id_creq_type)
LEFT JOIN
`noonltddwh.lms.address` src_address
ON
id_address_src=src_address.id_address
LEFT JOIN
`noonltddwh.lms.address` dst_address
ON
id_address_dst=dst_address.id_address
LEFT JOIN
`noonltddwh.lms.reason` reason
ON
id_reason_held=reason.id_reason
LEFT JOIN
`noonltddwh.lms.country` country
ON
dst_address.id_country=country.id_country
WHERE
id_creq_leg_type=1
AND creq_leg.id_status NOT IN (4,
6)
AND DATE(creq_leg.created_at)>="2021-12-01"
AND id_creq_type=2
)T
'''

[[matview]]
dag_id = 'st_dag'
task_id = 'Yesterday_FA_Summary'
destination_table = 'noonbilogmis.reporting.Yesterday_FA_Summary'
sql = '''
SELECT 
Country
,SUM(Yesterday_Attempted) as Yesterday_Attempted
,SUM(Yesterday_9_to_12_Attempted) as Yesterday_9_to_12_Attempted
,SUM(Total_EDD_Shipments) as Total_Shipments 
,current_timestamp() ts
FROM
(
SELECT * FROM (Select lower(so.country_code) as Country
,sois.awb_nr
,so.order_nr
,DATE(estimated_delivery_at) edd
,Hub.code as LM_Hub
,destination_city
,extract(hour from FA_TS) hour
,nexfa.FA_TS 

,CASE WHEN lower(so.country_code) = 'ae' then timestamp_add(case when dx02.created_at is not null then dx02.created_at when Direct_ship.created_at is not null then Direct_ship.created_at when manifest1.m_created_at is not null then manifest1.m_created_at  end,interval 4 hour)
WHEN lower(so.country_code) = 'sa' then timestamp_add(case when dx02.created_at is not null then dx02.created_at when Direct_ship.created_at is not null then Direct_ship.created_at when manifest1.m_created_at is not null then manifest1.m_created_at  end,interval 3 hour)
WHEN lower(so.country_code) = 'eg' then timestamp_add(case when dx02.created_at is not null then dx02.created_at when Direct_ship.created_at is not null then Direct_ship.created_at when manifest1.m_created_at is not null then manifest1.m_created_at  end,interval 2 hour) end as ship_dt
,case when lower(so.country_code) = 'ae' then timestamp_add(b.shipped_at, interval 4 hour)
when lower(so.country_code) = 'sa' then timestamp_add(b.shipped_at, interval 3 hour)
when lower(so.country_code) = 'eg' then timestamp_add(b.shipped_at, interval 2 hour) end as ship_cutoff
,so.created_at customer_order_dt
,COUNT(DISTINCT Case when date(FA_TS) = DATE(estimated_delivery_at) then 1 end)  as  Yesterday_Attempted
,COUNT(DISTINCT Case when date(FA_TS) = DATE(estimated_delivery_at) AND extract(hour from FA_TS) between 21 and 23 then 1 end)  as  Yesterday_9_to_12_Attempted
,count(distinct sois.awb_nr ) as Total_EDD_Shipments
,count(distinct case when (date(estimated_delivery_at)< date(nexfa.FA_TS) or date(nexfa.FA_TS) is null) then sois.awb_nr end) as Overall_Breach,
count(distinct case when case when lower(so.country_code) = 'ae' then timestamp_add(b.shipped_at, interval 4 hour)
when lower(so.country_code) = 'sa' then timestamp_add(b.shipped_at, interval 3 hour)
when lower(so.country_code) = 'eg' then timestamp_add(b.shipped_at, interval 2 hour) end>=
(cast(
CASE WHEN lower(so.country_code) = 'ae' then timestamp_add(
case when dx02.created_at is not null then dx02.created_at
when Direct_ship.created_at is not null then Direct_ship.created_at
when manifest1.m_created_at is not null then manifest1.m_created_at
 end,interval 4 hour)
WHEN lower(so.country_code) = 'sa' then timestamp_add(
case when dx02.created_at is not null then dx02.created_at
when Direct_ship.created_at is not null then Direct_ship.created_at
when manifest1.m_created_at is not null then manifest1.m_created_at  end,interval 3 hour) WHEN lower(so.country_code) = 'eg' then timestamp_add(
case when dx02.created_at is not null then dx02.created_at
when Direct_ship.created_at is not null then Direct_ship.created_at
when manifest1.m_created_at is not null then manifest1.m_created_at  end,interval 2 hour) end as timestamp))  and lost.lost_awb is null and (date(nexfa.FA_TS) > date(estimated_delivery_at) or date(nexfa.FA_TS) is null) and InBound_ManifestNr is not null then sois.awb_nr end) as Pure_NE_Breach
from (SELECT *,CASE WHEN lower(json_extract(item_misc,"$.shipping_preferences.ndd")) like "%true%" then 1
WHEN lower(json_extract(item_misc,"$.shipping_preferences.sdd")) like "%true%" THEN 1 ELSE 0 END AS NDD_SDD_Flag,
lower(json_extract(item_misc,"$.shipping_preferences.ndd")) NDD ,lower(json_extract(item_misc,"$.shipping_preferences.sdd")) SDD
FROM `noonltddwh.sales.sales_order_item`) soi
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order
LEFT JOIN (SELECT distinct id_sales_order FROM `noonltddwh.sales.sales_order_address_change`) oac on oac.id_sales_order = so.id_sales_order
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment
LEFT JOIN `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca on so.address_code = ca.address_code
left join (select id_city, name_en as destination_city from `noonltddwh.ref.city` ) as dc on ca.id_city=dc.id_city
LEFT JOIN
(
SELECT distinct awb_nr
FROM noonltddwh.lms.item it
LEFT JOIN noonltddwh.lms.item_pkg pkg USING (id_item)
WHERE CAST(json_extract(pkg.misc,'$.is_direct_delivery') AS NUMERIC) = 1
) DSDS on DSDS.awb_nr = sois.awb_nr
LEFT JOIN
(
SELECT i.awb_nr,MIN(ish.created_at) m_created_at
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN noonltddwh.lms.item i using(id_item)
WHERE ish.id_loc_type = 1
GROUP BY 1
) manifest1 on Manifest1.awb_nr = sois.awb_nr
LEFT JOIN
(
SELECT sois.awb_nr AWB5,sois.created_at FROM
(
SELECT i.awb_nr,MIN(ish.created_at) created_at
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN noonltddwh.lms.item i using(id_item)
WHERE ish.id_loc_type = 3
GROUP BY 1
) sois
LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr
LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller
WHERE wl.id_warehouse_lane_type in (3,5)
)Direct_ship On sois.awb_nr = Direct_ship.AWB5
LEFT JOIN
(
SELECT sois.awb_nr awb4,pw.display_name ,dd.created_at
FROM `noonltddwh.sales.sales_order_item_shipment` sois
LEFT JOIN noonltddwh.sales.sales_order so using(id_Sales_order)
left JOIN `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse
LEFT JOIN
(
SELECT i.awb_nr,MIN(ish.created_at) created_at
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN noonltddwh.lms.item i using(id_item)
WHERE ish.id_loc_type = 3
GROUP BY 1
) dd on sois.awb_nr = dd.awb_nr
WHERE pw.display_name IN ('NOON/DXBG02','NOON/RUHG02','NOON/JEDG01')
) dx02 on dx02.awb4 = sois.awb_nr
left join (
select awb_nr lost_awb
from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.hub_location` hl on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)
left join noonltddwh.lms.item i using(id_item)
where id_loc_type = 1 and hl.code like "%LOST-M%"
)lost on lost.lost_awb= sois.awb_nr
left join (
select sois.awb_nr,reference_nr,
case
when sois.id_carrier=9 and reference_nr is null then "NE"
when sois.id_carrier =2 or tpl_carrier=2 then "Aramex"
when sois.id_carrier =6 or tpl_carrier=3 then "SMSA"
when sois.id_carrier = 43 or tpl_carrier=4 then "Saudi Post"
when tpl_carrier=5 then "IMile"
else refc.name_en
end as Carrier,
from `noonltddwh.sales.sales_order_item_shipment` sois
LEFT JOIN(
select distinct item.awb_nr , tipm.id_item , tcr.reference_nr, tcr.id_carrier as tpl_carrier from `noonltddwh.lms.item` item
LEFT JOIN `noonltddwh.lms.tpl_item_pgroup_map` tipm on tipm.id_item =item.id_item
LEFT JOIN `noonltddwh.lms.tpl_carrier_reference` tcr on tipm.id_item_pgroup = tcr.id_item
WHERE tcr.reference_nr is not null
)tpl on sois.awb_nr =tpl.awb_nr
LEFT JOIN `noonltddwh.ref.carrier` refc on sois.id_carrier=refc.id_carrier
where sois.id_carrier in (2,4,6,9,43)
) as car on sois.awb_nr =car.awb_nr
LEFT JOIN(select awb_nr , InBound_ManifestNr ,In_Created_At from `noonltddwh.lms.item`
LEFT JOIN (SELECT id_item,manifest_nr as InBound_ManifestNr ,manifest_item.created_at as In_Created_At
FROM `noonltddwh.lms.manifest_item` manifest_item
LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest)
WHERE is_outbound=0) in_manifest_item USING (id_item) ) Manifest on sois.awb_nr=Manifest.awb_nr
left join `noonltddwh.lms.client_pkg_ref` client_pkg_ref on sois.awb_nr=client_pkg_ref.awb_nr
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq)
left join `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector
left join `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left join `noonltddwh.oms.purchase_item` pi on pi.purchase_item_nr = poi.purchase_item_nr
left join `noonltddwh.oms.sales_item` si using (id_sales_item)
left join (
SELECT awb_nr,
CASE WHEN NDD_SDD_Flag = 1 then expected_shipping_ts ELSE shipped_at end as shipped_at
,delivered_At
FROM (
SELECT sois.awb_nr
,case when day = 'EDD-0' then timestamp_add(estimated_delivery_at , interval cut_off_min minute)
when day = 'EDD-1' then timestamp_add (timestamp_sub(estimated_delivery_at, interval 24 hour) , interval cut_off_min minute)
else timestamp_add(timestamp_sub(estimated_delivery_at, interval 24 hour) , interval 18 hour)
end expected_shipping_ts
,CASE WHEN lower(json_extract(item_misc,"$.shipping_preferences.ndd")) like "%true%" then 1
WHEN lower(json_extract(item_misc,"$.shipping_preferences.sdd")) like "%true%" THEN 1 ELSE 0 END AS NDD_SDD_Flag
,MAX(shipped_at) shipped_at,MAX(delivered_At) delivered_At
FROM noonltddwh.sales.sales_order_item soi
LEFT JOIN noonltddwh.sales.sales_order so using(id_sales_order)
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca on ca.address_code = so.address_code
LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois using(id_sales_order_item_shipment)
left join `noonbilogoi.battleplan_v1.item_final_state` ifs using (awb_nr)
left join (select * from noonbilogmis.reporting.premium_services_cutoff where type in ('NDD','VIP-NDD') and id_city is not null) ps on (ifs.origin_warehouse , ca.id_city) = (ps.warehouse_code , ps.id_city)
left join `noonltddwh.lms.creq` c using (client_ref)
LEFT JOIN `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left join `noonltddwh.oms.purchase_item` pi on pi.purchase_item_nr = poi.purchase_item_nr
left join `noonltddwh.oms.sales_item` si using (id_sales_item)
left join ((select id_purchase_item,id_partner_warehouse_from ,MIN(shipped_at) shipped_at,MAx(delivered_at) delivered_at from `noonltddwh.oms.stock_item` GROUP BY 1,2))as b on (b.id_purchase_item,b.id_partner_warehouse_from) =(pi.id_purchase_item,soi.id_partner_warehouse) and b.id_purchase_item is not null
GROUP BY 1,2,3
)
)as b on b.awb_nr = sois.awb_nr
left join (SELECT awb_nr , MIN(FA_TS) FA_TS FROM
(
SELECT awb_nr , FA_TS FA_TS FROM
noonbilogoi.Share_Point.NE_FAS
)group by 1)nexfa on nexfa.awb_nr=sois.awb_nr
where date(estimated_delivery_at) = current_Date -1
and extract(year from current_date)=extract(year from date(estimated_delivery_at))
and so.id_mp <>6
and soi.id_invoice_section = 1
and so.id_cart_type = 1
and carrier="NE"
and soi.id_sales_order_item_status not in (1,2,7,9)
and lost.lost_awb is null
and b.shipped_at <= b.delivered_At
and DSDS.awb_nr is null
and((NDD_SDD_Flag = 0 AND DATE(case when lower(so.country_code) = 'ae' then timestamp_add(b.shipped_at, interval 4 hour)
when lower(so.country_code) = 'sa' then timestamp_add(b.shipped_at, interval 3 hour)
when lower(so.country_code) = 'eg' then timestamp_add(b.shipped_at, interval 2 hour) end) <= DATE(estimated_delivery_at)) OR NDD_SDD_Flag = 1)
and sois.id_carrier in (2,4,6,9,43)
group by 1,2 ,3,4,5,6,7,8,9,10,11
)
)GROUP BY 1
order by 1
'''


[[matview]]
dag_id = 'st_dag'
task_id = 'Fake_Attempt_rawdata'
destination_table = 'noonbilogmis.reporting.Fake_Attempt_rawdata'
sql = '''
SELECT 
*,current_timestamp() ts
FROM 
(SELECT distinct awb_nr,Id_leg, country, client_ref,ofd_date,username,Hub,calls,omw,reachable,unreachable,ud_reason,usr_reason, firstdel_awb, Fake_Attempts, flag, updated_by,hub_sector FROM (SELECT ofd_data.country,ofd_data.awb_nr,client_ref,ofd_date,username,ofd_data.hub Hub,hub_sector,calls,omw ,reachable,unreachable,ofd_status ud_reason ,reason usr_reason,firstdel.awb_nr firstdel_awb,Id_leg, dd,clh_data as updated_by,CASE WHEN ofd_data.ofd_status IN ("Delivered","rto_marked","unrechable") THEN "No Fake Attempt"
WHEN omw IS NULL AND reason IS NOT NULL THEN "UD without omw"
WHEN omw = 0 AND reason IS NOT NULL THEN "UD without omw"
WHEN calls IS NULL AND reason IS NOT NULL THEN "UD without Call"
WHEN calls = 0 AND reason IS NOT NULL THEN "UD without Call"
WHEN reachable >= 1 AND ofd_status IS NULL THEN "No UD Reachable Call"
WHEN reason IN ("address_misrouted","address_changed_warning","address_changed_reroute","address_changed")
and del_dt < ofd_data.ofd_date
AND ofd_data.awb_nr <> firstdel.awb_nr THEN "Address Change Already Delivered"
WHEN usr_created_at < IVR_Call AND DATE(usr_created_at) = DATE(IVR_call) THEN "Calling Validated"
WHEN ofd_status IS NULL AND IVR_Call IS NOT NULL THEN 'Calling Validated' ELSE "No Fake Attempt"End as Fake_Attempts,
ROW_NUMBER() OVER (PARTITION BY ofd_data.awb_nr,ofd_data.ofd_date ORDER BY ofd_data.ofd_date DESC) row_num,case when lower(json_extract(data,"$.updated_app")) like "%field%" then 'field'
     when lower(json_extract(data,"$.updated_app")) is null then 'null'
     when lower(json_extract(data,"$.updated_app")) like "%client%" then 'CX'
     when lower(json_extract(data,"$.updated_app")) like "noon@client.express.noon.team" then 'CS'
     else 'others'
end as flag FROM (
select * except (created_at), cast(created_at as timestamp) as session_field_item_created_at FROM
( SELECT ofd.* from `noonbilogoi.MJ.OFD` ofd
left join `noonltddwh.lms.creq_leg` using (id_creq_leg) 
left join `noonltddwh.lms.creq` creq using (id_creq) 
left join `noonltddwh.lms.client` client using (id_client)
left join (SELECT it.awb_nr,sfi.is_delivery_block,demo.id_creq_leg_type clt, sfi.id_address,
    cust.code customer_type, sf.created_at, id_session_field FROM `noonltddwh.lms.session_field` sf
LEFT JOIN `noonltddwh.lms.session_field_item` sfi USING (id_session_field)
LEFT JOIN `noonltddwh.lms.item` it USING (id_item)
LEFT JOIN `noonltddwh.lms.address` addr USING (id_address)
LEFT JOIN `noonltddwh.lms.customer` cus USING (id_customer)
LEFT JOIN `noonltddwh.lms.customer_type` cust USING (id_customer_type)
left join `noonltddwh.lms.creq_leg`  demo on demo.id_creq_leg = sfi.id_creq_leg 
)  a using  (id_session_field,awb_nr)
left join (select username, lms_roles from `noonltddwh.lms.user` 
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username) 
where id_creq_type =1
and clt = 3
and ofd.is_delivery_block =0
) as d
left join (select awb_nr,client_ref,country,creq,creq_leg_type from `noonbilogoi.battleplan_v1.item_final_state`) using (awb_nr)
left join
(
SELECT sfi.*,
MIN(temp.id_leg) Id_leg
FROM `noonltddwh.lms.session_field_item` sfi
LEFT JOIN (
SELECT id_creq_leg id_leg, created_at ct_at from 
`noonltddwh.lms.creq_leg_history` clh
WHERE json_extract(data,"$.updated_app") = '"client"'
) temp on sfi.id_creq_leg = temp.id_leg AND sfi.created_at >= temp.ct_at AND Date(sfi.created_at ) = date ( temp.ct_at)
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
)
using (id_item,id_session_field)
where creq = "LM"  and d.is_delivery_block = 0
) ofd_data
left join(select awb_nr,timestamp_add(clh.created_at,interval 4 hour) as usr_created_at, data as clh_data from `noonbilogoi.MJ.OFD`
left join `noonltddwh.lms.creq_leg_history` clh using (id_creq_leg)
-- where lower(json_extract(data,"$.updated_app")) like "%field%"
) using (awb_nr)left join `noonltddwh.lms.item` item using (id_item,awb_nr)
left join `noonltddwh.lms.item_pkg` ip using (id_item)
left join `noonltddwh.lms.creq_leg_history` clh on (clh.id_creq_leg = ip.id_creq_leg)
LEFT JOIN (
SELECT awb_nr1, cast(Received_by_LPC as timestamp) Received_by_LPC
FROM(
SELECT awb_nr1,
CASE
WHEN SUBSTR(awb_nr1,14,1) = "E" THEN timestamp_add(Received_by_LPC,interval 2 hour)
WHEN SUBSTR(awb_nr1,14,1) = "S" THEN timestamp_add(Received_by_LPC,interval 3 hour)
WHEN SUBSTR(awb_nr1,14,1) = "A" THEN timestamp_add(Received_by_LPC,interval 4 hour)
ELSE
timestamp_add(Received_by_LPC,interval 4 hour)
END as Received_by_LPC
FROM (
select awb_nr awb_nr1,min(ish.created_at) as Received_by_LPC
from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.hub_location` hl on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)
left join `noonltddwh.lms.item` using (id_item)
where id_loc_type = 1
and substr(CAST(substr(hl.code,0,6) AS String),5,1)
not in ("G","Z","Y","D","T")
group by 1))
) t on t.awb_nr1 = ofd_data.awb_nr
-- and t.Received_by_LPC < ofd_data.session_field_item_created_at
LEFT JOIN(
SELECT awb_nr, cast(DateTIME(dd) as timestamp) dd
from(
Select awb_nr, max(CASE
WHEN SUBSTR(awb_nr,14,1) = "E" THEN timestamp_add(ish.created_at,interval 2 hour)
WHEN SUBSTR(awb_nr,14,1) = "S" THEN timestamp_add(ish.created_at,interval 3 hour)
WHEN SUBSTR(awb_nr,14,1) = "A" THEN timestamp_add(ish.created_at,interval 4 hour)
ELSE
timestamp_add(ish.created_at,interval 3 hour)
END) dd
From `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.item` i using (id_item)
LEFT JOIN `noonltddwh.lms.creq_leg` cl using (id_creq_leg)
where cl.id_creq_leg_type = 3 group by 1) t
) RTO_Check
ON RTO_Check.awb_nr = ofd_data.awb_nr
-- and RTO_Check.dd > ofd_data.session_field_item_created_at
LEFT JOIN `noonbilogoi.LOGKSA_DATA.location_by_country` lbc on lbc.branch_code = ofd_data.hub
LEFT JOIN (
SELECT awb_nr,
client_ref,
Hub_Sector,
ofd_date del_dt
FROM (
SELECT awb_nr,
client_ref,
ofd_date,
Hub_Sector,
ROW_NUMBER() OVER (PARTITION BY client_ref ORDER BY ofd_date DESC) row_num
FROM noonbilogoi.LOGKSA_DATA.lms2_ofd_data
WHERE Final_Status like "Delivered" AND ofd_date >= DATE_ADD(CURRENT_DATE(),INTERVAL -90 DAY)) WHERE row_num = 1) firstdel using(client_ref,Hub_Sector)
LEFT JOIN (
SELECT Unique_ID,
Cust_Category,
MAX(Date_Time) as IVR_Call FROM `noonbilogoi.nefreelancer.ne_calling_outcom_history`
WHERE lower(Cust_Disposition) like '%reschedule%' and lower(Cust_Category) in ('unreachable','sivvi_customer_cancel','prepaid','attempts_exhausted','kul_customer_cancel','kul_address_change','sivvi_high_value','sivvi_address_change','address_change_hub_scetor','oda','attempt_exhausted','address_change','customer_cancel','oda_not_for_eg_ae','high_value','ndr')
GROUP BY 1,2) calling on Unique_ID = client_ref
WHERE  ofd_data.ofd_date > '2021-12-31'
-- extract(month from ofd_data.ofd_date) = extract(month from current_date())
-- AND Received_by_LPC is not null
-- AND RTO_Check.dd is not null
AND
substr(CAST(substr(ofd_data.hub,0,6) AS String),5,1) not in ("G","Z","Y","D","T")
and lower(json_extract(clh_data,"$.updated_app")) like "%field%"
-- and lower(json_extract(clh_data,"$.updated_by")) not like "%customer@noon.com%"-- "updated_by":"customer@noon.com"
)
WHERE Fake_Attempts <> "No Fake Attempt"
-- AND ((country = 'AE' and Hub not like '%-B%') or (country = 'SA' and Hub not like '%-F%') or country = 'EG')
and flag not in ('CS','CX','OFD','null')
and not (calls <> 0 and omw <> 0)
)
WHERE case when Id_leg is not null and Fake_Attempts = 'UD without omw' then 0 else 1 end = 1
and case when Id_leg is not null and Fake_Attempts = 'UD without Call' then 0 else 1 end = 1
and usr_reason not in ('held_for_pickup','held_consolidation')
'''




[[matview]]
dag_id = 'mat_battleplan_once'
task_id = 'ST3'
destination_table = 'noonbilogmis.reporting.ST3_once'
sql = '''
select distinct
so.country_code as Country,
cxx.name_en as City,
hub.code as Hub,
hsec.code as HubSector,
cz.code as CountryZone,
so.order_nr ,
coalesce(zz.InBound_Manifest_Number) as InBound_Manifest_Number,
coalesce(zz.OutBound_Manifest_Number) OutBound_Manifest_Number,
coalesce(zz.DA,zz1.DA,zz2.DA) as DA,
DABagNr ,
BoxNr ,
hub_transfer_nr,
shp.awb_nr ,
shp.shipment_nr,
soi.item_nr ,
timestamp_add(so.created_at,interval 4 hour) as OrderTS,
CAST(sdsg.delivery_date AS TIMESTAMP) as EDD,
case when bb.CurrentLocation like  '%DMG%' or bb.CurrentLocation like '%LOST%' or refstat.code = 'undeliverable' then bb.CurrentLocation else coalesce(boxLoc.CurrentLocation,bb.CurrentLocation) end as CurrentLocation,
case when bb.CurrentLocation like  '%DMG%' or bb.CurrentLocation like '%LOST%' or refstat.code = 'undeliverable' then bb.loc_type else coalesce(BoxLoc.loc_type,bb.loc_type) end as LocationType,
dts.name as SlotTimeGST,
dts.is_sdd as SDDFlag,
cleg.id_address as CLEG_ID_ADDRESS, 
dts.start_hour as SlotStartHourUTC,
dts.end_hour as SlotEndHourUTC,
case when so.country_code = 'SA' then dts.start_hour+3 else dts.start_hour+4 end as SlotStartHourGST,
case when so.country_code = 'SA' then dts.end_hour+3 else dts.end_hour+4 end as SlotEndHourGST,
refstat.code as ItemFinalStatus,
reason.name_en as CancellationReason,
First_held_reason,
case when lower(so.payment_method_code) <> 'cod' then "PREPAID" else 'COD' end as PaymentMethod,
pv.title_en ProductName,
STRING_AGG(DISTINCT pb.pbarcode_canonical) as barcodes,
case when pwx.is_fbn = 1 then "FBN" else "NON_FBN" end as FBN,
coalesce(pw.code,zz.address_uid) as warehouseCode,
REPLACE(coalesce(pw.display_name,zz.address_uid),"NOON/","") OriginWH,
---timestamps---
case when so.country_code= 'SA' then coalesce(timestamp_add(shp.created_at,interval 3 hour)) else coalesce(timestamp_add(shp.created_at,interval 4 hour)) end as ShipmentCreatedAt,
case when so.country_code= 'SA' then timestamp_add(zz.InBoundMFCreatedAt,interval 3 hour) else timestamp_add(zz.InBoundMFCreatedAt,interval 4 hour) end as ShipmentWHHandoverAt,
case when so.country_code = 'SA' then timestamp_add(zz.InTriageAt,interval 3 hour) else timestamp_add(zz.InTriageAt,interval 4 hour) end as ShipmentWHReceivedAt,
case when so.country_code = 'SA' then timestamp_add(zz.BoxTransitAt,interval 3 hour) else timestamp_add(zz.BoxTransitAt,interval 4 hour) end as ShipmentInTransitAt,
case when so.country_code = 'SA' then timestamp_add(zz.TransitToteScannedAt,interval 3 hour) else timestamp_add(zz.TransitToteScannedAt,interval 4 hour) end as ShipmentInToteAt,
case when so.country_code = 'SA' then coalesce(timestamp_add(yy.created_at ,interval 3 hour)) else coalesce(timestamp_add(yy.created_at ,interval 4 hour)) end as BoxCreatedAt,
case when so.country_code = 'SA' then coalesce(timestamp_add(HTcreationTS ,interval 3 hour)) else coalesce(timestamp_add(HTcreationTS ,interval 4 hour)) end as HTCreatedAt,
case when so.country_code = 'SA' then coalesce(timestamp_add(zz1.OFD_TS,interval 3 hour),timestamp_add(zz.OFDAt,interval 3 hour),timestamp_add(zz2.OFD_TS,interval 3 hour)) else coalesce(timestamp_add(zz1.OFD_TS,interval 4 hour),timestamp_add(zz.OFDAt,interval 4 hour),timestamp_add(zz2.OFD_TS,interval 4 hour)) end as OFDAt,
case when so.country_code = 'SA' then coalesce(timestamp_add(DeliveredManifestedAt,interval 3 hour)) else coalesce(timestamp_add(DeliveredManifestedAt,interval 4 hour)) end as DeliveredAt,
case when so.country_code = 'SA' then coalesce(timestamp_add(firstheld_TS,interval 3 hour)) else coalesce(timestamp_add(firstheld_TS,interval 4 hour)) end as firstheld_TS,
case when so.country_code = 'SA' then coalesce(timestamp_add(UnreachableTS,interval 3 hour)) else coalesce(timestamp_add(UnreachableTS,interval 4 hour)) end UnreachableTS,
if( (coalesce(pw.display_name,zz.address_uid) like "%DXBDS%" or coalesce(pw.display_name,zz.address_uid) like "%RUHDS%")  and json_extract(so.misc,"$.shipping_preferences.instant") = "true" , 1,0) as Instant_order,
dsa.code as DSA_name
from
(select * from noonltddwh.sales.sales_order_item where id_invoice_section=1 and sales_order_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR)) )soi
  LEFT JOIN noonltddwh.ref.sales_order_item_status sois USING (id_sales_order_item_status)
  left join (select * from  `noonltddwh.sales.sales_order_item_shipment` where sales_order_pdate>= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) shp using (id_sales_order_item_shipment, id_sales_order)
  LEFT JOIN (select * from noonltddwh.sales.sales_order where id_mp = 6 and sales_order_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))  and id_cart_type=1) so USING (id_sales_order)
left join (select * from `noonltddwh.lms.creq` WHERE DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) creq on creq.client_ref = so.order_nr    
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type =3 and DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR)))cleg on cleg.id_creq = creq.id_creq 
------------------------- Get First Held Reason
left join (select id_creq_leg, if(r.code is null, "rescheduled", r.code) as First_held_reason, clhx.created_at as firstheld_TS from (select id_creq_leg, min(created_at) created_at from `noonltddwh.lms.creq_leg_history` 
where DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))
and (cast(json_extract(data, "$.id_reason_held") as int64) is not null or json_extract(data, "$.scheduled_date")  is not null)
group by 1)
left join (select * from `noonltddwh.lms.creq_leg_history` where DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) clhx using (id_creq_leg, created_at)
left join `noonltddwh.lms.reason` r on id_reason = cast(json_extract(data, "$.id_reason_held") as int64)) firstheld on firstheld.id_creq_leg = cleg.id_creq_leg
left join `noonltddwh.lms.hub_sector` hsec on hsec.id_hub_sector = cleg.id_hub_sector
left join `noonltddwh.lms.country_zone` cz on cz.id_country_zone = cleg.id_country_zone
left join `noonltddwh.lms.hub` hub on hub.id_hub = hsec.id_hub
    
left join `noonltddwh.ref.sales_order_item_status` refstat on refstat.id_sales_order_item_status = soi.id_sales_order_item_status 
left join `noonltddwh.ref.reason` reason on reason.code = soi.cancel_reason_code
          
left join (select * from noonltddwh.sales.sales_delivery_slot_group WHERE DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) sdsg ON (sdsg.id_sales_order, sdsg.delivery_slot_group_ix) = (soi.id_sales_order, soi.delivery_slot_group_ix)
left join `noonltddwh.dsa.daily_service_area` dsa on dsa.code = dsa_code
left join `noonltddwh.ref.city` cxx on cxx.id_city = dsa.id_city
left join `noonltddwh.ref.delivery_time_slot` dts on dts.code = sdsg.delivery_time_slot_code 
left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) item on item.awb_nr = shp.awb_nr 
-----------------------------------------------------Get Unreachable TS
left join (
  SELECT
    id_item,
    min(session_field_contact_attempt.created_at) AS UnreachableTS
  FROM (
    SELECT
      id_item,
      DATE(session_field_contact_attempt.created_at) AS contact_attempt_date,
      attempt_at,
      id_attempt_type,
      session_field_contact_attempt.created_at
    FROM  (select * from   `noonltddwh.lms.session_field_item` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) session_field_item
    LEFT JOIN(select * from  `noonltddwh.lms.session_field_contact_attempt` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) session_field_contact_attempt   ON  (session_field_item.id_session_field,session_field_item.id_creq_leg_customer)=(session_field_contact_attempt.id_session_field,
        session_field_contact_attempt.id_creq_leg)) session_field_contact_attempt
where id_attempt_type=4
 group by 1 ) using (id_item)
----------------------------------------------------- GET BOX NUMBER-------------------------------------------------------
left join (select cline.id_item, item1.id_item as BoxItem, item1.awb_nr as BoxNr, item1.created_at from (SELECT * FROM `noonltddwh.lms.container_line` WHERE DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) cline
            left join `noonltddwh.lms.loc_type` clt ON cline.id_loc_type = clt.id_loc_type
            left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) item1 ON (clt.code, cline.loc_id) = ('pgroup', item1.id_item)
            left join  `noonltddwh.lms.item_pgroup`  itpg ON itpg.id_item = item1.id_item
            left join `noonltddwh.lms.item_pgroup_type` iptype USING (id_item_pgroup_type)
            where iptype.code ='creq') yy using (id_item)
----------------------------------------------------BOX HT ---------------------------------------            
left join (SELECT hub_transfer.hub_transfer_nr 
,awb_nr as DBoxNr
,container_line.unpacked_at as unpack_TS
,container_line.created_at as HTcreationTS
FROM (
select id_item, min(created_at) as created_at  from `noonltddwh.lms.container_line` where id_loc_type = 4 and created_at >= timestamp_add(current_timestamp(),interval -13000 HOUR) group by 1)
left join (select * from `noonltddwh.lms.container_line` where created_at >= timestamp_add(current_timestamp(),interval -13000 HOUR)) container_line using (id_item, created_at)
left join `noonltddwh.lms.item` item using (id_item)
left join (select * from `noonltddwh.lms.hub_transfer` where created_at >= timestamp_add(current_timestamp(),interval -13000 HOUR)) hub_transfer on container_line.loc_id=hub_transfer.id_hub_transfer
where id_loc_type = 4
and item.id_item_type = 2 ) htt on htt.DBoxNr = yy.BoxNr
            
-------------------------------------------------------- BOX LOCATION------------------------------            
left join (
select distinct
 ish.id_item
, id_creq_leg
, i.awb_nr
, s.code as status
, lt.code as loc_type
, REPLACE(coalesce(hl.code,
u.username,
pgroup,
ht.hub_transfer_nr,
m.manifest_nr,
mx.manifest_nr,
spc.code,
spl.code,
tote.awb_nr,
pgroup_com,
spcl.code,
adx.address_uid),"@ops.idp.noon.team","") 
as CurrentLocation
, ish.updated_at as  created_at
from 
(select * from `noonltddwh.lms.item_state` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR)))ish 
left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) i using (id_item)
left join (select * from `noonltddwh.lms.item_pkg` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) using (id_item)
left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)
left join `noonltddwh.lms.user` u on (ish.id_loc_type,ish.loc_id) = (2,id_user)
left join (select id_item, awb_nr as pgroup from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ip on  (ish.id_loc_type,ish.loc_id) = (3,ip.id_item)
left join (select * from `noonltddwh.lms.hub_transfer` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) ht on  (ish.id_loc_type,ish.loc_id) = (4,id_hub_transfer)
left join (select * from `noonltddwh.lms.manifest` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) m on  (ish.id_loc_type,ish.loc_id) = (5,m.id_manifest)
left join (select * from `noonltddwh.lms.manifest` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) mx on (ish.id_loc_type,ish.loc_id) = (6,mx.id_manifest)
left join `noonltddwh.lms.service_point_counter` spc on  (ish.id_loc_type,ish.loc_id) = (8,id_service_point_counter)
left join `noonltddwh.lms.address` adx on  (ish.id_loc_type,ish.loc_id) = (9,adx.id_address)
left join (select id_item, awb_nr as pgroup_com from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ipc on (ish.id_loc_type,ish.loc_id) = (11,ipc.id_item)
left join `noonltddwh.lms.service_point_locker` spl on (ish.id_loc_type,ish.loc_id) = (12,id_service_point_locker)
LEFT JOIN `noonltddwh.lms.service_point_counter_location` spcl ON (ish.id_loc_type,ish.loc_id)=(13,spcl.id_service_point_counter_location)
LEFT JOIN (select * from `noonltddwh.lms.item` where item_pdate >= '2020-01-01') tote ON (ish.id_loc_type,ish.loc_id)=(16,tote.id_item)
left join `noonltddwh.lms.status` s on s.id_status = ish.id_status
left join `noonltddwh.lms.loc_type` lt using (id_loc_type)
where i.id_item_type = 2
group by 1,2,3,4,5,6,7
)boxLoc on BoxLoc.awb_nr = yy.BoxNr           
left join ( select AWB ,
                  id_item , max(address_uid) as address_uid,
                  min(case when id_loc_type = 2 and username is not null then username end) as DA,
                  min(case when id_loc_type = 5 and MFIN is not null then MFIN end) as InBound_Manifest_Number,
                  min(case when id_loc_type = 6 and OmType = 4 and OBMF is not null then OBMF end) as OutBound_Manifest_Number,
                  min(case when id_loc_type = 9 and address_uid is not null then TS end) as LogisticsInTakeAt,
                  min(case when id_loc_type= 5 and MFIN is not null then TS end) as InBoundMFCreatedAt,
                  min(case when id_loc_type= 1 and hubloc is not null then TS end) as InTriageAt,
                  min(case when id_loc_type = 3 and TransitBox like '%H%' and TransitBox is not null then TS end) as BoxTransitAt,
                  max(case when id_loc_type= 1 and hubloc is not null and hubloc like '%TRIAGE%' and hubloc not like '%DXB-A4%' then TS end) as InHubAt,
                  max(case when id_loc_type= 16 and Tote is not null then TS end) as TransitToteScannedAt,
                  min(case when id_loc_type = 3 and TransitBox like '%Q%' and TransitBox is not null then TS end) as BoxReadyAt,
                  min(case when id_loc_type = 2 and username is not null then TS end) as OFDAt,
                  max(case when id_loc_type = 6 and OmType = 4 and OBMF is not null then TS end) as DeliveredManifestedAt,
                  max(case when id_loc_type = 6 and (IMtype=5 or OmType = 5) then TS end) as LostManifestedAt,
                  from
                  (
       select item.awb_nr as AWB,  ish.id_item , ish.id_loc_type , lt.code , adx.address_uid , hl.code as hubloc, u.username,ht.id_hub_transfer  as HT, tote.awb_nr Tote, (case when m.id_manifest_type in (3,6) then m.manifest_nr end) as MFIN, m.id_manifest_type as IMType, mx.id_manifest_type as OmType,
                  (case when mx.id_manifest_type=4 then mx.manifest_nr end) as OBMF, TransitBox , ish.created_at TS 
                  from (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) item
                  
                  left join (select * from `noonltddwh.lms.item_state_history` where date(created_at)>= date(timestamp_add(current_timestamp(),interval -11000 HOUR)) )ish on ish.id_item = item.id_item 
                  left join `noonltddwh.lms.hub_location` hl on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)
                  left join `noonltddwh.lms.user` u on (ish.id_loc_type,ish.loc_id) = (2,id_user)
                  left join (select id_item, awb_nr as TransitBox , code as PgroupType1 from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item)
                  left join `noonltddwh.lms.item_pgroup_type` using (id_item_pgroup_type)
                  ) ip on (ish.id_loc_type,ish.loc_id)  = (3,ip.id_item)
                  left join `noonltddwh.lms.hub_transfer` ht on (ish.id_loc_type,ish.loc_id) = (4,id_hub_transfer)
                  left join (select * from `noonltddwh.lms.manifest` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) m on (ish.id_loc_type,ish.loc_id) = (5,m.id_manifest)
                  left join (select * from `noonltddwh.lms.manifest` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) mx on (ish.id_loc_type,ish.loc_id) = (6,mx.id_manifest)
                  left join `noonltddwh.lms.service_point_counter` spc on (ish.id_loc_type,ish.loc_id) = (8,id_service_point_counter)
                  left join `noonltddwh.lms.service_point_locker` spl on (ish.id_loc_type,ish.loc_id) = (12,id_service_point_locker)
                  LEFT JOIN (select * from `noonltddwh.lms.item` where item_pdate >= '2020-04-01')tote ON (ish.id_loc_type,ish.loc_id)=(16,tote.id_item)
                  left join `noonltddwh.lms.address` adx on  (ish.id_loc_type,ish.loc_id) = (9,adx.id_address)
                  left join `noonltddwh.lms.status` s on s.id_status = ish.id_status
                  left join `noonltddwh.lms.loc_type` lt using (id_loc_type)
                  
                  order by ish.created_at asc
                  )
                  group by 1,2
                  ) zz on zz.AWB = shp.awb_nr 
left join ----------------------------------------------------BOX DA
(select awb_nr as b_awb_nr , username as DA , item_state_historyy.created_at as OFD_TS from (select * from (select distinct ish.id_item, max(ish.created_at) as created_at from  `noonltddwh.lms.item_state_history` as ish where date(created_at)>= date(timestamp_add(current_timestamp(),interval -11000 HOUR)) and ish.id_loc_type=2 and id_status = 301 and ish.loc_id<>1
group by 1
)left join (SELECT * FROM `noonltddwh.lms.item_state_history` WHERE DATE(created_at) >=  date(timestamp_add(current_timestamp(),interval -11000 HOUR))) as item_state_historyx  using (id_item,created_at)
where loc_id<>1
) as item_state_historyy 
left join `noonltddwh.lms.user` as user on user.id_user =item_state_historyy.loc_id 
left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) using (id_item) 
)zz1 on b_awb_nr = BoxNr 
---------------------------------DA HANDOVER BAG---------------
 left join (select cline.id_item ,item1.awb_nr as DABagNr
            from (SELECT * FROM `noonltddwh.lms.container_line` WHERE DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) cline
            left join `noonltddwh.lms.loc_type` clt ON cline.id_loc_type = clt.id_loc_type
            
            left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) item1 ON (clt.code, cline.loc_id) = ('pgroup', item1.id_item)
            
            left join (select id_item,id_item_pgroup_type from `noonltddwh.lms.item_pgroup`) itpg ON itpg.id_item = item1.id_item
            left join `noonltddwh.lms.item_pgroup_type` iptype USING (id_item_pgroup_type)
            where iptype.code ='daily_handover') yyq on yyq.id_item=yy.BoxItem
            
------------------------------------------------------------------- DA BAG DA
left join (select awb_nr as b1_awb_nr , username as DA , item_state_historyy.created_at as OFD_TS from (select * from (select distinct ish.id_item, max(ish.created_at) as created_at from  (SELECT * FROM `noonltddwh.lms.item_state_history` WHERE DATE(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) as ish where ish.id_loc_type=2 and ish.loc_id<>1
group by 1
)left join (SELECT * FROM `noonltddwh.lms.item_state_history` WHERE DATE(created_at) >=  date(timestamp_add(current_timestamp(),interval -11000 HOUR))) as item_state_historyx  using (id_item,created_at)
where loc_id<>1
) as item_state_historyy 
left join `noonltddwh.lms.user` as user on user.id_user =item_state_historyy.loc_id 
left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) using (id_item)) zz2 on b1_awb_nr = DABagNr            
left join (
select distinct
 ish.id_item
, id_creq_leg
, i.awb_nr
, s.code as status
, lt.code as loc_type
, REPLACE(coalesce(hl.code,
u.username,
pgroup,
ht.hub_transfer_nr,
m.manifest_nr,
mx.manifest_nr,
spc.code,
spl.code,
tote.awb_nr,
pgroup_com,
spcl.code,
adx.address_uid),"@ops.idp.noon.team","") 
as CurrentLocation
, ish.updated_at as  created_at
from 
(select * from `noonltddwh.lms.item_state` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR)))ish 
left join (SELECT * FROM `noonltddwh.lms.item` WHERE item_pdate >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) i using (id_item)
left join (select * from `noonltddwh.lms.item_pkg` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) using (id_item)
left join `noonltddwh.lms.hub_location` hl  on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)
left join `noonltddwh.lms.user` u on (ish.id_loc_type,ish.loc_id) = (2,id_user)
left join (select id_item, awb_nr as pgroup from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ip on  (ish.id_loc_type,ish.loc_id) = (3,ip.id_item)
left join (select * from `noonltddwh.lms.hub_transfer` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) ht on  (ish.id_loc_type,ish.loc_id) = (4,id_hub_transfer)
left join (select * from `noonltddwh.lms.manifest` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) m on  (ish.id_loc_type,ish.loc_id) = (5,m.id_manifest)
left join (select * from `noonltddwh.lms.manifest` where date(created_at) >= date(timestamp_add(current_timestamp(),interval -11000 HOUR))) mx on (ish.id_loc_type,ish.loc_id) = (6,mx.id_manifest)
left join `noonltddwh.lms.service_point_counter` spc on  (ish.id_loc_type,ish.loc_id) = (8,id_service_point_counter)
left join `noonltddwh.lms.address` adx on  (ish.id_loc_type,ish.loc_id) = (9,adx.id_address)
left join (select id_item, awb_nr as pgroup_com from `noonltddwh.lms.item_pgroup` left join `noonltddwh.lms.item` using (id_item) ) ipc on (ish.id_loc_type,ish.loc_id) = (11,ipc.id_item)
left join `noonltddwh.lms.service_point_locker` spl on (ish.id_loc_type,ish.loc_id) = (12,id_service_point_locker)
LEFT JOIN `noonltddwh.lms.service_point_counter_location` spcl ON (ish.id_loc_type,ish.loc_id)=(13,spcl.id_service_point_counter_location)
LEFT JOIN (select * from `noonltddwh.lms.item` where item_pdate >= '2020-12-01') tote ON (ish.id_loc_type,ish.loc_id)=(16,tote.id_item)
left join `noonltddwh.lms.status` s on s.id_status = ish.id_status
left join `noonltddwh.lms.loc_type` lt using (id_loc_type)
where i.id_item_type = 1
group by 1,2,3,4,5,6,7
)bb on shp.awb_nr = bb.awb_nr    
left join `noonltddwh.partner.partner_warehouse` pw on pw.id_partner_warehouse  = soi.id_partner_warehouse 
left join `noonltddwh.partner.partner_warehouse` pwx on pwx.id_partner_warehouse =  soi.id_partner_warehouse 
left join `noonltddwh.cache.product_variant` pv on pv.sku = soi.SKU 
left join `noonltddwh.cache.product_extra` pe on pe.sku = soi.sku 
left join (select * from `noonltddwh.oms.sales_item` where sales_order_pdate>=date(timestamp_add(current_timestamp(),interval -11000 HOUR))) si on si.sales_item_nr = soi.item_nr 
left join (select * from `noonltddwh.oms.purchase_item` where sales_order_pdate>=date(timestamp_add(current_timestamp(),interval -11000 HOUR))) pi on pi.id_sales_item = si.id_sales_item 
LEFT JOIN noonltddwh.cache.psku ps on ps.psku_code = pi.psku_code 
LEFT JOIN noonltddwh.cache.pbarcode pb on pb.psku_code = ps.psku_code  
where 
so.id_cart_type = 1
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48
'''


[[sheetstobq]]
dag_id = 'mat_battleplan_once'
task_id = 'manifest_check'
destination_table = 'noonbilogmis.reporting.manifest_check'
sheet_url = 'https://docs.google.com/spreadsheets/d/1wdZJ9D-IDN2FHrFyS97uj_mOnR1g3VL3JZddwyikLfs/edit#gid=0'
tabname = 'Sheet1'



[[authview]]
dag_id ='mat_battleplan_once' 
task_id ='PDD_Breach_Raw_data'
destination_table =  'noonbilogmis.reporting.PDD_Breach_RawData_Copy'
sql ='''
SELECT *
,case when CFC IN ('NOON/DXBG02','NOON/RUHG02','NOON/JEDG01') and flag =1 then 1 else 0 end as Grocery_Breach
,case when Carrier = 'Noon Express v2' and flag =1 then 1 else 0 end as TPL_FLow_Breach
,case when CFC Not IN ('NOON/DXBG02','NOON/RUHG02','NOON/JEDG01') and Carrier <> 'Noon Express v2' and flag =1 then 1 else 0 end as Pure_NE_Breached
FROM (
select * except(Pure_NE_Breach_flag, Overall_Breach)
, case when Country='sa' and date(ship_cutoff)>=edd then 0 else Pure_NE_Breach_flag end as flag
, case when Country='sa' and date(ship_cutoff)>=edd then 0 else Overall_Breach end as Overall_Breach
from
(
Select lower(so.country_code) as Country
,sois.awb_nr
,so.order_nr
,soi.NDD_SDD_Flag
,soi.NDD
,soi.SDD
,DATE(estimated_delivery_at) edd
,Hub.code as LM_Hub
,hub_sector.name as Hub_sector
,cz.code as Country_zone
,destination_city
,Carrier
,pw.display_name CFC
,CASE WHEN lower(so.country_code) = 'ae' then timestamp_add(
least(ifnull(manifest1.m_created_at,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)),
ifnull(dx02.created_at ,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), 
ifnull(Direct_ship.created_at,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
),interval 4 hour)
WHEN lower(so.country_code) = 'sa' then timestamp_add(
least(ifnull(manifest1.m_created_at,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)),
ifnull(dx02.created_at ,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), 
ifnull(Direct_ship.created_at,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
),interval 3 hour)
WHEN lower(so.country_code) = 'eg' then timestamp_add(
least(ifnull(manifest1.m_created_at,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)),
ifnull(dx02.created_at ,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day)), 
ifnull(Direct_ship.created_at,TIMESTAMP_ADD(current_timestamp,INTERVAL 200000 day))
),interval 2 hour) end as ship_dt
,case when  lower(so.country_code) = 'ae' and NDD_SDD_Flag = 0 then timestamp_add(b.shipped_at, interval 4 hour)
when lower(so.country_code) = 'sa'  and NDD_SDD_Flag = 0 then timestamp_add(b.shipped_at, interval 3 hour)
when lower(so.country_code) = 'eg'  and NDD_SDD_Flag = 0 then timestamp_add(b.shipped_at, interval 2 hour) else b.shipped_at end as ship_cutoff
,so.created_at customer_order_dt
,count(distinct sois.awb_nr ) as Total_EDD_Shipments
-- overall_breach
,count(distinct case when (date(estimated_delivery_at)<
--date(nexfa.FA_TS)
-- KSA relaxinf FA until 2 am in the morning
(case when lower(so.country_code) = 'sa' then date(timestamp_sub(nexfa.FA_TS,Interval 2 hour)) else date(nexfa.FA_TS) end)
or date(nexfa.FA_TS) is null) then sois.awb_nr end) as Overall_Breach,
count(distinct case when case when lower(so.country_code) = 'ae' and NDD_SDD_Flag = 0 then timestamp_add(b.shipped_at, interval 4 hour)
when lower(so.country_code) = 'sa' and NDD_SDD_Flag = 0 then timestamp_add(b.shipped_at, interval 3 hour)
when lower(so.country_code) = 'eg' and NDD_SDD_Flag = 0 then timestamp_add(b.shipped_at, interval 2 hour) else b.shipped_at  end>=
(cast(
CASE WHEN lower(so.country_code) = 'ae' then timestamp_add(
case when dx02.created_at is not null then dx02.created_at
when Direct_ship.created_at is not null then Direct_ship.created_at
when manifest1.m_created_at is not null then manifest1.m_created_at
 end,interval 4 hour)
WHEN lower(so.country_code) = 'sa' then timestamp_add(
case when dx02.created_at is not null then dx02.created_at
when Direct_ship.created_at is not null then Direct_ship.created_at
when manifest1.m_created_at is not null then manifest1.m_created_at end,interval 3 hour) WHEN lower(so.country_code) = 'eg' then timestamp_add(
case when dx02.created_at is not null then dx02.created_at
when Direct_ship.created_at is not null then Direct_ship.created_at
when manifest1.m_created_at is not null then manifest1.m_created_at end,interval 2 hour) end as timestamp))
and lost.lost_awb is null and
(
--date(nexfa.FA_TS)
--relaxing KSA FA until 2 AM in the morning
(case when lower(so.country_code) = 'sa' then date(timestamp_sub(nexfa.FA_TS,Interval 2 hour)) else date(nexfa.FA_TS) end)
> date(estimated_delivery_at) or date(nexfa.FA_TS) is null) and InBound_ManifestNr is not null then sois.awb_nr end) as Pure_NE_Breach_flag
from (SELECT *,CASE WHEN lower(json_extract(item_misc,"$.shipping_preferences.ndd")) in ('"free"','"paid"',"true") then 1
     WHEN lower(json_extract(item_misc,"$.shipping_preferences.sdd")) in ('"free"','"paid"',"true") THEN 1 ELSE 0 END AS NDD_SDD_Flag,
lower(json_extract(item_misc,"$.shipping_preferences.ndd")) NDD ,lower(json_extract(item_misc,"$.shipping_preferences.sdd")) SDD
FROM `noonltddwh.sales.sales_order_item`) soi
left join `noonltddwh.sales.sales_order` so on so.id_sales_order =soi.id_sales_order
LEFT JOIN (SELECT distinct id_sales_order FROM `noonltddwh.sales.sales_order_address_change`) oac on oac.id_sales_order = so.id_sales_order
left join `noonltddwh.sales.sales_order_item_shipment` sois on soi.id_sales_order_item_shipment =sois.id_sales_order_item_shipment
LEFT JOIN `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca on so.address_code = ca.address_code
left join (select id_city, name_en as destination_city from `noonltddwh.ref.city` ) as dc on ca.id_city=dc.id_city
LEFT JOIN
(
SELECT distinct awb_nr
FROM noonltddwh.lms.item it
LEFT JOIN noonltddwh.lms.item_pkg pkg USING (id_item)
WHERE CAST(json_extract(pkg.misc,'$.is_direct_delivery') AS NUMERIC) = 1
) DSDS on DSDS.awb_nr = sois.awb_nr
LEFT JOIN
(
select
 awb_nr
,container_line.unpacked_at as m_created_at,
from `noonltddwh.lms.container_line` container_line
left join `noonltddwh.lms.container_state`  container_state using (id_loc_type,loc_id)
left join `noonltddwh.lms.item` item using (id_item)
left join `noonltddwh.lms.manifest` manifest on container_line.loc_id=manifest.id_manifest
left join `noonltddwh.lms.manifest_type` manifest_type using (id_manifest_type)
left join `noonltddwh.lms.address` add using (id_address)
where id_loc_type = 5
and manifest_type.is_outbound = 0
) manifest1 on manifest1.awb_nr = sois.awb_nr
LEFT JOIN
(
SELECT sois.awb_nr AWB5,sois.created_at FROM
(
SELECT i.awb_nr,MIN(ish.created_at) created_at
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN noonltddwh.lms.item i using(id_item)
WHERE ish.id_loc_type = 3
GROUP BY 1
) sois
LEFT JOIN noonltddwh.xms_sourcing.ship_box sb on sois.awb_nr =sb.awb_nr
LEFT JOIN noonltddwh.xms_sourcing.warehouse_lane wl on wl.id_warehouse = sb.id_warehouse_seller
WHERE wl.id_warehouse_lane_type in (3,5)
)Direct_ship On sois.awb_nr = Direct_ship.AWB5
LEFT JOIN
(
SELECT sois.awb_nr awb4,pw.display_name ,dd.created_at
FROM `noonltddwh.sales.sales_order_item_shipment` sois
LEFT JOIN noonltddwh.sales.sales_order so using(id_Sales_order)
left JOIN `noonltddwh.partner.partner_warehouse` pw on sois.id_partner_warehouse_origin = pw.id_partner_warehouse
LEFT JOIN
(
SELECT i.awb_nr,MIN(ish.created_at) created_at
FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN noonltddwh.lms.item i using(id_item)
WHERE ish.id_loc_type = 3
GROUP BY 1
) dd on sois.awb_nr = dd.awb_nr
WHERE pw.display_name IN ('NOON/DXBG02','NOON/RUHG02','NOON/JEDG01')
) dx02 on dx02.awb4 = sois.awb_nr
left join (select awb_nr lost_awb
from (select id_item, max(created_at) created_at from noonltddwh.lms.item_state_history
where id_loc_type=1
group by 1)
left join noonltddwh.lms.item_state_history ish using(id_item, created_at)
left join noonltddwh.lms.hub_location hl on (ish.id_loc_type,ish.loc_id) = (1,id_hub_location)
left join noonltddwh.lms.item i using(id_item)
where id_loc_type = 1 and hl.code like "%LOST%"
)lost on lost.lost_awb= sois.awb_nr
left join (
select sois.awb_nr,reference_nr,
case
when sois.id_carrier=9 and reference_nr is null then "NE"
when sois.id_carrier =2 or tpl_carrier=2 then "Aramex"
when sois.id_carrier =6 or tpl_carrier=3 then "SMSA"
when sois.id_carrier = 43 or tpl_carrier=4 then "Saudi Post"
when tpl_carrier=5 then "IMile"
else refc.name_en
end as Carrier,
from `noonltddwh.sales.sales_order_item_shipment` sois
LEFT JOIN(
select distinct item.awb_nr , tipm.id_item , tcr.reference_nr, tcr.id_carrier as tpl_carrier from `noonltddwh.lms.item` item
LEFT JOIN `noonltddwh.lms.tpl_item_pgroup_map` tipm on tipm.id_item =item.id_item
LEFT JOIN `noonltddwh.lms.tpl_carrier_reference` tcr on tipm.id_item_pgroup = tcr.id_item
WHERE tcr.reference_nr is not null
)tpl on sois.awb_nr =tpl.awb_nr
LEFT JOIN `noonltddwh.ref.carrier` refc on sois.id_carrier=refc.id_carrier
where sois.id_carrier in (2,4,6,9,43)
) as car on sois.awb_nr =car.awb_nr
LEFT JOIN(select awb_nr , InBound_ManifestNr ,In_Created_At from `noonltddwh.lms.item`
LEFT JOIN (SELECT id_item,manifest_nr as InBound_ManifestNr ,manifest_item.created_at as In_Created_At
FROM `noonltddwh.lms.manifest_item` manifest_item
LEFT JOIN `noonltddwh.lms.manifest` using (id_manifest)
WHERE is_outbound=0) in_manifest_item USING (id_item) ) Manifest on sois.awb_nr=Manifest.awb_nr
left join `noonltddwh.lms.client_pkg_ref` client_pkg_ref on sois.awb_nr=client_pkg_ref.awb_nr
left join (select * from `noonltddwh.lms.creq_leg` where id_creq_leg_type=3) as creq_leg using (id_creq)
left join `noonltddwh.lms.hub_sector` hub_sector on hub_sector.id_hub_sector=creq_leg.id_hub_sector
left join `noonltddwh.lms.hub` hub on hub_sector.id_hub=hub.id_hub
left join `noonltddwh.lms.country_zone` as cz on cz.id_country_zone=creq_leg.id_country_zone
left join `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left join `noonltddwh.oms.purchase_item` pi on pi.purchase_item_nr = poi.purchase_item_nr
left join `noonltddwh.oms.sales_item` si using (id_sales_item)
left join (
select *
from
(SELECT distinct awb_nr, 
CASE 
WHEN DE_version = "new DE" then shipped_at
WHEN NDD_SDD_Flag = 1 and DE_version = "old DE" then expected_shipping_ts 
ELSE shipped_at end as shipped_at
,delivered_At
FROM (
SELECT sois.awb_nr
,case when day = 'EDD-0' then timestamp_add(estimated_delivery_at , interval cut_off_min minute)
when day = 'EDD-1' then timestamp_add (timestamp_sub(estimated_delivery_at, interval 24 hour) , interval cut_off_min minute)
else timestamp_add(timestamp_sub(estimated_delivery_at, interval 24 hour) , interval 18 hour)
end expected_shipping_ts
,CASE WHEN lower(json_extract(item_misc,"$.shipping_preferences.ndd")) in ('"free"','"paid"',"true") then 1
      WHEN lower(json_extract(item_misc,"$.shipping_preferences.sdd")) in ('"free"','"paid"',"true") THEN 1 ELSE 0 END AS NDD_SDD_Flag
,DE_version
,MIN(shipped_at) shipped_at,MIN(delivered_At) delivered_At
FROM `noonltddwh.sales.sales_order_item` soi
LEFT JOIN noonltddwh.sales.sales_order so using(id_sales_order)
left join (select address_code, id_city from `noonltddwh.bqsync.customer_address`) as ca on ca.address_code = so.address_code
LEFT JOIN `noonltddwh.sales.sales_order_item_shipment` sois using(id_sales_order_item_shipment)
left join `noonbilogoi.battleplan_v1.item_final_state` ifs using (awb_nr)
left join (select * from `noonbilogmis.reporting.premium_services_cutoff` where type in ('NDD','VIP-NDD') and id_city is not null) ps on (ifs.origin_warehouse , ca.id_city) = (ps.warehouse_code , ps.id_city)
left join `noonltddwh.lms.creq` c using (client_ref)
LEFT JOIN `noonltddwh.purchase_v2.purchase_order_item` poi on soi.id_sales_order_item=poi.id_sales_order_item
left join `noonltddwh.oms.purchase_item` pi on pi.purchase_item_nr = poi.purchase_item_nr
left join `noonltddwh.oms.sales_item` si using (id_sales_item)
left join (
select * EXCEPT(min_target_shipped_at), case when min_target_shipped_at is not null then "new DE" else "old DE" end as DE_version from   
(select id_purchase_item,id_partner_warehouse_from , 
coalesce(MIN(min_target_shipped_at),MIN(shipped_at)) shipped_at,MAx(delivered_at) delivered_at, 
MIN(min_target_shipped_at) min_target_shipped_at
from `noonltddwh.oms.stock_item` 
left join `noonltddwh.oms.item_estimate` using(id_stock_item)
GROUP BY 1,2)
)as b on (b.id_purchase_item,b.id_partner_warehouse_from) =(pi.id_purchase_item,soi.id_partner_warehouse) and b.id_purchase_item is not null
GROUP BY 1,2,3,4
))
where shipped_at is not null
)as b on b.awb_nr = sois.awb_nr
left join (SELECT awb_nr , MIN(FA_TS) FA_TS FROM
(
SELECT awb_nr , FA_TS FA_TS FROM
noonbilogoi.Share_Point.NE_FAS
)group by 1)nexfa on nexfa.awb_nr=sois.awb_nr
where  so.id_mp <>6
and soi.id_invoice_section = 1
and so.id_cart_type = 1
and carrier IN ("NE","Noon Express v2")
and soi.id_sales_order_item_status not in (1,2,7,9)
and lost.lost_awb is null
--and (b.shipped_at <= b.delivered_At OR  b.delivered_At is null)
and DSDS.awb_nr is null
and((NDD_SDD_Flag = 0 AND DATE(case when lower(so.country_code) = 'ae' then timestamp_add(b.shipped_at, interval 4 hour)
when lower(so.country_code) = 'sa' then timestamp_add(b.shipped_at, interval 3 hour)
when lower(so.country_code) = 'eg' then timestamp_add(b.shipped_at, interval 2 hour) end) <= DATE(estimated_delivery_at)) OR NDD_SDD_Flag = 1)
and sois.id_carrier in (2,4,6,9,43)
group by 1,2 ,3,4,5,6,7,8,9,10,11,12,13,14,15,16
)
)
'''

[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_namshi'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_namshi'
sql ='''
select awb_nr,hub,Region, city_tier_type, creq_leg_type,clh_forward_leg_held_reason,fa_ts,
pdd,payment_mode,delivered_date, shipment_status  
from `noonbilogoi.Share_Point.Namshi_performance` N
left join `noonbilogoi.LOGKSA_DATA.location_by_country` loc  on N.hub = loc.branch_code 
where pdd = current_date() - 1 and Region <> 'NA'
'''

[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_namshi_Cutoff'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_namshi_cuttOFF'
sql ='''
select *,round(Delivered_shipments/total_shipments,2) Del_pct  from 
(select 
City_tier,
payment_mode,
case 
when City_tier = 'Riyadh' and date(mn.shipment_creation_ts) = current_date()-1 and shipment_creation_hour <= 11 then 'Same Day' 
when City_tier = 'Riyadh' and date(mn.shipment_creation_ts) = current_date()-2 and shipment_creation_hour > 11 and shipment_creation_hour <= 23 then 'Next Day' 
when City_tier = 'Jeddah' and date(mn.shipment_creation_ts) = current_date()-2 and shipment_creation_hour <= 11 then 'Next Day'
when City_tier = 'Jeddah' and date(mn.shipment_creation_ts) = current_date()-3 and shipment_creation_hour > 11 then 'Next Day'
when City_tier = 'Dammam' and date(mn.shipment_creation_ts) = current_date()-2 and shipment_creation_hour <= 11 then 'Next Day' 
when City_tier = 'Dammam' and date(mn.shipment_creation_ts) = current_date()-3 and shipment_creation_hour > 11 then 'Next Day' 
when City_tier = 'Tier 1' and date(mn.shipment_creation_ts) = current_date()-3 and shipment_creation_hour <= 17 then '2 Days' 
when City_tier = 'Tier 1' and date(mn.shipment_creation_ts) = current_date()-4 and shipment_creation_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-3 and shipment_creation_hour <= 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-4 and shipment_creation_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-4 and shipment_creation_hour <= 17 then '3 Days'
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-5 and shipment_creation_hour > 17 then '3 Days'
when City_tier = 'Tier 3' and date(mn.shipment_creation_ts) = current_date()-5 and shipment_creation_hour <= 17 then '4 Days' 
when City_tier = 'Tier 3' and date(mn.shipment_creation_ts) = current_date()-6 and shipment_creation_hour > 17 then '4 Days' 
when City_tier = 'Tier 3' and date(mn.shipment_creation_ts) = current_date()-6 and shipment_creation_hour > 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.shipment_creation_ts) = current_date()-5 and shipment_creation_hour <= 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.shipment_creation_ts) = current_date()-6 and shipment_creation_hour > 17 then '4 Days' 
else null end as Transit_time,
count(awb_nr) total_shipments, count(distinct case when mn.shipment_status = 'Delivery' then awb_nr end) Delivered_shipments
from `noonbilogoi.Share_Point.Namshi_storyboard_mainview` mn
left join `noonbilogoi.battleplan_v1.item_final_state` it using(awb_nr)
where  substr(hub,1,5) not in ( 'RUH-B','RUH-C')
group by 1,2,3) 
where Transit_time is not null 
'''
[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_Touchpoint'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_Touchpoint'
sql ='''
select 
case when cz.id_country =1 then "AE"
     when cz.id_country =2 then "SA"
     when cz.id_country =3 then "EG"
     else "Check"
     end as Country,
INITCAP(case when json_extract_scalar(creq.misc,'$.mp_code') is null  then client.name 
else json_extract_scalar(creq.misc,'$.mp_code') end) 
as MP,
count(DISTINCT awb_nr) as OFD, 
count(DISTINCT CASE WHEN ofd_status ="Delivered" then awb_nr end) as OFD_Delivered,
count(distinct touchpoint) customers_served, 
count(Distinct username ) as DA
,current_timestamp() ts
from `noonbilogmis.reporting.OFD`  OFD 
left join `noonltddwh.lms.creq_leg` using (id_creq_leg) 
left join `noonltddwh.lms.creq` creq using (id_creq) 
left join `noonltddwh.lms.client` client using (id_client)
left join `noonltddwh.lms.hub_sector` hs using (id_hub_sector)
left join `noonltddwh.lms.country_zone` cz using (id_country_zone)
left join `noonltddwh.sales.sales_order` on client_ref =order_nr 
left join (select username, lms_roles from `noonltddwh.lms.user` 
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username) 
where date_diff(current_date(),OFD_Date ,day )=1 
and lms_roles not in ("fast-manifest","fast-manifest,non-sort-qc","non-sort-qc","seller-delivery") 
and id_creq_type =1 
and OFD.ofd_status <> 'held_consolidation'
group by 1,2
'''
[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_FA_UNDEL_PER'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_FA_UNDEL_PER'
sql ='''
select cs,ud_reason,count(distinct case when delivery_flag = 'undel' then ab end )as undel_count from(
select
distinct
 ifs.country as cs ,ofd_status as ud_reason,a.awb_nr as ab,
--a.ofd_hub,
-- extract(month from ofd1.ofd_date) as fa_month,
-- extract(year from ofd1.ofd_date) as fa_year,
--CASE WHEN so.payment_method_code = 'cod' THEN 'COD' ELSE 'Prepaid' END AS pay_method,
--count(distinct a.awb_nr) as fa_shipment,
--count(distinct case when ofd1.ofd_status ="Delivered" then a.awb_nr end) as fa_delivered
case when ofd1.ofd_status ="Delivered" then "del" else "undel" end as delivery_flag,
ROW_NUMBER() OVER(PARTITION BY a.awb_nr order by ofd_date desc) rn 
from (
  select awb_nr, ofd.ofd_hub ,  
  min(ofd_ts) as ofd_ts,
  from `noonbilogoi.MJ.OFD` ofd
  left join `noonbilogmis.base_table.creq_leg` using(id_creq_leg)
  left join `noonbilogmis.base_table.creq` using(id_creq)
  left join `noonbilogoi.battleplan_v1.item_final_state` using(awb_nr)
  left join `noonltddwh.sales.sales_order_item_shipment` sois using (awb_nr)
  left join `noonltddwh.sales.sales_order` so using (id_sales_order)
  where ofd.is_delivery_block = 0 
  and so.id_mp != 6 -- removes daily 
 and ofd_status<>'Not_Attempted'
  and ((id_creq_type =1 and id_creq_leg_type = 3))
  and ofd.hub_sector not like '%SP%' -- removes locker 
  group by 1,2
) a 
left join `noonbilogoi.MJ.OFD` ofd1 on (ofd1.awb_nr,ofd1.ofd_ts)=(a.awb_nr,a.ofd_ts)
LEFT JOIN `noonbilogoi.battleplan_v1.item_final_state` ifs on a.awb_nr=ifs.awb_nr
left join `noonltddwh.sales.sales_order` so on so.order_nr=ifs.client_ref
-- LEFT JOIN 
-- (SELECT distinct awb_nr, country as country_code, customer_type, payment_method_code, date(delivered_ts) as delivered_date
--   FROM `noonbifugc.datamart.core_sales` 
--   where awb_nr is not null
-- ) cs on a.awb_nr=cs.awb_nr

left join (  
select distinct awb_nr, reason cs_ud, updated_app, a.updated_date
from (select distinct id_creq_leg, awb_nr,
json_extract(clh.data,'$.updated_app') as updated_app,
r.code as reason, data, date(clh.created_at) updated_date
, row_number()over(partition by awb_nr order by clh.created_at desc) rw
from `noonltddwh.lms.creq_leg_history` clh
left join `noonltddwh.lms.creq_leg` cl using(id_creq_leg)
left join `noonltddwh.lms.creq` creq using(id_creq)
left join `noonltddwh.lms.reason` r on CAST(json_EXTRACT(DATA,"$.id_reason_held") AS INT64) = r.id_reason
left join `noonltddwh.lms.user` u using(id_user)
left join (select distinct awb_nr, id_item, id_creq_leg 
from `noonltddwh.lms.item_state_history`
left join `noonltddwh.lms.item` it using(id_item)
)ish using(id_creq_leg)
---------
where id_creq_leg_type =3
and date(clh.created_at) >= current_Date -10
and id_creq_type =1 and json_extract(clh.data,'$.updated_app') ='"client"'
order by 1,4) a
where rw=1
and reason in ('held_consolidation','rescheduled','held_for_pickup', 'customer_canceled') 
) ud on (a.awb_nr) = (ud.awb_nr)

where (if(ud.updated_date < ofd1.ofd_date,1,0)=1 or ud.cs_ud is null)
and ofd1.ofd_date = current_date() - 1
-- and ofd1.ofd_hub=ifs.forward_hub
and  (substr(a.ofd_hub,5,1) NOT IN ("G","Z","Y","V") or a.ofd_hub in (select string_field_0 from `noonbilogmis.reporting.MH_Facilities` where string_field_1 like 'LM%')) 
-- and ifs.country='eg' 
)where rn =1 group by 1,2

'''
[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_namshi_Cutoff_raw'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_namshi_Cutoff_raw'
sql ='''
select * from ( SELECT mn.*,
case 
when City_tier = 'Riyadh' and date(mn.shipment_creation_ts) = current_date()-1 and mn.shipment_creation_hour <= 11 then 'Same Day' 
when City_tier = 'Riyadh' and date(mn.shipment_creation_ts) = current_date()-2 and mn.shipment_creation_hour > 11 and mn.shipment_creation_hour <= 23 then 'Next Day' 
when City_tier = 'Jeddah' and date(mn.shipment_creation_ts) = current_date()-2 and mn.shipment_creation_hour <= 11 then 'Next Day'
when City_tier = 'Jeddah' and date(mn.shipment_creation_ts) = current_date()-3 and mn.shipment_creation_hour > 11 then 'Next Day'
when City_tier = 'Dammam' and date(mn.shipment_creation_ts) = current_date()-2 and mn.shipment_creation_hour <= 11 then 'Next Day' 
when City_tier = 'Dammam' and date(mn.shipment_creation_ts) = current_date()-3 and mn.shipment_creation_hour > 11 then 'Next Day' 
when City_tier = 'Tier 1' and date(mn.shipment_creation_ts) = current_date()-3 and mn.shipment_creation_hour <= 17 then '2 Days' 
when City_tier = 'Tier 1' and date(mn.shipment_creation_ts) = current_date()-4 and mn.shipment_creation_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-3 and mn.shipment_creation_hour <= 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-4 and mn.shipment_creation_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-4 and mn.shipment_creation_hour <= 17 then '3 Days'
when City_tier = 'Tier 2' and date(mn.shipment_creation_ts) = current_date()-5 and mn.shipment_creation_hour > 17 then '3 Days'
when City_tier = 'Tier 3' and date(mn.shipment_creation_ts) = current_date()-5 and mn.shipment_creation_hour <= 17 then '4 Days' 
when City_tier = 'Tier 3' and date(mn.shipment_creation_ts) = current_date()-6 and mn.shipment_creation_hour > 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.shipment_creation_ts) = current_date()-5 and mn.shipment_creation_hour <= 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.shipment_creation_ts) = current_date()-6 and mn.shipment_creation_hour > 17 then '4 Days' 
else null end as Transit_time,
FROM `noonbilogoi.Share_Point.Namshi_storyboard_mainview` mn
left join `noonbilogoi.battleplan_v1.item_final_state` it using(awb_nr)
where  substr(hub,1,5) not in ('RUH-B','RUH-C'))
where Transit_time is not null 
'''
[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_namshi_cuttOFF2nd'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_namshi_cuttOFF2nd'
sql ='''

select *,round(Delivered_shipments/total_shipments,2) Del_pct  from 
(select 
City_tier,
payment_mode,
case 
when City_tier = 'Riyadh' and date(mn.manifest_unpacked_TS) = current_date()-1 and mn.manifest_unpacked_hour <= 11 then 'Same Day' 
when City_tier = 'Riyadh' and date(mn.manifest_unpacked_TS) = current_date()-2 and mn.manifest_unpacked_hour > 11 and mn.manifest_unpacked_hour <= 23 then 'Next Day' 
when City_tier = 'Jeddah' and date(mn.manifest_unpacked_TS) = current_date()-2 and mn.manifest_unpacked_hour <= 11 then 'Next Day'
when City_tier = 'Jeddah' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour > 11 then 'Next Day'
when City_tier = 'Dammam' and date(mn.manifest_unpacked_TS) = current_date()-2 and mn.manifest_unpacked_hour <= 11 then 'Next Day' 
when City_tier = 'Dammam' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour > 11 then 'Next Day' 
when City_tier = 'Tier 1' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour <= 17 then '2 Days' 
when City_tier = 'Tier 1' and date(mn.manifest_unpacked_TS) = current_date()-4 and mn.manifest_unpacked_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour <= 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-4 and mn.manifest_unpacked_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-4 and mn.manifest_unpacked_hour <= 17 then '3 Days'
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-5 and mn.manifest_unpacked_hour > 17 then '3 Days'
when City_tier = 'Tier 3' and date(mn.manifest_unpacked_TS) = current_date()-5 and mn.manifest_unpacked_hour <= 17 then '4 Days' 
when City_tier = 'Tier 3' and date(mn.manifest_unpacked_TS) = current_date()-6 and mn.manifest_unpacked_hour > 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.manifest_unpacked_TS) = current_date()-5 and mn.manifest_unpacked_hour <= 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.manifest_unpacked_TS) = current_date()-6 and mn.manifest_unpacked_hour > 17 then '4 Days' 
else null end as Transit_time,
count(awb_nr) total_shipments, count(distinct case when mn.shipment_status = 'Delivery' then awb_nr end) Delivered_shipments
from `noonbilogoi.Share_Point.Namshi_storyboard_mainview` mn
left join `noonbilogoi.battleplan_v1.item_final_state` it using(awb_nr)
where  substr(hub,1,5) not in ( 'RUH-B','RUH-C')
group by 1,2,3) 
where Transit_time is not null 
'''
[[matview]]
dag_id = 'st_dag'
task_id ='Story_Board_Query_namshi_Cutoff_raw2nd'
destination_table =  'noonbilogmis.reporting.Story_Board_Query_namshi_Cutoff_rawa2nd'
sql ='''
select * from ( SELECT mn.*,
case 
when City_tier = 'Riyadh' and date(mn.manifest_unpacked_TS) = current_date()-1 and mn.manifest_unpacked_hour <= 11 then 'Same Day' 
when City_tier = 'Riyadh' and date(mn.manifest_unpacked_TS) = current_date()-2 and mn.manifest_unpacked_hour > 11 and mn.manifest_unpacked_hour <= 23 then 'Next Day' 
when City_tier = 'Jeddah' and date(mn.manifest_unpacked_TS) = current_date()-2 and mn.manifest_unpacked_hour <= 11 then 'Next Day'
when City_tier = 'Jeddah' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour > 11 then 'Next Day'
when City_tier = 'Dammam' and date(mn.manifest_unpacked_TS) = current_date()-2 and mn.manifest_unpacked_hour <= 11 then 'Next Day' 
when City_tier = 'Dammam' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour > 11 then 'Next Day' 
when City_tier = 'Tier 1' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour <= 17 then '2 Days' 
when City_tier = 'Tier 1' and date(mn.manifest_unpacked_TS) = current_date()-4 and mn.manifest_unpacked_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-3 and mn.manifest_unpacked_hour <= 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-4 and mn.manifest_unpacked_hour > 17 then '2 Days' 
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-4 and mn.manifest_unpacked_hour <= 17 then '3 Days'
when City_tier = 'Tier 2' and date(mn.manifest_unpacked_TS) = current_date()-5 and mn.manifest_unpacked_hour > 17 then '3 Days'
when City_tier = 'Tier 3' and date(mn.manifest_unpacked_TS) = current_date()-5 and mn.manifest_unpacked_hour <= 17 then '4 Days' 
when City_tier = 'Tier 3' and date(mn.manifest_unpacked_TS) = current_date()-6 and mn.manifest_unpacked_hour > 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.manifest_unpacked_TS) = current_date()-5 and mn.manifest_unpacked_hour <= 17 then '4 Days' 
when City_tier = 'Tier 4' and date(mn.manifest_unpacked_TS) = current_date()-6 and mn.manifest_unpacked_hour > 17 then '4 Days' 
else null end as Transit_time
FROM `noonbilogoi.Share_Point.Namshi_storyboard_mainview` mn
left join `noonbilogoi.battleplan_v1.item_final_state` it using(awb_nr)
where  substr(hub,1,5) not in ('RUH-B','RUH-C') )
where Transit_time is not null 
'''
[[matview]]
dag_id = 'st_dag'
task_id = 'MTD_DEL_SB'
destination_table = 'noonbilogmis.reporting.MTD_DEL_SB'
sql = '''
select distinct country, count(distinct awb_nr) as total_ofd  ,
count( distinct case when ofd_status ="Delivered" then awb_nr end ) total_delivered
from (select distinct * 
from(
select hh.code as ofd_hub,country, hub as awb_hub, hub_sector, client_ref, awb_nr, OFD_Date, manifest_nr, touchpoint, username, ofd_status, attempt_registered, reason, num_attempts, is_session_active, calls, omw, reachable, unreachable, last_call_attempt, creq_type, is_customer_cancelled , if(cod_value is not null, "COD", "Prepaid") as Payment_mode, id_session_field , id_item , id_pay_model,od.app as  lms_version ,is_delivery_block
from `noonbilogoi.MJ.OFD` as od 
left join (select id_item, promised_at , cod_value from `noonltddwh.lms.item_pkg` ) using (id_item)
left join(select id_creq, id_creq_leg, id_country_zone from `noonltddwh.lms.creq_leg`) as cl using(id_creq_leg)
left join (select id_country_zone, id_country from `noonltddwh.lms.country_zone`) as cz using(id_country_zone)
left join (select id_country,code as country from `noonltddwh.lms.country`) as ctr using (id_country)
left join (select id_creq, client_ref , id_creq_type from `noonltddwh.lms.creq`) as c using ( id_creq)
left join (select id_creq_type, code as creq_type from `noonltddwh.lms.creq_type`) as ct using (id_creq_type)
left join `noonltddwh.lms.session_field` using (id_session_field)
left join `noonltddwh.lms.hub` hh using (id_hub)
left join (select username, lms_roles , id_pay_model from `noonltddwh.lms.user`
left join `noonltddwh.lms.user_misc` using (id_user) ) using (username)
where creq_type='b2c_delivery'
--and OFD_Date = current_date() -1
and OFD_Date between DATE_TRUNC(current_date-1, month) and current_date-1
and substr(client_ref,6,1) <> "D"
and is_delivery_block = 0
and ofd_status <> "RTO"))
group by 1 

'''
[[matview]]
dag_id = 'st_dag'
task_id ='AE_Story_Board_Query_namshi'
destination_table =  'noonbilogmis.reporting.AE_Story_Board_Query_namshi'
sql ='''
select awb_nr,hub, city_tier_type, creq_leg_type,clh_forward_leg_held_reason,fa_ts,manifest_unpacked_TS,shipment_creation_ts,
pdd,payment_mode,delivered_date, shipment_status  
,case when hub like "DXB%" Then "Dubai" 
when hub like "SHJ%" Then "Sharjah"
else "Rest of UAE" 
END as Region
from `noonbilogmis.reporting.AE_Namshi_performance` N
--left join `noonbilogoi.LOGKSA_DATA.location_by_country` loc  on N.hub = loc.branch_code 
where pdd = current_date() - 1 and pdd > Date(manifest_unpacked_TS)

'''
[[dags]]
dag_id = 'authview_View'
schedule_interval = '@once'

[[authview]]
dag_id = 'authview_View'
task_id = 'hub_transfer_airport_route'
destination_table = 'noonbilogmis.NB.hub_transfer_airport_route'
sql = '''
select * from  `noondwh.lms.hub_transfer_airport_route`
'''

[[matview]]
dag_id = 'reschedule'
task_id ='Yesterday_reschedule_rawdata'
destination_table =  'noonbilogmis.reporting.Yesterday_reschedule_rawdata'
sql = '''select data.* from (select rschd.*,v2.* except(awb_nr,scheduled_date,row_num,Final_Status), case when ofd.awb_nr is not null then 1 else 0 end as Attempt_Adherence from (select * from (SELECT awb_nr,max(scheduled_date) upd_scheduled_date FROM ( SELECT * FROM (SELECT * FROM ( SELECT id_creq_leg,clh.created_at,username,REPLACE(json_EXTRACT(clh.DATA,"$.scheduled_date"),'"','') scheduled_date, ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num FROM noondwh.lms.creq_leg_history clh LEFT JOIN noondwh.lms.user usr USING(id_user) WHERE clh.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() AS TIMESTAMP), INTERVAL 30 DAY) AND json_EXTRACT(clh.DATA,"$.scheduled_date") IS NOT NULL)) WHERE row_num=1) LEFT JOIN noondwh.lms.item_pkg using(id_creq_leg) LEFT JOIN noondwh.lms.item using(id_item) GROUP BY 1) Where DATE(upd_scheduled_date)=CURRENT_DATE()-1)rschd left join `noonbilogoi.LOGKSA_DATA.lms_v2` v2 using (awb_nr) left join (select * from `noonbilogoi.MJ.OFD` Where is_delivery_block=0) ofd on (rschd.awb_nr,date(rschd.upd_scheduled_date)) = (ofd.awb_nr, ofd.ofd_date) Where RTO_LegDate is null and (date(Delivery_Date) >=current_date()-1 or date(Delivery_Date) is null) and carrier_change <>"Yes" and location_entity not like "%-LOST-O" and current_location in (select forward_hub from `noonbilogoi.battleplan_v1.item_final_state` where creq = "LM" ) and current_location is not null) data left join (select distinct awb_nr,reason, max(updated_date) updated_at from (select * from (select distinct id_creq_leg, awb_nr, json_extract(clh.data,'$.updated_app') as updated_app, r.code as reason, data, date(clh.created_at) updated_date,ROW_NUMBER() OVER (PARTITION BY id_creq_leg, DATE(clh.created_at) ORDER BY clh.created_at DESC) row_num from `noonltddwh.lms.creq_leg_history` clh left join `noonltddwh.lms.creq_leg` cl using(id_creq_leg) left join `noonltddwh.lms.creq` creq using(id_creq) left join `noonltddwh.lms.reason` r on CAST(json_EXTRACT(DATA,"$.id_reason_held") AS INT64) = r.id_reason left join `noonltddwh.lms.user` u using(id_user) left join (select distinct awb_nr, id_item, id_creq_leg from `noonltddwh.lms.item_state_history` left join `noonltddwh.lms.item` it using(id_item) )ish using(id_creq_leg) where date(clh.created_at) between current_Date -10 and current_date()-2 and id_creq_leg_type =3 and id_creq_type =1)) Where reason in ('attempts_exhausted','address_misrouted','customer_canceled','held_for_pickup') group by 1,2) ud on  ud.awb_nr=data.awb_nr where ud.awb_nr is null'''


[[matview]]
dag_id = 'FA_Del_10'
task_id ='FA_summary_10Days'
destination_table =  'noonbilogmis.reporting.FA_Del_10Days'
sql = '''select	distinct country,ofd_hub,awb_nr,OFD_Date, IF(COD_Value>0,"COD","Prepaid") Payment_method,cod_value,
	case when ofd_status="Delivered" then 1 else 0 end as delivered_check,
	case when ofd_status="Delivered" and Date(ofd_date)=Date(FA_TS) then 1 else 0 end as FAdelivered_check,
	case when Date(ofd_date)= Date(FA_TS) then 1 else 0 end as FA_OFD
	from(
	select distinct awb_nr, ofd_hub,OFD_Date,ofd_status,FA_TS,country,app,cod_value FROM `noonbilogoi.MJ.OFD` 
	left join `noonbilogoi.battleplan_v1.item_final_state` using (awb_nr)
	left join `noonbilogoi.Share_Point.NE_FAS` FA using (awb_nr)
	Where is_delivery_block=0
	and ofd_hub is not null
	and creq ="LM"
	and ofd_status<>"RTO"
	and (substr(ofd_hub,5,1) NOT IN ("G","Z","Y") or ofd_hub in (select string_field_0 from noonbilogmis.reporting.MH_Facilities where string_field_1 like 'LM%'))
	and MP NOT IN ('"daily"','"grocery"')
	and ofd_date between current_date()-10 and current_date()
	and date(FA_ts)=date(OFD_Date))
	order by 1,2
'''

[[matview]]
dag_id = 'st_dag'
task_id ='FAdel_strick_Hubwise'
destination_table =  'noonbilogmis.reporting.FAdel_strick_Hubwise'
sql = '''

With ofd_data as(select ofd_date, ofd_hub,ifs.country,
total_fa_ofd,
not_fa_ofd,
FA_Delivered,
not_fa_Delivered,
count(distinct ofd.awb_nr) as total_ofd,
from noonbilogoi.MJ.OFD ofd
Left join noonbilogoi.battleplan_v1.item_final_state ifs using (awb_nr)
left join (select ofd_date, ofd_hub,count(distinct case when rnk =1 then awb_nr end) as total_fa_ofd,
count (distinct case when rnk=1 and ofd_status like "Delivered" then awb_nr end) FA_Delivered,
count(distinct case when rnk <> 1 then awb_nr end) as not_fa_ofd,
count (distinct case when rnk <>1 and ofd_status like "Delivered" then awb_nr end) not_fa_Delivered,
from (select distinct awb_nr, ofd_date, ofd_hub,ofd_status,
rank() over (partition by awb_nr order by ofd_date asc) rnk
from noonbilogoi.MJ.OFD
Left join noonbilogoi.battleplan_v1.item_final_state ifs using (awb_nr)

where ofd_date>= current_date -30
and is_delivery_block =0
and ofd_hub is not null
and creq="LM" and MP NOT IN ('"daily"','"grocery"')
and  (substr(ofd_hub,5,1) NOT IN ("G","Z","Y") or ofd_hub in (select string_field_0 from `noonbilogmis.reporting.MH_Facilities` where string_field_1 like 'LM%'))
) --where rnk =1
group by 1,2
) fa using(ofd_date,ofd_hub)
where ofd_Date between date_add (current_date(),Interval -10 day) and current_date()-1
and is_delivery_block =0
and  (substr(ofd_hub,5,1) NOT IN ("G","Z","Y") or ofd_hub in (select string_field_0 from `noonbilogmis.reporting.MH_Facilities` where string_field_1 like 'LM%'))
 and ofd_hub is not null
and creq="LM" and MP NOT IN ('"daily"','"grocery"')
group by 1,2,3,4,5,6,7
order by 1,2)
select ofd_date, ofd_hub,country,total_ofd,
total_fa_ofd,
not_fa_ofd ,
fA_delivered,
not_fa_Delivered,
round(safe_divide(FA_Delivered,total_fa_ofd),2) fA_Strikerate,
from ofd_data

'''
[[matview]]
dag_id = 'pgroup_details'
task_id ='pgroup_details_90days'
destination_table = 'noonbilogmis.reporting.pgroup_details_90days'
sql = '''SELECT lbc.country,
pgroup.awb_nr,
pgroup.id_item,
pgroup.pgroup_ts,
pgroup_creation.pgroup_ts1,
pgroup_start.hub_transfer_nr hta_start,
pgroup_start.created_at hta_start_ts,
pgroup_end.hub_transfer_nr hta_last,
pgroup_end.created_at hta_last_ts,
pgroup_start.hub org_hub,
pgroup.hub current_hub,
pgroup.dst_hub,
bag_arrival.bag_arrival_ts,
Pgroup_type,
username as pgroup_creater, 
awb_count.awb_count
-- last transaction of bag
FROM (SELECT awb_nr,id_item,dst_hub,hub,Pgroup_type,
MIN(created_at) pgroup_ts,
MIN(hub_transfer_ts) hub_transfer_ts FROM (
SELECT awb_nr,ish.id_item,ish.created_at,hub_transfer.hub_transfer_nr,COALESCE(SUBSTR(hub_location.code,1,6),hub.code) hub,
COALESCE(hub_transfer.created_at) hub_transfer_ts,phub.code dst_hub,item_pgroup_type.code as Pgroup_type,
ROW_NUMBER() OVER (PARTITION BY ish.id_item ORDER BY ish.created_at DESC) start_row FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.item` item using(id_item)
LEFT JOIN `noonltddwh.lms.item_pgroup` item_pgroup using(id_item)
LEFT JOIN  `noondwh.lms.item_pgroup_type` item_pgroup_type using (id_item_pgroup_type)
LEFT JOIN `noonltddwh.lms.hub` phub on (item_pgroup.id_loc_type,item_pgroup.loc_id) = (7,phub.id_hub)
LEFT JOIN `noonltddwh.lms.hub_location` hub_location ON (ish.id_loc_type,ish.loc_id) = (1,hub_location.id_hub_location)
LEFT JOIN `noonltddwh.lms.hub_transfer` hub_transfer ON (ish.id_loc_type,ish.loc_id) = (4,hub_transfer.id_hub_transfer)
LEFT JOIN `noonltddwh.lms.hub` hub ON hub.id_hub = hub_transfer.id_hub_src
WHERE ish.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() as TIMESTAMP), INTERVAL 90 DAY) AND
item.item_pdate >= DATE_ADD(CURRENT_DATE(),INTERVAL -90 DAY) AND
item_pgroup.id_loc_type in (7,10)
AND ish.id_loc_type in (1,4))
WHERE start_row = 1
GROUP BY 1,2,3,4,5) pgroup
LEFT JOIN (select id_item,id_user_updater,awb_nr, username from (select ish.id_item,ish.created_at,id_user_updater,
row_number() over (PARTITION BY ish.id_item ORDER BY ish.created_at) start_row FROM `noonltddwh.lms.item_state_history`
ish)
left join `noonltddwh.lms.item` item using(id_item)
left join `noonltddwh.lms.user` on id_user_updater=id_user
Where start_row=1) pgroup_creator on pgroup.awb_nr=pgroup_creator.awb_nr

-- to fetch first hub_transfer_details
LEFT JOIN (SELECT * FROM (SELECT ish.id_item,ish.created_at,hub.code hub,hub_transfer.hub_transfer_nr,hub_transfer.created_at hub_transfer_ts,
ROW_NUMBER() OVER (PARTITION BY ish.id_item ORDER BY ish.created_at) start_row FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.item` item using(id_item)
LEFT JOIN `noonltddwh.lms.item_pgroup` item_pgroup using(id_item)
LEFT JOIN `noonltddwh.lms.hub_transfer` hub_transfer ON (ish.id_loc_type,ish.loc_id) = (4,hub_transfer.id_hub_transfer)
LEFT JOIN `noonltddwh.lms.hub` hub on hub.id_hub = hub_transfer.id_hub_src
WHERE ish.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() as TIMESTAMP), INTERVAL 90 DAY) AND
item.item_pdate >= DATE_ADD(CURRENT_DATE(),INTERVAL -90 DAY) AND
item_pgroup.id_loc_type in (7,10)
AND ish.id_loc_type = 4) where start_row = 1) pgroup_start ON pgroup_start.id_item = pgroup.id_item 
-- to fetch last hub_transfer_details
LEFT JOIN (SELECT * FROM (SELECT ish.id_item,ish.created_at,hub_transfer.hub_transfer_nr,hub_transfer.created_at hub_transfer_ts,
ROW_NUMBER() OVER (PARTITION BY ish.id_item ORDER BY ish.created_at DESC) end_row FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.item` item using(id_item)
LEFT JOIN `noonltddwh.lms.item_pgroup` item_pgroup using(id_item)
LEFT JOIN `noonltddwh.lms.hub_transfer` hub_transfer ON (ish.id_loc_type,ish.loc_id) = (4,hub_transfer.id_hub_transfer)
WHERE ish.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() as TIMESTAMP), INTERVAL 90 DAY) AND
item.item_pdate >= DATE_ADD(CURRENT_DATE(),INTERVAL -90 DAY) AND
item_pgroup.id_loc_type in (7,10)
AND ish.id_loc_type = 4) where end_row = 1) pgroup_end ON pgroup_end.id_item = pgroup.id_item
-- bag_arrival_ts
LEFT JOIN (SELECT id_item,min(created_at) bag_arrival_ts FROM(
SELECT awb_nr,
ish.id_item,
ish.created_at,
hub.code current_hub,
phub.code dst_hub
     FROM `noonltddwh.lms.item_state_history` ish
LEFT JOIN `noonltddwh.lms.item` item using(id_item)
LEFT JOIN `noonltddwh.lms.item_pgroup` item_pgroup using(id_item)
LEFT JOIN `noonltddwh.lms.hub` phub on (item_pgroup.id_loc_type,item_pgroup.loc_id) = (7,phub.id_hub)
LEFT JOIN `noonltddwh.lms.hub_location` hub_location ON (ish.id_loc_type,ish.loc_id) = (1,hub_location.id_hub_location)
LEFT JOIN `noonltddwh.lms.hub` hub ON hub.id_hub = hub_location.id_hub
WHERE ish.created_at >= TIMESTAMP_SUB(CAST(CURRENT_DATE() as TIMESTAMP), INTERVAL 90 DAY) AND
item.item_pdate >= DATE_ADD(CURRENT_DATE(),INTERVAL -90 DAY) AND
item_pgroup.id_loc_type = 7
AND ish.id_loc_type = 1) where current_hub = dst_hub 
GROUP BY 1) bag_arrival ON bag_arrival.id_item = pgroup.id_item
LEFT JOIN `noonbilogoi.LOGKSA_DATA.location_by_country` lbc on lbc.branch_code=pgroup.hub
LEFT JOIN (select item.awb_nr as pgroup, count(distinct ish.id_item) awb_count from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.item` item on (item.id_item,3)= (ish.loc_id,ish.id_loc_type)
left join `noonltddwh.lms.item` item_1 on ish.id_item=item_1.id_item
where ish.id_loc_type=3 
and item_1.id_item_type=1
group by 1) awb_count on awb_count.pgroup=pgroup.awb_nr

LEFT JOIN (select id_item,awb_nr,MIN(c_ts) pgroup_ts1 from (select ish.id_item,ish.created_at c_ts,
row_number() over (PARTITION BY ish.id_item ORDER BY ish.created_at) start_row FROM `noonltddwh.lms.item_state_history`
ish)
left join `noonltddwh.lms.item` item using(id_item)
Where start_row=1
group by 1,2) 
pgroup_creation on pgroup.awb_nr=pgroup_creation.awb_nr'''
 
 [[matview]]
dag_id = 'pgroup_details'
task_id ='awb_details_DS_Flex'
destination_table = 'noonbilogmis.reporting.awb_details_DS_Flex'
sql = '''select * EXCEPT(awb_print_TS,docket_nr) FROM(
select distinct f.*,p.*,
TIMESTAMP_ADD(awb_print_TS , INTERVAL (CASE WHEN country = "eg" THEN 2
     WHEN country = "sa" THEN 3
     WHEN country = "ae" THEN 4 END) HOUR) AS upd_awb_print_TS,
TIMESTAMP_ADD(ish.first_scan_ts, INTERVAL (CASE WHEN country = "eg" THEN 2
     WHEN country = "sa" THEN 3
     WHEN country = "ae" THEN 4  END) HOUR) AS first_scan_ts,ish.Fscanned_entity,
     
TIMESTAMP_ADD(SG_Scan, INTERVAL (CASE WHEN country = "eg" THEN 2
     WHEN country = "sa" THEN 3
     WHEN country = "ae" THEN 4 END) HOUR) AS SG_Scan_ts, SG_Location,
     pgroup_ts,bag_number
 from(select distinct awb_nr,country, wh_code,display_name,type,exp_pickup_date,"DS" Flag FROM `noonbilogmis.kd.ds_data` where type='normal'
union all
SELECT distinct awb_nr,country,wh_code, display_name,wh_type,exp_pickup_date,"Flex" Flag FROM `noonbilogmis.kd.seller_flex` where wh_type<>'Bulky') f
left join(select * from(
SELECT distinct a.id_item,i.awb_nr docket_nr,a.created_at awb_print_TS,a.id_hub,h.code as hub_code,u.username, a.id_user,
ROW_NUMBER() OVER(PARTITION BY a.id_item ORDER BY a.created_at) rn
FROM `noonltddwh.lms.user_item_print_log` a
LEFT JOIN `noonltddwh.lms.item` i on a.id_item=i.id_item
LEFT JOIN `noonltddwh.lms.hub` h on a.id_hub=h.id_hub
LEFT JOIN `noonltddwh.lms.user` u on a.id_user=u.id_user
)where rn=1) p on f.awb_nr=p.docket_nr
------------First scan entity--------
LEFT JOIN 
(select * from(
SELECT distinct t.*,LEFT(hub_location.code,6) Origin_hub,hub_location.code Fscanned_entity,row_number() over(partition by awb_nr order by t.first_scan_ts) rn 
FROM(select * from (select itm.awb_nr,itm.id_item, id_loc_type,loc_id,  lt.code as location_type, u.username username, ish.created_at first_scan_ts from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.item` itm using(id_item)
left join `noondwh.lms.loc_type` lt using(id_loc_type)
left join `noondwh.lms.user` u on ish.id_user_updater = u.id_user)
where date(first_scan_ts) >= current_date()-100 and id_loc_type=1) t
LEFT JOIN `noonltddwh.lms.hub_location` hub_location ON (t.id_loc_type,t.loc_id) = (1,hub_location.id_hub_location)
 WHERE location_type='hub_location' and  LEFT(hub_location.code,6) like '%-G%') where rn=1)ish on f.awb_nr=ish.awb_nr

 ------------SG Scan entity
LEFT JOIN 
 (select * from(
SELECT distinct t.*,LEFT(hub_location.code,6) Origin_hub,hub_location.code SG_Location,row_number() over(partition by awb_nr order by t.SG_Scan) rn 
FROM(select * from (select itm.awb_nr,itm.id_item, id_loc_type,loc_id,  lt.code as location_type, u.username username, ish.created_at SG_Scan from `noonltddwh.lms.item_state_history` ish
left join `noonltddwh.lms.item` itm using(id_item)
left join `noondwh.lms.loc_type` lt using(id_loc_type)
left join `noondwh.lms.user` u on ish.id_user_updater = u.id_user)
where date(SG_Scan) >= current_date()-100 and id_loc_type=1) t
LEFT JOIN `noonltddwh.lms.hub_location` hub_location ON (t.id_loc_type,t.loc_id) = (1,hub_location.id_hub_location)
 WHERE location_type='hub_location' and  hub_location.code like '%-SG%') where rn=1) sg on (p.docket_nr,p.hub_code)=(sg.awb_nr,sg.Origin_hub)
-------------------Pgroup---------
LEFT JOIN 
(select * from(
select ht.org_hub, awb_in_bag,bag_number,pgroup_ts, row_number() over(partition by awb_in_bag order by packed_at ) rn  from `noonbilogoi.LOGKSA_DATA.hub_transfer` ht
left join `noonbilogoi.LOGKSA_DATA.pgroup` pg on (ht.org_hub,ht.bag_number)=(pg.org_hub,pg.awb_nr) where ht.org_hub like '%-G%')
where rn=1) pg on f.awb_nr=pg.awb_in_bag

WHERE DATE(awb_print_TS) between CURRENT_DATE()-90 and current_date()-1  and hub_code like '%-G%')'''


