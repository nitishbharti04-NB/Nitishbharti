<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz with Certificate</title>
<style>
  body { background:#121212; color:#eee; font-family: Arial, sans-serif; margin:0; padding:20px;}
  .container { max-width:600px; margin:auto; background:#222; border-radius:8px; padding:20px; }
  h2 { color:#ffcc00; }
  button { cursor:pointer; border:none; padding:8px 16px; border-radius:4px; }
  button:disabled { background:#555; cursor:not-allowed; }
  .btn-primary { background:#0044cc; color:#fff; }
  .btn-secondary { background:#666; color:#fff; }
  .options label { display:block; background:#333; margin:6px 0; padding:10px; border-radius:4px; cursor:pointer; }
  .options input[type="radio"] { margin-right:8px; }
  #timer { color:#ffcc00; margin-bottom:10px; font-weight:bold; }
  #certificateFrame { border: 3px solid #ffcc00; padding: 20px; border-radius: 10px; margin-top: 20px; background: #111; color:#eee; }
  #certificateFrame h2 { margin-top:0; color:#ffcc00; }
  #admin-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); color:#eee; padding:20px; overflow:auto; }
  #admin-modal table { width:100%; border-collapse: collapse; }
  #admin-modal th, #admin-modal td { border:1px solid #555; padding:8px; text-align:left; }
  #admin-modal th { background:#333; }
  #admin-modal button { margin:5px; }
</style>
</head>
<body>

<div class="container" id="landing">
  <h2>Welcome to NITI Quiz</h2>
  <button onclick="showLogin()">Start Test</button>
  <button id="admin-launch">Admin Panel</button>
</div>

<div class="container" id="login" style="display:none;">
  <h2>Enter Your Details</h2>
  <input type="text" id="inputName" placeholder="Full Name" style="width:100%;padding:10px;margin-bottom:10px;" />
  <input type="email" id="inputEmail" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;" />
  <button class="btn-primary" onclick="continueToSubject()">Continue</button>
  <button class="btn-secondary" onclick="backToLanding()">Back</button>
</div>

<div class="container" id="subject" style="display:none;">
  <h2>Select Subject</h2>
  <select id="segmentSelect" style="width:100%;padding:10px;margin-bottom:10px;">
    <option value="">-- Choose --</option>
    <option value="Excel">Excel</option>
    <option value="Advanced Excel">Advanced Excel</option>
    <option value="SQL">SQL</option>
    <option value="Power BI">Power BI</option>
    <option value="Python">Python</option>
  </select>
  <button class="btn-primary" onclick="startTest()">Start Test</button>
  <button class="btn-secondary" onclick="backToLogin()">Back</button>
</div>

<div class="container" id="quiz" style="display:none;">
  <div id="timer">Time Left: 20:00</div>
  <div id="questionCard"></div>
  <button class="btn-secondary" onclick="prevQ()" id="prevBtn" disabled>Previous</button>
  <button class="btn-primary" onclick="nextQ()" id="nextBtn">Next</button>
  <button class="btn-primary" onclick="finishTest()" id="finishBtn" style="display:none;">Finish</button>
</div>

<div class="container" id="result" style="display:none;">
  <h2>Test Completed</h2>
  <div id="scoreText"></div>
  <div id="certificateFrame">
    <h2>Certificate of Completion</h2>
    <p><strong>Name:</strong> <span id="certName"></span></p>
    <p><strong>Subject:</strong> <span id="certSkill"></span></p>
    <p><strong>Score:</strong> <span id="certScore"></span></p>
    <p><strong>Grade:</strong> <span id="certGrade"></span></p>
    <p><strong>Date:</strong> <span id="certDate"></span></p>
    <p><strong>Certificate ID:</strong> <span id="certId"></span></p>
  </div>
  <button class="btn-primary" onclick="downloadCertificate()">Download Certificate (PDF)</button>
  <button class="btn-secondary" onclick="restartTest()">Restart Test</button>
</div>

<!-- Admin Panel -->
<div id="admin-modal">
  <h2>Admin Panel - Test Results</h2>
  <button onclick="closeAdmin()">Close</button>
  <button onclick="clearData()">Clear All Data</button>
  <button onclick="exportCSV()">Export CSV</button>
  <table>
    <thead><tr><th>#</th><th>Name</th><th>Email</th><th>Subject</th><th>Score</th><th>Total</th><th>Grade</th><th>Certificate ID</th><th>Time</th></tr></thead>
    <tbody id="admin-tbody"></tbody>
  </table>
  <div id="summary" style="margin-top:10px;"></div>
</div>

<!-- Include html2canvas and jsPDF from CDN for certificate download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const POOL_SIZE = 1000;
const Q_PER_TEST = 15;
const TIME_LIMIT_S = 20 * 60;

let userName = '', userEmail = '';
let currentSegment = '';
let currentTest = [];
let userResponses = [];
let currentIndex = 0;
let remainingSeconds = TIME_LIMIT_S;
let timerInterval = null;

/* === Helpers === */
function show(id){ document.getElementById(id).style.display = ''; }
function hide(id){ document.getElementById(id).style.display = 'none'; }
function pad(n){return n<10?'0'+n:n;}
function formatTime(s){ return `${pad(Math.floor(s/60))}:${pad(s%60)}`; }

// Clean trailing numbers/spaces from string for matching
function cleanText(s) {
  return String(s).replace(/\s*\d+$/, '').trim();
}

// Shuffle array copy
function shuffle(arr){ 
  const a = arr.slice();
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// Sample k elements from array without replacement
function sample(arr, k){
  if(k >= arr.length) return arr.slice();
  const out = [], used = new Set();
  while(out.length < k){
    const i = Math.floor(Math.random()*arr.length);
    if(!used.has(i)){
      used.add(i);
      out.push(arr[i]);
    }
  }
  return out;
}

/* === Base question templates for each segment === */
const baseQuestions = {
  Excel:[
    {q:"Which function returns current date and time?", correct:"NOW()"},
    {q:"Which function counts numeric entries?", correct:"COUNT()"},
    {q:"Which function looks up values vertically?", correct:"VLOOKUP()"},
    {q:"Which function returns position of value in range?", correct:"MATCH()"},
    {q:"Which feature removes duplicate rows?", correct:"REMOVE DUPLICATES"},
    {q:"Which function concatenates strings?", correct:"CONCAT()"},
    {q:"Which function rounds a number?", correct:"ROUND()"},
    {q:"Which function generates random integers?", correct:"RANDBETWEEN()"},
    {q:"Which function returns today's date?", correct:"TODAY()"},
    {q:"Which function returns average of numbers?", correct:"AVERAGE()"}
  ],
  "Advanced Excel":[
    {q:"Which function replaces VLOOKUP?", correct:"XLOOKUP()"},
    {q:"Which function creates reusable functions?", correct:"LAMBDA()"},
    {q:"Which tool performs ETL in Excel?", correct:"Power Query"},
    {q:"Which language is used in Power Pivot?", correct:"DAX"},
    {q:"Which function supports dynamic arrays?", correct:"FILTER()"},
    {q:"Which function calculates values?", correct:"CALCULATE()"},
    {q:"Which function offsets a range?", correct:"OFFSET()"}
  ],
  SQL:[
    {q:"Which clause filters rows?", correct:"WHERE"},
    {q:"Which keyword removes duplicates?", correct:"DISTINCT"},
    {q:"Which clause groups rows?", correct:"GROUP BY"},
    {q:"Which join returns all left rows?", correct:"LEFT JOIN"},
    {q:"Which command inserts rows?", correct:"INSERT INTO"},
    {q:"Which command updates rows?", correct:"UPDATE"},
    {q:"Which clause orders rows?", correct:"ORDER BY"}
  ],
  "Power BI":[
    {q:"Which tool transforms data?", correct:"Power Query"},
    {q:"Which language creates measures?", correct:"DAX"},
    {q:"Which feature restricts data per user?", correct:"Row-level security"},
    {q:"Which visual shows trends?", correct:"Line chart"},
    {q:"Which refreshes cloud data?", correct:"Gateway"},
    {q:"Which feature filters reports?", correct:"Slicer"}
  ],
  Python:[
    {q:"Which keyword defines a function?", correct:"def"},
    {q:"Which type is immutable?", correct:"tuple"},
    {q:"Which function returns length?", correct:"len()"},
    {q:"Which keyword handles exceptions?", correct:"try/except"},
    {q:"Which creates a generator?", correct:"yield"},
    {q:"Which keyword creates anonymous functions?", correct:"lambda"},
    {q:"Which data structure stores key-value pairs?", correct:"dict"}
  ]
};

/* === Banks of distractors for options === */
const banks = {
  Excel:["NOW()","TODAY()","COUNT()","SUM()","AVERAGE()","VLOOKUP()","MATCH()","INDEX()","ROUND()","RANDBETWEEN()","REMOVE DUPLICATES","CONCAT()"],
  "Advanced Excel":["XLOOKUP()","LAMBDA()","FILTER()","Power Query","DAX","CALCULATE()","OFFSET()"],
  SQL:["SELECT","WHERE","GROUP BY","ORDER BY","DISTINCT","LEFT JOIN","INSERT INTO","UPDATE"],
  "Power BI":["Power Query","DAX","Line chart","Gateway","Row-level security","Slicer"],
  Python:["def","tuple","list","len()","yield","lambda","try/except","dict"]
};

/* === Generate a large pool of questions by repeating and adding variant numbers === */
function makePool(segment, size){
  const base = baseQuestions[segment];
  const bank = banks[segment];

  if(!base) return [];

  const pool = [];
  let counter = 1;

  while(pool.length < size){
    for(const tmpl of base){
      if(pool.length >= size) break;

      const correctText = tmpl.correct;

      // Distractors excluding the correct
      const distractors = shuffle(
        bank.filter(b => b !== correctText)
      ).slice(0, 3);

      // Compose options and shuffle
      const optionsRaw = shuffle([correctText, ...distractors]);

      // Add variant number suffix for uniqueness
      const variantNum = Math.floor(Math.random()*10)+1;
      const options = optionsRaw.map(opt => opt + (opt === correctText ? '' : ' ' + variantNum));

      // Clean texts for matching correct index
      const cleanCorrect = cleanText(correctText);
      const cleanedOptions = options.map(opt => cleanText(opt));
      const correctIndex = cleanedOptions.indexOf(cleanCorrect);

      pool.push({
        id: `${segment}-${counter++}`,
        q: `${segment} â€” ${tmpl.q} (variant ${variantNum})`,
        options,
        _answerIndex: correctIndex,
        correct: correctText,
        difficulty: 'hard'
      });
    }
  }

  return shuffle(pool);
}

/* === Start test === */
function startTest(){
  const sel = document.getElementById('segmentSelect').value;
  if(!sel) return alert('Please select a subject');
  currentSegment = sel;
  currentTest = makePool(currentSegment, POOL_SIZE);
  currentTest = sample(currentTest, Q_PER_TEST);
  userResponses = Array(Q_PER_TEST).fill(null);
  currentIndex = 0;
  remainingSeconds = TIME_LIMIT_S;

  hide('subject');
  show('quiz');
  renderQuestion();
  startTimer();
}

/* === Render current question === */
function renderQuestion(){
  const q = currentTest[currentIndex];
  const optsHtml = q.options.map((opt,i)=>`
    <label>
      <input type="radio" name="opt" value="${i}" ${userResponses[currentIndex]===i?'checked':''}/>
      ${opt}
    </label>`).join('');

  document.getElementById('questionCard').innerHTML = `
    <h3>Question ${currentIndex+1} / ${currentTest.length}</h3>
    <p>${q.q}</p>
    <div class="options">${optsHtml}</div>
  `;

  document.getElementById('prevBtn').disabled = currentIndex === 0;
  document.getElementById('nextBtn').style.display = currentIndex === currentTest.length -1 ? 'none' : '';
  document.getElementById('finishBtn').style.display = currentIndex === currentTest.length -1 ? '' : 'none';
}

/* === Navigation === */
function prevQ(){
  saveResponse();
  if(currentIndex > 0){
    currentIndex--;
    renderQuestion();
  }
}
function nextQ(){
  saveResponse();
  if(currentIndex < currentTest.length - 1){
    currentIndex++;
    renderQuestion();
  }
}
function saveResponse(){
  const sel = document.querySelector('input[name="opt"]:checked');
  userResponses[currentIndex] = sel ? +sel.value : null;
}

/* === Timer === */
function startTimer(){
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    remainingSeconds--;
    if(remainingSeconds <= 0){
      finishTest();
      return;
    }
    document.getElementById('timer').textContent = 'Time Left: ' + formatTime(remainingSeconds);
  }, 1000);
}

/* === Finish and show certificate === */
function finishTest(){
  saveResponse();
  clearInterval(timerInterval);
  hide('quiz');
  show('result');

  const score = userResponses.reduce((acc,v,i) => (v === currentTest[i]._answerIndex ? acc + 1 : acc), 0);
  const grade = score >= 13 ? 'Expert' : score >= 10 ? 'Proficient' : score >= 7 ? 'Intermediate' : 'Beginner';
  const date = new Date().toLocaleDateString();

  document.getElementById('certName').textContent = userName;
  document.getElementById('certSkill').textContent = currentSegment;
  document.getElementById('certScore').textContent = `${score} / ${currentTest.length}`;
  document.getElementById('certGrade').textContent = grade;
  document.getElementById('certDate').textContent = date;
  document.getElementById('certId').textContent = 'NITI-' + Math.random().toString(36).substring(2, 10).toUpperCase();

  // Save result
  const stored = JSON.parse(localStorage.getItem('niti_results') || '[]');
  stored.push({
    name: userName,
    email: userEmail,
    segment: currentSegment,
    score,
    total: currentTest.length,
    grade,
    certId: document.getElementById('certId').textContent,
    time: new Date().toISOString()
  });
  localStorage.setItem('niti_results', JSON.stringify(stored));

  document.getElementById('scoreText').textContent = `You scored ${score} out of ${currentTest.length} (${grade})`;
}

/* === Download certificate as PDF === */
async function downloadCertificate(){
  const el = document.getElementById('certificateFrame');
  const canvas = await html2canvas(el, {scale: 2});
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: 'landscape',
    unit: 'px',
    format: [canvas.width, canvas.height]
  });
  pdf.addImage(img, 'PNG', 0, 0, canvas.width, canvas.height);
  pdf.save('NITI_Certificate.pdf');
}

/* === Restart test === */
function restartTest(){
  hide('result');
  show('subject');
  currentSegment = '';
  currentTest = [];
  userResponses = [];
  currentIndex = 0;
  document.getElementById('segmentSelect').value = '';
}

/* === Navigation helpers === */
function showLogin(){
  hide('landing');
  show('login');
}
function backToLanding(){
  hide('login');
  show('landing');
}
function continueToSubject(){
  const n = document.getElementById('inputName').value.trim();
  const e = document.getElementById('inputEmail').value.trim().toLowerCase();
  if(!n) return alert('Enter your full name.');
  if(!e) return alert('Enter your email.');
  userName = n;
  userEmail = e;
  hide('login');
  show('subject');
}
function backToLogin(){
  hide('subject');
  show('login');
}

/* === Admin Panel === */
document.getElementById('admin-launch').onclick = () => {
  const data = JSON.parse(localStorage.getItem('niti_results') || '[]');
  const tbody = document.getElementById('admin-tbody');
  tbody.innerHTML = '';
  data.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${r.email}</td>
      <td>${r.segment}</td>
      <td>${r.score}</td>
      <td>${r.total}</td>
      <td>${r.grade}</td>
      <td>${r.certId}</td>
      <td>${new Date(r.time).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('summary').textContent = `Total attempts: ${data.length}`;
  show('admin-modal');
};
function closeAdmin(){ hide('admin-modal'); }
function clearData(){
  if(confirm('Clear all stored test results?')){
    localStorage.removeItem('niti_results');
    closeAdmin();
  }
}
function exportCSV(){
  const data = JSON.parse(localStorage.getItem('niti_results') || '[]');
  if(data.length === 0){
    alert('No data to export');
    return;
  }
  const csvRows = [
    ['Name','Email','Subject','Score','Total','Grade','Certificate ID','Date']
  ];
  data.forEach(r => {
    csvRows.push([
      `"${r.name}"`,
      `"${r.email}"`,
      `"${r.segment}"`,
      r.score,
      r.total,
      `"${r.grade}"`,
      `"${r.certId}"`,
      `"${new Date(r.time).toLocaleString()}"`
    ].join(','));
  });
  const csvString = csvRows.join('\n');
  const blob = new Blob([csvString], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'niti_results.csv';
  a.click();
  URL.revokeObjectURL(url);
}

</script>

</body>
</html>
