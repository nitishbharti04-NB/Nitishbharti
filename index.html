<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Skill Test Portal (Demo)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { margin:0; font-family:Segoe UI, system-ui, -apple-system, "Segoe UI Emoji"; background:linear-gradient(135deg,#141e30,#243b55); color:white;}
  .container {max-width:900px;margin:auto;padding:20px;}
  .card {background:white;color:#333;padding:25px;border-radius:15px;margin-top:20px;box-shadow:0 15px 30px rgba(0,0,0,.3);}
  button {background:linear-gradient(135deg,#ff512f,#dd2476); color:white; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; margin:5px; font-size:15px;}
  button:hover {transform:scale(1.03);}
  input[type="text"], input[type="email"] {padding:8px;border-radius:8px;border:1px solid #ccc; width: 300px;}
  label.option { cursor: pointer; display:block; margin:6px 0; }
  #timer {font-weight:bold;color:#ff512f;margin-top:10px;}
  .muted { color: #666; font-size:14px; }
  .center { text-align:center; }
  .logo { height:44px; vertical-align:middle; margin-right:12px; }
</style>
</head>
<body>
<div class="container">
  <div style="display:flex;align-items:center;">
    <img id="orgLogo" class="logo" src="" alt="" style="display:none;">
    <h1 id="orgName">üéØ Skill Assessment Portal</h1>
  </div>

  <!-- LOGIN / CANDIDATE CAPTURE -->
  <div id="login" class="card" aria-live="polite">
    <h2>Enter Your Details</h2>
    <label for="username" class="muted">Full Name</label><br>
    <input id="username" type="text" placeholder="Your Name" autocomplete="name"><br><br>
    <label for="email" class="muted">Email</label><br>
    <input id="email" type="email" placeholder="your@email.com" autocomplete="email"><br><br>
    <button type="button" onclick="login()">Next</button>
  </div>

  <!-- SELECT STREAM -->
  <div id="stream" class="card" style="display:none">
    <h2>Select Your Stream/Skill</h2>
    <div>
      <button type="button" onclick="startTest('Excel')">Excel</button>
      <button type="button" onclick="startTest('Advanced Excel')">Advanced Excel</button>
      <button type="button" onclick="startTest('SQL')">SQL</button>
      <button type="button" onclick="startTest('Power BI')">Power BI</button>
      <button type="button" onclick="startTest('Python')">Python</button>
    </div>
  </div>

  <div id="timer"></div>
  <div id="quiz" class="card" style="display:none"></div>
  <div id="result" class="card" style="display:none"></div>
</div>

<script>
/* ===========================
   CONFIG
   If you deploy Apps Script and want real backend, set that URL here.
   Example:
   const GAS_WEB_APP_URL = "https://script.google.com/macros/s/REPLACE_WITH_ID/exec";
   =========================== */
const GAS_WEB_APP_URL = ""; // empty => demo/mock mode

/* Branding (set by server response on session create/load) */
let ORG_NAME = "Skill Test Portal";
let ORG_LOGO = "";
let THEME_COLOR = "#764ba2";

/* ===== Globals ===== */
let user = "", email = "", skill = "", sessionId = null, startTime = null;
let test = [], answers = [], index = 0, score = 0, timer = null, timeLeft = 300;
let proctor = { tabSwitchCount:0, fullscreenExitCount:0, devtoolsDetected:0, idleTimeSecs:0, lastActivityTs: Date.now(), idleStart: null };
let autoSaveIntervalId = null;
const TOTAL_QUESTIONS = 15;
const AUTOSAVE_INTERVAL_MS = 15000; // 15s

/* ===== Utility ===== */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(str){
  return String(str||"").replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
function nowISO(){ return new Date().toISOString(); }
function secondsBetween(startISO, endISO){ return Math.max(0, Math.round((new Date(endISO) - new Date(startISO))/1000)); }

/* ===== Anti-cheat & proctoring hooks ===== */
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden){
    proctor.tabSwitchCount++;
    sendProctorEvent('tab_switch');
  } else {
    sendProctorEvent('tab_resume');
  }
});
document.addEventListener('fullscreenchange', ()=>{
  if(!document.fullscreenElement){
    proctor.fullscreenExitCount++;
    sendProctorEvent('fullscreen_exit');
  } else {
    sendProctorEvent('fullscreen_enter');
  }
});
(function devtoolsDetector(){
  let threshold = 160;
  setInterval(()=>{
    try{
      if(window.outerWidth - window.innerWidth > threshold || window.outerHeight - window.innerHeight > threshold){
        proctor.devtoolsDetected++;
        sendProctorEvent('devtools_suspected');
      }
    }catch(e){}
  }, 2000);
})();
['mousemove','keydown','scroll','touchstart'].forEach(ev=>document.addEventListener(ev, ()=>{ proctor.lastActivityTs = Date.now(); if(proctor.idleStart){ proctor.idleTimeSecs += Math.round((Date.now()-proctor.idleStart)/1000); proctor.idleStart = null; sendProctorEvent('resume_from_idle'); } }));
setInterval(()=>{
  const idleLimitMs = 30000;
  if(Date.now() - proctor.lastActivityTs > idleLimitMs && !proctor.idleStart){
    proctor.idleStart = Date.now();
    sendProctorEvent('idle_start');
  }
}, 2000);
function sendProctorEvent(type){
  if(!sessionId) return;
  const payload = {
    action: 'proctor_log',
    sessionId: sessionId,
    eventType: type,
    timestamp: nowISO(),
    proctorSummary: proctor,
    ua: navigator.userAgent,
    screen: { width: screen.width, height: screen.height }
  };
  // best-effort - not critical in demo
  if(GAS_WEB_APP_URL){
    fetch(GAS_WEB_APP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, mode:'cors', body: JSON.stringify(payload) }).catch(()=>{/* ignore */});
  } else {
    // in demo mode we store proctor events locally (not required)
    const key = `demo_proctor_${sessionId||'no_session'}`;
    const arr = JSON.parse(localStorage.getItem(key) || "[]");
    arr.push(payload);
    localStorage.setItem(key, JSON.stringify(arr));
  }
}

/* ===== Login & Resume detection ===== */
function login(){
  user = document.getElementById("username").value.trim();
  email = document.getElementById("email").value.trim();
  if(!user){ alert("Please enter your name."); return; }
  if(!email){ alert("Please enter your email."); return; }

  const saved = JSON.parse(localStorage.getItem('skill_test_session') || "null");
  if(saved && saved.sessionId){
    if(confirm("A previous session was found in this browser. Resume?")){
      sessionId = saved.sessionId;
      loadAndResume(sessionId);
      return;
    } else {
      localStorage.removeItem('skill_test_session');
    }
  }

  document.getElementById("login").style.display = "none";
  document.getElementById("stream").style.display = "block";
}

/* ===== Create session (server-side authoritative questions & shuffle) ===== */
async function startTest(s){
  skill = s;
  document.getElementById("stream").style.display = "none";
  document.getElementById("quiz").style.display = "block";

  const payload = {
    action: 'create_session',
    name: user,
    email: email,
    skill: skill,
    requestedQuestions: TOTAL_QUESTIONS,
    clientInfo: { ua: navigator.userAgent, screen: { width: screen.width, height: screen.height } }
  };

  try{
    const res = await callServer(payload);
    if(!res || !res.success){
      alert("Unable to start test: " + (res && res.message ? res.message : "server error"));
      document.getElementById("quiz").style.display = "none";
      document.getElementById("stream").style.display = "block";
      return;
    }
    sessionId = res.sessionId;
    test = res.questions;
    answers = new Array(test.length);
    index = 0;
    startTime = res.startTime;
    if(res.branding) { ORG_NAME = res.branding.name || ORG_NAME; ORG_LOGO = res.branding.logo || ""; THEME_COLOR = res.branding.color || THEME_COLOR; applyBranding(); }
    localStorage.setItem('skill_test_session', JSON.stringify({ sessionId: sessionId, skill: skill, startTime: startTime }));
    timeLeft = res.timeLimitSecs || 300;
    startTimer();
    showQ();
    if(autoSaveIntervalId) clearInterval(autoSaveIntervalId);
    autoSaveIntervalId = setInterval(()=>{ autosave(); }, AUTOSAVE_INTERVAL_MS);
  }catch(err){
    console.error(err);
    alert("Network or server error starting test.");
    document.getElementById("quiz").style.display = "none";
    document.getElementById("stream").style.display = "block";
  }
}

/* ===== Resume restore from server ===== */
async function loadAndResume(sessionIdToLoad){
  try{
    const res = await callServer({ action:'load_session', sessionId: sessionIdToLoad });
    if(!res || !res.success){ alert("Could not load session. Starting fresh."); localStorage.removeItem('skill_test_session'); return; }
    const data = res.data;
    if(data.Completed === "TRUE"){ alert("This session has been already submitted. You cannot resume it."); localStorage.removeItem('skill_test_session'); return; }
    if(res.SessionData){
      const sd = res.SessionData;
      test = sd.questions || [];
      answers = sd.answers || new Array(test.length);
      index = sd.currentIndex || 0;
      startTime = sd.startTime || data.StartTime;
      sessionId = data.SessionID;
      skill = data.Skill || sd.skill;
      user = data.Name || user;
      email = data.Email || email;
      document.getElementById("login").style.display = "none";
      document.getElementById("stream").style.display = "none";
      document.getElementById("quiz").style.display = "block";
      timeLeft = sd.timeLimitSecs || 300;
      startTimer();
      showQ();
      if(autoSaveIntervalId) clearInterval(autoSaveIntervalId);
      autoSaveIntervalId = setInterval(()=>{ autosave(); }, AUTOSAVE_INTERVAL_MS);
    } else {
      document.getElementById("login").style.display = "none";
      document.getElementById("stream").style.display = "block";
    }
    document.getElementById('username').value = user;
    document.getElementById('email').value = email;
  }catch(err){
    console.error(err);
    alert("Failed to resume session.");
  }
}

/* ===== Timer (client UI) ===== */
function startTimer(){
  const timerDiv = document.getElementById("timer");
  timerDiv.style.display = "block";
  clearInterval(timer);
  timer = setInterval(()=>{
    if(timeLeft <= 0){ clearInterval(timer); submit(); return; }
    timeLeft--;
    const m = Math.floor(timeLeft/60), s = timeLeft%60;
    timerDiv.textContent = `‚è± Time Left: ${m}:${s<10?"0"+s:s}`;
  },1000);
}

/* ===== Show question UI ===== */
function showQ(){
  const q = test[index];
  const quiz = document.getElementById("quiz");
  const total = test.length;
  const optsHtml = (q.options || []).map((o,i)=> {
    const id = `opt-${index}-${i}`;
    const checked = answers[index] === i ? "checked" : "";
    return `<label class="option"><input id="${id}" type="radio" name="opt" value="${i}" ${checked}> ${String.fromCharCode(65+i)}. ${escapeHtml(o)}</label>`;
  }).join("");
  quiz.innerHTML = `
    <div>
      <h3 style="color:${THEME_COLOR}">Question ${index+1}/${total} <small class="muted">(${q.difficulty || 'medium'})</small></h3>
      <p>${escapeHtml(q.q)}</p>
      ${optsHtml}
      <br>
      <div class="center">
        ${index>0?'<button type="button" onclick="prevQ()">Previous</button>':''}
        ${index<total-1?'<button type="button" onclick="nextQ()">Next</button>':'<button type="button" onclick="submit()">Submit</button>'}
      </div>
      <p class="muted">Unanswered: ${countUnanswered()} ‚Ä¢ Auto-saved every ${AUTOSAVE_INTERVAL_MS/1000}s.</p>
    </div>
  `;
  const firstOpt = quiz.querySelector('input[name="opt"]');
  if(firstOpt) firstOpt.focus();
}

/* ===== Answers & navigation ===== */
function saveAnswer(){
  const sel = document.querySelector('input[name="opt"]:checked');
  if(sel) answers[index] = Number(sel.value);
}
function nextQ(){ saveAnswer(); if(answers[index]===undefined){ if(!confirm("You haven't selected an answer for this question. Move to next?")) return; } adaptiveAdjust(); if(index < test.length-1){ index++; showQ(); } }
function prevQ(){ saveAnswer(); if(index>0){ index--; showQ(); } }
function countUnanswered(){ let c=0; for(let i=0;i<test.length;i++) if(answers[i]===undefined) c++; return c; }

/* ===== Adaptive (client-side light) ===== */
function adaptiveAdjust(){
  // Placeholder: server-side handles true adaptive selection for next sessions.
}

/* ===== Autosave ===== */
async function autosave(){
  saveAnswer();
  if(!sessionId) return;
  const payload = {
    action: 'autosave',
    sessionId: sessionId,
    answers: answers,
    currentIndex: index,
    proctorSummary: proctor,
    clientInfo: { ua: navigator.userAgent, screen: { width: screen.width, height: screen.height } },
    lastSavedAt: nowISO()
  };
  try{ await callServer(payload); }catch(err){ console.warn("Autosave failed", err); }
}

/* ===== Submit (server authoritative) ===== */
async function submit(){
  clearInterval(timer);
  saveAnswer();
  const unanswered = countUnanswered();
  if(unanswered > 0){ if(!confirm(`There are ${unanswered} unanswered question(s). Submit anyway?`)){ startTimer(); return; } }
  const payload = { action: 'submit', sessionId: sessionId, clientInfo: { ua: navigator.userAgent, screen: { width: screen.width, height: screen.height } }, answers: answers };
  try{
    const res = await callServer(payload);
    if(!res || !res.success){ alert("Submit failed: " + (res && res.message ? res.message : "server error")); return; }
    score = res.score;
    const total = res.totalQuestions || test.length;
    const level = res.level || computeLevel(score, total);
    localStorage.removeItem('skill_test_session');
    document.getElementById("quiz").style.display = "none";
    document.getElementById("timer").style.display = "none";
    if(autoSaveIntervalId) clearInterval(autoSaveIntervalId);
    showCertificate(user, skill, score, total, level, res.certificateId);
  }catch(err){
    console.error(err);
    alert("Network error submitting test.");
  }
}
function computeLevel(score, total){ const pct = (score/total)*100; if(pct >= 80) return "Advanced"; if(pct >= 50) return "Intermediate"; return "Beginner"; }

/* ===== Certificate UI & Download ===== */
function showCertificate(name, skill, score, total, level, certificateId){
  const resultDiv = document.getElementById("result");
  resultDiv.style.display = "block";
  resultDiv.innerHTML = "";
  const wrapper = document.createElement("div");
  wrapper.style.border = `5px solid ${THEME_COLOR}`;
  wrapper.style.padding = "30px";
  wrapper.style.textAlign = "center";
  const h1 = document.createElement("h1"); h1.innerHTML = `<span style="background:linear-gradient(90deg,#ff512f,#dd2476); -webkit-background-clip:text; color:transparent;">üèÜ Certificate of Completion</span>`; wrapper.appendChild(h1);
  const h3a = document.createElement("h3"); h3a.textContent = "This is to certify that"; wrapper.appendChild(h3a);
  const h2user = document.createElement("h2"); h2user.textContent = name; wrapper.appendChild(h2user);
  const h3b = document.createElement("h3"); h3b.textContent = "has successfully completed the"; wrapper.appendChild(h3b);
  const h2skill = document.createElement("h2"); h2skill.innerHTML = `<b style="color:${THEME_COLOR}">${escapeHtml(skill)} Test</b>`; wrapper.appendChild(h2skill);
  const pScore = document.createElement("p"); pScore.innerHTML = `<b>Score:</b> ${score}/${total}`; wrapper.appendChild(pScore);
  const pLevel = document.createElement("p"); pLevel.innerHTML = `<b>Level:</b> ${level}`; wrapper.appendChild(pLevel);
  const pDate = document.createElement("p"); pDate.textContent = `Date: ${new Date().toDateString()}`; wrapper.appendChild(pDate);
  const pThanks = document.createElement("p");
  pThanks.innerHTML = `Thanks for visiting our page ‚Äî <a href="https://nitishbharti04-nb.github.io/Nitishbharti/" target="_blank">https://nitishbharti04-nb.github.io/Nitishbharti/</a>`;
  wrapper.appendChild(pThanks);
  const idLine = document.createElement("p");
  if(certificateId) idLine.innerHTML = `<b style="background:linear-gradient(90deg,#12c2e9,#c471ed,#f64f59); -webkit-background-clip:text; color:transparent;">Certificate ID: ${escapeHtml(certificateId)}</b>`;
  wrapper.appendChild(idLine);
  const btnDownload = document.createElement("button"); btnDownload.type = "button"; btnDownload.textContent = "Download PDF"; btnDownload.onclick = () => downloadPDFStyled(name, skill, score, total, level, certificateId); wrapper.appendChild(btnDownload);
  const btnRestart = document.createElement("button"); btnRestart.type = "button"; btnRestart.textContent = "Restart Test"; btnRestart.onclick = () => location.reload(); wrapper.appendChild(btnRestart);
  resultDiv.appendChild(wrapper);
  btnDownload.focus();
}
function downloadPDFStyled(name, skill, score, total, level, certificateId){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  doc.setFontSize(28);
  doc.setTextColor(255,80,47);
  doc.text("Certificate of Completion", pageWidth / 2, 120, { align: 'center' });
  doc.setFontSize(14);
  doc.setTextColor(0,0,0);
  doc.text("This is to certify that", pageWidth / 2, 150, { align: 'center' });
  doc.setFontSize(22);
  doc.setTextColor(30,30,30);
  doc.text(name, pageWidth / 2, 185, { align: 'center' });
  doc.setFontSize(16);
  doc.setTextColor(0,102,204);
  doc.setFont(undefined, 'bold');
  doc.text(`${skill} Test`, pageWidth / 2, 210, { align: 'center' });
  doc.setFont(undefined, 'normal');
  doc.setFontSize(12);
  doc.setTextColor(0,0,0);
  doc.text(`Score: ${score}/${total}  |  Level: ${level}`, pageWidth / 2, 240, { align: 'center' });
  if(certificateId){ doc.setFontSize(10); doc.setTextColor(120, 0, 200); doc.text(`Certificate ID: ${certificateId}`, pageWidth / 2, 260, { align: 'center' }); }
  doc.setFontSize(11);
  doc.setTextColor(50,50,50);
  doc.text("Thanks for visiting our page", pageWidth / 2, 290, { align: 'center' });
  doc.setTextColor(0, 102, 204);
  doc.textWithLink("https://nitishbharti04-nb.github.io/Nitishbharti/", pageWidth / 2, 310, { align: 'center', url: "https://nitishbharti04-nb.github.io/Nitishbharti/" });
  doc.setLineWidth(1.5);
  doc.rect(40, 60, pageWidth - 80, 460);
  doc.save(`${(name || 'certificate').replace(/\s+/g,'_')}_Certificate.pdf`);
}

/* ===== Server comms helper (uses a demo/mock server when GAS_WEB_APP_URL is empty) ===== */
async function callServer(payload){
  if(!GAS_WEB_APP_URL){
    // demo/mock server implementation
    return mockServer(payload);
  }
  const res = await fetch(GAS_WEB_APP_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  return res.json();
}

/* ===== Demo/mock server (local-only) ===== */
function mockServer(payload){
  const action = payload.action;
  // use localStorage for session persistence in demo
  if(action === 'create_session'){
    const sid = 'demo-' + Date.now();
    const requested = payload.requestedQuestions || 5;
    // sample question bank (extend as needed)
    const bank = [
      { q: "What does SQL stand for?", options: ["Structured Query Language","Simple Query Language","Sequential Query Language","Server Query Language"], answerIndex: 0, difficulty: "easy" },
      { q: "In Excel, which function returns the current date?", options: ["NOW()", "TODAY()", "CURRENT()", "DATE()"], answerIndex: 1, difficulty: "easy" },
      { q: "Which Python keyword is used to create a function?", options: ["func", "def", "function", "lambda"], answerIndex: 1, difficulty: "easy" },
      { q: "Which chart is best for showing trends over time?", options: ["Pie chart","Line chart","Bar chart","Scatter plot"], answerIndex: 1, difficulty: "medium" },
      { q: "Which SQL clause is used to filter rows?", options: ["GROUP BY","ORDER BY","WHERE","HAVING"], answerIndex: 2, difficulty: "medium" },
      { q: "In Power BI, which feature transforms raw data?", options: ["Power Query","Power Pivot","Power View","Power Map"], answerIndex: 0, difficulty: "medium" },
      { q: "Which Excel feature helps remove duplicate rows?", options: ["Remove Duplicates","Data Cleanse","Unique Filter","Trim"], answerIndex: 0, difficulty: "easy" },
      { q: "What is the output of 2 + 3 * 4 in most programming languages?", options: ["20","14","24","10"], answerIndex: 1, difficulty: "easy" },
      { q: "Which of these is a NoSQL database?", options: ["MySQL","PostgreSQL","MongoDB","SQLite"], answerIndex: 2, difficulty: "medium" },
      { q: "What operator is used for equality in Python?", options: ["=","==",":=","==="], answerIndex: 1, difficulty: "easy" }
    ];
    // create questions by shuffling bank and picking requested
    const qset = shuffle(bank).slice(0, Math.min(requested, bank.length)).map(q=>{
      return { q: q.q, options: q.options.slice(), difficulty: q.difficulty, _answerIndex: q.answerIndex };
    });
    const start = nowISO();
    const sessionObj = {
      SessionID: sid,
      Name: payload.name,
      Email: payload.email,
      Skill: payload.skill,
      StartTime: start,
      Questions: qset,
      TimeLimitSecs: 300,
      Completed: "FALSE"
    };
    localStorage.setItem(`demo_session_${sid}`, JSON.stringify(sessionObj));
    return Promise.resolve({ success: true, sessionId: sid, questions: qset, startTime: start, timeLimitSecs: 300, branding: { name: "Demo Skill Portal", logo: "", color: "#764ba2" } });
  }

  if(action === 'load_session'){
    const sid = payload.sessionId;
    const raw = localStorage.getItem(`demo_session_${sid}`);
    if(!raw) return Promise.resolve({ success: false, message: "Not found" });
    const sessionObj = JSON.parse(raw);
    const saved = JSON.parse(localStorage.getItem(`demo_saved_${sid}`) || "null");
    return Promise.resolve({ success: true, data: sessionObj, SessionData: saved, SessionID: sid });
  }

  if(action === 'autosave'){
    const sid = payload.sessionId;
    const saved = {
      answers: payload.answers || [],
      currentIndex: payload.currentIndex || 0,
      proctorSummary: payload.proctorSummary || {},
      startTime: nowISO(),
      questions: JSON.parse(localStorage.getItem(`demo_session_${sid}`) || "{}").Questions || [],
      timeLimitSecs: 300
    };
    localStorage.setItem(`demo_saved_${sid}`, JSON.stringify(saved));
    return Promise.resolve({ success: true });
  }

  if(action === 'submit'){
    const sid = payload.sessionId;
    const sessionRaw = localStorage.getItem(`demo_session_${sid}`);
    if(!sessionRaw) return Promise.resolve({ success: false, message: "Session not found" });
    const sessionObj = JSON.parse(sessionRaw);
    const qlist = sessionObj.Questions || [];
    const given = payload.answers || [];
    let sc = 0;
    for(let i=0;i<qlist.length;i++){
      const qi = qlist[i];
      // the correct index is in _answerIndex in demo
      if(typeof qi._answerIndex !== 'undefined' && given[i] === qi._answerIndex) sc++;
    }
    sessionObj.Completed = "TRUE";
    localStorage.setItem(`demo_session_${sid}`, JSON.stringify(sessionObj));
    const certId = 'DEMO-CERT-' + Math.random().toString(36).substring(2,10).toUpperCase();
    return Promise.resolve({ success: true, score: sc, totalQuestions: qlist.length, level: computeLevel(sc, qlist.length), certificateId: certId });
  }

  // default: not implemented
  return Promise.resolve({ success: false, message: "Unknown action in demo mode" });
}

/* ===== Branding apply ===== */
function applyBranding(){
  try{
    if(ORG_LOGO){
      const img = document.getElementById('orgLogo');
      img.src = ORG_LOGO;
      img.style.display = 'inline-block';
    }
    document.getElementById('orgName').textContent = ORG_NAME;
  }catch(e){}
}

/* ===== Keyboard navigation (optional) ===== */
document.addEventListener('keydown',(e)=>{
  if(document.getElementById('quiz').style.display === 'block'){
    if(e.key === 'ArrowLeft') { e.preventDefault(); if(index>0) prevQ(); }
    if(e.key === 'ArrowRight') { e.preventDefault(); if(index<test.length-1) nextQ(); }
    if(e.key === 'Enter') {
      const focused = document.activeElement;
      if(focused && focused.matches('input[name="opt"]')){
        saveAnswer();
        if(index < test.length - 1) nextQ();
      }
    }
  }
});

/* ===== On unload, attempt save ===== */
window.addEventListener('beforeunload', (e)=>{
  if(sessionId){
    // best-effort save in demo
    if(GAS_WEB_APP_URL){
      navigator.sendBeacon && navigator.sendBeacon(GAS_WEB_APP_URL, JSON.stringify({ action:'autosave', sessionId: sessionId, answers: answers, currentIndex: index, proctorSummary: proctor }));
    } else {
      // save locally in demo
      localStorage.setItem(`demo_saved_${sessionId}`, JSON.stringify({ answers, currentIndex: index, proctorSummary: proctor, startTime: nowISO(), questions: test }));
    }
  }
});
</script>
</body>
</html>
